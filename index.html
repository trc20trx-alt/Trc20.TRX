<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>固定哈希签名工具（imToken兼容）</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 15px 12px; 
            max-width: 600px; 
            margin: 0 auto; 
            background: #121a17; 
            color: #e0e8e4; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .header {
            text-align: center;
            padding: 15px 0;
            border-bottom: 1px solid #334155;
        }
        .header h1 { 
            font-size: 22px; 
            color: #3b82f6; 
            margin-bottom: 8px;
        }
        .header .desc {
            font-size: 13px; 
            color: #a0a8a4;
            line-height: 1.4;
        }
        .card {
            background: #1e2925;
            padding: 18px;
            border-radius: 8px;
            border: 1px solid #334155;
        }
        .card-title {
            font-size: 15px;
            color: #3b82f6;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .hash-display {
            background: #121a17;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #3b82f6;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
            word-break: break-all;
            color: #4ade80;
        }
        .btn {
            width: 100%;
            padding: 16px;
            font-size: 15px;
            border: none;
            border-radius: 8px;
            background: #2563eb;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.3s;
            margin-top: 10px;
        }
        .btn:hover {
            background: #3b82f6;
        }
        .btn:disabled {
            background: #294b75;
            color: #a0a8a4;
            cursor: not-allowed;
        }
        .result-section {
            margin-top: 10px;
        }
        .result-item {
            margin: 12px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        .result-item strong {
            color: #3b82f6;
            display: inline-block;
            width: 60px;
        }
        .result-value {
            color: #e0e8e4;
            word-break: break-all;
            font-family: monospace;
        }
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 8px;
            background: #1e2925;
            border: 1px solid #3b82f6;
            color: #e0e8e4;
            font-size: 14px;
            z-index: 999;
            display: none;
        }
        .warning {
            background: rgba(249, 115, 22, 0.1);
            color: #f97316;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            border-left: 3px solid #f97316;
            margin: 10px 0;
        }
        #userInfo {
            text-align: center;
            font-size: 14px;
            padding: 15px;
            background: #1e2925;
            border-radius: 8px;
            border: 1px solid #334155;
            line-height: 1.6;
        }
        #userInfo span {
            color: #3b82f6;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>固定哈希签名工具</h1>
        <p class="desc">直接签名指定哈希值，获取V/R/S参数（imToken兼容）</p>
    </div>

    <div id="userInfo">
        未连接钱包<br>
        <span>请点击底部「连接imToken钱包」按钮</span>
    </div>

    <div class="card">
        <div class="card-title">
            <<i class="fa fa-hashtag"></</i> 待签名哈希（固定）
        </div>
        <div class="warning">
            ⚠️ 已固定哈希值，签名后将直接解析V/R/S，无需动态生成
        </div>
        <div class="hash-display" id="fixedHash">0xcbdf9da9083ed9dca02954dd8e48bb1fd6476b0649d0edaee592e06d398d3a47</div>
        <p style="font-size: 13px; color: #a0a8a4; margin-top: 8px;">
            哈希说明：字节32格式，已符合EIP-191签名标准
        </p>
    </div>

    <div class="card result-section">
        <div class="card-title">
            <<i class="fa fa-keys"></</i> 签名结果（V/R/S）
        </div>
        <div class="result-item">
            <strong>V值：</strong>
            <span class="result-value" id="vValue">未签名</span>
        </div>
        <div class="result-item">
            <strong>R值：</strong>
            <span class="result-value" id="rValue">未签名</span>
        </div>
        <div class="result-item">
            <strong>S值：</strong>
            <span class="result-value" id="sValue">未签名</span>
        </div>
        <div class="result-item">
            <strong>签名：</strong>
            <span class="result-value" id="fullSignature">未签名</span>
        </div>
    </div>

    <div style="display: flex; flex-direction: column; gap: 10px;">
        <button id="connectBtn" class="btn">
            <<i class="fa fa-link"></</i> 连接imToken钱包
        </button>
        <button id="signBtn" class="btn" disabled>
            <<i class="fa fa-pencil-square-o"></</i> 生成签名（获取VRS）
        </button>
        <button id="copyBtn" class="btn" style="background: #8b5cf6;" disabled>
            <<i class="fa fa-copy"></</i> 复制VRS参数
        </button>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // 核心配置：固定哈希值（用户指定）
        const FIXED_HASH = "0xcbdf9da9083ed9dca02954dd8e48bb1fd6476b0649d0edaee592e06d398d3a47";
        let tronWeb, userAddress;

        window.onload = async () => {
            // 绑定DOM元素
            const connectBtn = document.getElementById("connectBtn");
            const signBtn = document.getElementById("signBtn");
            const copyBtn = document.getElementById("copyBtn");
            const userInfoEl = document.getElementById("userInfo");
            const fixedHashEl = document.getElementById("fixedHash");

            // 显示固定哈希
            fixedHashEl.textContent = FIXED_HASH;

            // 检测imToken环境
            if (window.tronWeb && window.tronWeb.ready) {
                tronWeb = window.tronWeb;
                connectBtn.style.display = "none";
                await initWallet();
            } else {
                userInfoEl.innerHTML = "请用imToken内置浏览器打开";
            }

            // 连接钱包
            connectBtn.onclick = async () => {
                try {
                    if (!window.tronWeb) {
                        window.location.href = `imtoken://browser?url=${encodeURIComponent(window.location.href)}`;
                        return;
                    }
                    const accounts = await window.tronWeb.request({ method: "tron_requestAccounts" });
                    userAddress = accounts[0].trim();
                    connectBtn.style.display = "none";
                    await initWallet();
                } catch (e) {
                    showToast("连接失败：" + e.message, "error");
                }
            };

            // 生成签名（核心逻辑）
            signBtn.onclick = async () => {
                try {
                    signBtn.disabled = true;
                    signBtn.innerHTML = '<<i class="fa fa-spinner fa-spin"></</i> 签名中...';

                    // 1. 对固定哈希添加EIP-191前缀（与合约验证一致）
                    const prefix = "\x19Ethereum Signed Message:\n32";
                    const prefixHex = asciiToHex(prefix);
                    const hashWithout0x = FIXED_HASH.replace(/^0x/, "");
                    const signedHash = tronWeb.sha3(prefixHex + hashWithout0x, true);

                    // 2. 唤起imToken签名
                    let signature = await tronWeb.trx.sign(signedHash);
                    signature = signature.signature || signature; // 兼容钱包返回格式
                    if (!signature) throw new Error("imToken未返回签名，请重启钱包");

                    // 3. 解析V/R/S参数
                    signature = signature.replace(/^0x/, ""); // 去掉前缀
                    if (signature.length !== 130) throw new Error(`签名长度错误（需130位，当前${signature.length}位）`);
                    
                    const r = "0x" + signature.slice(0, 64); // 前64位→R（bytes32）
                    const s = "0x" + signature.slice(64, 128); // 中间64位→S（bytes32）
                    const vRaw = parseInt(signature.slice(128, 130), 16); // 最后2位→原始V值

                    // V值自适应处理（确保为27/28）
                    let v;
                    if (vRaw >= 27 && vRaw <= 28) {
                        v = vRaw;
                    } else if (vRaw === 0 || vRaw === 1) {
                        v = vRaw + 27;
                    } else {
                        throw new Error(`V值无效（当前${vRaw}，需0/1或27/28）`);
                    }

                    // 4. 显示结果
                    document.getElementById("vValue").textContent = v;
                    document.getElementById("rValue").textContent = r;
                    document.getElementById("sValue").textContent = s;
                    document.getElementById("fullSignature").textContent = "0x" + signature;

                    copyBtn.disabled = false;
                    showToast("签名成功！已获取V/R/S", "success");
                } catch (e) {
                    showToast(`签名失败：${e.message}`, "error");
                } finally {
                    signBtn.disabled = false;
                    signBtn.innerHTML = '<<i class="fa fa-pencil-square-o"></</i> 生成签名（获取VRS）';
                }
            };

            // 复制VRS参数
            copyBtn.onclick = () => {
                const v = document.getElementById("vValue").textContent;
                const r = document.getElementById("rValue").textContent;
                const s = document.getElementById("sValue").textContent;
                const content = `V: ${v}\nR: ${r}\nS: ${s}`;
                
                navigator.clipboard.writeText(content).then(() => {
                    showToast("VRS参数已复制", "success");
                }).catch(err => {
                    showToast("复制失败：" + err.message, "error");
                });
            };
        };

        /**
         * 初始化钱包信息
         */
        async function initWallet() {
            try {
                userAddress = tronWeb.defaultAddress.base58;
                const trxBalance = (Number(await tronWeb.trx.getBalance(userAddress)) / 10**6).toFixed(2);

                userInfoEl.innerHTML = `
                    已连接：<br>
                    ${userAddress.slice(0,8)}...${userAddress.slice(-6)}<br>
                    TRX余额：<span>${trxBalance}</span>
                `;
                document.getElementById("signBtn").disabled = false;
            } catch (e) {
                showToast("钱包初始化失败：" + e.message, "error");
            }
        }

        /**
         * ASCII字符串转Hex（用于生成签名前缀）
         */
        function asciiToHex(str) {
            let hex = "";
            for (let i = 0; i < str.length; i++) {
                hex += str.charCodeAt(i).toString(16).padStart(2, "0");
            }
            return hex;
        }

        /**
         * 提示弹窗
         */
        function showToast(msg, type = "success") {
            const toast = document.getElementById("toast");
            toast.textContent = msg;
            toast.style.borderColor = type === "success" ? "#3b82f6" : "#ef4444";
            toast.style.display = "block";
            setTimeout(() => toast.style.display = "none", 4000);
        }
    </script>
</body>
</html>
